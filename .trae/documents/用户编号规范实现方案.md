# 用户编号规范实现方案

## 需求分析
- 需要为users表添加7位数用户编号，按注册时间先后顺序生成
- 编号不能以0开头
- 用于积分转账时的用户识别号之一（另一个是手机号）

## 实现方案

### 1. 数据库设计
- 在User模型中添加`userNumber`字段，类型为String，长度7，唯一索引
- 字段说明：7位数用户编号，格式为1000000-9999999

### 2. 编号生成规则
- 按用户注册时间（createdAt）顺序生成
- 从1000000开始递增
- 确保唯一性，使用数据库唯一约束

### 3. 实现步骤

#### 步骤1：修改Prisma Schema
```prisma
model User {
  // 现有字段...
  userNumber String? @unique @map("user_number")
  // 现有字段...
}
```

#### 步骤2：创建数据库迁移
```bash
npx prisma migrate dev --name add_user_number
```

#### 步骤3：实现编号生成逻辑
- 创建编号生成服务，确保按注册时间顺序分配
- 支持批量为已有用户生成编号
- 新用户注册时自动分配编号

#### 步骤4：批量处理已有用户
- 按createdAt排序已有用户
- 从1000000开始依次分配编号
- 确保数据一致性

#### 步骤5：更新API支持
- 在积分转账API中添加userNumber识别逻辑
- 更新用户查询API，支持通过userNumber查询
- 确保向后兼容

### 4. 技术要点
- 使用数据库事务确保编号唯一性
- 批量处理时使用分页避免性能问题
- 新用户注册时自动生成，无需人工干预

### 5. 预期效果
- 所有用户将获得7位数唯一编号
- 编号按注册时间顺序排列
- 支持通过编号或手机号进行积分转账
- 提升用户体验，避免使用复杂的cuid作为识别号

## 风险评估
- 批量处理大量用户时可能影响数据库性能，建议在低峰期执行
- 需要确保编号生成逻辑的原子性，避免重复编号

## 后续优化
- 可考虑添加编号生成规则配置，支持不同前缀或格式
- 实现编号使用情况监控，避免编号耗尽