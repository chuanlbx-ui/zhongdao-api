# ===========================================
# 中道商城 - Nginx 生产配置（宝塔面板）
# 更新时间: 2025-11-24
# ===========================================

# -------------------------------------------
# 1. 后端 API 服务 - zd-api.wenbita.cn
# -------------------------------------------
# 在宝塔面板中创建网站，选择 "反向代理"
# 配置如下：

# 目标URL: http://127.0.0.1:3000
# 发送域名: $host
# 内容替换: 留空

# 或手动配置（在站点配置文件中添加）：
server {
    listen 80;
    listen 443 ssl http2;
    server_name zd-api.wenbita.cn;

    # SSL证书配置（宝塔自动生成或手动上传）
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;

    # 访问日志
    access_log /www/wwwlogs/zd-api.wenbita.cn.log;
    error_log /www/wwwlogs/zd-api.wenbita.cn.error.log;

    # 客户端最大请求体大小
    client_max_body_size 10M;

    # 反向代理到 Node.js API 服务
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        
        # 设置代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # 缓冲设置
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # 健康检查端点
    location /health {
        proxy_pass http://127.0.0.1:3000/health;
        access_log off;
    }

    # 强制HTTPS（可选）
    if ($server_port !~ 443){
        rewrite ^(/.*)$ https://$host$1 permanent;
    }
}

# -------------------------------------------
# 2. 管理后台 - zd-admin.wenbita.cn
# -------------------------------------------
# 在宝塔面板中创建网站，选择 "静态网站"
# 网站目录设置为前端构建产物路径，如：/www/wwwroot/zhongdao-admin/dist

# 或手动配置：
server {
    listen 80;
    listen 443 ssl http2;
    server_name zd-admin.wenbita.cn;

    # SSL证书配置
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    # 网站根目录（前端构建产物）
    root /www/wwwroot/zhongdao-admin/dist;
    index index.html;

    # 访问日志
    access_log /www/wwwlogs/zd-admin.wenbita.cn.log;
    error_log /www/wwwlogs/zd-admin.wenbita.cn.error.log;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/javascript application/json application/xml+rss 
               application/x-javascript image/svg+xml;

    # SPA 路由支持（所有请求都返回 index.html）
    location / {
        try_files $uri $uri/ /index.html;
        
        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 强制HTTPS
    if ($server_port !~ 443){
        rewrite ^(/.*)$ https://$host$1 permanent;
    }
}

# -------------------------------------------
# 3. 移动端 H5 - zd-h5.wenbita.cn
# -------------------------------------------
# 配置同管理后台，只是网站目录不同

server {
    listen 80;
    listen 443 ssl http2;
    server_name zd-h5.wenbita.cn;

    # SSL证书配置
    # ssl_certificate /path/to/cert.pem;
    # ssl_certificate_key /path/to/key.pem;

    # 网站根目录（H5前端构建产物）
    root /www/wwwroot/zhongdao-h5/dist;
    index index.html;

    # 访问日志
    access_log /www/wwwlogs/zd-h5.wenbita.cn.log;
    error_log /www/wwwlogs/zd-h5.wenbita.cn.error.log;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript 
               application/javascript application/json application/xml+rss 
               application/x-javascript image/svg+xml;

    # SPA 路由支持
    location / {
        try_files $uri $uri/ /index.html;
        
        # 安全头
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 强制HTTPS
    if ($server_port !~ 443){
        rewrite ^(/.*)$ https://$host$1 permanent;
    }
}

# ===========================================
# 宝塔面板操作步骤总结
# ===========================================
# 
# 1. API 服务（zd-api.wenbita.cn）
#    - 网站 → 添加站点 → 输入域名 zd-api.wenbita.cn
#    - 选择"反向代理" → 目标URL: http://127.0.0.1:3000
#    - SSL → 申请Let's Encrypt证书
#    - 在服务器上启动 Node.js 服务：pm2 start dist/index.js --name zd-api
#
# 2. 管理后台（zd-admin.wenbita.cn）
#    - 网站 → 添加站点 → 输入域名 zd-admin.wenbita.cn
#    - 网站目录设为：/www/wwwroot/zhongdao-admin/dist
#    - SSL → 申请Let's Encrypt证书
#    - 上传前端构建产物到该目录
#
# 3. H5前端（zd-h5.wenbita.cn）
#    - 网站 → 添加站点 → 输入域名 zd-h5.wenbita.cn
#    - 网站目录设为：/www/wwwroot/zhongdao-h5/dist
#    - SSL → 申请Let's Encrypt证书
#    - 上传H5构建产物到该目录
#
# 4. 防火墙设置
#    - 确保开放 80、443 端口
#    - 3000 端口仅允许本地访问（127.0.0.1）
#
# ===========================================
