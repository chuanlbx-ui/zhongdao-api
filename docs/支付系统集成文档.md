# 中道商城支付系统集成文档

## 📋 项目概述

本文档描述了中道商城支付系统的完整实现，包括微信支付和支付宝支付的集成，以及统一的支付管理架构。

## 🏗️ 系统架构

### 支付系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    支付管理系统                             │
├─────────────────────────────────────────────────────────────┤
│  API路由层 (/api/v1/payments)                              │
│  ├─ 微信支付路由 (/wechat)                                   │
│  ├─ 支付宝支付路由 (/alipay)                                 │
│  └─ 积分支付路由 (/points)                                   │
├─────────────────────────────────────────────────────────────┤
│  支付管理器 (PaymentManager)                                │
│  ├─ 统一支付接口                                             │
│  ├─ 支付提供商管理                                           │
│  └─ 支付方式映射                                             │
├─────────────────────────────────────────────────────────────┤
│  支付提供商抽象层                                           │
│  ├─ 支付提供商接口 (PaymentProvider)                        │
│  ├─ 微信支付实现 (WechatPayProvider)                        │
│  ├─ 支付宝支付实现 (AlipayPayProvider)                       │
│  └─ 积分支付实现 (PointsProvider)                            │
├─────────────────────────────────────────────────────────────┤
│  回调处理器 (PaymentCallbackHandler)                         │
│  ├─ 支付成功处理                                             │
│  ├─ 支付失败处理                                             │
│  ├─ 退款成功处理                                             │
│  ├─ 库存管理                                                 │
│  └─ 数据一致性保证                                           │
└─────────────────────────────────────────────────────────────┘
```

## 🔧 核心功能

### 1. 支付方式支持

#### 微信支付
- **JSAPI支付**: 小程序/公众号内支付
- **Native支付**: 扫码支付
- **APP支付**: 移动应用支付
- **H5支付**: 手机网站支付

#### 支付宝支付
- **网页支付**: PC网站支付
- **手机网站支付**: 移动端支付
- **APP支付**: 移动应用支付
- **扫码支付**: 二维码支付

### 2. 核心API接口

#### 统一支付接口
```http
POST /api/v1/payments/{provider}/create
```

#### 支付查询接口
```http
GET /api/v1/payments/{provider}/query/{orderId}
```

#### 支付关闭接口
```http
POST /api/v1/payments/{provider}/close/{orderId}
```

#### 退款申请接口
```http
POST /api/v1/payments/{provider}/refund
```

#### 支付回调接口
```http
POST /api/v1/payments/{provider}/notify
```

#### 退款回调接口
```http
POST /api/v1/payments/{provider}/refund/notify
```

## 🛠️ 技术实现

### 1. 技术栈
- **后端框架**: Express.js + TypeScript
- **数据库**: MySQL + Prisma ORM
- **加密算法**: RSA2、SHA256、AES-256-GCM
- **签名验证**: 微信支付V3签名、支付宝RSA2签名
- **架构模式**: 工厂模式 + 抽象工厂模式

### 2. 安全特性
- **签名验证**: 所有回调请求都进行严格签名验证
- **数据加密**: 敏感数据使用AES加密存储
- **事务保证**: 所有支付操作使用数据库事务
- **幂等性**: 支付回调处理保证幂等性
- **防重放**: 回调请求包含时间戳和随机数验证

### 3. 数据库设计

#### 支付相关数据表
- `orders` - 订单表
- `payment_transactions` - 支付交易记录表
- `refund_records` - 退款记录表
- `inventory_items` - 库存表
- `inventory_logs` - 库存流水表

## 📦 部署配置

### 环境变量配置

#### 微信支付配置
```bash
# 微信支付应用配置
WECHAT_APP_ID=your_wx_app_id
WECHAT_MCH_ID=your_merchant_id
WECHAT_API_V3_KEY=your_api_v3_key
WECHAT_KEY=your_merchant_key

# 微信支付证书配置
WECHAT_API_CLIENT_CERT=-----BEGIN CERTIFICATE-----...
WECHAT_API_CLIENT_KEY=-----BEGIN PRIVATE KEY-----...
WECHAT_API_SERIAL_NO=your_cert_serial_no

# 微信支付回调配置
WECHAT_NOTIFY_URL=https://yourdomain.com/api/v1/payments/wechat/notify
WECHAT_REFUND_NOTIFY_URL=https://yourdomain.com/api/v1/payments/wechat/refund/notify
```

#### 支付宝支付配置
```bash
# 支付宝应用配置
ALIPAY_APP_ID=your_alipay_app_id
ALIPAY_PRIVATE_KEY=-----BEGIN RSA PRIVATE KEY-----...
ALIPAY_PUBLIC_KEY=-----BEGIN PUBLIC KEY-----...

# 支付宝网关配置
ALIPAY_GATEWAY_URL=https://openapi.alipay.com/gateway.do

# 支付宝回调配置
ALIPAY_NOTIFY_URL=https://yourdomain.com/api/v1/payments/alipay/notify
ALIPAY_REFUND_NOTIFY_URL=https://yourdomain.com/api/v1/payments/alipay/refund/notify
ALIPAY_RETURN_URL=https://yourdomain.com/payment/success
```

### 服务器要求
- **Node.js**: >= 16.0.0
- **内存**: >= 2GB
- **存储**: >= 20GB SSD
- **网络**: 稳定的公网访问能力（用于回调通知）

## 🔄 支付流程

### 1. 支付创建流程
```mermaid
sequenceDiagram
    participant 客户端
    participant 商城系统
    participant 支付提供商
    participant 数据库

    客户端->>商城系统: 创建支付订单
    商城系统->>数据库: 创建订单记录
    商城系统->>支付提供商: 调用支付接口
    支付提供商-->>商城系统: 返回支付参数
    商城系统-->>客户端: 返回支付信息
    客户端->>支付提供商: 发起支付
    支付提供商-->>客户端: 展示支付界面
```

### 2. 支付回调流程
```mermaid
sequenceDiagram
    participant 支付提供商
    participant 商城系统
    participant 数据库
    participant 库存系统

    支付提供商->>商城系统: 发送支付回调
    商城系统->>商城系统: 验证签名
    商城系统->>数据库: 开启事务
    商城系统->>数据库: 更新订单状态
    商城系统->>数据库: 创建交易记录
    商城系统->>库存系统: 扣减库存
    商城系统->>数据库: 记录库存流水
    商城系统->>数据库: 提交事务
    商城系统-->>支付提供商: 确认回调
```

### 3. 退款流程
```mermaid
sequenceDiagram
    participant 客户端
    participant 商城系统
    participant 支付提供商
    participant 数据库
    participant 库存系统

    客户端->>商城系统: 申请退款
    商城系统->>数据库: 创建退款记录
    商城系统->>支付提供商: 调用退款接口
    支付提供商-->>商城系统: 退款处理结果
    商城系统-->>客户端: 返回退款结果

    支付提供商->>商城系统: 退款回调通知
    商城系统->>数据库: 更新退款状态
    商城系统->>库存系统: 恢复库存
    商城系统-->>支付提供商: 确认回调
```

## 📊 监控和日志

### 1. 关键指标监控
- 支付成功率
- 支付响应时间
- 回调处理延迟
- 库存同步状态
- 异常交易数量

### 2. 日志记录
- **支付操作日志**: 所有支付相关操作
- **回调处理日志**: 异步回调处理详情
- **错误日志**: 支付异常和失败记录
- **性能日志**: 支付接口响应时间

## 🚀 使用示例

### 1. 创建支付订单
```javascript
// 微信支付示例
const response = await fetch('/api/v1/payments/wechat/create', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    method: 'WECHAT_JSAPI',
    orderId: 'order_123',
    amount: 100.00,
    subject: '商品购买',
    openid: 'user_openid'
  })
});

// 支付宝支付示例
const response = await fetch('/api/v1/payments/alipay/create', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  },
  body: JSON.stringify({
    method: 'ALIPAY_WEB',
    orderId: 'order_123',
    amount: 100.00,
    subject: '商品购买',
    returnUrl: 'https://yourdomain.com/payment/success'
  })
});
```

### 2. 处理支付回调
```javascript
// 微信支付回调处理
router.post('/api/v1/payments/wechat/notify', async (req, res) => {
  try {
    const notifyData = await paymentManager.verifyNotify(req.body, req.headers);

    if (notifyData.orderId) {
      if (notifyData.tradeStatus === 'SUCCESS') {
        await PaymentCallbackHandler.handlePaymentSuccess(notifyData);
      }
      res.json({ code: 'SUCCESS', message: '成功' });
    }
  } catch (error) {
    res.status(500).json({ code: 'FAIL', message: '处理失败' });
  }
});
```

## ⚠️ 注意事项

### 1. 安全考虑
- 所有敏感配置必须使用环境变量
- 支付密钥和证书需要定期更新
- 回调URL必须使用HTTPS
- 需要实现访问频率限制

### 2. 业务考虑
- 支付订单需要设置合理的超时时间
- 库存扣减需要考虑并发安全
- 退款需要考虑业务规则限制
- 需要实现支付金额的二次验证

### 3. 性能优化
- 支付接口响应时间控制在3秒内
- 回调处理需要支持高并发
- 数据库查询需要优化索引
- 可以考虑使用Redis缓存热点数据

## 📞 技术支持

如有技术问题，请联系开发团队：
- **架构设计**: 完成统一支付抽象层
- **接口实现**: 微信支付V3和支付宝开放平台
- **数据一致性**: 数据库事务和幂等性保证
- **安全验证**: 签名验证和数据加密

---

**文档版本**: v1.0.0
**最后更新**: 2025-11-19
**维护人员**: 开发团队