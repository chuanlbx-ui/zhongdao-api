# 微信小程序登录使用指南

## 概述

本文档介绍了中道商城微信小程序登录系统的使用方法、API接口和安全特性。

## 功能特性

- ✅ 真实的微信API集成
- ✅ 自动用户创建和更新
- ✅ JWT Token认证
- ✅ 手机号绑定
- ✅ 多重安全防护
- ✅ 限流保护
- ✅ 防重放攻击

## 快速开始

### 1. 配置微信小程序

在 `.env` 文件中配置你的微信小程序信息：

```env
# 微信小程序配置
WECHAT_APP_ID=wx1ea1b1b0bf6bb19c
WECHAT_APP_SECRET=dd9a1e0b21c0dfb8614071f32bc61ded
WECHAT_LOGIN_TIMEOUT=30000
```

### 2. 小程序端登录流程

```javascript
// 1. 调用wx.login获取code
wx.login({
  success: async (res) => {
    if (res.code) {
      // 2. 获取用户信息（可选）
      const userInfo = await wx.getUserProfile({
        desc: '用于完善用户资料'
      });

      // 3. 发送到后端登录
      const loginRes = await wx.request({
        url: 'https://your-domain.com/api/v1/auth/wechat/login',
        method: 'POST',
        data: {
          code: res.code,
          userInfo: userInfo.userInfo
        }
      });

      if (loginRes.data.success) {
        // 4. 保存token
        wx.setStorageSync('token', loginRes.data.data.tokens.accessToken);
        wx.setStorageSync('refreshToken', loginRes.data.data.tokens.refreshToken);

        // 5. 登录成功
        console.log('登录成功', loginRes.data.data.user);
      }
    }
  }
});
```

## API接口文档

### 1. 微信登录

**接口地址**: `POST /api/v1/auth/wechat/login`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | string | 是 | 微信登录凭证 |
| userInfo | object | 否 | 用户信息 |
| userInfo.nickName | string | 否 | 昵称 |
| userInfo.avatarUrl | string | 否 | 头像URL |
| encryptedData | string | 否 | 加密的用户数据 |
| iv | string | 否 | 初始向量 |
| signature | string | 否 | 数据签名 |

**响应示例**:

```json
{
  "success": true,
  "message": "登录成功",
  "data": {
    "user": {
      "id": "user_1234567890",
      "userNumber": "ZD000001",
      "openid": "ox1234567890abcdef",
      "nickname": "张三",
      "avatarUrl": "https://...",
      "level": "NORMAL",
      "status": "ACTIVE",
      "isNewUser": false
    },
    "tokens": {
      "accessToken": "eyJhbGciOiJIUzI1NiIs...",
      "refreshToken": "eyJhbGciOiJIUzI1NiIs...",
      "expiresIn": "7d"
    },
    "sessionKey": "Abc123...（仅开发环境返回）"
  }
}
```

### 2. 刷新Token

**接口地址**: `POST /api/v1/auth/refresh`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| refreshToken | string | 是 | 刷新令牌 |

**响应示例**:

```json
{
  "success": true,
  "message": "Token刷新成功",
  "data": {
    "user": { ... },
    "tokens": {
      "accessToken": "新的访问令牌",
      "refreshToken": "新的刷新令牌",
      "expiresIn": "7d"
    }
  }
}
```

### 3. 绑定手机号

**接口地址**: `POST /api/v1/auth/wechat/bind-phone`

**请求头**: `Authorization: Bearer <access_token>`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| sessionKey | string | 是 | 微信session_key |
| encryptedData | string | 是 | 加密的手机号数据 |
| iv | string | 是 | 初始向量 |

**小程序端获取手机号**:

```javascript
// 获取手机号
wx.getPhoneNumber({
  success: async (res) => {
    const bindRes = await wx.request({
      url: 'https://your-domain.com/api/v1/auth/wechat/bind-phone',
      method: 'POST',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      },
      data: {
        sessionKey: '从登录接口获取的session_key',
        encryptedData: res.encryptedData,
        iv: res.iv
      }
    });

    if (bindRes.data.success) {
      console.log('手机号绑定成功', bindRes.data.data.phone);
    }
  }
});
```

### 4. 获取用户信息

**接口地址**: `GET /api/v1/auth/wechat/user-info`

**请求头**: `Authorization: Bearer <access_token>`

**响应示例**:

```json
{
  "success": true,
  "message": "获取用户信息成功",
  "data": {
    "id": "user_1234567890",
    "userNumber": "ZD000001",
    "nickname": "张三",
    "avatarUrl": "https://...",
    "phone": "138****8000",
    "level": "NORMAL",
    "status": "ACTIVE",
    "isPhoneBound": true,
    "registeredAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-01-01T00:00:00.000Z"
  }
}
```

## 安全特性

### 1. 限流保护

- 登录接口：5次/15分钟/IP
- 防止暴力破解和恶意攻击

### 2. 防重放攻击

- 验证微信数据水印和时间戳
- 加密数据有效期：5分钟

### 3. 数据验证

- 微信code格式验证
- 用户信息签名验证
- Token有效性检查

### 4. 安全响应头

```http
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
Cache-Control: no-store
```

## 错误码说明

| 错误码 | 说明 | 处理建议 |
|--------|------|----------|
| WECHAT_CONFIG_MISSING | 微信配置缺失 | 检查服务器配置 |
| INVALID_CODE | 授权码无效 | 重新调用wx.login |
| RATE_LIMIT_EXCEEDED | 请求过于频繁 | 稍后重试 |
| USER_INACTIVE | 用户状态异常 | 联系客服 |
| INVALID_REFRESH_TOKEN | 刷新令牌无效 | 重新登录 |
| DECRYPT_FAILED | 解密失败 | 检查参数格式 |

## 测试方法

### 1. 运行测试脚本

```bash
# 确保服务器运行
npm run dev

# 运行微信登录测试
node test-wechat-login.js
```

### 2. 运行单元测试

```bash
# 运行所有测试
npm test

# 只运行微信认证测试
npm test tests/api/wechat-auth.test.ts
```

### 3. 查看服务状态

```bash
# 检查微信认证服务
curl http://localhost:3000/api/v1/auth/wechat/health

# 检查登录指引
curl http://localhost:3000/api/v1/auth/wechat/qr
```

## 常见问题

### Q1: 登录返回"微信授权码无效"

**原因**:
- code已过期（5分钟有效期）
- code已被使用
- appid或appsecret配置错误

**解决**:
- 重新调用wx.login获取新code
- 检查服务器配置

### Q2: 无法解密用户信息

**原因**:
- session_key已过期
- encryptedData或iv格式错误
- 不是同一用户的session_key

**解决**:
- 使用最新登录的session_key
- 确保数据格式正确

### Q3: 登录被限制

**原因**:
- 触发限流保护
- IP被标记为可疑

**解决**:
- 等待15分钟后重试
- 使用正常的小程序环境

### Q4: Token刷新失败

**原因**:
- refreshToken已过期
- 用户状态异常

**解决**:
- 重新登录获取新token

## 最佳实践

1. **Token管理**
   - 定期刷新accessToken
   - 安全存储refreshToken
   - 处理token过期场景

2. **错误处理**
   - 友好提示用户
   - 记录错误日志
   - 实现重试机制

3. **性能优化**
   - 缓存用户信息
   - 减少不必要的登录
   - 使用CDN加速头像

4. **安全建议**
   - 使用HTTPS
   - 验证请求来源
   - 监控异常登录

## 更新日志

- **2024-01-10**: 初始版本，支持基础登录功能
- **2024-01-11**: 添加手机号绑定功能
- **2024-01-12**: 增强安全特性，添加限流保护
- **2024-01-13**: 完善错误处理和日志记录