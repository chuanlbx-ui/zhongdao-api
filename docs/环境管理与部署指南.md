# ä¸­é“å•†åŸç³»ç»Ÿ - ç¯å¢ƒç®¡ç†ä¸éƒ¨ç½²æŒ‡å—

**æ–‡æ¡£ç›®çš„**ï¼šæä¾›æœ¬åœ°å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒçš„å¹³æ»‘åˆ‡æ¢æ–¹æ¡ˆ
**é€‚ç”¨äººå‘˜**ï¼šå¼€å‘äººå‘˜ã€è¿ç»´äººå‘˜ã€AIåä½œè€…
**æœ€åæ›´æ–°**ï¼š2025å¹´11æœˆ18æ—¥
**ç‰ˆæœ¬**ï¼š1.0

---

## ğŸ¯ ç¯å¢ƒä½“ç³»æ¦‚è§ˆ

### ç¯å¢ƒåˆ†ç±»

```
å¼€å‘ç¯å¢ƒä½“ç³»
â”œâ”€â”€ æœ¬åœ°å¼€å‘ç¯å¢ƒ (development)
â”‚   â”œâ”€ å¼€å‘è€…æœ¬åœ°æœºå™¨
â”‚   â”œâ”€ Docker Compose
â”‚   â””â”€ çƒ­é‡è½½ + è°ƒè¯•
â”‚
â”œâ”€â”€ æµ‹è¯•ç¯å¢ƒ (testing)
â”‚   â”œâ”€ äº‘æœåŠ¡å™¨æµ‹è¯•
â”‚   â”œâ”€ æ¨¡æ‹Ÿç”Ÿäº§æ•°æ®
â”‚   â””â”€ è‡ªåŠ¨åŒ–æµ‹è¯•
â”‚
â”œâ”€â”€ é¢„å‘å¸ƒç¯å¢ƒ (staging)
â”‚   â”œâ”€ ç”Ÿäº§ç¯å¢ƒé•œåƒ
â”‚   â”œâ”€ çœŸå®æ•°æ®è„±æ•
â”‚   â””â”€ æœ€ç»ˆéªŒè¯
â”‚
â””â”€â”€ ç”Ÿäº§ç¯å¢ƒ (production)
    â”œâ”€ äº‘æœåŠ¡å™¨é›†ç¾¤
    â”œâ”€ çœŸå®ä¸šåŠ¡æ•°æ®
    â””â”€ ç›‘æ§å‘Šè­¦
```

### ç¯å¢ƒé…ç½®ç­–ç•¥

| ç¯å¢ƒ | é…ç½®æ–‡ä»¶ | æ•°æ®åº“ | åŸŸå | ç”¨é€” |
|-----|---------|--------|------|------|
| development | .env.development | æœ¬åœ°MySQL | localhost:3000 | æ—¥å¸¸å¼€å‘è°ƒè¯• |
| testing | .env.testing | æµ‹è¯•æ•°æ®åº“ | test-api.zhongdao.com | è‡ªåŠ¨åŒ–æµ‹è¯• |
| staging | .env.staging | é¢„å‘å¸ƒæ•°æ®åº“ | staging-api.zhongdao.com | ä¸Šçº¿å‰éªŒè¯ |
| production | .env.production | ç”Ÿäº§æ•°æ®åº“ | api.zhongdao.com | æ­£å¼è¿è¡Œ |

---

## ğŸ› ï¸ æœ¬åœ°å¼€å‘ç¯å¢ƒé…ç½®

### 1. ç¯å¢ƒå‡†å¤‡

#### ç³»ç»Ÿè¦æ±‚
```bash
# åŸºç¡€ç¯å¢ƒ
Node.js >= 18.0.0
Docker >= 20.0.0
Docker Compose >= 2.0.0
Git >= 2.30.0

# å¼€å‘å·¥å…·
VS Code + æ¨èæ‰©å±•
Postman/Insomnia (APIæµ‹è¯•)
MySQL Workbench (æ•°æ®åº“ç®¡ç†)
```

#### å¿«é€Ÿå¯åŠ¨è„šæœ¬
```bash
#!/bin/bash
# scripts/dev-setup.sh

echo "ğŸš€ å¼€å§‹é…ç½®ä¸­é“å•†åŸå¼€å‘ç¯å¢ƒ..."

# 1. æ£€æŸ¥ç¯å¢ƒ
check_environment() {
    echo "ğŸ“‹ æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ..."

    if ! command -v node &> /dev/null; then
        echo "âŒ Node.js æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Node.js >= 18.0.0"
        exit 1
    fi

    if ! command -v docker &> /dev/null; then
        echo "âŒ Docker æœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£… Docker"
        exit 1
    fi

    echo "âœ… ç¯å¢ƒæ£€æŸ¥é€šè¿‡"
}

# 2. åˆå§‹åŒ–é¡¹ç›®
init_project() {
    echo "ğŸ“¦ åˆå§‹åŒ–é¡¹ç›®..."

    # å¤åˆ¶ç¯å¢ƒé…ç½®
    if [ ! -f .env.development ]; then
        cp .env.example .env.development
        echo "ğŸ“ å·²åˆ›å»º .env.development æ–‡ä»¶ï¼Œè¯·æ ¹æ®éœ€è¦ä¿®æ”¹"
    fi

    # å®‰è£…ä¾èµ–
    npm install

    # ç”ŸæˆPrismaå®¢æˆ·ç«¯
    npx prisma generate

    echo "âœ… é¡¹ç›®åˆå§‹åŒ–å®Œæˆ"
}

# 3. å¯åŠ¨æ•°æ®åº“
start_database() {
    echo "ğŸ—„ï¸ å¯åŠ¨æ•°æ®åº“æœåŠ¡..."

    docker-compose -f docker-compose.dev.yml up -d mysql redis

    # ç­‰å¾…æ•°æ®åº“å¯åŠ¨
    echo "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
    sleep 10

    # è¿è¡Œæ•°æ®åº“è¿ç§»
    npx prisma migrate dev --name init

    echo "âœ… æ•°æ®åº“å¯åŠ¨å®Œæˆ"
}

# 4. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
start_dev_server() {
    echo "ğŸŒŸ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."

    npm run dev
}

# æ‰§è¡Œæµç¨‹
check_environment
init_project
start_database
start_dev_server
```

### 2. Dockerå¼€å‘é…ç½®

#### docker-compose.dev.yml
```yaml
version: '3.8'

services:
  # å¼€å‘æ•°æ®åº“
  mysql-dev:
    image: mysql:8.0
    container_name: zhongdao-mysql-dev
    environment:
      MYSQL_ROOT_PASSWORD: dev_password_123
      MYSQL_DATABASE: zhongdao_mall_dev
      MYSQL_USER: dev_user
      MYSQL_PASSWORD: dev_password_123
    ports:
      - "3307:3306"  # ä½¿ç”¨ä¸åŒç«¯å£é¿å…å†²çª
    volumes:
      - mysql_dev_data:/var/lib/mysql
      - ./database/init:/docker-entrypoint-initdb.d
    networks:
      - zhongdao-network

  # å¼€å‘Redis
  redis-dev:
    image: redis:7-alpine
    container_name: zhongdao-redis-dev
    ports:
      - "6380:6379"
    volumes:
      - redis_dev_data:/data
    networks:
      - zhongdao-network

  # å¼€å‘ç®¡ç†å·¥å…·
  adminer:
    image: adminer
    container_name: zhongdao-adminer-dev
    ports:
      - "8080:8080"
    depends_on:
      - mysql-dev
    networks:
      - zhongdao-network

volumes:
  mysql_dev_data:
  redis_dev_data:

networks:
  zhongdao-network:
    driver: bridge
```

### 3. ç¯å¢ƒå˜é‡é…ç½®

#### .env.development
```bash
# å¼€å‘ç¯å¢ƒé…ç½®
NODE_ENV=development
PORT=3000
DEBUG=true

# æ•°æ®åº“é…ç½®
DATABASE_URL="mysql://dev_user:dev_password_123@localhost:3307/zhongdao_mall_dev"
DB_HOST=localhost
DB_PORT=3307
DB_USER=dev_user
DB_PASSWORD=dev_password_123
DB_NAME=zhongdao_mall_dev

# Redisé…ç½®
REDIS_URL="redis://localhost:6380"
REDIS_HOST=localhost
REDIS_PORT=6380

# JWTé…ç½®
JWT_SECRET="dev_super_secret_key_change_in_production"
JWT_EXPIRES_IN="7d"

# å¾®ä¿¡å°ç¨‹åºé…ç½®ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
WECHAT_APP_ID="dev_wechat_app_id"
WECHAT_APP_SECRET="dev_wechat_app_secret"

# æ—¥å¿—é…ç½®
LOG_LEVEL="debug"
LOG_FILE="./logs/app-dev.log"

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_PATH="./uploads/dev"
MAX_FILE_SIZE=10485760

# æ”¯ä»˜é…ç½®ï¼ˆæ²™ç›’ç¯å¢ƒï¼‰
WECHAT_PAY_MERCHANT_ID="dev_merchant_id"
WECHAT_PAY_API_KEY="dev_api_key"
WECHAT_PAY_CERT_PATH="./certs/dev/wechat_cert.pem"

# é‚®ä»¶é…ç½®ï¼ˆå¼€å‘ç¯å¢ƒä½¿ç”¨æµ‹è¯•é‚®ç®±ï¼‰
SMTP_HOST="smtp.mailtrap.io"
SMTP_PORT=2525
SMTP_USER="dev_user"
SMTP_PASS="dev_pass"

# å¼€å‘ä¸“ç”¨é…ç½®
ENABLE_CORS=true
ENABLE_SWAGGER=true
ENABLE_MOCK_DATA=true
```

### 4. å¼€å‘å·¥ä½œæµ

#### npm scripts é…ç½®
```json
{
  "scripts": {
    "dev": "nodemon src/app.ts",
    "dev:debug": "nodemon --inspect src/app.ts",
    "dev:docker": "docker-compose -f docker-compose.dev.yml up",
    "dev:down": "docker-compose -f docker-compose.dev.yml down",
    "db:reset": "npx prisma migrate reset",
    "db:studio": "npx prisma studio --browser none",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "lint:fix": "eslint src --fix",
    "type-check": "tsc --noEmit"
  }
}
```

#### å¼€å‘è°ƒè¯•é…ç½®
```json
// .vscode/launch.json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Debug API Server",
      "type": "node",
      "request": "launch",
      "program": "${workspaceFolder}/src/app.ts",
      "outFiles": ["${workspaceFolder}/dist/**/*.js"],
      "env": {
        "NODE_ENV": "development"
      },
      "runtimeArgs": ["-r", "ts-node/register"],
      "console": "integratedTerminal",
      "restart": true,
      "protocol": "inspector"
    }
  ]
}
```

---

## ğŸ”„ ç¯å¢ƒåˆ‡æ¢æœºåˆ¶

### 1. ç¯å¢ƒæ£€æµ‹ä¸è‡ªåŠ¨åˆ‡æ¢

#### ç¯å¢ƒæ£€æµ‹è„šæœ¬
```typescript
// src/config/environment.ts
export class EnvironmentManager {
  private static instance: EnvironmentManager;
  private currentEnv: string;

  constructor() {
    this.currentEnv = this.detectEnvironment();
    this.loadEnvironmentConfig();
  }

  private detectEnvironment(): string {
    const nodeEnv = process.env.NODE_ENV;

    if (nodeEnv) {
      return nodeEnv;
    }

    // æ ¹æ®åŸŸåè‡ªåŠ¨æ£€æµ‹
    const hostname = require('os').hostname();

    if (hostname.includes('prod') || hostname.includes('server')) {
      return 'production';
    } else if (hostname.includes('test') || hostname.includes('staging')) {
      return 'staging';
    } else {
      return 'development';
    }
  }

  private loadEnvironmentConfig(): void {
    const envFile = `.env.${this.currentEnv}`;

    if (require('fs').existsSync(envFile)) {
      require('dotenv').config({ path: envFile });
      console.log(`ğŸŒ å·²åŠ è½½ç¯å¢ƒé…ç½®: ${envFile}`);
    } else {
      console.warn(`âš ï¸ ç¯å¢ƒé…ç½®æ–‡ä»¶ä¸å­˜åœ¨: ${envFile}`);
    }
  }

  public getCurrentEnvironment(): string {
    return this.currentEnv;
  }

  public isDevelopment(): boolean {
    return this.currentEnv === 'development';
  }

  public isProduction(): boolean {
    return this.currentEnv === 'production';
  }

  public getDatabaseConfig(): DatabaseConfig {
    return {
      host: process.env.DB_HOST || 'localhost',
      port: parseInt(process.env.DB_PORT || '3306'),
      username: process.env.DB_USER || 'root',
      password: process.env.DB_PASSWORD || '',
      database: process.env.DB_NAME || 'zhongdao_mall',
      ssl: this.isProduction() ? { rejectUnauthorized: false } : false
    };
  }
}

// å…¨å±€ç¯å¢ƒç®¡ç†å™¨å®ä¾‹
export const env = EnvironmentManager.getInstance();
```

### 2. æ•°æ®åº“ç¯å¢ƒåˆ‡æ¢

#### æ•°æ®åº“é…ç½®ç®¡ç†
```typescript
// src/config/database.ts
export class DatabaseManager {
  private prisma: PrismaClient;

  constructor() {
    this.prisma = new PrismaClient({
      datasources: {
        db: {
          url: env.getDatabaseUrl()
        }
      },
      log: env.isDevelopment() ? ['query', 'info', 'warn', 'error'] : ['error']
    });
  }

  async connect(): Promise<void> {
    try {
      await this.prisma.$connect();
      console.log(`âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ [${env.getCurrentEnvironment()}]`);

      if (env.isDevelopment()) {
        await this.runHealthCheck();
      }
    } catch (error) {
      console.error('âŒ æ•°æ®åº“è¿æ¥å¤±è´¥:', error);
      process.exit(1);
    }
  }

  private async runHealthCheck(): Promise<void> {
    try {
      const result = await this.prisma.$queryRaw`SELECT 1 as health_check`;
      console.log('ğŸ’“ æ•°æ®åº“å¥åº·æ£€æŸ¥é€šè¿‡');
    } catch (error) {
      console.error('ğŸ’” æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥:', error);
    }
  }

  getClient(): PrismaClient {
    return this.prisma;
  }

  async disconnect(): Promise<void> {
    await this.prisma.$disconnect();
  }
}
```

#### æ•°æ®åº“è¿ç§»ç®¡ç†
```bash
#!/bin/bash
# scripts/migrate.sh

ENVIRONMENT=${1:-development}
ACTION=${2:-up}

echo "ğŸ”„ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
echo "ç¯å¢ƒ: $ENVIRONMENT"
echo "æ“ä½œ: $ACTION"

# åŠ è½½å¯¹åº”ç¯å¢ƒé…ç½®
export NODE_ENV=$ENVIRONMENT

case $ACTION in
  "up")
    echo "ğŸ“ˆ æ‰§è¡Œè¿ç§»..."
    npx prisma migrate deploy
    ;;
  "down")
    echo "ğŸ“‰ å›æ»šè¿ç§»..."
    npx prisma migrate reset
    ;;
  "reset")
    echo "ğŸ”„ é‡ç½®æ•°æ®åº“..."
    npx prisma migrate reset --force
    ;;
  "studio")
    echo "ğŸ¨ å¯åŠ¨ Prisma Studio..."
    npx prisma studio
    ;;
  *)
    echo "âŒ æœªçŸ¥æ“ä½œ: $ACTION"
    echo "å¯ç”¨æ“ä½œ: up, down, reset, studio"
    exit 1
    ;;
esac

echo "âœ… æ•°æ®åº“æ“ä½œå®Œæˆ"
```

### 3. ç¼“å­˜ç¯å¢ƒåˆ‡æ¢

#### Redisé…ç½®ç®¡ç†
```typescript
// src/config/redis.ts
export class RedisManager {
  private client: Redis;

  constructor() {
    const config = env.getRedisConfig();

    this.client = new Redis({
      host: config.host,
      port: config.port,
      password: config.password,
      db: config.db,
      retryDelayOnFailover: 100,
      maxRetriesPerRequest: 3,
      lazyConnect: true
    });

    this.setupEventHandlers();
  }

  private setupEventHandlers(): void {
    this.client.on('connect', () => {
      console.log(`ğŸ”— Redisè¿æ¥æˆåŠŸ [${env.getCurrentEnvironment()}]`);
    });

    this.client.on('error', (error) => {
      console.error('âŒ Redisè¿æ¥é”™è¯¯:', error);
    });

    this.client.on('close', () => {
      console.log('ğŸ”Œ Redisè¿æ¥å…³é—­');
    });
  }

  async connect(): Promise<void> {
    try {
      await this.client.connect();

      if (env.isDevelopment()) {
        await this.ping();
      }
    } catch (error) {
      console.error('âŒ Redisè¿æ¥å¤±è´¥:', error);
    }
  }

  private async ping(): Promise<void> {
    const result = await this.client.ping();
    console.log('ğŸ’“ Rediså¥åº·æ£€æŸ¥:', result);
  }

  getClient(): Redis {
    return this.client;
  }
}
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹ä¸ç¯å¢ƒåˆ‡æ¢

### 1. è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

#### deploy.sh
```bash
#!/bin/bash
# scripts/deploy.sh

ENVIRONMENT=${1:-staging}
VERSION=${2:-latest}

echo "ğŸš€ å¼€å§‹éƒ¨ç½²ä¸­é“å•†åŸç³»ç»Ÿ..."
echo "ç¯å¢ƒ: $ENVIRONMENT"
echo "ç‰ˆæœ¬: $VERSION"

# 1. ç¯å¢ƒéªŒè¯
validate_environment() {
    echo "ğŸ” éªŒè¯éƒ¨ç½²ç¯å¢ƒ..."

    if [[ ! "$ENVIRONMENT" =~ ^(development|testing|staging|production)$ ]]; then
        echo "âŒ æ— æ•ˆçš„ç¯å¢ƒ: $ENVIRONMENT"
        exit 1
    fi

    if [[ "$ENVIRONMENT" == "production" ]]; then
        read -p "âš ï¸ ç¡®è®¤è¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå—ï¼Ÿ(y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "âŒ éƒ¨ç½²å·²å–æ¶ˆ"
            exit 1
        fi
    fi

    echo "âœ… ç¯å¢ƒéªŒè¯é€šè¿‡"
}

# 2. ä»£ç æ„å»º
build_application() {
    echo "ğŸ”¨ æ„å»ºåº”ç”¨ç¨‹åº..."

    # å®‰è£…ä¾èµ–
    npm ci --production=false

    # æ„å»ºTypeScript
    npm run build

    # è¿è¡Œæµ‹è¯•
    npm run test

    echo "âœ… åº”ç”¨æ„å»ºå®Œæˆ"
}

# 3. æ•°æ®åº“è¿ç§»
migrate_database() {
    echo "ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."

    export NODE_ENV=$ENVIRONMENT

    # å¤‡ä»½ç”Ÿäº§æ•°æ®åº“ï¼ˆä»…åœ¨éå¼€å‘ç¯å¢ƒï¼‰
    if [[ "$ENVIRONMENT" != "development" ]]; then
        ./scripts/backup-database.sh $ENVIRONMENT
    fi

    # æ‰§è¡Œè¿ç§»
    npx prisma migrate deploy

    echo "âœ… æ•°æ®åº“è¿ç§»å®Œæˆ"
}

# 4. éƒ¨ç½²åº”ç”¨
deploy_application() {
    echo "ğŸ“¦ éƒ¨ç½²åº”ç”¨ç¨‹åº..."

    case $ENVIRONMENT in
        "development")
            docker-compose -f docker-compose.dev.yml up -d --build
            ;;
        "testing"|"staging")
            docker-compose -f docker-compose.staging.yml up -d --build
            ;;
        "production")
            docker-compose -f docker-compose.prod.yml up -d --build
            ;;
    esac

    echo "âœ… åº”ç”¨éƒ¨ç½²å®Œæˆ"
}

# 5. å¥åº·æ£€æŸ¥
health_check() {
    echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."

    local max_attempts=30
    local attempt=1

    while [ $attempt -le $max_attempts ]; do
        if curl -f http://localhost:3000/health > /dev/null 2>&1; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            return 0
        fi

        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($attempt/$max_attempts)"
        sleep 10
        ((attempt++))
    done

    echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
    return 1
}

# 6. éƒ¨ç½²åé€šçŸ¥
notify_deployment() {
    echo "ğŸ“¢ å‘é€éƒ¨ç½²é€šçŸ¥..."

    local status=$1
    local message="éƒ¨ç½² $ENVIRONMENT ç¯å¢ƒ $status"

    # å‘é€åˆ°ä¼ä¸šå¾®ä¿¡/é’‰é’‰ç­‰
    # send_notification "$message"

    echo "âœ… é€šçŸ¥å‘é€å®Œæˆ: $message"
}

# æ‰§è¡Œéƒ¨ç½²æµç¨‹
main() {
    validate_environment

    if build_application; then
        if migrate_database; then
            if deploy_application; then
                if health_check; then
                    notify_deployment "æˆåŠŸ"
                    echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
                else
                    notify_deployment "å¤±è´¥ï¼ˆå¥åº·æ£€æŸ¥æœªé€šè¿‡ï¼‰"
                    exit 1
                fi
            else
                notify_deployment "å¤±è´¥ï¼ˆéƒ¨ç½²é”™è¯¯ï¼‰"
                exit 1
            fi
        else
            notify_deployment "å¤±è´¥ï¼ˆæ•°æ®åº“è¿ç§»é”™è¯¯ï¼‰"
            exit 1
        fi
    else
        notify_deployment "å¤±è´¥ï¼ˆæ„å»ºé”™è¯¯ï¼‰"
        exit 1
    fi
}

main
```

### 2. Dockerå¤šç¯å¢ƒé…ç½®

#### docker-compose.staging.yml
```yaml
version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.staging
    container_name: zhongdao-api-staging
    environment:
      - NODE_ENV=staging
    ports:
      - "3001:3000"
    depends_on:
      - mysql-staging
      - redis-staging
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    networks:
      - zhongdao-staging

  mysql-staging:
    image: mysql:8.0
    container_name: zhongdao-mysql-staging
    environment:
      MYSQL_ROOT_PASSWORD: ${STAGING_DB_PASSWORD}
      MYSQL_DATABASE: zhongdao_mall_staging
    volumes:
      - mysql_staging_data:/var/lib/mysql
      - ./backups:/backups
    networks:
      - zhongdao-staging

  redis-staging:
    image: redis:7-alpine
    container_name: zhongdao-redis-staging
    volumes:
      - redis_staging_data:/data
    networks:
      - zhongdao-staging

  nginx-staging:
    image: nginx:alpine
    container_name: zhongdao-nginx-staging
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.staging.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - api
    networks:
      - zhongdao-staging

volumes:
  mysql_staging_data:
  redis_staging_data:

networks:
  zhongdao-staging:
    driver: bridge
```

#### docker-compose.prod.yml
```yaml
version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: zhongdao-api-prod
    environment:
      - NODE_ENV=production
    ports:
      - "3000:3000"
    depends_on:
      - mysql-prod
      - redis-prod
    volumes:
      - ./logs:/app/logs
      - ./uploads:/app/uploads
    networks:
      - zhongdao-prod
    restart: unless-stopped

  mysql-prod:
    image: mysql:8.0
    container_name: zhongdao-mysql-prod
    environment:
      MYSQL_ROOT_PASSWORD: ${PROD_DB_PASSWORD}
      MYSQL_DATABASE: zhongdao_mall_prod
    volumes:
      - mysql_prod_data:/var/lib/mysql
      - ./backups:/backups
    networks:
      - zhongdao-prod
    restart: unless-stopped

  redis-prod:
    image: redis:7-alpine
    container_name: zhongdao-redis-prod
    volumes:
      - redis_prod_data:/data
    networks:
      - zhongdao-prod
    restart: unless-stopped

  nginx-prod:
    image: nginx:alpine
    container_name: zhongdao-nginx-prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - api
    networks:
      - zhongdao-prod
    restart: unless-stopped

volumes:
  mysql_prod_data:
  redis_prod_data:

networks:
  zhongdao-prod:
    driver: bridge
```

### 3. ç¯å¢ƒç›‘æ§ä¸åˆ‡æ¢

#### ç¯å¢ƒç›‘æ§è„šæœ¬
```typescript
// src/monitoring/environment-monitor.ts
export class EnvironmentMonitor {
  private healthCheckInterval: NodeJS.Timeout;

  constructor() {
    this.startHealthCheck();
  }

  private startHealthCheck(): void {
    this.healthCheckInterval = setInterval(async () => {
      await this.performHealthCheck();
    }, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
  }

  private async performHealthCheck(): Promise<void> {
    const checks = [
      this.checkDatabase(),
      this.checkRedis(),
      this.checkExternalServices(),
      this.checkDiskSpace(),
      this.checkMemoryUsage()
    ];

    const results = await Promise.allSettled(checks);

    const failedChecks = results.filter(result =>
      result.status === 'rejected'
    );

    if (failedChecks.length > 0) {
      console.error('âŒ å¥åº·æ£€æŸ¥å¤±è´¥:', failedChecks);
      await this.alertHealthCheckFailure(failedChecks);
    }
  }

  private async checkDatabase(): Promise<void> {
    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
  }

  private async checkRedis(): Promise<void> {
    // æ£€æŸ¥Redisè¿æ¥
  }

  private async checkExternalServices(): Promise<void> {
    // æ£€æŸ¥å¤–éƒ¨æœåŠ¡ï¼ˆå¾®ä¿¡APIã€æ”¯ä»˜æ¥å£ç­‰ï¼‰
  }

  private async checkDiskSpace(): Promise<void> {
    // æ£€æŸ¥ç£ç›˜ç©ºé—´
  }

  private async checkMemoryUsage(): Promise<void> {
    // æ£€æŸ¥å†…å­˜ä½¿ç”¨
  }

  private async alertHealthCheckFailure(failures: any[]): Promise<void> {
    // å‘é€å‘Šè­¦é€šçŸ¥
  }

  public stop(): void {
    if (this.healthCheckInterval) {
      clearInterval(this.healthCheckInterval);
    }
  }
}
```

---

## ğŸ”„ æ•°æ®åŒæ­¥ä¸è¿ç§»

### 1. æ•°æ®åº“åŒæ­¥ç­–ç•¥

#### å¼€å‘ç¯å¢ƒæ•°æ®åŒæ­¥
```bash
#!/bin/bash
# scripts/sync-database.sh

SOURCE_ENV=${1:-production}
TARGET_ENV=${2:-development}

echo "ğŸ”„ åŒæ­¥æ•°æ®åº“æ•°æ®..."
echo "æºç¯å¢ƒ: $SOURCE_ENV"
echo "ç›®æ ‡ç¯å¢ƒ: $TARGET_ENV"

# 1. å¤‡ä»½æºæ•°æ®åº“
echo "ğŸ“¦ å¤‡ä»½æºæ•°æ®åº“..."
mysqldump -h $SOURCE_DB_HOST -u $SOURCE_DB_USER -p$SOURCE_DB_PASS \
  $SOURCE_DB_NAME > backups/backup_$(date +%Y%m%d_%H%M%S).sql

# 2. è„±æ•å¤„ç†
echo "ğŸ”’ æ‰§è¡Œæ•°æ®è„±æ•..."
node scripts/anonymize-data.js backups/backup_latest.sql

# 3. å¯¼å…¥ç›®æ ‡æ•°æ®åº“
echo "ğŸ“¥ å¯¼å…¥ç›®æ ‡æ•°æ®åº“..."
mysql -h $TARGET_DB_HOST -u $TARGET_DB_USER -p$TARGET_DB_PASS \
  $TARGET_DB_NAME < backups/backup_anonymized.sql

echo "âœ… æ•°æ®åŒæ­¥å®Œæˆ"
```

#### æ•°æ®è„±æ•è„šæœ¬
```javascript
// scripts/anonymize-data.js
const fs = require('fs');

function anonymizeSQL(sqlContent) {
  // è„±æ•æ‰‹æœºå·
  sqlContent = sqlContent.replace(
    /(\b1[3-9]\d{9})\b/g,
    match => match.substring(0, 3) + '****' + match.substring(7)
  );

  // è„±æ•é‚®ç®±
  sqlContent = sqlContent.replace(
    /([a-zA-Z0-9._%+-]+)@([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,
    '****@$2'
  );

  // è„±æ•çœŸå®å§“å
  sqlContent = sqlContent.replace(
    /çœŸå®å§“å\s*=\s*'([^']+)'/g,
    "çœŸå®å§“å = 'ç”¨æˆ·****'"
  );

  // è„±æ•èº«ä»½è¯å·
  sqlContent = sqlContent.replace(
    /(\b\d{17}[\dXx]\b)/g,
    match => match.substring(0, 6) + '********' + match.substring(14)
  );

  return sqlContent;
}

// æ‰§è¡Œè„±æ•
const inputFile = process.argv[2];
const outputFile = inputFile.replace('.sql', '_anonymized.sql');

const sqlContent = fs.readFileSync(inputFile, 'utf8');
const anonymizedContent = anonymizeSQL(sqlContent);

fs.writeFileSync(outputFile, anonymizedContent);
console.log('âœ… æ•°æ®è„±æ•å®Œæˆ:', outputFile);
```

### 2. é…ç½®æ–‡ä»¶åŒæ­¥

#### ç¯å¢ƒé…ç½®åŒæ­¥è„šæœ¬
```bash
#!/bin/bash
# scripts/sync-config.sh

SYNC_DIRECTION=${1:-up}  # up: ç”Ÿäº§->å¼€å‘, down: å¼€å‘->ç”Ÿäº§
CONFIG_FILES=(
  "nginx.conf"
  "docker-compose.yml"
  "env.template"
)

echo "ğŸ”„ åŒæ­¥é…ç½®æ–‡ä»¶..."
echo "æ–¹å‘: $SYNC_DIRECTION"

for file in "${CONFIG_FILES[@]}"; do
    if [[ "$SYNC_DIRECTION" == "up" ]]; then
        # ç”Ÿäº§åˆ°å¼€å‘
        if [[ -f "production/$file" ]]; then
            cp production/$file development/
            echo "âœ… å·²åŒæ­¥: production/$file â†’ development/$file"
        fi
    else
        # å¼€å‘åˆ°ç”Ÿäº§
        if [[ -f "development/$file" ]]; then
            cp development/$file production/
            echo "âœ… å·²åŒæ­¥: development/$file â†’ production/$file"
        fi
    fi
done

echo "ğŸ‰ é…ç½®åŒæ­¥å®Œæˆ"
```

---

## ğŸ› ï¸ å¼€å‘å·¥å…·ä¸å·¥ä½œæµ

### 1. ç¯å¢ƒåˆ‡æ¢å·¥å…·

#### CLIå·¥å…·
```typescript
// tools/env-cli.ts
#!/usr/bin/env node

import { Command } from 'commander';
import { execSync } from 'child_process';

const program = new Command();

program
  .name('env-cli')
  .description('ä¸­é“å•†åŸç¯å¢ƒç®¡ç†å·¥å…·')
  .version('1.0.0');

program
  .command('switch')
  .description('åˆ‡æ¢ç¯å¢ƒ')
  .argument('<environment>', 'ç›®æ ‡ç¯å¢ƒ (development|testing|staging|production)')
  .action((environment) => {
    console.log(`ğŸ”„ åˆ‡æ¢åˆ°ç¯å¢ƒ: ${environment}`);

    // 1. å¤‡ä»½å½“å‰ç¯å¢ƒ
    execSync('./scripts/backup-current.sh', { stdio: 'inherit' });

    // 2. åˆ‡æ¢ç¯å¢ƒé…ç½®
    process.env.NODE_ENV = environment;

    // 3. é‡å¯æœåŠ¡
    execSync(`./scripts/restart-services.sh ${environment}`, { stdio: 'inherit' });

    // 4. å¥åº·æ£€æŸ¥
    execSync('./scripts/health-check.sh', { stdio: 'inherit' });

    console.log(`âœ… ç¯å¢ƒåˆ‡æ¢å®Œæˆ: ${environment}`);
  });

program
  .command('status')
  .description('æŸ¥çœ‹ç¯å¢ƒçŠ¶æ€')
  .action(() => {
    console.log('ğŸ“Š å½“å‰ç¯å¢ƒçŠ¶æ€:');

    const currentEnv = process.env.NODE_ENV || 'development';
    console.log(`ç¯å¢ƒ: ${currentEnv}`);

    // æ£€æŸ¥æœåŠ¡çŠ¶æ€
    execSync('docker-compose ps', { stdio: 'inherit' });

    // æ£€æŸ¥å¥åº·çŠ¶æ€
    execSync('curl -s http://localhost:3000/health || echo "âŒ æœåŠ¡æœªè¿è¡Œ"', { stdio: 'inherit' });
  });

program
  .command('sync')
  .description('åŒæ­¥æ•°æ®æˆ–é…ç½®')
  .argument('<type>', 'åŒæ­¥ç±»å‹ (data|config)')
  .argument('<source>', 'æºç¯å¢ƒ')
  .argument('<target>', 'ç›®æ ‡ç¯å¢ƒ')
  .action((type, source, target) => {
    if (type === 'data') {
      execSync(`./scripts/sync-database.sh ${source} ${target}`, { stdio: 'inherit' });
    } else if (type === 'config') {
      execSync(`./scripts/sync-config.sh ${source} ${target}`, { stdio: 'inherit' });
    }
  });

program.parse();
```

### 2. å¼€å‘å·¥ä½œæµ

#### Gitå·¥ä½œæµé›†æˆ
```bash
#!/bin/bash
# .git/hooks/pre-push

echo "ğŸ” æ¨é€å‰æ£€æŸ¥..."

# 1. è¿è¡Œæµ‹è¯•
echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
npm test

if [ $? -ne 0 ]; then
    echo "âŒ æµ‹è¯•å¤±è´¥ï¼Œç¦æ­¢æ¨é€"
    exit 1
fi

# 2. æ£€æŸ¥ä»£ç è´¨é‡
echo "ğŸ“ æ£€æŸ¥ä»£ç è´¨é‡..."
npm run lint

if [ $? -ne 0 ]; then
    echo "âŒ ä»£ç è´¨é‡æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
    exit 1
fi

# 3. ç¯å¢ƒä¸€è‡´æ€§æ£€æŸ¥
echo "ğŸŒ æ£€æŸ¥ç¯å¢ƒé…ç½®..."
if [ ! -f ".env.${NODE_ENV}" ]; then
    echo "âŒ ç¯å¢ƒé…ç½®æ–‡ä»¶ä¸å­˜åœ¨: .env.${NODE_ENV}"
    exit 1
fi

# 4. æ•°æ®åº“è¿ç§»æ£€æŸ¥
echo "ğŸ—„ï¸ æ£€æŸ¥æ•°æ®åº“è¿ç§»..."
npx prisma migrate deploy

echo "âœ… æ¨é€å‰æ£€æŸ¥é€šè¿‡"
```

---

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. ç¯å¢ƒç®¡ç†æœ€ä½³å®è·µ

- âœ… **ä½¿ç”¨ç¯å¢ƒå˜é‡**ï¼šæ‰€æœ‰é…ç½®é€šè¿‡ç¯å¢ƒå˜é‡ç®¡ç†
- âœ… **é…ç½®æ–‡ä»¶åˆ†ç¦»**ï¼šä¸åŒç¯å¢ƒä½¿ç”¨ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶
- âœ… **æ•°æ®åº“éš”ç¦»**ï¼šæ¯ä¸ªç¯å¢ƒä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“å®ä¾‹
- âœ… **æ•°æ®è„±æ•**ï¼šç”Ÿäº§æ•°æ®åŒæ­¥åˆ°å¼€å‘ç¯å¢ƒå‰å¿…é¡»è„±æ•
- âœ… **è‡ªåŠ¨åŒ–éƒ¨ç½²**ï¼šä½¿ç”¨CI/CD pipelineè‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹
- âœ… **å¥åº·æ£€æŸ¥**ï¼šæ¯ä¸ªç¯å¢ƒéƒ½é…ç½®å¥åº·æ£€æŸ¥æœºåˆ¶
- âœ… **ç›‘æ§å‘Šè­¦**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»æœ‰å®Œå–„çš„ç›‘æ§å‘Šè­¦

### 2. å¼€å‘å·¥ä½œæµæœ€ä½³å®è·µ

- âœ… **æœ¬åœ°ä¼˜å…ˆ**ï¼šå…ˆåœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒå……åˆ†æµ‹è¯•
- âœ… **æµ‹è¯•ç¯å¢ƒéªŒè¯**ï¼šåŠŸèƒ½å®Œæˆååœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
- âœ… **é¢„å‘å¸ƒéªŒè¯**ï¼šä¸Šçº¿å‰åœ¨é¢„å‘å¸ƒç¯å¢ƒæœ€ç»ˆéªŒè¯
- âœ… **ç°åº¦å‘å¸ƒ**ï¼šç”Ÿäº§ç¯å¢ƒæ›´æ–°é‡‡ç”¨ç°åº¦å‘å¸ƒç­–ç•¥
- âœ… **å›æ»šå‡†å¤‡**ï¼šæ¯æ¬¡éƒ¨ç½²å‰å‡†å¤‡å›æ»šæ–¹æ¡ˆ
- âœ… **æ–‡æ¡£åŒæ­¥**ï¼šç¯å¢ƒå˜æ›´åŠæ—¶æ›´æ–°æ–‡æ¡£

### 3. æ•…éšœå¤„ç†æœ€ä½³å®è·µ

- âœ… **å¿«é€Ÿå®šä½**ï¼šä½¿ç”¨æ—¥å¿—å’Œç›‘æ§å¿«é€Ÿå®šä½é—®é¢˜
- âœ… **ç¯å¢ƒå½±å“éš”ç¦»**ï¼šæ•…éšœå¤„ç†ä¸å½±å“å…¶ä»–ç¯å¢ƒ
- âœ… **æ•°æ®å¤‡ä»½**ï¼šæ“ä½œå‰å…ˆå¤‡ä»½é‡è¦æ•°æ®
- âœ… **é€æ­¥æ¢å¤**ï¼šæŒ‰ä¼˜å…ˆçº§é€æ­¥æ¢å¤æœåŠ¡
- âœ… **äº‹ååˆ†æ**ï¼šæ•…éšœè§£å†³åè¿›è¡Œæ ¹å› åˆ†æ

---

## ğŸ“ æ•…éšœå¤„ç†

### å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### 1. ç¯å¢ƒåˆ‡æ¢å¤±è´¥
```bash
# æ£€æŸ¥ç¯å¢ƒé…ç½®
echo $NODE_ENV
ls -la .env*

# é‡æ–°åŠ è½½é…ç½®
source .env.${NODE_ENV}

# é‡å¯æœåŠ¡
npm run dev
```

#### 2. æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥æ•°æ®åº“çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ•°æ®åº“æ—¥å¿—
docker-compose logs mysql

# é‡å¯æ•°æ®åº“
docker-compose restart mysql
```

#### 3. ç¼“å­˜è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥RedisçŠ¶æ€
docker-compose ps redis

# æ¸…ç†Redisç¼“å­˜
docker-compose exec redis redis-cli FLUSHALL

# é‡å¯Redis
docker-compose restart redis
```

---

**é‡è¦æé†’**ï¼š
1. ç”Ÿäº§ç¯å¢ƒæ“ä½œå¿…é¡»è°¨æ…ï¼Œå……åˆ†æµ‹è¯•åå†æ‰§è¡Œ
2. ç¯å¢ƒåˆ‡æ¢å‰åŠ¡å¿…å¤‡ä»½é‡è¦æ•°æ®
3. éµå¾ªæœ€å°æƒé™åŸåˆ™é…ç½®ç¯å¢ƒè®¿é—®æƒé™
4. å®šæœŸæ£€æŸ¥å’Œæ›´æ–°ç¯å¢ƒé…ç½®ï¼Œç¡®ä¿å®‰å…¨æ€§