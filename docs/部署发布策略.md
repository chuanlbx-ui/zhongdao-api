# ä¸­é“å•†åŸç³»ç»Ÿ - éƒ¨ç½²å‘å¸ƒç­–ç•¥

**æ–‡æ¡£ç›®çš„**ï¼šå®šä¹‰å®Œæ•´çš„ç³»ç»Ÿéƒ¨ç½²ã€å‘å¸ƒå’Œå›æ»šç­–ç•¥
**é€‚ç”¨èŒƒå›´**ï¼šç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ã€ç‰ˆæœ¬å‘å¸ƒã€åº”æ€¥å›æ»š
**æœ€åæ›´æ–°**ï¼š2025å¹´11æœˆ18æ—¥
**ç‰ˆæœ¬**ï¼š1.0

---

## ğŸ¯ éƒ¨ç½²æ¶æ„è®¾è®¡

### ğŸ—ï¸ éƒ¨ç½²ç¯å¢ƒæ‹“æ‰‘

```mermaid
graph TD
    subgraph "å¼€å‘ç¯å¢ƒ"
        DEV[å¼€å‘æœåŠ¡å™¨]
        DEV_DB[(å¼€å‘æ•°æ®åº“)]
        DEV_CACHE[(å¼€å‘Redis)]
    end

    subgraph "æµ‹è¯•ç¯å¢ƒ"
        TEST[æµ‹è¯•æœåŠ¡å™¨]
        TEST_DB[(æµ‹è¯•æ•°æ®åº“)]
        TEST_CACHE[(æµ‹è¯•Redis)]
    end

    subgraph "é¢„å‘å¸ƒç¯å¢ƒ"
        STAGING[é¢„å‘å¸ƒæœåŠ¡å™¨]
        STAGING_DB[(é¢„å‘å¸ƒæ•°æ®åº“)]
        STAGING_CACHE[(é¢„å‘å¸ƒRedis)]
    end

    subgraph "ç”Ÿäº§ç¯å¢ƒ"
        subgraph "è´Ÿè½½å‡è¡¡å±‚"
            LB[è´Ÿè½½å‡è¡¡å™¨]
        end

        subgraph "WebæœåŠ¡å±‚"
            WEB1[WebæœåŠ¡å™¨1]
            WEB2[WebæœåŠ¡å™¨2]
            WEB3[WebæœåŠ¡å™¨3]
        end

        subgraph "åº”ç”¨æœåŠ¡å±‚"
            API1[APIæœåŠ¡å™¨1]
            API2[APIæœåŠ¡å™¨2]
            API3[APIæœåŠ¡å™¨3]
        end

        subgraph "æ•°æ®å±‚"
            PROD_DB[(ç”Ÿäº§æ•°æ®åº“)]
            PROD_CACHE[(ç”Ÿäº§Redis)]
            FILE_STORAGE[æ–‡ä»¶å­˜å‚¨]
        end
    end

    DEV --> TEST --> STAGING --> LB
    LB --> WEB1 & WEB2 & WEB3
    WEB1 & WEB2 & WEB3 --> API1 & API2 & API3
    API1 & API2 & API3 --> PROD_DB & PROD_CACHE & FILE_STORAGE
```

### ğŸ³ å®¹å™¨åŒ–éƒ¨ç½²æ¶æ„

```yaml
# docker-compose.prod.yml
version: '3.8'

services:
  # è´Ÿè½½å‡è¡¡å™¨
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - api
    restart: unless-stopped
    networks:
      - frontend
      - backend

  # APIæœåŠ¡
  api:
    image: zhongdao-mall:${VERSION}
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./logs/app:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - mysql
      - redis
    restart: unless-stopped
    networks:
      - backend
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # æ•°æ®åº“
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${DB_ROOT_PASSWORD}
      - MYSQL_DATABASE=${DB_NAME}
      - MYSQL_USER=${DB_USER}
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/my.cnf:/etc/mysql/my.cnf
      - ./backup/mysql:/backup
    ports:
      - "3306:3306"
    restart: unless-stopped
    networks:
      - backend
    command: --default-authentication-plugin=mysql_native_password

  # Redisç¼“å­˜
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/etc/redis/redis.conf
    ports:
      - "6379:6379"
    restart: unless-stopped
    networks:
      - backend

  # æ–‡ä»¶å­˜å‚¨
  minio:
    image: minio/minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    restart: unless-stopped
    networks:
      - backend

  # ç›‘æ§
  prometheus:
    image: prom/prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    restart: unless-stopped
    networks:
      - monitoring

  grafana:
    image: grafana/grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana:/etc/grafana/provisioning
    restart: unless-stopped
    networks:
      - monitoring

volumes:
  mysql_data:
  redis_data:
  minio_data:
  prometheus_data:
  grafana_data:

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
  monitoring:
    driver: bridge
```

---

## ğŸš€ éƒ¨ç½²ç­–ç•¥

### ğŸ”„ è“ç»¿éƒ¨ç½²

#### è“ç»¿éƒ¨ç½²æ¶æ„

```mermaid
graph TD
    subgraph "ç”Ÿäº§ç¯å¢ƒ"
        subgraph "è“è‰²ç¯å¢ƒ"
            LB_BLUE[è´Ÿè½½å‡è¡¡-è“è‰²]
            APP_BLUE[åº”ç”¨-è“è‰²]
            DB_BLUE[(æ•°æ®åº“-è“è‰²)]
        end

        subgraph "ç»¿è‰²ç¯å¢ƒ"
            LB_GREEN[è´Ÿè½½å‡è¡¡-ç»¿è‰²]
            APP_GREEN[åº”ç”¨-ç»¿è‰²]
            DB_GREEN[(æ•°æ®åº“-ç»¿è‰²)]
        end

        USER[ç”¨æˆ·æµé‡]
        SWITCH[æµé‡åˆ‡æ¢]
    end

    USER --> LB_BLUE
    SWITCH --> LB_GREEN
```

#### è“ç»¿éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# scripts/blue-green-deploy.sh

set -e

# é…ç½®
IMAGE_TAG=${1:-"latest"}
APP_NAME="zhongdao-mall"
BLUE_PORT=3000
GREEN_PORT=3001
HEALTH_CHECK_URL="http://localhost"
HEALTH_CHECK_TIMEOUT=60

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_blue() {
    echo -e "${BLUE}[BLUE]${NC} $1"
}

log_green() {
    echo -e "${GREEN}[GREEN]${NC} $1"
}

# è·å–å½“å‰æ´»è·ƒç¯å¢ƒ
get_active_environment() {
    if curl -f -s "$HEALTH_CHECK_URL:$BLUE_PORT/health" > /dev/null 2>&1; then
        echo "blue"
    elif curl -f -s "$HEALTH_CHECK_URL:$GREEN_PORT/health" > /dev/null 2>&1; then
        echo "green"
    else
        echo "none"
    fi
}

# è·å–éæ´»è·ƒç¯å¢ƒ
get_inactive_environment() {
    local active=$(get_active_environment)
    if [ "$active" = "blue" ]; then
        echo "green"
    elif [ "$active" = "green" ]; then
        echo "blue"
    else
        echo "blue"  # é»˜è®¤ä½¿ç”¨è“è‰²ä½œä¸ºåˆå§‹ç¯å¢ƒ
    fi
}

# å¥åº·æ£€æŸ¥
health_check() {
    local port=$1
    local timeout=$2

    log_info "å¼€å§‹å¥åº·æ£€æŸ¥ (ç«¯å£: $port, è¶…æ—¶: ${timeout}s)..."

    for i in $(seq 1 $timeout); do
        if curl -f -s "$HEALTH_CHECK_URL:$port/health" > /dev/null 2>&1; then
            log_info "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            return 0
        fi
        sleep 1
    done

    log_error "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
    return 1
}

# æ•°æ®åº“åŒæ­¥
sync_database() {
    local from_env=$1
    local to_env=$2

    log_info "åŒæ­¥æ•°æ®åº“æ•°æ®: $from_env -> $to_env"

    # è¿™é‡Œå®ç°æ•°æ®åº“åŒæ­¥é€»è¾‘
    # æ³¨æ„ï¼šå¯¹äºè¯»å¤šå†™å°‘çš„åº”ç”¨ï¼Œå¯ä»¥è€ƒè™‘ä¸»ä»å¤åˆ¶
    # å¯¹äºå†™æ“ä½œé¢‘ç¹çš„åº”ç”¨ï¼Œéœ€è¦å®ç°æ•°æ®åŒå†™ç­–ç•¥

    log_info "âœ… æ•°æ®åº“åŒæ­¥å®Œæˆ"
}

# éƒ¨ç½²åˆ°æŒ‡å®šç¯å¢ƒ
deploy_to_environment() {
    local environment=$1
    local port=$2

    log_info "éƒ¨ç½²åˆ° $environment ç¯å¢ƒ (ç«¯å£: $port)..."

    # åœæ­¢æ—§å®¹å™¨
    if docker ps -q -f name="$APP_NAME-$environment" | grep -q .; then
        log_info "åœæ­¢æ—§çš„ $environment å®¹å™¨..."
        docker stop "$APP_NAME-$environment" || true
        docker rm "$APP_NAME-$environment" || true
    fi

    # å¯åŠ¨æ–°å®¹å™¨
    log_info "å¯åŠ¨æ–°çš„ $environment å®¹å™¨..."
    docker run -d \
        --name "$APP_NAME-$environment" \
        --network host \
        -e NODE_ENV=production \
        -e PORT=$port \
        -e DATABASE_URL="$DATABASE_URL" \
        -e REDIS_URL="$REDIS_URL" \
        -v "$(pwd)/logs:/app/logs" \
        -v "$(pwd)/uploads:/app/uploads" \
        "$APP_NAME:$IMAGE_TAG"

    log_info "âœ… $environment ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
}

# æµé‡åˆ‡æ¢
switch_traffic() {
    local from_env=$1
    local to_env=$2
    local from_port=$3
    local to_port=$4

    log_info "åˆ‡æ¢æµé‡: $from_env -> $to_env"

    # æ›´æ–°è´Ÿè½½å‡è¡¡å™¨é…ç½®
    cat > nginx/upstream.conf << EOF
upstream zhongdao_mall {
    server 127.0.0.1:$to_port;
    # ä¿ç•™æ—§ç¯å¢ƒä½œä¸ºå¤‡ä»½
    server 127.0.0.1:$from_port backup;
}
EOF

    # é‡æ–°åŠ è½½Nginxé…ç½®
    docker exec nginx nginx -s reload

    log_info "âœ… æµé‡åˆ‡æ¢å®Œæˆ"
}

# éªŒè¯éƒ¨ç½²
verify_deployment() {
    local environment=$1
    local port=$2

    log_info "éªŒè¯ $environment ç¯å¢ƒéƒ¨ç½²..."

    # å¥åº·æ£€æŸ¥
    if ! health_check $port 30; then
        log_error "å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œéƒ¨ç½²éªŒè¯ä¸é€šè¿‡"
        return 1
    fi

    # ä¸šåŠ¡åŠŸèƒ½æ£€æŸ¥
    log_info "æ‰§è¡Œä¸šåŠ¡åŠŸèƒ½æ£€æŸ¥..."

    # æ£€æŸ¥ç”¨æˆ·ç™»å½•
    if ! curl -f -s -X POST "$HEALTH_CHECK_URL:$port/api/v1/auth/health" > /dev/null 2>&1; then
        log_error "ç”¨æˆ·ç™»å½•åŠŸèƒ½æ£€æŸ¥å¤±è´¥"
        return 1
    fi

    # æ£€æŸ¥å•†å“æŸ¥è¯¢
    if ! curl -f -s "$HEALTH_CHECK_URL:$port/api/v1/products/health" > /dev/null 2>&1; then
        log_error "å•†å“æŸ¥è¯¢åŠŸèƒ½æ£€æŸ¥å¤±è´¥"
        return 1
    fi

    # æ£€æŸ¥è®¢å•åŠŸèƒ½
    if ! curl -f -s "$HEALTH_CHECK_URL:$port/api/v1/orders/health" > /dev/null 2>&1; then
        log_error "è®¢å•åŠŸèƒ½æ£€æŸ¥å¤±è´¥"
        return 1
    fi

    log_info "âœ… $environment ç¯å¢ƒéªŒè¯é€šè¿‡"
    return 0
}

# æ¸…ç†æ—§ç¯å¢ƒ
cleanup_old_environment() {
    local environment=$1

    log_info "æ¸…ç†æ—§çš„ $environment ç¯å¢ƒ..."

    if docker ps -q -f name="$APP_NAME-$environment" | grep -q .; then
        docker stop "$APP_NAME-$environment" || true
        docker rm "$APP_NAME-$environment" || true
    fi

    log_info "âœ… æ—§ç¯å¢ƒæ¸…ç†å®Œæˆ"
}

# ä¸»éƒ¨ç½²æµç¨‹
main() {
    log_info "å¼€å§‹è“ç»¿éƒ¨ç½²..."
    log_info "é•œåƒæ ‡ç­¾: $IMAGE_TAG"

    # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
    if ! docker images -q "$APP_NAME:$IMAGE_TAG" | grep -q .; then
        log_error "é•œåƒ $APP_NAME:$IMAGE_TAG ä¸å­˜åœ¨"
        exit 1
    fi

    # è·å–å½“å‰ç¯å¢ƒçŠ¶æ€
    local active_env=$(get_active_environment)
    local inactive_env=$(get_inactive_environment)

    log_info "å½“å‰æ´»è·ƒç¯å¢ƒ: $active_env"
    log_info "ç›®æ ‡éƒ¨ç½²ç¯å¢ƒ: $inactive_env"

    # ç¡®å®šç«¯å£
    local active_port=$([ "$active_env" = "blue" ] && echo $BLUE_PORT || echo $GREEN_PORT)
    local inactive_port=$([ "$inactive_env" = "blue" ] && echo $BLUE_PORT || echo $GREEN_PORT)

    # éƒ¨ç½²åˆ°éæ´»è·ƒç¯å¢ƒ
    deploy_to_environment "$inactive_env" $inactive_port

    # éªŒè¯æ–°ç¯å¢ƒ
    if ! verify_deployment "$inactive_env" $inactive_port; then
        log_error "æ–°ç¯å¢ƒéªŒè¯å¤±è´¥ï¼Œå›æ»šéƒ¨ç½²"
        cleanup_old_environment "$inactive_env"
        exit 1
    fi

    # å¦‚æœæœ‰æ´»è·ƒç¯å¢ƒï¼ŒåŒæ­¥æ•°æ®åº“
    if [ "$active_env" != "none" ]; then
        sync_database "$active_env" "$inactive_env"
    fi

    # åˆ‡æ¢æµé‡
    if [ "$active_env" != "none" ]; then
        switch_traffic "$active_env" "$inactive_env" $active_port $inactive_port
    else
        # é¦–æ¬¡éƒ¨ç½²ï¼Œç›´æ¥é…ç½®æµé‡
        cat > nginx/upstream.conf << EOF
upstream zhongdao_mall {
    server 127.0.0.1:$inactive_port;
}
EOF
        docker exec nginx nginx -s reload
    fi

    # æœ€ç»ˆéªŒè¯
    sleep 10  # ç­‰å¾…æµé‡åˆ‡æ¢ç”Ÿæ•ˆ
    if ! verify_deployment "$inactive_env" $inactive_port; then
        log_error "æµé‡åˆ‡æ¢åéªŒè¯å¤±è´¥"
        # è¿™é‡Œå¯ä»¥è§¦å‘è‡ªåŠ¨å›æ»š
        exit 1
    fi

    # æ¸…ç†æ—§ç¯å¢ƒ
    if [ "$active_env" != "none" ]; then
        cleanup_old_environment "$active_env"
    fi

    log_green "ğŸ‰ è“ç»¿éƒ¨ç½²å®Œæˆï¼"
    log_green "æ–°ç‰ˆæœ¬å·²åœ¨ $inactive_env ç¯å¢ƒä¸Šçº¿"
}

main "$@"
```

### ğŸ”„ æ»šåŠ¨æ›´æ–°

#### æ»šåŠ¨æ›´æ–°é…ç½®

```yaml
# docker-compose.rolling.yml
version: '3.8'

services:
  api:
    image: zhongdao-mall:${VERSION}
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    volumes:
      - ./logs/app:/app/logs
      - ./uploads:/app/uploads
    depends_on:
      - mysql
      - redis
    restart: unless-stopped
    networks:
      - backend
    deploy:
      replicas: 3
      update_config:
        parallelism: 1          # æ¯æ¬¡æ›´æ–°1ä¸ªå®ä¾‹
        delay: 30s              # æ›´æ–°é—´éš”
        failure_action: rollback # å¤±è´¥æ—¶å›æ»š
        monitor: 60s            # å¥åº·æ£€æŸ¥æ—¶é—´
        max_failure_ratio: 0.3  # æœ€å¤§å¤±è´¥ç‡
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

#### æ»šåŠ¨æ›´æ–°è„šæœ¬

```bash
#!/bin/bash
# scripts/rolling-update.sh

set -e

# é…ç½®
IMAGE_TAG=${1:-"latest"}
SERVICE_NAME="zhongdao-mall-api"
MAX_REPLICAS=3
HEALTH_CHECK_TIMEOUT=120

log_info() {
    echo -e "\033[0;32m[INFO]\033[0m $1"
}

log_warn() {
    echo -e "\033[1;33m[WARN]\033[0m $1"
}

log_error() {
    echo -e "\033[0;31m[ERROR]\033[0m $1"
}

# è·å–å½“å‰æœåŠ¡çŠ¶æ€
get_service_status() {
    docker service ls --filter name=$SERVICE_NAME --format "{{.Replicas}}"
}

# æ‰§è¡Œæ»šåŠ¨æ›´æ–°
rolling_update() {
    log_info "å¼€å§‹æ»šåŠ¨æ›´æ–°..."
    log_info "ç›®æ ‡é•œåƒ: $IMAGE_TAG"

    local current_status=$(get_service_status)
    log_info "å½“å‰æœåŠ¡çŠ¶æ€: $current_status"

    # æ›´æ–°æœåŠ¡é•œåƒ
    log_info "æ›´æ–°æœåŠ¡é•œåƒ..."
    docker service update \
        --image zhongdao-mall:$IMAGE_TAG \
        --update-parallelism 1 \
        --update-delay 30s \
        --update-monitor 60s \
        --update-failure-action rollback \
        --update-max-failure-ratio 0.3 \
        $SERVICE_NAME

    # ç›‘æ§æ›´æ–°è¿›åº¦
    log_info "ç›‘æ§æ›´æ–°è¿›åº¦..."
    local start_time=$(date +%s)

    while true; do
        local status=$(get_service_status)
        log_info "æœåŠ¡çŠ¶æ€: $status"

        # æ£€æŸ¥æ˜¯å¦å®Œæˆ
        if [[ $status =~ ^[0-9]+/[0-9]+$ ]]; then
            local current=$(echo $status | cut -d'/' -f1)
            local total=$(echo $status | cut -d'/' -f2)

            if [ $current -eq $total ]; then
                log_info "âœ… æ»šåŠ¨æ›´æ–°å®Œæˆ"
                break
            fi
        fi

        # æ£€æŸ¥è¶…æ—¶
        local current_time=$(date +%s)
        local elapsed=$((current_time - start_time))
        if [ $elapsed -gt $HEALTH_CHECK_TIMEOUT ]; then
            log_error "æ»šåŠ¨æ›´æ–°è¶…æ—¶"
            exit 1
        fi

        sleep 10
    done
}

# éªŒè¯æ›´æ–°ç»“æœ
verify_update() {
    log_info "éªŒè¯æ›´æ–°ç»“æœ..."

    # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
    local services=$(docker service ps $SERVICE_NAME --format "{{.CurrentState}}")
    local failed_count=$(echo "$services" | grep -c "Failed" || true)

    if [ $failed_count -gt 0 ]; then
        log_error "å‘ç° $failed_count ä¸ªå¤±è´¥çš„å®ä¾‹"
        return 1
    fi

    # æ‰§è¡Œå¥åº·æ£€æŸ¥
    for i in {1..5}; do
        if curl -f -s "http://localhost/health" > /dev/null 2>&1; then
            log_info "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
            return 0
        fi
        sleep 10
    done

    log_error "æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
    return 1
}

# å›æ»šåŠŸèƒ½
rollback() {
    log_warn "å¼€å§‹å›æ»š..."

    # è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬
    local previous_image=$(docker service inspect $SERVICE_NAME --format "{{.Spec.TaskTemplate.ContainerSpec.Image}}" | head -1)

    if [ -z "$previous_image" ]; then
        log_error "æ— æ³•è·å–ä¸Šä¸€ä¸ªç‰ˆæœ¬"
        exit 1
    fi

    log_info "å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬: $previous_image"

    docker service update \
        --image $previous_image \
        --rollback \
        $SERVICE_NAME

    log_info "âœ… å›æ»šå®Œæˆ"
}

# ä¸»æµç¨‹
main() {
    case "${2:-update}" in
        "update")
            rolling_update
            if verify_update; then
                log_info "ğŸ‰ æ»šåŠ¨æ›´æ–°æˆåŠŸå®Œæˆ"
            else
                log_error "éªŒè¯å¤±è´¥ï¼Œè§¦å‘å›æ»š"
                rollback
                exit 1
            fi
            ;;
        "rollback")
            rollback
            ;;
        "status")
            get_service_status
            ;;
        *)
            echo "ç”¨æ³•: $0 <image_tag> [update|rollback|status]"
            exit 1
            ;;
    esac
}

main "$@"
```

---

## ğŸ”„ å›æ»šç­–ç•¥

### ğŸš¨ ç´§æ€¥å›æ»š

#### è‡ªåŠ¨å›æ»šæ£€æµ‹

```typescript
// è‡ªåŠ¨å›æ»šç›‘æ§
class RollbackMonitor {
  private readonly thresholds = {
    errorRate: 0.05,              // é”™è¯¯ç‡è¶…è¿‡5%
    responseTime: 5000,           // å“åº”æ—¶é—´è¶…è¿‡5ç§’
    availability: 0.95            // å¯ç”¨æ€§ä½äº95%
  };

  private rollbackInProgress = false;

  async startMonitoring(): Promise<void> {
    // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡éƒ¨ç½²çŠ¶æ€
    setInterval(async () => {
      if (this.rollbackInProgress) return;

      try {
        await this.checkDeploymentHealth();
      } catch (error) {
        this.logger.error('éƒ¨ç½²å¥åº·æ£€æŸ¥å¤±è´¥', { error: error.message });
      }
    }, 30000);
  }

  private async checkDeploymentHealth(): Promise<void> {
    const metrics = await this.collectMetrics();
    const healthScore = this.calculateHealthScore(metrics);

    this.logger.info('éƒ¨ç½²å¥åº·æ£€æŸ¥', { healthScore, metrics });

    if (healthScore < 0.7) {
      this.logger.warn('éƒ¨ç½²å¥åº·åº¦è¿‡ä½ï¼Œè§¦å‘è‡ªåŠ¨å›æ»š', { healthScore });
      await this.triggerAutoRollback(healthScore, metrics);
    }
  }

  private async collectMetrics(): Promise<DeploymentMetrics> {
    const now = Date.now();
    const fiveMinutesAgo = now - 5 * 60 * 1000;

    // æ”¶é›†é”™è¯¯ç‡
    const totalRequests = await this.metricsRepository.count('http_requests_total', {
      timestamp: { gte: fiveMinutesAgo }
    });

    const errorRequests = await this.metricsRepository.count('http_requests_total', {
      timestamp: { gte: fiveMinutesAgo },
      statusCode: { gte: 500 }
    });

    const errorRate = totalRequests > 0 ? errorRequests / totalRequests : 0;

    // æ”¶é›†å“åº”æ—¶é—´
    const responseTime = await this.metricsRepository.getPercentile(
      'http_request_duration',
      0.95,
      { timestamp: { gte: fiveMinutesAgo } }
    );

    // æ”¶é›†å¯ç”¨æ€§
    const successfulRequests = await this.metricsRepository.count('http_requests_total', {
      timestamp: { gte: fiveMinutesAgo },
      statusCode: { lt: 500 }
    });

    const availability = totalRequests > 0 ? successfulRequests / totalRequests : 1;

    return {
      errorRate,
      responseTime,
      availability,
      timestamp: new Date()
    };
  }

  private calculateHealthScore(metrics: DeploymentMetrics): number {
    let score = 1.0;

    // é”™è¯¯ç‡å½±å“
    if (metrics.errorRate > this.thresholds.errorRate) {
      score -= (metrics.errorRate - this.thresholds.errorRate) * 2;
    }

    // å“åº”æ—¶é—´å½±å“
    if (metrics.responseTime > this.thresholds.responseTime) {
      score -= (metrics.responseTime - this.thresholds.responseTime) / 10000;
    }

    // å¯ç”¨æ€§å½±å“
    if (metrics.availability < this.thresholds.availability) {
      score -= (this.thresholds.availability - metrics.availability) * 3;
    }

    return Math.max(0, score);
  }

  private async triggerAutoRollback(healthScore: number, metrics: DeploymentMetrics): Promise<void> {
    if (this.rollbackInProgress) {
      this.logger.warn('å›æ»šå·²åœ¨è¿›è¡Œä¸­ï¼Œè·³è¿‡');
      return;
    }

    this.rollbackInProgress = true;

    try {
      // å‘é€å‘Šè­¦
      await this.alertManager.sendAlert({
        level: 'critical',
        message: `è‡ªåŠ¨å›æ»šè§¦å‘ï¼šéƒ¨ç½²å¥åº·åº¦è¿‡ä½ ${healthScore}`,
        details: {
          healthScore,
          metrics,
          thresholds: this.thresholds
        }
      });

      // æ‰§è¡Œå›æ»š
      await this.executeRollback('auto-rollback', 'éƒ¨ç½²å¥åº·åº¦ä½äºé˜ˆå€¼');

      // éªŒè¯å›æ»šç»“æœ
      await this.verifyRollback();

    } catch (error) {
      this.logger.error('è‡ªåŠ¨å›æ»šå¤±è´¥', { error: error.message });
      await this.alertManager.sendAlert({
        level: 'critical',
        message: 'è‡ªåŠ¨å›æ»šå¤±è´¥ï¼Œéœ€è¦æ‰‹åŠ¨å¹²é¢„',
        details: { error: error.message }
      });
    } finally {
      this.rollbackInProgress = false;
    }
  }

  private async executeRollback(reason: string, description: string): Promise<void> {
    this.logger.info(`å¼€å§‹å›æ»š: ${reason}`);

    // è·å–å½“å‰éƒ¨ç½²ä¿¡æ¯
    const currentDeployment = await this.getCurrentDeployment();

    // è·å–ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
    const previousVersion = await this.getPreviousStableVersion(currentDeployment);

    if (!previousVersion) {
      throw new Error('æ— æ³•æ‰¾åˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬');
    }

    // è®°å½•å›æ»šäº‹ä»¶
    await this.deploymentRepository.createRollbackRecord({
      fromVersion: currentDeployment.version,
      toVersion: previousVersion.version,
      reason,
      description,
      timestamp: new Date()
    });

    // æ‰§è¡Œå›æ»šæ“ä½œ
    await this.rollbackService.rollbackToVersion(previousVersion.version);

    this.logger.info(`å›æ»šå®Œæˆ: ${currentDeployment.version} -> ${previousVersion.version}`);
  }

  private async verifyRollback(): Promise<void> {
    this.logger.info('éªŒè¯å›æ»šç»“æœ...');

    // ç­‰å¾…æœåŠ¡ç¨³å®š
    await this.sleep(30000);

    // å¥åº·æ£€æŸ¥
    const metrics = await this.collectMetrics();
    const healthScore = this.calculateHealthScore(metrics);

    if (healthScore >= 0.9) {
      this.logger.info('âœ… å›æ»šéªŒè¯é€šè¿‡');
      await this.alertManager.sendAlert({
        level: 'info',
        message: 'è‡ªåŠ¨å›æ»šæˆåŠŸ',
        details: { healthScore, metrics }
      });
    } else {
      this.logger.warn('å›æ»šåå¥åº·åº¦ä»ç„¶è¾ƒä½', { healthScore });
      await this.alertManager.sendAlert({
        level: 'high',
        message: 'å›æ»šåç³»ç»Ÿå¥åº·åº¦ä»ç„¶è¾ƒä½ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒæŸ¥',
        details: { healthScore, metrics }
      });
    }
  }

  private async sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }
}

interface DeploymentMetrics {
  errorRate: number;
  responseTime: number;
  availability: number;
  timestamp: Date;
}
```

#### æ‰‹åŠ¨å›æ»šè„šæœ¬

```bash
#!/bin/bash
# scripts/manual-rollback.sh

set -e

# é…ç½®
TARGET_VERSION=${1:-""}
ROLLBACK_REASON=${2:-"æ‰‹åŠ¨å›æ»š"}
DEPLOYMENT_LOG_FILE="./logs/deployments.log"

log_info() {
    echo -e "\033[0;32m[INFO]\033[0m $1"
}

log_warn() {
    echo -e "\033[1;33m[WARN]\033[0m $1"
}

log_error() {
    echo -e "\033[0;31m[ERROR]\033[0m $1"
}

# è®°å½•å›æ»šæ—¥å¿—
log_rollback() {
    local from_version=$1
    local to_version=$2
    local reason=$3

    echo "$(date '+%Y-%m-%d %H:%M:%S') ROLLBACK: $from_version -> $to_version, Reason: $reason" >> $DEPLOYMENT_LOG_FILE
}

# è·å–å½“å‰ç‰ˆæœ¬
get_current_version() {
    docker service inspect zhongdao-mall-api --format "{{.Spec.TaskTemplate.ContainerSpec.Image}}" | cut -d':' -f2
}

# è·å–å¯ç”¨ç‰ˆæœ¬åˆ—è¡¨
get_available_versions() {
    docker images zhongdao-mall --format "{{.Tag}}" | grep -v 'latest' | sort -r
}

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
rollback_to_version() {
    local target_version=$1
    local reason=$2

    local current_version=$(get_current_version)

    log_info "å¼€å§‹å›æ»š: $current_version -> $target_version"
    log_info "å›æ»šåŸå› : $reason"

    # æ£€æŸ¥ç›®æ ‡ç‰ˆæœ¬æ˜¯å¦å­˜åœ¨
    if ! docker images zhongdao-mall:$target_version | grep -q .; then
        log_error "ç›®æ ‡ç‰ˆæœ¬ $target_version ä¸å­˜åœ¨"
        exit 1
    fi

    # æ‰§è¡Œå›æ»š
    log_info "æ‰§è¡ŒæœåŠ¡å›æ»š..."
    docker service update \
        --image zhongdao-mall:$target_version \
        --rollback \
        zhongdao-mall-api

    # ç­‰å¾…å›æ»šå®Œæˆ
    log_info "ç­‰å¾…å›æ»šå®Œæˆ..."
    sleep 30

    # éªŒè¯å›æ»šç»“æœ
    if verify_deployment $target_version; then
        log_info "âœ… å›æ»šæˆåŠŸå®Œæˆ"
        log_rollback $current_version $target_version "$reason"

        # å‘é€é€šçŸ¥
        send_rollback_notification $current_version $target_version "$reason"
    else
        log_error "å›æ»šéªŒè¯å¤±è´¥"
        exit 1
    fi
}

# éªŒè¯éƒ¨ç½²
verify_deployment() {
    local expected_version=$1

    log_info "éªŒè¯éƒ¨ç½²çŠ¶æ€..."

    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    local status=$(docker service ls --filter name=zhongdao-mall-api --format "{{.Replicas}}")
    log_info "æœåŠ¡çŠ¶æ€: $status"

    if [[ ! $status =~ ^[0-9]+/[0-9]+$ ]]; then
        log_error "æœåŠ¡çŠ¶æ€å¼‚å¸¸"
        return 1
    fi

    local current=$(echo $status | cut -d'/' -f1)
    local total=$(echo $status | cut -d'/' -f2)

    if [ $current -ne $total ]; then
        log_error "æœåŠ¡å®ä¾‹æœªå…¨éƒ¨å¯åŠ¨"
        return 1
    fi

    # å¥åº·æ£€æŸ¥
    for i in {1..10}; do
        if curl -f -s "http://localhost/health" > /dev/null 2>&1; then
            local actual_version=$(curl -s "http://localhost/health" | jq -r '.version')
            if [ "$actual_version" = "$expected_version" ]; then
                log_info "âœ… å¥åº·æ£€æŸ¥é€šè¿‡ï¼Œç‰ˆæœ¬æ­£ç¡®"
                return 0
            else
                log_warn "ç‰ˆæœ¬ä¸åŒ¹é…: æœŸæœ› $expected_version, å®é™… $actual_version"
            fi
        fi
        sleep 10
    done

    log_error "å¥åº·æ£€æŸ¥å¤±è´¥"
    return 1
}

# å‘é€å›æ»šé€šçŸ¥
send_rollback_notification() {
    local from_version=$1
    local to_version=$2
    local reason=$3

    # å‘é€åˆ°ä¼ä¸šå¾®ä¿¡
    if [ -n "$WECHAT_WEBHOOK" ]; then
        curl -X POST "$WECHAT_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "{
                \"msgtype\": \"text\",
                \"text\": {
                    \"content\": \"ğŸš¨ ç³»ç»Ÿå›æ»šé€šçŸ¥\\n\\nå›æ»šåŸå› : $reason\\nç‰ˆæœ¬å˜åŒ–: $from_version -> $to_version\\næ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')\\n\\nè¯·åŠæ—¶å…³æ³¨ç³»ç»ŸçŠ¶æ€\"
                }
            }"
    fi

    # å‘é€é‚®ä»¶é€šçŸ¥
    if command -v mail &> /dev/null; then
        echo "ç³»ç»Ÿå›æ»šé€šçŸ¥

å›æ»šåŸå› : $reason
ç‰ˆæœ¬å˜åŒ–: $from_version -> $to_version
æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')

è¯·åŠæ—¶å…³æ³¨ç³»ç»ŸçŠ¶æ€" | mail -s "ä¸­é“å•†åŸç³»ç»Ÿå›æ»šé€šçŸ¥" ops@zhongdao-mall.com
    fi
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
ç”¨æ³•: $0 [ç‰ˆæœ¬å·] [å›æ»šåŸå› ]

å‚æ•°:
  ç‰ˆæœ¬å·      è¦å›æ»šåˆ°çš„ç›®æ ‡ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼Œä¸æŒ‡å®šåˆ™æ˜¾ç¤ºå¯ç”¨ç‰ˆæœ¬åˆ—è¡¨ï¼‰
  å›æ»šåŸå›     å›æ»šåŸå› æè¿°ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º"æ‰‹åŠ¨å›æ»š"ï¼‰

ç¤ºä¾‹:
  $0                          # æ˜¾ç¤ºå¯ç”¨ç‰ˆæœ¬åˆ—è¡¨
  $0 v1.2.3 "ä¿®å¤ç´§æ€¥bug"      # å›æ»šåˆ°v1.2.3ç‰ˆæœ¬
  $0 v1.2.2                   # å›æ»šåˆ°v1.2.2ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤åŸå› 

EOF
}

# ä¸»æµç¨‹
main() {
    if [ -z "$TARGET_VERSION" ]; then
        log_info "å¯ç”¨ç‰ˆæœ¬åˆ—è¡¨ï¼š"
        get_available_versions
        echo
        show_help
        exit 0
    fi

    # æ£€æŸ¥æƒé™
    if [ "$(id -u)" -ne 0 ]; then
        log_warn "å»ºè®®ä½¿ç”¨rootæƒé™æ‰§è¡Œæ­¤è„šæœ¬"
    fi

    # æ£€æŸ¥DockeræœåŠ¡çŠ¶æ€
    if ! docker info &> /dev/null; then
        log_error "DockeræœåŠ¡æœªè¿è¡Œ"
        exit 1
    fi

    rollback_to_version "$TARGET_VERSION" "$ROLLBACK_REASON"
}

main "$@"
```

---

## ğŸ“¦ CI/CDæµæ°´çº¿

### ğŸ”„ GitHub Actionså·¥ä½œæµ

```yaml
# .github/workflows/deploy.yml
name: éƒ¨ç½²æµæ°´çº¿

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: zhongdao-mall

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      - name: ç±»å‹æ£€æŸ¥
        run: npm run type-check

      - name: ä»£ç é£æ ¼æ£€æŸ¥
        run: npm run lint

      - name: å•å…ƒæµ‹è¯•
        run: npm run test:unit

      - name: é›†æˆæµ‹è¯•
        run: npm run test:integration

      - name: æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
        run: npm run test:coverage

      - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info

  # å®‰å…¨æ‰«æ
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è¿è¡Œnpm audit
        run: npm audit --audit-level moderate

      - name: è¿è¡ŒSnykå®‰å…¨æ‰«æ
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: å®¹å™¨é•œåƒå®‰å…¨æ‰«æ
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ä¸Šä¼ Trivyæ‰«æç»“æœåˆ°GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # æ„å»ºé•œåƒ
  build:
    needs: [quality-check, security-scan]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ°å®¹å™¨æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.zhongdao-mall.com
    steps:
      - name: éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
        run: |
          echo "éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ..."
          # è¿™é‡Œæ·»åŠ éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒçš„è„šæœ¬

      - name: è¿è¡Œå†’çƒŸæµ‹è¯•
        run: |
          echo "è¿è¡Œå†’çƒŸæµ‹è¯•..."
          # è¿™é‡Œæ·»åŠ å†’çƒŸæµ‹è¯•è„šæœ¬

      - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
        run: |
          echo "è¿è¡Œæ€§èƒ½æµ‹è¯•..."
          # è¿™é‡Œæ·»åŠ æ€§èƒ½æµ‹è¯•è„šæœ¬

  # éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
  deploy-staging-prod:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: staging-prod
      url: https://staging-prod.zhongdao-mall.com
    steps:
      - name: éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ
        run: |
          echo "éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ..."
          # ä½¿ç”¨è“ç»¿éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ

      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          curl -f https://staging-prod.zhongdao-mall.com/health

      - name: è¿è¡ŒE2Eæµ‹è¯•
        run: |
          echo "è¿è¡ŒE2Eæµ‹è¯•..."
          # è¿™é‡Œæ·»åŠ E2Eæµ‹è¯•è„šæœ¬

  # æ‰‹åŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    needs: [build, deploy-staging-prod]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://api.zhongdao-mall.com
    steps:
      - name: ç­‰å¾…æ‰‹åŠ¨æ‰¹å‡†
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: team-ops
          minimum-approvals: 2

      - name: éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
        run: |
          echo "å¼€å§‹ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
          # ä½¿ç”¨è“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

      - name: ç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥
        run: |
          echo "æ‰§è¡Œç”Ÿäº§ç¯å¢ƒå¥åº·æ£€æŸ¥..."
          ./scripts/health-check.sh https://api.zhongdao-mall.com

      - name: è¿è¡Œç”Ÿäº§ç¯å¢ƒå†’çƒŸæµ‹è¯•
        run: |
          echo "è¿è¡Œç”Ÿäº§ç¯å¢ƒå†’çƒŸæµ‹è¯•..."
          # è¿è¡Œå…³é”®ä¸šåŠ¡æµç¨‹æµ‹è¯•

      - name: å‘é€éƒ¨ç½²é€šçŸ¥
        if: always()
        run: |
          echo "å‘é€éƒ¨ç½²é€šçŸ¥..."
          # å‘é€éƒ¨ç½²æˆåŠŸæˆ–å¤±è´¥çš„é€šçŸ¥

  # å‘å¸ƒåéªŒè¯
  post-deployment-verification:
    needs: deploy-production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ç›‘æ§éƒ¨ç½²åçŠ¶æ€
        run: |
          echo "ç›‘æ§éƒ¨ç½²åç³»ç»ŸçŠ¶æ€..."
          # ç›‘æ§å…³é”®æŒ‡æ ‡ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®š

      - name: æ€§èƒ½åŸºå‡†æµ‹è¯•
        run: |
          echo "è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
          # ä¸ä¹‹å‰çš„æ€§èƒ½æ•°æ®è¿›è¡Œå¯¹æ¯”

      - name: ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
        run: |
          echo "ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š..."
          # ç”Ÿæˆè¯¦ç»†çš„éƒ¨ç½²æŠ¥å‘Š
```

---

## ğŸ“Š éƒ¨ç½²é…ç½®ç®¡ç†

### âš™ï¸ ç¯å¢ƒé…ç½®

```typescript
// config/deployment.config.ts
export interface DeploymentConfig {
  environment: 'development' | 'testing' | 'staging' | 'production';

  // æ•°æ®åº“é…ç½®
  database: {
    host: string;
    port: number;
    name: string;
    user: string;
    password: string;
    ssl: boolean;
    poolSize: number;
  };

  // Redisé…ç½®
  redis: {
    host: string;
    port: number;
    password?: string;
    db: number;
    maxRetriesPerRequest: number;
  };

  // åº”ç”¨é…ç½®
  app: {
    port: number;
    nodeEnv: string;
    logLevel: string;
    maxRequestBodySize: string;
  };

  // å®‰å…¨é…ç½®
  security: {
    jwtSecret: string;
    jwtExpiration: string;
    bcryptRounds: number;
    corsOrigins: string[];
  };

  // å¤–éƒ¨æœåŠ¡é…ç½®
  external: {
    wechat: {
      appId: string;
      appSecret: string;
    };
    payment: {
      alipay: {
        appId: string;
        privateKey: string;
        publicKey: string;
      };
      wechatPay: {
        appId: string;
        mchId: string;
        apiKey: string;
      };
    };
  };

  // ç›‘æ§é…ç½®
  monitoring: {
    enabled: boolean;
    prometheus: {
      enabled: boolean;
      port: number;
    };
    tracing: {
      enabled: boolean;
      endpoint: string;
    };
  };
}

const configs: Record<string, DeploymentConfig> = {
  development: {
    environment: 'development',
    database: {
      host: 'localhost',
      port: 3306,
      name: 'zhongdao_mall_dev',
      user: 'dev_user',
      password: 'dev_password',
      ssl: false,
      poolSize: 5
    },
    redis: {
      host: 'localhost',
      port: 6379,
      db: 0,
      maxRetriesPerRequest: 3
    },
    app: {
      port: 3000,
      nodeEnv: 'development',
      logLevel: 'debug',
      maxRequestBodySize: '10mb'
    },
    security: {
      jwtSecret: 'dev-secret-key',
      jwtExpiration: '7d',
      bcryptRounds: 10,
      corsOrigins: ['http://localhost:3000']
    },
    external: {
      wechat: {
        appId: 'dev-wechat-app-id',
        appSecret: 'dev-wechat-app-secret'
      },
      payment: {
        alipay: {
          appId: 'dev-alipay-app-id',
          privateKey: 'dev-private-key',
          publicKey: 'dev-public-key'
        },
        wechatPay: {
          appId: 'dev-wechat-pay-app-id',
          mchId: 'dev-mch-id',
          apiKey: 'dev-api-key'
        }
      }
    },
    monitoring: {
      enabled: true,
      prometheus: {
        enabled: true,
        port: 9090
      },
      tracing: {
        enabled: false,
        endpoint: ''
      }
    }
  },

  production: {
    environment: 'production',
    database: {
      host: process.env.DB_HOST!,
      port: parseInt(process.env.DB_PORT || '3306'),
      name: process.env.DB_NAME!,
      user: process.env.DB_USER!,
      password: process.env.DB_PASSWORD!,
      ssl: true,
      poolSize: 20
    },
    redis: {
      host: process.env.REDIS_HOST!,
      port: parseInt(process.env.REDIS_PORT || '6379'),
      password: process.env.REDIS_PASSWORD,
      db: 0,
      maxRetriesPerRequest: 5
    },
    app: {
      port: parseInt(process.env.PORT || '3000'),
      nodeEnv: 'production',
      logLevel: 'info',
      maxRequestBodySize: '5mb'
    },
    security: {
      jwtSecret: process.env.JWT_SECRET!,
      jwtExpiration: '24h',
      bcryptRounds: 12,
      corsOrigins: process.env.CORS_ORIGINS?.split(',') || []
    },
    external: {
      wechat: {
        appId: process.env.WECHAT_APP_ID!,
        appSecret: process.env.WECHAT_APP_SECRET!
      },
      payment: {
        alipay: {
          appId: process.env.ALIPAY_APP_ID!,
          privateKey: process.env.ALIPAY_PRIVATE_KEY!,
          publicKey: process.env.ALIPAY_PUBLIC_KEY!
        },
        wechatPay: {
          appId: process.env.WECHAT_PAY_APP_ID!,
          mchId: process.env.WECHAT_PAY_MCH_ID!,
          apiKey: process.env.WECHAT_PAY_API_KEY!
        }
      }
    },
    monitoring: {
      enabled: true,
      prometheus: {
        enabled: true,
        port: 9090
      },
      tracing: {
        enabled: true,
        endpoint: process.env.JAEGER_ENDPOINT!
      }
    }
  }
};

export function getDeploymentConfig(): DeploymentConfig {
  const env = process.env.NODE_ENV || 'development';
  return configs[env] || configs.development;
}
```

---

## ğŸ“‹ éƒ¨ç½²æ£€æŸ¥æ¸…å•

### ğŸš€ éƒ¨ç½²å‰æ£€æŸ¥

#### ä»£ç è´¨é‡æ£€æŸ¥
- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] ä»£ç è¦†ç›–ç‡è¾¾æ ‡ (>80%)
- [ ] é™æ€ä»£ç åˆ†æé€šè¿‡
- [ ] å®‰å…¨æ‰«æé€šè¿‡
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡

#### ç¯å¢ƒå‡†å¤‡æ£€æŸ¥
- [ ] ç›®æ ‡ç¯å¢ƒèµ„æºå……è¶³
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] Redisè¿æ¥æ­£å¸¸
- [ ] å¤–éƒ¨æœåŠ¡å¯ç”¨
- [ ] ç›‘æ§ç³»ç»Ÿæ­£å¸¸
- [ ] å¤‡ä»½ç­–ç•¥å°±ç»ª

#### é…ç½®éªŒè¯æ£€æŸ¥
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“è¿ç§»è„šæœ¬å‡†å¤‡
- [ ] é…ç½®æ–‡ä»¶æ¨¡æ¿æ›´æ–°
- [ ] SSLè¯ä¹¦æœ‰æ•ˆ
- [ ] åŸŸåè§£ææ­£ç¡®

### ğŸ”„ éƒ¨ç½²è¿‡ç¨‹æ£€æŸ¥

#### éƒ¨ç½²æ‰§è¡Œæ£€æŸ¥
- [ ] é•œåƒæ„å»ºæˆåŠŸ
- [ ] å®¹å™¨å¯åŠ¨æ­£å¸¸
- [ ] å¥åº·æ£€æŸ¥é€šè¿‡
- [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
- [ ] é…ç½®æ›´æ–°ç”Ÿæ•ˆ
- [ ] æœåŠ¡æ³¨å†ŒæˆåŠŸ

#### éªŒè¯æ£€æŸ¥
- [ ] APIæ¥å£å“åº”æ­£å¸¸
- [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸
- [ ] ç¼“å­˜æœåŠ¡æ­£å¸¸
- [ ] æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½æ­£å¸¸
- [ ] æ”¯ä»˜åŠŸèƒ½æ­£å¸¸
- [ ] é€šçŸ¥åŠŸèƒ½æ­£å¸¸

### âœ… éƒ¨ç½²åæ£€æŸ¥

#### ä¸šåŠ¡åŠŸèƒ½éªŒè¯
- [ ] ç”¨æˆ·æ³¨å†Œç™»å½•æ­£å¸¸
- [ ] å•†å“æµè§ˆæ­£å¸¸
- [ ] è®¢å•åˆ›å»ºæ­£å¸¸
- [ ] æ”¯ä»˜æµç¨‹æ­£å¸¸
- [ ] åº“å­˜ç®¡ç†æ­£å¸¸
- [ ] é€šåˆ¸æµè½¬æ­£å¸¸

#### æ€§èƒ½ç›‘æ§æ£€æŸ¥
- [ ] å“åº”æ—¶é—´æ­£å¸¸
- [ ] é”™è¯¯ç‡æ­£å¸¸
- [ ] å¹¶å‘å¤„ç†æ­£å¸¸
- [ ] æ•°æ®åº“æ€§èƒ½æ­£å¸¸
- [ ] ç¼“å­˜å‘½ä¸­ç‡æ­£å¸¸
- [ ] å†…å­˜ä½¿ç”¨æ­£å¸¸

#### ç›‘æ§å‘Šè­¦æ£€æŸ¥
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸
- [ ] æ—¥å¿—æ”¶é›†æ­£å¸¸
- [ ] å‘Šè­¦è§„åˆ™ç”Ÿæ•ˆ
- [ ] é€šçŸ¥æ¸ é“æ­£å¸¸
- [ ] è‡ªåŠ¨åŒ–ä»»åŠ¡æ­£å¸¸

---

## ğŸ¯ æœ€ä½³å®è·µ

### ğŸ“ éƒ¨ç½²æœ€ä½³å®è·µ

#### 1. ç‰ˆæœ¬ç®¡ç†
- ä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬æ§åˆ¶
- æ¯ä¸ªç‰ˆæœ¬éƒ½æœ‰æ˜ç¡®çš„å˜æ›´æ—¥å¿—
- ä¿æŒç‰ˆæœ¬çš„å¯è¿½æº¯æ€§
- å®šæœŸæ¸…ç†æ—§ç‰ˆæœ¬é•œåƒ

#### 2. ç¯å¢ƒä¸€è‡´æ€§
- ä½¿ç”¨åŸºç¡€è®¾æ–½å³ä»£ç 
- ä¿æŒå¤šç¯å¢ƒé…ç½®çš„ä¸€è‡´æ€§
- ä½¿ç”¨å®¹å™¨åŒ–ç¡®ä¿ç¯å¢ƒä¸€è‡´æ€§
- å®šæœŸåŒæ­¥ç¯å¢ƒé…ç½®

#### 3. ç›‘æ§å’Œæ—¥å¿—
- å®Œæ•´çš„éƒ¨ç½²è¿‡ç¨‹ç›‘æ§
- è¯¦ç»†çš„éƒ¨ç½²æ—¥å¿—è®°å½•
- å…³é”®æŒ‡æ ‡çš„å®æ—¶ç›‘æ§
- å¼‚å¸¸æƒ…å†µçš„åŠæ—¶å‘Šè­¦

#### 4. å›æ»šç­–ç•¥
- å§‹ç»ˆä¿æŒå›æ»šèƒ½åŠ›
- å¿«é€Ÿå›æ»šæœºåˆ¶
- è‡ªåŠ¨å›æ»šè§¦å‘æ¡ä»¶
- å›æ»šéªŒè¯æµç¨‹

#### 5. å®‰å…¨è€ƒè™‘
- é•œåƒå®‰å…¨æ‰«æ
- è®¿é—®æƒé™æ§åˆ¶
- æ•æ„Ÿä¿¡æ¯åŠ å¯†
- å®‰å…¨å®¡è®¡æ—¥å¿—

### ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. æ„å»ºä¼˜åŒ–
- ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒä½“ç§¯
- åˆ©ç”¨ç¼“å­˜å±‚åŠ é€Ÿæ„å»º
- ä¼˜åŒ–ä¾èµ–å®‰è£…é¡ºåº
- ç§»é™¤ä¸å¿…è¦çš„å¼€å‘ä¾èµ–

#### 2. éƒ¨ç½²ä¼˜åŒ–
- ä½¿ç”¨è“ç»¿éƒ¨ç½²å‡å°‘åœæœºæ—¶é—´
- å®æ–½å¥åº·æ£€æŸ¥ç¡®ä¿æœåŠ¡è´¨é‡
- ä¼˜åŒ–å®¹å™¨èµ„æºåˆ†é…
- ä½¿ç”¨è´Ÿè½½å‡è¡¡æé«˜å¯ç”¨æ€§

#### 3. æ•°æ®åº“ä¼˜åŒ–
- ä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥
- å®æ–½è¯»å†™åˆ†ç¦»
- å®šæœŸä¼˜åŒ–æ•°æ®åº“ç´¢å¼•
- ç›‘æ§æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

---

**é‡è¦æé†’**ï¼š
1. éƒ¨ç½²æ˜¯é«˜é£é™©æ“ä½œï¼Œå¿…é¡»ä¸¥æ ¼æŒ‰ç…§æµç¨‹æ‰§è¡Œ
2. å›æ»šæ˜¯æœ€åçš„ä¿éšœï¼Œå¿…é¡»å§‹ç»ˆå¯ç”¨
3. ç›‘æ§æ˜¯éƒ¨ç½²çš„çœ¼ç›ï¼Œå¿…é¡»å…¨é¢è¦†ç›–
4. æµ‹è¯•æ˜¯éƒ¨ç½²çš„å‰æï¼Œå¿…é¡»å……åˆ†éªŒè¯
5. æ–‡æ¡£æ˜¯éƒ¨ç½²çš„æŒ‡å—ï¼Œå¿…é¡»åŠæ—¶æ›´æ–°

**é€šè¿‡å®Œå–„çš„éƒ¨ç½²å‘å¸ƒç­–ç•¥ï¼Œæˆ‘ä»¬å°†ç¡®ä¿ä¸­é“å•†åŸç³»ç»Ÿçš„ç¨³å®šäº¤ä»˜å’Œå¿«é€Ÿå“åº”èƒ½åŠ›ï¼** ğŸš€