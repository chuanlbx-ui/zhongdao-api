# 中道商城性能监控使用说明

## 快速开始

### 1. 确保服务器正在运行

```bash
# 在项目根目录启动开发服务器
npm run dev
```

### 2. 运行性能监控

```bash
# 建立性能基线并生成报告
npm run performance:monitor

# 仅建立基线（首次运行）
npm run performance:baseline

# 仅查看现有报告
npm run performance:report
```

## 如果遇到连接问题

如果出现"服务器未运行"的错误，可能是因为：

1. **端口配置问题** - 服务器可能运行在不同端口
2. **环境变量问题** - 检查是否正确设置了环境变量

### 解决方案

#### 方法1：手动指定端口
修改 `scripts/performance-monitor.js` 中的端口列表，添加您的服务器实际运行的端口：

```javascript
const possiblePorts = [3000, 3001, 8000, 8080, 3100]; // 添加您的端口
```

#### 方法2：直接使用curl测试
```bash
# 测试单个API端点
curl -X GET http://localhost:3000/api/v1/auth/me -H "Authorization: Bearer YOUR_TOKEN" -w "Response time: %{time_total}s\n"

# 测试服务器是否运行
curl -s http://localhost:3000/health
```

## 性能监控文件说明

### 生成的文件

1. **`.performance-baseline.json`** - 性能基线数据
   - 存储各API端点的基准响应时间
   - 用于后续性能回归检测

2. **`performance-report.json`** - 详细性能报告
   - 包含当前性能测试结果
   - 与基线对比分析
   - 性能优化建议

### 监控的API端点

系统默认监控以下关键端点：
- 用户信息查询 (`GET /api/v1/auth/me`)
- 用户资料获取 (`GET /api/v1/users/profile`)
- 用户资料更新 (`PUT /api/v1/users/profile`)
- 团队信息查询 (`GET /api/v1/users/team`)
- 用户统计信息 (`GET /api/v1/users/statistics`)
- 商品列表查询 (`GET /api/v1/products`)
- 商品分类查询 (`GET /api/v1/products/categories`)
- 积分余额查询 (`GET /api/v1/points/balance`)
- 库存摘要查询 (`GET /api/v1/inventory/summary`)
- 佣金摘要查询 (`GET /api/v1/commission/summary`)

## 性能指标说明

### 响应时间等级

- 🟢 **优秀** (< 100ms) - API响应非常快
- 🔵 **良好** (100-300ms) - API响应正常
- 🟡 **可接受** (300-1000ms) - API响应较慢但可接受
- 🟠 **缓慢** (1000-2000ms) - 需要优化
- 🔴 **严重** (> 2000ms) - 需要立即优化

### 性能警告类型

1. **单次超时警告** - 单个请求响应时间超过阈值
2. **性能回归警告** - 响应时间比基线慢20%以上
3. **持续性能问题** - 同一端点连续5次出现警告

## 集成到开发流程

### 1. 开发阶段
```bash
# 每次重要功能开发完成后
npm run performance:monitor
```

### 2. 提交代码前
```bash
# 确保没有性能回归
npm run performance:report
```

### 3. 定期检查
```bash
# 每周运行一次全面性能检查
npm run performance:monitor
```

## 常见问题解决

### 问题1：curl命令失败
**现象**：`ϵͳ�Ҳ���ָ����·����`
**原因**：Windows系统中curl命令路径问题
**解决**：使用Git Bash或PowerShell，或将curl替换为`wget`

### 问题2：ADMIN_TOKEN未设置
**现象**：401 Unauthorized错误
**解决**：设置环境变量或在脚本中硬编码测试token

### 问题3：端口占用
**现象**：服务器无法启动在指定端口
**解决**：
```bash
# 查找占用端口的进程
netstat -ano | findstr :3000

# 终止进程
taskkill /PID <进程ID> /F

# 或使用其他端口
PORT=3001 npm run dev
```

## 性能优化建议

### 1. 数据库优化
- 为经常查询的字段添加索引
- 优化复杂查询，避免N+1查询问题
- 使用数据库连接池

### 2. 缓存策略
- 实现Redis缓存
- 缓存静态资源和配置数据
- 使用CDN加速

### 3. 代码优化
- 避免同步阻塞操作
- 使用异步处理
- 优化循环和递归算法

### 4. 系统配置
- 调整Node.js内存限制
- 优化垃圾回收策略
- 使用PM2集群模式

## 联系支持

如果遇到其他问题：
1. 查看项目文档：`docs/`目录
2. 检查日志文件：`logs/`目录
3. 联系开发团队获取帮助

---

**提示**：性能监控是持续的过程，建议定期运行并跟踪性能趋势。