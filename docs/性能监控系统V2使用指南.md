# 性能监控系统 V2 使用指南

## 概述

中道商城性能监控系统V2是一个高性能、低开销的实时性能监控解决方案。它采用智能采样策略，在保证监控精度的同时，最小化对业务性能的影响。

## 核心特性

### 1. 智能采样策略
- **动态采样率**：根据响应时间自动调整采样率
  - 快速请求（<50ms）：1% 采样
  - 正常请求（50-200ms）：10% 采样
  - 慢请求（200-500ms）：50% 采样
  - 很慢请求（500-1000ms）：100% 采样
  - 严重请求（>1000ms）：100% 采样
- **错误率触发**：当错误率超过5%时自动切换到全采样
- **生产环境优化**：基础采样率仅为5%

### 2. 高性能数据存储
- **环形缓冲区**：固定大小（10,000条记录），自动覆盖旧数据
- **内存优化**：使用紧凑的数据结构，单个请求记录仅占用约100字节
- **异步日志**：批量写入日志，避免I/O阻塞

### 3. 实时告警系统
- **内存监控**：512MB警告，1024MB严重告警
- **响应时间告警**：基于百分位数动态调整阈值
- **错误率监控**：持续跟踪错误率变化

## API 端点

### 1. 系统健康检查
```bash
GET /api/v1/performance/health
```

响应示例：
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-01-01T00:00:00.000Z",
    "uptime": 3600,
    "memory": {
      "heapUsed": 256.5,
      "heapTotal": 512,
      "external": 45.2,
      "rss": 380.1
    },
    "performance": {
      "monitor": {
        "version": "v2",
        "active": true,
        "features": {
          "smartSampling": true,
          "asyncLogging": true,
          "ringBuffer": true,
          "aggregation": true
        }
      },
      "stats": {
        "bufferUtilization": 0.35,
        "totalRequests": 15000,
        "averageResponseTime": 120,
        "errorRate": 0.02,
        "activeAlerts": 0
      }
    }
  }
}
```

### 2. 性能概览（管理员）
```bash
GET /api/v1/performance/overview
Authorization: Bearer <admin-token>
```

响应包含：
- 性能汇总统计
- 响应时间百分位数（P50, P90, P95, P99）
- 活跃告警列表
- 优化建议

### 3. 慢路由列表（管理员）
```bash
GET /api/v1/performance/slow-routes?limit=20
Authorization: Bearer <admin-token>
```

### 4. 实时性能流（管理员）
```bash
GET /api/v1/performance/stream
Authorization: Bearer <admin-token>
```

使用 Server-Sent Events (SSE) 提供实时性能数据推送。

## 性能开销

监控系统的设计目标是将性能开销降至最低：

- **95%的请求监控开销 < 5ms**
- **内存占用 < 10MB**（包含10,000条记录）
- **CPU开销 < 1%**

## 配置说明

### 环境变量配置

```bash
# 生产环境采样率
NODE_ENV=production

# 可选：自定义采样率（覆盖默认值）
PERF_SAMPLE_RATE=0.05

# 可选：批量写入间隔（毫秒）
PERF_BATCH_INTERVAL=5000
```

### 运行时配置

```javascript
// 在 src/shared/middleware/performance-monitor-v2.ts 中修改
const PERF_CONFIG = {
  thresholds: {
    fast: 50,        // 快速阈值
    normal: 200,     // 正常阈值
    slow: 500,       // 慢阈值
    verySlow: 1000,  // 很慢阈值
    critical: 2000   // 严重阈值
  },
  sampling: {
    // ... 采样配置
  },
  memory: {
    warning: 512,    // 内存警告阈值（MB）
    critical: 1024   // 内存严重阈值（MB）
  }
};
```

## 使用建议

### 1. 开发环境
- 保留完整日志输出
- 使用较低采样率以观察所有请求
- 检查响应头中的 `X-RT` 和 `X-Sample`

### 2. 测试环境
- 使用与生产环境相同的配置
- 验证性能监控系统不影响测试结果

### 3. 生产环境
- 保持默认配置（已优化）
- 定期检查 `/api/v1/performance/health`
- 设置监控告警，当系统状态变为 warning 或 critical 时通知

## 测试验证

运行测试脚本验证性能监控系统：

```bash
node test-performance-monitor.js
```

测试内容：
1. 健康检查端点
2. 性能数据采集
3. 负载测试
4. 响应头验证

## 故障排除

### 问题1：性能监控未生效
检查：
1. 确认 `app.use(enhancedPerformanceMonitor)` 已启用
2. 检查是否有导入错误
3. 查看控制台是否有错误日志

### 问题2：内存占用过高
解决：
1. 降低 `ringBufferSize` 配置
2. 减少采样率
3. 检查是否有内存泄漏

### 问题3：性能影响过大
解决：
1. 降低采样率配置
2. 启用异步日志（默认已启用）
3. 检查是否正确使用环形缓冲区

## 最佳实践

1. **定期审查性能报告**：每周查看性能概览，识别优化机会
2. **设置告警阈值**：根据业务需求调整告警阈值
3. **监控采样率**：确保采样率在合理范围内
4. **保留历史数据**：定期导出性能数据用于长期分析
5. **与其他监控工具集成**：可将数据发送到外部监控系统

## 更新日志

### V2.0.0 (2024-01-01)
- ✅ 实现智能采样策略
- ✅ 添加环形缓冲区
- ✅ 优化内存使用
- ✅ 实现异步日志
- ✅ 添加实时数据流
- ✅ 修复重复导出问题

### 已知问题
- 暂不支持分布式追踪
- 慢查询监控需要手动集成数据库查询日志
- 告警系统暂不支持外部通知集成

## 联系支持

如有问题或建议，请联系技术团队。