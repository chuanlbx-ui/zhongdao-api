# 微信支付配置指南

## 📋 概述

本指南将帮助您完成中道商城系统的微信支付配置，包括开发环境的沙箱测试和生产环境的正式接入。

## 🔧 准备工作

### 1. 注册微信公众号和小程序
- 访问 [微信公众平台](https://mp.weixin.qq.com/)
- 注册小程序账号，获取小程序AppID
- 完成小程序认证（个人或企业）

### 2. 注册微信商户平台
- 访问 [微信商户平台](https://pay.weixin.qq.com/)
- 注册商户账号
- 完成商户认证

### 3. 关联小程序与商户
- 在商户平台中选择"产品中心" → "AppID授权管理"
- 授权小程序AppID给商户号

## ⚙️ 配置步骤

### 1. 获取基础配置信息

#### 微信小程序AppID
1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入"开发" → "开发设置" → "开发者ID（AppID）"
3. 复制小程序的AppID（格式：wx开头的18位字符串）

#### 微信商户号
1. 登录 [微信商户平台](https://pay.weixin.qq.com/)
2. 在"账户中心" → "商户信息"中查看商户号
3. 复制10位数字的商户号

### 2. 配置API密钥

#### API v3密钥（推荐）
1. 在商户平台选择"账户中心" → "API安全" → "API密钥"
2. 设置APIv3密钥（32位字符）
3. **重要**：妥善保存密钥，建议使用密码管理工具

#### 商户密钥（API v2兼容）
1. 在"账户中心" → "API安全" → "API密钥"中设置
2. 生成并下载商户密钥文件

### 3. 配置API证书（生产环境必需）

#### 下载证书
1. 在商户平台选择"账户中心" → "API安全" → "API证书"
2. 下载以下文件：
   - 证书文件（apiclient_cert.pem）
   - 私钥文件（apiclient_key.pem）
3. 记录证书序列号

### 4. 配置回调地址

#### 要求
- **必须使用HTTPS协议**
- 域名必须备案
- 建议使用HTTPS协议

#### 回调地址设置
1. 在商户平台选择"产品中心" → "开发配置"
2. 设置支付回调地址：
   ```
   支付结果通知URL: https://yourdomain.com/api/v1/payments/wechat/notify
   退款结果通知URL: https://yourdomain.com/api/v1/payments/wechat/refund/notify
   ```

## 🛠️ 环境变量配置

### 开发环境配置

在项目根目录创建 `.env` 文件：

```bash
# 微信小程序配置
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_V3_KEY=your_32_character_api_v3_key_here
WECHAT_KEY=your_merchant_key_here

# 回调地址（开发环境可以使用ngrok等工具）
WECHAT_NOTIFY_URL=https://your-ngrok-domain.ngrok.io/api/v1/payments/wechat/notify
WECHAT_REFUND_NOTIFY_URL=https://your-ngrok-domain.ngrok.io/api/v1/payments/wechat/refund/notify

# 沙箱环境
WECHAT_SANDBOX=true
```

### 生产环境配置

```bash
# 微信小程序配置
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_V3_KEY=your_32_character_api_v3_key_here
WECHAT_KEY=your_merchant_key_here

# API证书（必需）
WECHAT_API_CLIENT_CERT="-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----"
WECHAT_API_CLIENT_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
WECHAT_API_SERIAL_NO=your_cert_serial_no

# 回调地址（必须是HTTPS）
WECHAT_NOTIFY_URL=https://yourdomain.com/api/v1/payments/wechat/notify
WECHAT_REFUND_NOTIFY_URL=https://yourdomain.com/api/v1/payments/wechat/refund/notify

# 生产环境
WECHAT_SANDBOX=false
```

## 🔍 配置验证

### 1. 检查配置状态

使用系统提供的配置检查接口：

```bash
GET /api/v1/payments/wechat/config
```

### 2. 管理员配置验证

```bash
POST /api/v1/payments/wechat/validate-config
Content-Type: application/json

{
  "config": {
    "appId": "wx1234567890abcdef",
    "mchId": "1234567890",
    "apiV3Key": "your_32_character_api_v3_key_here"
  }
}
```

### 3. 连接测试

```bash
POST /api/v1/payments/wechat/test-connection
```

## 🧪 测试流程

### 沙箱环境测试

1. **确保沙箱环境启用**
   ```bash
   WECHAT_SANDBOX=true
   ```

2. **测试支付接口**
   ```bash
   # 创建测试订单
   POST /api/v1/payments/wechat/create
   ```

3. **验证支付回调**
   - 使用微信开发者工具模拟支付
   - 检查系统是否收到回调通知

### 生产环境切换

1. **更新配置**
   ```bash
   WECHAT_SANDBOX=false
   ```

2. **添加证书配置**
   ```bash
   # 确保证书文件配置正确
   ```

3. **验证生产环境**
   ```bash
   POST /api/v1/payments/wechat/test-connection
   ```

## 🚨 常见问题

### 1. 配置错误排查

#### AppID格式错误
- **问题**: AppID格式不正确
- **解决**: 确保是 `wx` 开头的18位字符串

#### 商户号格式错误
- **问题**: 商户号格式不正确
- **解决**: 确保是10位数字

#### API密钥长度错误
- **问题**: APIv3密钥长度不是32位
- **解决**: 重新设置32位密钥

### 2. 证书问题

#### 证书解析失败
- **问题**: API证书格式错误
- **解决**: 确保证证内容完整，包含正确的BEGIN/END标记

#### 证书序列号错误
- **问题**: 证书序列号不匹配
- **解决**: 使用商户平台显示的准确序列号

### 3. 回调问题

#### 回调地址无法访问
- **问题**: 服务器无法访问回调地址
- **解决**:
   - 确保域名已备案
   - 检查防火墙设置
   - 验证HTTPS证书

#### 回调签名验证失败
- **问题**: 回调签名验证不通过
- **解决**:
   - 检查API密钥配置
   - 验证回调处理逻辑
   - 查看日志排查具体错误

## 📋 配置检查清单

### 基础配置
- [ ] 微信小程序AppID已获取
- [ ] 微信商户号已注册
- [ ] 小程序已关联商户

### API配置
- [ ] API v3密钥已设置（32位）
- [ ] 商户密钥已设置
- [ ] 沙箱/生产环境已选择

### 证书配置（生产环境）
- [ ] API证书已下载
- [ ] 证书私钥已配置
- [ ] 证书序列号已记录

### 回调配置
- [ ] 支付回调地址已设置
- [ ] 退款回调地址已设置
- [ ] 回调地址使用HTTPS
- [ ] 域名已备案
- [ ] 服务器可访问回调地址

### 环境变量
- [ ] .env文件已创建
- [ ] 所有必要环境变量已配置
- [ ] 敏感信息未暴露

## 🔒 安全建议

### 1. 密钥管理
- 使用密码管理工具存储密钥
- 定期更换API密钥
- 不要在代码中硬编码密钥

### 2. 证书安全
- 定期更新API证书
- 安全存储证书文件
- 监控证书过期时间

### 3. 网络安全
- 启用HTTPS协议
- 配置防火墙规则
- 实施IP白名单（可选）

### 4. 日志监控
- 启用详细日志记录
- 监控支付异常
- 设置异常告警

## 📞 技术支持

如果在配置过程中遇到问题，请联系：

1. **微信官方客服**
   - 微信小程序客服
   - 微信支付商户客服

2. **技术文档**
   - [微信支付开发文档](https://pay.weixin.qq.com/wiki/doc/apiv3/)
   - [小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/)

3. **社区支持**
   - 微信开发者社区
   - GitHub Issues

---

**更新时间**: 2025-11-19
**版本**: v1.0.0
**维护**: 开发团队