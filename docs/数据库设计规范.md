# ä¸­é“å•†åŸç³»ç»Ÿ - æ•°æ®åº“è®¾è®¡è§„èŒƒ

**æ–‡æ¡£ç›®çš„**ï¼šå®šä¹‰æ•°æ®åº“è®¾è®¡æ ‡å‡†ã€å‘½åè§„èŒƒå’Œæ ¸å¿ƒè¡¨ç»“æ„
**é€‚ç”¨èŒƒå›´**ï¼šæ‰€æœ‰æ•°æ®åº“è®¾è®¡ã€è¿ç§»å’Œç»´æŠ¤å·¥ä½œ
**æœ€åæ›´æ–°**ï¼š2025å¹´11æœˆ18æ—¥
**ç‰ˆæœ¬**ï¼š1.0

---

## ğŸ“‹ æ•°æ®åº“è®¾è®¡åŸåˆ™

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **ä¸šåŠ¡é©±åŠ¨è®¾è®¡**ï¼šè¡¨ç»“æ„å¿…é¡»ä¸¥æ ¼ç¬¦åˆä¸šåŠ¡é€»è¾‘
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šä½¿ç”¨å¤–é”®å’Œçº¦æŸç¡®ä¿æ•°æ®å®Œæ•´æ€§
3. **æ€§èƒ½ä¼˜å…ˆ**ï¼šåˆç†è®¾è®¡ç´¢å¼•ï¼Œä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
4. **æ‰©å±•æ€§è€ƒè™‘**ï¼šé¢„ç•™æ‰©å±•å­—æ®µï¼Œæ”¯æŒä¸šåŠ¡å¢é•¿
5. **å®‰å…¨æ€§ä¿éšœ**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨ï¼Œè®¿é—®æƒé™æ§åˆ¶

### åˆ†åº“ç­–ç•¥

```sql
-- ä¸šåŠ¡é¢†åŸŸåˆ†åº“
user_db      -- ç”¨æˆ·ä½“ç³»ï¼ˆç”¨æˆ·ã€ç­‰çº§ã€å›¢é˜Ÿï¼‰
shop_db      -- åº—é“ºä½“ç³»ï¼ˆåº—é“ºã€å•†å“ã€åº“å­˜ï¼‰
order_db     -- è®¢å•ä½“ç³»ï¼ˆè®¢å•ã€ç‰©æµã€æ”¯ä»˜ï¼‰
finance_db   -- è´¢åŠ¡ä½“ç³»ï¼ˆé€šåˆ¸ã€å……å€¼ã€æç°ï¼‰
log_db       -- æ—¥å¿—ä½“ç³»ï¼ˆæ“ä½œæ—¥å¿—ã€å®¡è®¡æ—¥å¿—ï¼‰
```

---

## ğŸ—„ï¸ æ ¸å¿ƒè¡¨ç»“æ„è®¾è®¡

### ç”¨æˆ·ä½“ç³»è¡¨ï¼ˆuser_dbï¼‰

#### users - ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
```sql
CREATE TABLE users (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
  openid VARCHAR(128) NOT NULL COMMENT 'å¾®ä¿¡openid',
  unionid VARCHAR(128) DEFAULT NULL COMMENT 'å¾®ä¿¡unionid',
  nickname VARCHAR(100) DEFAULT NULL COMMENT 'æ˜µç§°',
  avatar_url TEXT DEFAULT NULL COMMENT 'å¤´åƒURL',
  phone VARCHAR(20) DEFAULT NULL COMMENT 'æ‰‹æœºå·',
  real_name VARCHAR(50) DEFAULT NULL COMMENT 'çœŸå®å§“å',
  id_card VARCHAR(18) DEFAULT NULL COMMENT 'èº«ä»½è¯å·',

  -- ç”¨æˆ·ç­‰çº§ä¿¡æ¯
  level ENUM('normal', 'vip', 'star_1', 'star_2', 'star_3', 'star_4', 'star_5', 'director') NOT NULL DEFAULT 'normal' COMMENT 'ç”¨æˆ·ç­‰çº§',
  level_path VARCHAR(200) DEFAULT NULL COMMENT 'ç­‰çº§å‡çº§è·¯å¾„',
  level_earned_at TIMESTAMP NULL COMMENT 'å½“å‰ç­‰çº§è·å¾—æ—¶é—´',
  level_upgrade_count INT DEFAULT 0 COMMENT 'å‡çº§æ¬¡æ•°',

  -- ä¸šç»©ç»Ÿè®¡
  total_sales DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ç´¯è®¡é”€å”®é¢',
  total_bottles INT DEFAULT 0 COMMENT 'ç´¯è®¡é”€å”®ç“¶æ•°ï¼ˆæŒ‰599å…ƒè®¡ç®—ï¼‰',
  direct_sales DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ç›´æ¨é”€å”®é¢',
  team_sales DECIMAL(15,2) DEFAULT 0.00 COMMENT 'å›¢é˜Ÿé”€å”®é¢',

  -- å›¢é˜Ÿç»“æ„
  parent_id BIGINT UNSIGNED DEFAULT NULL COMMENT 'æ¨èäººID',
  team_path VARCHAR(500) DEFAULT '/' COMMENT 'å›¢é˜Ÿè·¯å¾„',
  team_level INT DEFAULT 1 COMMENT 'å›¢é˜Ÿå±‚çº§',
  direct_count INT DEFAULT 0 COMMENT 'ç›´æ¨äººæ•°',
  team_count INT DEFAULT 0 COMMENT 'å›¢é˜Ÿäººæ•°',

  -- çŠ¶æ€ä¿¡æ¯
  status ENUM('active', 'inactive', 'suspended') NOT NULL DEFAULT 'active',
  last_login_at TIMESTAMP NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL DEFAULT NULL,

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_openid` (`openid`),
  UNIQUE KEY `uk_phone` (`phone`),
  KEY `idx_level` (`level`),
  KEY `idx_parent_id` (`parent_id`),
  KEY `idx_team_path` (`team_path`(255)),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_deleted_at` (`deleted_at`),
  KEY `idx_status` (`status`),

  INDEX `idx_performance` (`level`, `total_sales`, `team_sales`),
  INDEX `idx_team_structure` (`parent_id`, `team_level`),

  FOREIGN KEY (`parent_id`) REFERENCES `users`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨';
```

#### user_level_records - ç”¨æˆ·ç­‰çº§å˜æ›´è®°å½•è¡¨
```sql
CREATE TABLE user_level_records (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID',
  from_level ENUM('normal', 'vip', 'star_1', 'star_2', 'star_3', 'star_4', 'star_5', 'director') NOT NULL COMMENT 'åŸç­‰çº§',
  to_level ENUM('normal', 'vip', 'star_1', 'star_2', 'star_3', 'star_4', 'star_5', 'director') NOT NULL COMMENT 'æ–°ç­‰çº§',
  upgrade_type ENUM('auto', 'manual', 'wutong_direct') NOT NULL COMMENT 'å‡çº§ç±»å‹',
  sales_at_upgrade DECIMAL(15,2) DEFAULT 0.00 COMMENT 'å‡çº§æ—¶é”€å”®é¢',
  bottles_at_upgrade INT DEFAULT 0 COMMENT 'å‡çº§æ—¶ç“¶æ•°',
  team_structure_at_upgrade JSON DEFAULT NULL COMMENT 'å‡çº§æ—¶å›¢é˜Ÿç»“æ„',
  approved_by BIGINT UNSIGNED DEFAULT NULL COMMENT 'å®¡æ‰¹äººID',
  approved_at TIMESTAMP NULL DEFAULT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_upgrade_type` (`upgrade_type`),
  KEY `idx_created_at` (`created_at`),

  FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`approved_by`) REFERENCES `users`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·ç­‰çº§å˜æ›´è®°å½•è¡¨';
```

### åº—é“ºä½“ç³»è¡¨ï¼ˆshop_dbï¼‰

#### shops - åº—é“ºä¿¡æ¯è¡¨
```sql
CREATE TABLE shops (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL COMMENT 'åº—ä¸»ID',
  shop_name VARCHAR(200) NOT NULL COMMENT 'åº—é“ºåç§°',
  shop_type ENUM('cloud', 'wutong') NOT NULL COMMENT 'åº—é“ºç±»å‹',
  shop_level TINYINT DEFAULT 1 COMMENT 'åº—é“ºæ˜Ÿçº§ï¼ˆäº‘åº—ä¸“ç”¨ï¼‰',
  shop_status ENUM('pending', 'active', 'inactive', 'suspended') DEFAULT 'pending',

  -- äº‘åº—é”€é‡ç´¯ç§¯
  cloud_cumulative_sales DECIMAL(15,2) DEFAULT 0.00 COMMENT 'äº‘åº—ç´¯è®¡é”€å”®é¢',
  cloud_cumulative_bottles INT DEFAULT 0 COMMENT 'äº‘åº—ç´¯è®¡é”€å”®ç“¶æ•°',
  cloud_level_updated_at TIMESTAMP NULL COMMENT 'äº‘åº—ç­‰çº§æ›´æ–°æ—¶é—´',

  -- äº”é€šåº—ç‰¹æ®Šå­—æ®µ
  wutong_purchase_count INT DEFAULT 0 COMMENT 'äº”é€šåº—è´­ä¹°æ•°é‡',
  wutong_free_count INT DEFAULT 0 COMMENT 'äº”é€šåº—èµ é€æ•°é‡',
  wutong_total_count INT DEFAULT 0 COMMENT 'äº”é€šåº—æ€»æ•°é‡',
  wutong_earned_at TIMESTAMP NULL COMMENT 'äº”é€šåº—è·å¾—æ—¶é—´',

  -- ç”³è¯·ææ–™
  business_license TEXT DEFAULT NULL COMMENT 'è¥ä¸šæ‰§ç…§',
  id_card_front TEXT DEFAULT NULL COMMENT 'èº«ä»½è¯æ­£é¢',
  id_card_back TEXT DEFAULT NULL COMMENT 'èº«ä»½è¯èƒŒé¢',
  agreement_files JSON DEFAULT NULL COMMENT 'åè®®æ–‡ä»¶',
  agreement_signed BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç­¾ç½²åè®®',

  -- å®¡æ ¸ä¿¡æ¯
  approved_at TIMESTAMP NULL DEFAULT NULL COMMENT 'å®¡æ ¸é€šè¿‡æ—¶é—´',
  approved_by BIGINT UNSIGNED DEFAULT NULL COMMENT 'å®¡æ ¸äººID',
  reject_reason TEXT DEFAULT NULL COMMENT 'æ‹’ç»åŸå› ',

  -- åº—é“ºè®¾ç½®
  description TEXT DEFAULT NULL COMMENT 'åº—é“ºæè¿°',
  banner_image TEXT DEFAULT NULL COMMENT 'åº—é“ºæ¨ªå¹…',
  contact_phone VARCHAR(20) DEFAULT NULL COMMENT 'è”ç³»ç”µè¯',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL DEFAULT NULL,

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_shop_type` (`shop_type`),
  KEY `idx_shop_status` (`shop_status`),
  KEY `idx_shop_level` (`shop_level`),
  KEY `idx_approved_at` (`approved_at`),

  INDEX `idx_performance` (`shop_type`, `cloud_cumulative_sales`),

  FOREIGN KEY (`user_id`) REFERENCES `user_db.users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`approved_by`) REFERENCES `user_db.users`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åº—é“ºä¿¡æ¯è¡¨';
```

### å•†å“ä½“ç³»è¡¨ï¼ˆshop_dbï¼‰

#### products - å•†å“ä¿¡æ¯è¡¨
```sql
CREATE TABLE products (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  product_code VARCHAR(50) NOT NULL COMMENT 'å•†å“ç¼–ç ',
  product_name VARCHAR(200) NOT NULL COMMENT 'å•†å“åç§°',
  product_category ENUM('wutong_series', 'smart_wearable', 'member_only') NOT NULL COMMENT 'å•†å“åˆ†ç±»',
  product_type ENUM('pattern', 'non_pattern') NOT NULL COMMENT 'å•†å“ç±»å‹ï¼šæ¨¡å¼å•†å“/éæ¨¡å¼å•†å“',

  -- ä»·æ ¼ä¿¡æ¯
  original_price DECIMAL(10,2) NOT NULL COMMENT 'åŸä»·',
  current_price DECIMAL(10,2) NOT NULL COMMENT 'ç°ä»·',

  -- äº”é€šå‡è¡¥ç³»åˆ—ç‰¹æ®Šä»·æ ¼
  wutong_price_199 DECIMAL(10,2) DEFAULT NULL COMMENT 'è‚ é“é€šä»·æ ¼ï¼ˆ199å…ƒæ¡£ï¼‰',
  wutong_price_499 DECIMAL(10,2) DEFAULT NULL COMMENT 'è¡€è„‰é€šä»·æ ¼ï¼ˆ499å…ƒæ¡£ï¼‰',
  wutong_price_599 DECIMAL(10,2) DEFAULT NULL COMMENT 'ç»ç»œé€šä»·æ ¼ï¼ˆ599å…ƒæ¡£ï¼‰',
  wutong_price_699 DECIMAL(10,2) DEFAULT NULL COMMENT 'æ°”è„‰é€šä»·æ ¼ï¼ˆ699å…ƒæ¡£ï¼‰',
  wutong_price_2999 DECIMAL(10,2) DEFAULT NULL COMMENT 'è„è…‘é€š/æ·‹å·´é€šä»·æ ¼ï¼ˆ2999å…ƒæ¡£ï¼‰',

  -- äº”é€šåº—ç‰¹æ®Šä»·æ ¼
  wutong_shop_price DECIMAL(10,2) DEFAULT 270.00 COMMENT 'äº”é€šåº—ä»·æ ¼ï¼ˆ270å…ƒæ¡£ï¼‰',

  -- å•†å“å±æ€§
  product_images JSON DEFAULT NULL COMMENT 'å•†å“å›¾ç‰‡',
  product_description TEXT DEFAULT NULL COMMENT 'å•†å“æè¿°',
  product_specifications JSON DEFAULT NULL COMMENT 'å•†å“è§„æ ¼',

  -- åº“å­˜ä¿¡æ¯
  total_inventory INT DEFAULT 0 COMMENT 'æ€»åº“å­˜',
  available_inventory INT DEFAULT 0 COMMENT 'å¯ç”¨åº“å­˜',
  reserved_inventory INT DEFAULT 0 COMMENT 'é¢„ç•™åº“å­˜',

  -- é”€å”®ç»Ÿè®¡
  total_sales INT DEFAULT 0 COMMENT 'æ€»é”€é‡',
  month_sales INT DEFAULT 0 COMMENT 'æœ¬æœˆé”€é‡',

  -- çŠ¶æ€ä¿¡æ¯
  status ENUM('active', 'inactive', 'discontinued') DEFAULT 'active',
  sort_order INT DEFAULT 0 COMMENT 'æ’åºæƒé‡',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  deleted_at TIMESTAMP NULL DEFAULT NULL,

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_product_code` (`product_code`),
  KEY `idx_product_category` (`product_category`),
  KEY `idx_product_type` (`product_type`),
  KEY `idx_status` (`status`),
  KEY `idx_sort_order` (`sort_order`),
  KEY `idx_created_at` (`created_at`),

  INDEX `idx_price_range` (`original_price`, `current_price`),
  INDEX `idx_sales_performance` (`total_sales`, `month_sales`),

  FOREIGN KEY (`created_by`) REFERENCES `user_db.users`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='å•†å“ä¿¡æ¯è¡¨';
```

### é‡‡è´­ä½“ç³»è¡¨ï¼ˆorder_dbï¼‰

#### purchases - é‡‡è´­è®°å½•è¡¨
```sql
CREATE TABLE purchases (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  purchase_no VARCHAR(64) NOT NULL COMMENT 'é‡‡è´­å•å·',
  buyer_id BIGINT UNSIGNED NOT NULL COMMENT 'é‡‡è´­æ–¹ID',
  seller_id BIGINT UNSIGNED NOT NULL COMMENT 'é”€å”®æ–¹ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT 'å•†å“ID',
  product_name VARCHAR(200) NOT NULL COMMENT 'å•†å“åç§°',
  quantity INT NOT NULL COMMENT 'é‡‡è´­æ•°é‡',
  unit_price DECIMAL(10,2) NOT NULL COMMENT 'å•ä»·',
  total_amount DECIMAL(15,2) NOT NULL COMMENT 'æ€»é‡‘é¢',

  -- æ”¯ä»˜ä¿¡æ¯
  points_used DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ä½¿ç”¨é€šåˆ¸é‡‘é¢',
  cash_amount DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ç°é‡‘é‡‘é¢',
  payment_method ENUM('points', 'cash', 'mixed') DEFAULT 'points',

  -- é‡‡è´­é“¾è·¯å’Œä½£é‡‘
  purchase_chain JSON DEFAULT NULL COMMENT 'é‡‡è´­é“¾è·¯ä¿¡æ¯',
  commission_rules JSON DEFAULT NULL COMMENT 'ä½£é‡‘è§„åˆ™',
  commissions JSON DEFAULT NULL COMMENT 'ä½£é‡‘åˆ†é…ç»“æœ',
  direct_bonus_amount DECIMAL(10,2) DEFAULT 0.00 COMMENT 'ç›´æ¨å¥–åŠ±é‡‘é¢',
  middleman_commission_total DECIMAL(15,2) DEFAULT 0.00 COMMENT 'ä¸­é—´äººä½£é‡‘æ€»è®¡',

  -- çŠ¶æ€å’Œæ—¶é—´
  status ENUM('pending', 'processing', 'completed', 'cancelled', 'failed') DEFAULT 'pending',
  priority ENUM('low', 'normal', 'high', 'urgent') DEFAULT 'normal',
  completed_at TIMESTAMP NULL DEFAULT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_purchase_no` (`purchase_no`),
  KEY `idx_buyer_id` (`buyer_id`),
  KEY `idx_seller_id` (`seller_id`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_priority` (`priority`),

  INDEX `idx_purchase_performance` (`buyer_id`, `status`, `created_at`),
  INDEX `idx_commission_analysis` (`seller_id`, `commissions`),

  FOREIGN KEY (`buyer_id`) REFERENCES `user_db.users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`seller_id`) REFERENCES `user_db.users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`product_id`) REFERENCES `shop_db.products`(`id`) ON DELETE RESTRICT
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='é‡‡è´­è®°å½•è¡¨';
```

### é€šåˆ¸ä½“ç³»è¡¨ï¼ˆfinance_dbï¼‰

#### points_accounts - é€šåˆ¸è´¦æˆ·è¡¨
```sql
CREATE TABLE points_accounts (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  balance DECIMAL(15,2) NOT NULL DEFAULT 0.00 COMMENT 'å¯ç”¨ä½™é¢',
  frozen_balance DECIMAL(15,2) NOT NULL DEFAULT 0.00 COMMENT 'å†»ç»“ä½™é¢',

  -- ç»Ÿè®¡ä¿¡æ¯
  total_recharged DECIMAL(15,2) NOT NULL DEFAULT 0.00 COMMENT 'ç´¯è®¡å……å€¼',
  total_withdrawn DECIMAL(15,2) NOT NULL DEFAULT 0.00 COMMENT 'ç´¯è®¡æç°',
  total_earned DECIMAL(15,2) NOT NULL DEFAULT 0.00 COMMENT 'ç´¯è®¡è·å¾—',
  total_spent DECIMAL(15,2) NOT NULL DEFAULT 0.00 COMMENT 'ç´¯è®¡æ¶ˆè´¹',

  -- å……å€¼æƒé™
  recharge_enabled BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å…è®¸å……å€¼',
  recharge_limit DECIMAL(15,2) DEFAULT 0.00 COMMENT 'å……å€¼é™é¢',

  -- å®‰å…¨ä¿¡æ¯
  last_recharge_at TIMESTAMP NULL COMMENT 'æœ€åå……å€¼æ—¶é—´',
  last_withdraw_at TIMESTAMP NULL COMMENT 'æœ€åæç°æ—¶é—´',
  last_transaction_at TIMESTAMP NULL COMMENT 'æœ€åäº¤æ˜“æ—¶é—´',

  version INT NOT NULL DEFAULT 1 COMMENT 'ä¹è§‚é”ç‰ˆæœ¬å·',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_balance` (`balance`),
  KEY `idx_updated_at` (`updated_at`),
  KEY `idx_recharge_enabled` (`recharge_enabled`),

  INDEX `idx_user_activity` (`last_transaction_at`, `total_recharged`),

  FOREIGN KEY (`user_id`) REFERENCES `user_db.users`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='é€šåˆ¸è´¦æˆ·è¡¨';
```

#### points_transactions - é€šåˆ¸æµæ°´è¡¨
```sql
CREATE TABLE points_transactions (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL,
  transaction_no VARCHAR(64) NOT NULL COMMENT 'äº¤æ˜“æµæ°´å·',
  transaction_type ENUM('recharge', 'withdraw', 'transfer_in', 'transfer_out', 'purchase_payment', 'purchase_income', 'commission', 'bonus', 'gift', 'adjust') NOT NULL,

  -- é‡‘é¢ä¿¡æ¯
  amount DECIMAL(15,2) NOT NULL COMMENT 'äº¤æ˜“é‡‘é¢',
  balance_before DECIMAL(15,2) NOT NULL COMMENT 'äº¤æ˜“å‰ä½™é¢',
  balance_after DECIMAL(15,2) NOT NULL COMMENT 'äº¤æ˜“åä½™é¢',

  -- å…³è”ä¿¡æ¯
  related_user_id BIGINT UNSIGNED DEFAULT NULL COMMENT 'ç›¸å…³ç”¨æˆ·ID',
  order_id BIGINT UNSIGNED DEFAULT NULL COMMENT 'ç›¸å…³è®¢å•ID',
  purchase_id BIGINT UNSIGNED DEFAULT NULL COMMENT 'ç›¸å…³é‡‡è´­ID',
  shop_id BIGINT UNSIGNED DEFAULT NULL COMMENT 'ç›¸å…³åº—é“ºID',

  -- æè¿°å’Œæ‰©å±•
  description VARCHAR(500) DEFAULT NULL COMMENT 'äº¤æ˜“æè¿°',
  extra_data JSON DEFAULT NULL COMMENT 'æ‰©å±•æ•°æ®',

  -- çŠ¶æ€
  status ENUM('pending', 'success', 'failed', 'cancelled') DEFAULT 'success',

  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_transaction_no` (`transaction_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_transaction_type` (`transaction_type`),
  KEY `idx_related_user` (`related_user_id`),
  KEY `idx_created_at` (`created_at`),
  KEY `idx_status` (`status`),

  INDEX `idx_user_transactions` (`user_id`, `transaction_type`, `created_at`),
  INDEX `idx_related_transactions` (`related_user_id`, `created_at`),

  FOREIGN KEY (`user_id`) REFERENCES `user_db.users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`related_user_id`) REFERENCES `user_db.users`(`id`) ON DELETE SET NULL,
  FOREIGN KEY (`order_id`) REFERENCES `order_db.orders`(`id`) ON DELETE SET NULL,
  FOREIGN KEY (`purchase_id`) REFERENCES `order_db.purchases`(`id`) ON DELETE SET NULL,
  FOREIGN KEY (`shop_id`) REFERENCES `shop_db.shops`(`id`) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='é€šåˆ¸æµæ°´è¡¨';
```

### åº“å­˜ä½“ç³»è¡¨ï¼ˆshop_dbï¼‰

#### inventory - åº“å­˜è¡¨
```sql
CREATE TABLE inventory (
  id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  user_id BIGINT UNSIGNED NOT NULL COMMENT 'åº“å­˜æ‰€æœ‰è€…ID',
  product_id BIGINT UNSIGNED NOT NULL COMMENT 'å•†å“ID',
  warehouse_type ENUM('cloud', 'local') NOT NULL COMMENT 'ä»“åº“ç±»å‹',
  quantity INT NOT NULL DEFAULT 0 COMMENT 'åº“å­˜æ•°é‡',
  frozen_quantity INT DEFAULT 0 COMMENT 'å†»ç»“æ•°é‡',
  available_quantity INT GENERATED ALWAYS AS (quantity - frozen_quantity) STORED COMMENT 'å¯ç”¨æ•°é‡',

  -- åº“å­˜æ¥æºè¿½è¸ª
  source_type ENUM('purchase', 'transfer', 'gift', 'adjust') DEFAULT 'purchase',
  source_id BIGINT UNSIGNED DEFAULT NULL COMMENT 'æ¥æºID',

  -- æˆæœ¬ä¿¡æ¯
  unit_cost DECIMAL(10,2) DEFAULT NULL COMMENT 'å•ä½æˆæœ¬',
  total_cost DECIMAL(15,2) DEFAULT NULL COMMENT 'æ€»æˆæœ¬',

  -- é¢„è­¦ä¿¡æ¯
  warning_threshold INT DEFAULT 10 COMMENT 'é¢„è­¦é˜ˆå€¼',
  last_warning_at TIMESTAMP NULL COMMENT 'æœ€åé¢„è­¦æ—¶é—´',

  last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_product_warehouse` (`user_id`, `product_id`, `warehouse_type`),
  KEY `idx_warehouse_type` (`warehouse_type`),
  KEY `idx_quantity` (`quantity`),
  KEY `idx_available_quantity` (`available_quantity`),
  KEY `idx_product_id` (`product_id`),

  INDEX `idx_user_inventory` (`user_id`, `warehouse_type`, `available_quantity`),
  INDEX `idx_product_inventory` (`product_id`, `available_quantity`),
  INDEX `idx_warning_monitor` (`available_quantity`, `warning_threshold`),

  FOREIGN KEY (`user_id`) REFERENCES `user_db.users`(`id`) ON DELETE CASCADE,
  FOREIGN KEY (`product_id`) REFERENCES `shop_db.products`(`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åº“å­˜è¡¨';
```

---

## ğŸ“ å‘½åè§„èŒƒ

### è¡¨å‘½åè§„èŒƒ

```sql
-- è¡¨åï¼šå°å†™å­—æ¯+ä¸‹åˆ’çº¿ï¼Œå¤æ•°å½¢å¼
users, shops, products, orders, points_transactions

-- è§†å›¾åï¼šå°å†™å­—æ¯+ä¸‹åˆ’çº¿ï¼Œä»¥v_å¼€å¤´
v_user_performance, v_shop_statistics, v_monthly_sales

-- å­˜å‚¨è¿‡ç¨‹åï¼šå°å†™å­—æ¯+ä¸‹åˆ’çº¿ï¼Œä»¥sp_å¼€å¤´
sp_calculate_user_level, sp_generate_monthly_report

-- è§¦å‘å™¨åï¼šå°å†™å­—æ¯+ä¸‹åˆ’çº¿ï¼Œä»¥trg_å¼€å¤´
trg_update_user_level, trg_log_points_transaction
```

### å­—æ®µå‘½åè§„èŒƒ

```sql
-- ä¸»é”®ï¼šid
id BIGINT PRIMARY KEY AUTO_INCREMENT

-- å¤–é”®ï¼šè¡¨å+id
user_id, shop_id, order_id, product_id

-- å¸ƒå°”å­—æ®µï¼šis_/has_
is_active, has_permission, is_deleted

-- æ—¶é—´å­—æ®µï¼šcreated_at, updated_at, deleted_at
created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
deleted_at TIMESTAMP NULL DEFAULT NULL

-- çŠ¶æ€å­—æ®µï¼šstatus, type
status ENUM('active', 'inactive'), type ENUM('cloud', 'local')

-- é‡‘é¢å­—æ®µï¼šä½¿ç”¨DECIMALï¼Œä¿ç•™2ä½å°æ•°
price DECIMAL(10,2), amount DECIMAL(15,2)

-- æ•°é‡å­—æ®µï¼šä½¿ç”¨INT
quantity INT DEFAULT 0, count INT DEFAULT 0

-- æ–‡æœ¬å­—æ®µï¼šTEXTç”¨äºé•¿æ–‡æœ¬ï¼ŒVARCHARç”¨äºçŸ­æ–‡æœ¬
description TEXT, name VARCHAR(100)
```

### ç´¢å¼•å‘½åè§„èŒƒ

```sql
-- ä¸»é”®ç´¢å¼•ï¼špk_è¡¨å
pk_users

-- å”¯ä¸€ç´¢å¼•ï¼šuk_å­—æ®µå
uk_email, uk_phone

-- æ™®é€šç´¢å¼•ï¼šidx_å­—æ®µå
idx_status, idx_created_at

-- å¤åˆç´¢å¼•ï¼šidx_å­—æ®µå1_å­—æ®µå2
idx_user_status_created, idx_product_category_status

-- å…¨æ–‡ç´¢å¼•ï¼šft_å­—æ®µå
ft_product_name, ft_content
```

---

## ğŸ› ï¸ ç´¢å¼•è®¾è®¡ç­–ç•¥

### å¿…éœ€ç´¢å¼•

```sql
-- æ¯ä¸ªè¡¨éƒ½å¿…é¡»æœ‰çš„ç´¢å¼•
PRIMARY KEY (`id`)

-- å¤–é”®å­—æ®µç´¢å¼•
INDEX `idx_user_id` (`user_id`),
INDEX `idx_parent_id` (`parent_id`),

-- çŠ¶æ€å­—æ®µç´¢å¼•
INDEX `idx_status` (`status`),

-- æ—¶é—´å­—æ®µç´¢å¼•
INDEX `idx_created_at` (`created_at`),
INDEX `idx_updated_at` (`updated_at`),

-- è½¯åˆ é™¤ç´¢å¼•
INDEX `idx_deleted_at` (`deleted_at`);
```

### ä¸šåŠ¡æŸ¥è¯¢ç´¢å¼•

```sql
-- ç”¨æˆ·ç­‰çº§æŸ¥è¯¢
INDEX `idx_user_performance` (`level`, `total_sales`, `team_sales`);

-- å›¢é˜ŸæŸ¥è¯¢
INDEX `idx_team_structure` (`parent_id`, `team_level`);

-- é‡‡è´­æŸ¥è¯¢
INDEX `idx_purchase_analysis` (`buyer_id`, `seller_id`, `status`, `created_at`);

-- é€šåˆ¸æµæ°´æŸ¥è¯¢
INDEX `idx_points_flow` (`user_id`, `transaction_type`, `created_at`);

-- åº“å­˜æŸ¥è¯¢
INDEX `idx_inventory_available` (`product_id`, `available_quantity`);
```

### å¤åˆç´¢å¼•ä¼˜åŒ–

```sql
-- éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™
INDEX `idx_user_status_level` (`status`, `level`);

-- é«˜é¢‘æŸ¥è¯¢å­—æ®µä¼˜å…ˆ
INDEX `idx_purchase_buyer_status` (`buyer_id`, `status`, `created_at`);

-- é€‰æ‹©æ€§é«˜çš„å­—æ®µä¼˜å…ˆ
INDEX `idx_user_phone` (`phone`, `status`);
```

---

## ğŸ”’ æ•°æ®å®‰å…¨è§„èŒƒ

### æ•æ„Ÿæ•°æ®åŠ å¯†

```sql
-- æ‰‹æœºå·åŠ å¯†å­˜å‚¨
phone VARCHAR(100) DEFAULT NULL COMMENT 'åŠ å¯†æ‰‹æœºå·'

-- èº«ä»½è¯å·åŠ å¯†å­˜å‚¨
id_card VARCHAR(200) DEFAULT NULL COMMENT 'åŠ å¯†èº«ä»½è¯å·'

-- é“¶è¡Œå¡å·åŠ å¯†å­˜å‚¨
bank_card VARCHAR(200) DEFAULT NULL COMMENT 'åŠ å¯†é“¶è¡Œå¡å·'
```

### è®¿é—®æ§åˆ¶

```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER 'readonly'@'%' IDENTIFIED BY 'readonly_password';
GRANT SELECT ON zhongdao_mall.* TO 'readonly'@'%';

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER 'app_user'@'%' IDENTIFIED BY 'app_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON zhongdao_mall.* TO 'app_user'@'%';

-- åˆ›å»ºå¤‡ä»½ç”¨æˆ·
CREATE USER 'backup_user'@'%' IDENTIFIED BY 'backup_password';
GRANT SELECT, LOCK TABLES ON zhongdao_mall.* TO 'backup_user'@'%';
```

### æ•°æ®å¤‡ä»½ç­–ç•¥

```sql
-- å…¨é‡å¤‡ä»½è„šæœ¬
mysqldump -u root -p \
  --single-transaction \
  --routines \
  --triggers \
  --all-databases > backup_$(date +%Y%m%d_%H%M%S).sql

-- å¢é‡å¤‡ä»½è„šæœ¬
mysqldump -u root -p \
  --single-transaction \
  --incremental \
  --flush-logs \
  --master-data=2 \
  zhongdao_mall > incremental_backup_$(date +%Y%m%d_%H%M%S).sql
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–å»ºè®®

### æŸ¥è¯¢ä¼˜åŒ–

```sql
-- é¿å…SELECT *
SELECT id, name, status FROM users WHERE status = 'active';

-- ä½¿ç”¨LIMITé™åˆ¶ç»“æœé›†
SELECT * FROM orders WHERE user_id = ? ORDER BY created_at DESC LIMIT 10;

-- ä½¿ç”¨ç´¢å¼•è¦†ç›–æŸ¥è¯¢
SELECT id, status FROM products WHERE category = 'wutong_series' AND status = 'active';

-- é¿å…åœ¨WHEREå­å¥ä¸­å¯¹å­—æ®µè¿›è¡Œå‡½æ•°æ“ä½œ
-- é”™è¯¯ï¼šWHERE YEAR(created_at) = 2023
-- æ­£ç¡®ï¼šWHERE created_at >= '2023-01-01' AND created_at < '2024-01-01'
```

### è¡¨è®¾è®¡ä¼˜åŒ–

```sql
-- ä½¿ç”¨åˆé€‚çš„æ•°æ®ç±»å‹
TINYINT vs INT vs BIGINT
VARCHAR(100) vs TEXT
DECIMAL(10,2) vs FLOAT

-- åˆç†ä½¿ç”¨NOT NULLçº¦æŸ
status ENUM('active','inactive') NOT NULL DEFAULT 'active'

-- ä½¿ç”¨JSONå­—æ®µå­˜å‚¨éç»“æ„åŒ–æ•°æ®
metadata JSON DEFAULT NULL

-- è€ƒè™‘åˆ†åŒºè¡¨ï¼ˆå¤§æ•°æ®é‡è¡¨ï¼‰
CREATE TABLE orders (
  ...
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (id, created_at)
) PARTITION BY RANGE (YEAR(created_at)) (
  PARTITION p2023 VALUES LESS THAN (2024),
  PARTITION p2024 VALUES LESS THAN (2025),
  PARTITION p2025 VALUES LESS THAN (2026),
  PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

---

## ğŸ”„ è¿ç§»ç‰ˆæœ¬ç®¡ç†

### è¿ç§»æ–‡ä»¶å‘½å

```bash
# æ ¼å¼ï¼šYYYYMMDD_HHMMSS_description.sql
20231118_143000_create_users_table.sql
20231118_150000_add_user_level_records.sql
20231118_160000_add_indexes.sql
```

### è¿ç§»è„šæœ¬æ¨¡æ¿

```sql
-- è¿ç§»è„šæœ¬æ¨¡æ¿
-- Migration: 20231118_143000_create_users_table.sql
-- Description: åˆ›å»ºç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨

-- å¼€å§‹äº‹åŠ¡
BEGIN;

-- åˆ›å»ºè¡¨
CREATE TABLE users (
  ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_status ON users(status);

-- æ’å…¥åˆå§‹æ•°æ®
INSERT INTO users (id, openid, nickname, level, status)
VALUES (1, 'test_openid', 'æµ‹è¯•ç”¨æˆ·', 'normal', 'active');

-- æäº¤äº‹åŠ¡
COMMIT;

-- å›æ»šè„šæœ¬ï¼ˆå¯é€‰ï¼‰
-- DROP TABLE IF EXISTS users;
```

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### è¡¨è®¾è®¡æ£€æŸ¥

- [ ] æ‰€æœ‰è¡¨éƒ½æœ‰ä¸»é”®
- [ ] å¤–é”®å…³ç³»æ­£ç¡®å»ºç«‹
- [ ] å¿…è¦ç´¢å¼•å·²åˆ›å»º
- [ ] æ—¶é—´å­—æ®µæ­£ç¡®è®¾ç½®
- [ ] è½¯åˆ é™¤æœºåˆ¶å·²å®ç°
- [ ] æ•æ„Ÿæ•°æ®å·²åŠ å¯†
- [ ] å­—ç¬¦é›†è®¾ç½®ä¸ºutf8mb4

### æ€§èƒ½æ£€æŸ¥

- [ ] å¤§è¡¨è€ƒè™‘åˆ†åŒº
- [ ] å¤æ‚æŸ¥è¯¢æœ‰å¯¹åº”ç´¢å¼•
- [ ] é¿å…ä½¿ç”¨SELECT *
- [ ] åˆç†ä½¿ç”¨JOIN
- [ ] å®šæœŸç»´æŠ¤ç»Ÿè®¡ä¿¡æ¯

### å®‰å…¨æ£€æŸ¥

- [ ] æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–
- [ ] å®šæœŸå¤‡ä»½æ•°æ®
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- [ ] è®¿é—®æ—¥å¿—è®°å½•å®Œæ•´
- [ ] å®šæœŸå®‰å…¨å®¡è®¡

---

**é‡è¦æé†’**ï¼š
1. ä»»ä½•è¡¨ç»“æ„å˜æ›´å¿…é¡»ç»è¿‡æ¶æ„å¸ˆAIå®¡æŸ¥
2. ç”Ÿäº§ç¯å¢ƒå˜æ›´å¿…é¡»æœ‰å®Œæ•´å›æ»šæ–¹æ¡ˆ
3. å®šæœŸç›‘æ§æ•°æ®åº“æ€§èƒ½å’Œæ…¢æŸ¥è¯¢
4. ä¿æŒæ•°æ®å­—å…¸çš„åŠæ—¶æ›´æ–°