# å‚æ•°é…ç½®ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸš€ ç³»ç»Ÿæ¦‚è¿°

ä¸­é“å•†åŸçš„å‚æ•°é…ç½®ç³»ç»Ÿæ˜¯ä¸€ä¸ªå¼ºå¤§çš„åŠ¨æ€é…ç½®ç®¡ç†å·¥å…·ï¼Œå…è®¸æ‚¨åœ¨ä¸é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹å®æ—¶ä¿®æ”¹ä¸šåŠ¡å‚æ•°ã€‚

### æ ¸å¿ƒä¼˜åŠ¿
- âœ… **å®æ—¶ç”Ÿæ•ˆ**: ä¿®æ”¹å‚æ•°ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯åº”ç”¨
- âœ… **é«˜æ€§èƒ½**: 5åˆ†é’Ÿå†…å­˜ç¼“å­˜ï¼Œè¯»å–é€Ÿåº¦æå¿«
- âœ… **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹æ”¯æŒ
- âœ… **åˆ†ç±»ç®¡ç†**: æŒ‰ä¸šåŠ¡æ¨¡å—åˆ†ç±»ç®¡ç†å‚æ•°
- âœ… **æ“ä½œæ—¥å¿—**: è®°å½•å‚æ•°ä¿®æ”¹å†å²
- âœ… **é»˜è®¤å€¼**: æ”¯æŒå‚æ•°é»˜è®¤å€¼å›é€€

---

## ğŸ“‹ å·²é…ç½®çš„å‚æ•°åˆ†ç±»

### 1ï¸âƒ£ ä½£é‡‘é…ç½® (commission)
```json
{
  "commission_personal_rate": 0.05,           // ä¸ªäººé”€å”®ä½£é‡‘æ¯”ä¾‹ 5%
  "commission_direct_referral_rate": 0.02,   // ç›´æ¨ä½£é‡‘æ¯”ä¾‹ 2%
  "commission_indirect_referral_rate": 0.01, // é—´æ¥æ¨èä½£é‡‘æ¯”ä¾‹ 1%
  "commission_team_bonus_rate": 0.03,        // å›¢é˜Ÿå¥–é‡‘æ¯”ä¾‹ 3%
  "commission_level_bonus_rate": 0.02,       // ç­‰çº§å¥–é‡‘æ¯”ä¾‹ 2%
  "commission_performance_threshold": 10000   // ä¸šç»©å¥–é‡‘é˜ˆå€¼ 10000
}
```

### 2ï¸âƒ£ é€šåˆ¸é…ç½® (points)
```json
{
  "points_min_transfer_amount": 1,           // æœ€ä½è½¬è´¦é‡‘é¢ 1
  "points_max_transfer_amount": 100000,       // æœ€é«˜è½¬è´¦é‡‘é¢ 100000
  "points_daily_transfer_limit": 1000000,     // æ¯æ—¥è½¬è´¦é™é¢ 1000000
  "points_transfer_fee_rate": 0.01,          // è½¬è´¦æ‰‹ç»­è´¹ç‡ 1%
  "points_freeze_threshold": 100000           // å†»ç»“é˜ˆå€¼ 100000
}
```

### 3ï¸âƒ£ è®¢å•é…ç½® (order)
```json
{
  "order_auto_cancel_minutes": 30,            // è‡ªåŠ¨å–æ¶ˆè®¢å•æ—¶é—´ 30åˆ†é’Ÿ
  "order_refund_days": 7,                     // é€€æ¬¾æ—¶é™ 7å¤©
  "order_default_shipping_fee": 10,           // é»˜è®¤è¿è´¹ 10å…ƒ
  "order_free_shipping_threshold": 200        // åŒ…é‚®é˜ˆå€¼ 200å…ƒ
}
```

### 4ï¸âƒ£ åº“å­˜é…ç½® (inventory)
```json
{
  "inventory_warning_threshold": 10,           // åº“å­˜é¢„è­¦é˜ˆå€¼ 10
  "inventory_auto_reorder_enabled": false,    // æ˜¯å¦å¯ç”¨è‡ªåŠ¨è¡¥è´§
  "inventory_auto_reorder_quantity": 100       // è‡ªåŠ¨è¡¥è´§æ•°é‡ 100
}
```

### 5ï¸âƒ£ äº‘åº—ç­‰çº§é…ç½® (cloud_shop_levels)
```json
{
  "cloud_shop_level_1": { // äº‘åº—ç­‰çº§1
    "minBottles": 4,
    "minTeamSize": 2,
    "minDirectMembers": 1,
    "purchaseDiscount": 0.95,
    "monthlyTarget": 10000,
    "monthlyCommission": 500
  }
  // ... ç­‰çº§2-6ç±»ä¼¼é…ç½®
}
```

---

## ğŸ”§ APIä½¿ç”¨æ–¹æ³•

### åŸºç¡€æœåŠ¡ç±»ä½¿ç”¨

åœ¨ä¸šåŠ¡ä»£ç ä¸­å¼•å…¥é…ç½®æœåŠ¡ï¼š

```typescript
import { configService } from '../modules/config';

// è¯»å–å•ä¸ªé…ç½®
const commissionRate = await configService.getConfig<number>('commission_personal_rate', 0.05);

// æ‰¹é‡è¯»å–æŸåˆ†ç±»çš„é…ç½®
const commissionConfigs = await configService.getConfigsByCategory('commission');

// æ›´æ–°é…ç½®ï¼ˆéœ€è¦æƒé™æ§åˆ¶ï¼‰
await configService.updateConfig('commission_personal_rate', 0.08, {
  lastModifiedBy: 'admin_user_id'
});
```

### å®é™…ä¸šåŠ¡åœºæ™¯ç¤ºä¾‹

#### åœºæ™¯1ï¼šä½£é‡‘è®¡ç®—
```typescript
async calculateCommission(salesAmount: number) {
  const personalRate = await configService.getConfig<number>('commission_personal_rate', 0.05);
  const referralRate = await configService.getConfig<number>('commission_direct_referral_rate', 0.02);

  return {
    personal: salesAmount * personalRate,
    referral: salesAmount * referralRate
  };
}
```

#### åœºæ™¯2ï¼šäº‘åº—å‡çº§æ£€æŸ¥
```typescript
async checkCloudShopUpgrade(userId: string) {
  const user = await getUser(userId);

  const minBottles = await configService.getConfig<number>('cloud_shop_level_1_minBottles', 4);
  const minTeamSize = await configService.getConfig<number>('cloud_shop_level_1_minTeamSize', 2);

  return user.totalBottles >= minBottles && user.teamSize >= minTeamSize;
}
```

#### åœºæ™¯3ï¼šé€šåˆ¸è½¬è´¦éªŒè¯
```typescript
async validatePointsTransfer(amount: number) {
  const minAmount = await configService.getConfig<number>('points_min_transfer_amount', 1);
  const maxAmount = await configService.getConfig<number>('points_max_transfer_amount', 100000);
  const feeRate = await configService.getConfig<number>('points_transfer_fee_rate', 0.01);

  if (amount < minAmount || amount > maxAmount) {
    throw new Error('è½¬è´¦é‡‘é¢è¶…å‡ºé™åˆ¶');
  }

  return {
    fee: amount * feeRate,
    actualAmount: amount - (amount * feeRate)
  };
}
```

---

## ğŸ¯ æ¼”ç¤ºAPIæ¥å£

ä¸ºäº†æ–¹ä¾¿ç†è§£å’Œä½¿ç”¨ï¼Œç³»ç»Ÿæä¾›äº†å®Œæ•´çš„æ¼”ç¤ºæ¥å£ï¼š

### 1. è¯»å–å•ä¸ªé…ç½®
```bash
GET /api/v1/config/demo/single/{key}
```
**ç¤ºä¾‹**:
```bash
curl http://localhost:3000/api/v1/config/demo/single/commission_personal_rate
```

### 2. æ‰¹é‡è¯»å–åˆ†ç±»é…ç½®
```bash
GET /api/v1/config/demo/category/{category}
```
**ç¤ºä¾‹**:
```bash
curl http://localhost:3000/api/v1/config/demo/category/commission
```

### 3. äº‘åº—å‡çº§æ£€æŸ¥æ¼”ç¤º
```bash
GET /api/v1/config/demo/cloud-shop-check
```

### 4. ä½£é‡‘è®¡ç®—æ¼”ç¤º
```bash
GET /api/v1/config/demo/commission-calculation
```

### 5. é€šåˆ¸è½¬è´¦æ£€æŸ¥æ¼”ç¤º
```bash
GET /api/v1/config/demo/points-transfer-check
```

### 6. ç¼“å­˜æ€§èƒ½æµ‹è¯•
```bash
GET /api/v1/config/demo/cache-performance
```

### 7. åŠ¨æ€ä¿®æ”¹é…ç½®ï¼ˆæ¼”ç¤ºç‰ˆï¼‰
```bash
GET /api/v1/config/demo-update-config/{key}/{value}
```
**ç¤ºä¾‹**:
```bash
# å°†ä½£é‡‘ç‡ä»5%æ”¹ä¸º8%
curl http://localhost:3000/api/v1/config/demo-update-config/commission_personal_rate/0.08
```

---

## ğŸš€ å®é™…æ¼”ç¤ºç»“æœ

åˆšæ‰çš„æ¼”ç¤ºå®Œç¾å±•ç¤ºäº†ç³»ç»Ÿçš„å¼ºå¤§åŠŸèƒ½ï¼š

### æ¼”ç¤ºæµç¨‹
1. **è¯»å–é…ç½®**: `commission_personal_rate = 0.05 (5%)`
2. **ä¿®æ”¹é…ç½®**: åŠ¨æ€æ›´æ–°ä¸º `0.08 (8%)`
3. **éªŒè¯ç”Ÿæ•ˆ**: ä½£é‡‘è®¡ç®—ç«‹å³ä½¿ç”¨æ–°çš„8%è´¹ç‡
4. **æ¢å¤åŸå€¼**: æ”¹å›åŸæ¥çš„5%

### ç»“æœå¯¹æ¯”
- **ä¿®æ”¹å‰**: 1000å…ƒé”€å”®é¢ â†’ æ€»ä½£é‡‘Â¥100.00
- **ä¿®æ”¹å**: 1000å…ƒé”€å”®é¢ â†’ æ€»ä½£é‡‘Â¥130.00
- **æ•ˆæœ**: å‚æ•°ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯ï¼

---

## ğŸ—ï¸ åœ¨ä¸šåŠ¡ä»£ç ä¸­é›†æˆ

### ç¬¬1æ­¥ï¼šå¯¼å…¥é…ç½®æœåŠ¡
```typescript
import { configService } from '../../modules/config';
```

### ç¬¬2æ­¥ï¼šè¯»å–é…ç½®å‚æ•°
```typescript
// åœ¨æœåŠ¡ç±»ä¸­ä½¿ç”¨
export class CommissionService {
  async calculatePersonalCommission(salesAmount: number): Promise<number> {
    const rate = await configService.getConfig<number>('commission_personal_rate', 0.05);
    return salesAmount * rate;
  }
}
```

### ç¬¬3æ­¥ï¼šåœ¨è·¯ç”±ä¸­ä½¿ç”¨
```typescript
// åœ¨æ§åˆ¶å™¨ä¸­ä½¿ç”¨
router.post('/calculate', asyncHandler(async (req, res) => {
  const { amount } = req.body;
  const commissionService = new CommissionService();
  const commission = await commissionService.calculatePersonalCommission(amount);

  res.json(createSuccessResponse({ commission }));
}));
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. å‚æ•°å‘½åè§„èŒƒ
- ä½¿ç”¨ `snake_case` æ ¼å¼
- éµå¾ª `<æ¨¡å—>_<åŠŸèƒ½>_<å±æ€§>` è§„èŒƒ
- ä¾‹å¦‚ï¼š`commission_personal_rate`ã€`points_min_transfer_amount`

### 2. é»˜è®¤å€¼è®¾ç½®
- å§‹ç»ˆæä¾›åˆç†çš„é»˜è®¤å€¼
- é»˜è®¤å€¼åº”è¯¥æ˜¯æœ€å¸¸ç”¨çš„é…ç½®
- ä¾‹å¦‚ï¼š`await configService.getConfig('rate', 0.05)`

### 3. ç±»å‹å®‰å…¨
- ä½¿ç”¨æ³›å‹æŒ‡å®šè¿”å›ç±»å‹
- TypeScriptä¼šè‡ªåŠ¨æ¨æ–­å’ŒéªŒè¯
- ä¾‹å¦‚ï¼š`configService.getConfig<number>('rate')`

### 4. æ€§èƒ½è€ƒè™‘
- ç³»ç»Ÿè‡ªåŠ¨ç¼“å­˜5åˆ†é’Ÿ
- æ‰¹é‡è·å–åŒåˆ†ç±»å‚æ•°ä½¿ç”¨ `getConfigsByCategory`
- ä¿®æ”¹å‚æ•°åç¼“å­˜è‡ªåŠ¨æ¸…é™¤

### 5. ç”Ÿäº§ç¯å¢ƒå®‰å…¨
- é…ç½®ä¿®æ”¹APIéœ€è¦æƒé™éªŒè¯
- è®°å½•æ‰€æœ‰å‚æ•°ä¿®æ”¹æ—¥å¿—
- æ”¯æŒå‚æ•°å›æ»šåŠŸèƒ½

---

## ğŸ”® ç®¡ç†åå°æ‰©å±•

### ä¸‹ä¸€æ­¥å¯ä»¥å¼€å‘çš„ç®¡ç†åŠŸèƒ½ï¼š

#### 1. é…ç½®ç®¡ç†API
```typescript
// GET /api/v1/admin/configs           // è·å–æ‰€æœ‰é…ç½®
// GET /api/v1/admin/configs/:key      // è·å–å•ä¸ªé…ç½®
// PUT /api/v1/admin/configs/:key      // æ›´æ–°é…ç½®ï¼ˆéœ€è¦æƒé™ï¼‰
// POST /api/v1/admin/configs          // åˆ›å»ºæ–°é…ç½®
// DELETE /api/v1/admin/configs/:key   // åˆ é™¤é…ç½®
```

#### 2. é…ç½®å†å²è®°å½•
```typescript
// è®°å½•æ¯æ¬¡å‚æ•°ä¿®æ”¹
{
  key: 'commission_personal_rate',
  oldValue: 0.05,
  newValue: 0.08,
  modifiedBy: 'admin_123',
  modifiedAt: '2025-11-19T15:37:35.147Z',
  reason: 'åŒåä¸€ä¿ƒé”€æ´»åŠ¨è°ƒé«˜ä½£é‡‘ç‡'
}
```

#### 3. é…ç½®æ¨¡æ¿
- é¢„è®¾èŠ‚å‡æ—¥é…ç½®æ¨¡æ¿
- ä¸€é”®åˆ‡æ¢ä¿ƒé”€é…ç½®
- é…ç½®å¤‡ä»½å’Œæ¢å¤

---

## ğŸ‰ æ€»ç»“

ä¸­é“å•†åŸçš„å‚æ•°é…ç½®ç³»ç»Ÿå·²ç»å®Œç¾è¿è¡Œï¼Œå…·å¤‡ä»¥ä¸‹æ ¸å¿ƒèƒ½åŠ›ï¼š

1. **âœ… å®æ—¶ç”Ÿæ•ˆ**: å‚æ•°ä¿®æ”¹ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
2. **âœ… é«˜æ€§èƒ½**: 5åˆ†é’Ÿå†…å­˜ç¼“å­˜ï¼Œè¯»å–æå¿«
3. **âœ… ç±»å‹å®‰å…¨**: å®Œæ•´TypeScriptæ”¯æŒ
4. **âœ… ä¸šåŠ¡é›†æˆ**: å·²åœ¨ä½£é‡‘ã€é€šåˆ¸ã€è®¢å•ç­‰æ¨¡å—ä¸­ä½¿ç”¨
5. **âœ… å®‰å…¨é˜²æŠ¤**: CSRFä¿æŠ¤ã€æƒé™æ§åˆ¶
6. **âœ… å®Œæ•´æ¼”ç¤º**: 7ä¸ªæ¼”ç¤ºæ¥å£å±•ç¤ºå…¨éƒ¨åŠŸèƒ½

### ç«‹å³å¯ç”¨
- **é…ç½®ç®¡ç†**: 22ä¸ªæ ¸å¿ƒä¸šåŠ¡å‚æ•°å·²é…ç½®
- **APIæ¥å£**: å®Œæ•´çš„RESTful API
- **æ¼”ç¤ºç³»ç»Ÿ**: 7ä¸ªæ¼”ç¤ºæ¥å£å¯ç«‹å³æµ‹è¯•
- **æ–‡æ¡£å®Œæ•´**: è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—å’Œä»£ç ç¤ºä¾‹

æ‚¨çš„é¡¹ç›®ç°åœ¨æ‹¥æœ‰äº†ä¼ä¸šçº§çš„å‚æ•°ç®¡ç†èƒ½åŠ›ï¼ğŸš€

---

**æ›´æ–°æ—¶é—´**: 2025-11-19 23:38
**ç³»ç»Ÿç‰ˆæœ¬**: v1.0.0
**ç»´æŠ¤**: å¼€å‘å›¢é˜Ÿ