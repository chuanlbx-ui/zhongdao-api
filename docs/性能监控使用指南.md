# 中道商城系统 - 性能监控使用指南

## 概述

本系统内置了高性能监控中间件，提供全面的性能监控、Prometheus指标输出和告警功能。监控系统设计为低开销，不会影响业务API的性能。

## 功能特性

### 1. 实时性能监控
- **请求响应时间**：精确到毫秒级的响应时间统计
- **内存使用监控**：实时跟踪进程内存使用情况
- **CPU使用统计**：记录每个请求的CPU消耗
- **数据库查询监控**：跟踪查询数量和执行时间
- **错误率统计**：自动计算API错误率

### 2. Prometheus指标
- 标准Prometheus格式输出
- 支持Counter、Gauge、Histogram等指标类型
- 包含丰富的标签用于维度分析

### 3. 智能告警系统
- 基于阈值的自动告警
- 支持多种告警类型：响应时间、内存、CPU、连接池、错误率
- 告警冷却机制避免告警风暴
- 支持告警状态管理（触发/解决）

### 4. 性能分析报告
- 自动生成性能分析报告
- 包含趋势分析和优化建议
- 支持多时间段查询

## API端点

### 1. 获取Prometheus指标
```
GET /api/v1/performance/metrics
```
- 返回Prometheus格式的指标数据
- 可用于Grafana等监控工具集成

### 2. 获取性能报告
```
GET /api/v1/performance/report
```
- 返回JSON格式的性能报告
- 包含路由统计、告警信息、优化建议

### 3. 系统健康检查
```
GET /api/v1/performance/health
```
- 返回系统健康状态
- 包含内存、CPU、运行时间等基础指标

### 4. 告警管理
```
GET /api/v1/performance/alerts          # 获取告警列表（需认证）
POST /api/v1/performance/alerts/:id/resolve  # 标记告警已解决（需认证）
```

### 5. 慢查询分析
```
GET /api/v1/performance/slow-queries  # 获取慢查询列表（需认证）
```

### 6. 性能趋势
```
GET /api/v1/performance/trends?period=1h  # 获取性能趋势数据
```
支持的时间段：5m、15m、1h、6h、24h

### 7. 配置管理（仅管理员）
```
POST /api/v1/performance/reset     # 重置性能统计
PUT /api/v1/performance/config     # 更新监控配置
```

## 配置说明

### 性能阈值配置

```javascript
PERFORMANCE_CONFIG = {
  thresholds: {
    excellent: 50,   // 优秀：< 50ms
    good: 200,       // 良好：50-200ms
    acceptable: 500, // 可接受：200-500ms
    slow: 1000,      // 缓慢：500-1000ms
    critical: 2000   // 严重：> 1000ms
  },
  memory: {
    warning: 512,    // 警告：512MB
    critical: 1024   // 严重：1024MB
  },
  slowQuery: 1000,  // 慢查询阈值：1000ms
  sampleRate: 0.1   // 采样率：10%（生产环境）
}
```

### 环境变量

- `NODE_ENV`：环境模式（development/production）
  - 生产环境自动降低采样率至10%以减少开销
  - 开发环境启用详细的性能响应头

## 使用示例

### 1. 与Grafana集成

1. 配置Prometheus数据源
2. 导入或创建仪表板
3. 使用以下指标：
   - `http_request_duration_seconds`：请求响应时间
   - `http_requests_total`：请求总数
   - `process_memory_bytes`：内存使用量
   - `db_slow_queries_total`：慢查询总数

### 2. 监控脚本示例

```javascript
// 检查系统健康
const healthResponse = await fetch('/api/v1/performance/health');
const health = await healthResponse.json();

if (health.data.status !== 'healthy') {
  console.warn('系统性能警告:', health.data);
}

// 获取告警信息
const alertsResponse = await fetch('/api/v1/performance/alerts', {
  headers: { 'Authorization': 'Bearer <token>' }
});
const alerts = await alertsResponse.json();

// 处理严重告警
alerts.data.alerts
  .filter(a => a.severity === 'critical' && !a.resolved)
  .forEach(alert => {
    console.error('严重告警:', alert.message);
    // 发送通知或执行恢复操作
  });
```

## 性能优化建议

### 1. 监控指标解读

- **响应时间分布**：关注P95和P99值，它们更能反映用户体验
- **错误率**：超过5%需要立即关注
- **内存使用**：持续增长可能存在内存泄漏
- **慢查询**：定期审查并优化

### 2. 常见性能问题及解决方案

#### 高响应时间
1. 检查数据库查询是否存在N+1问题
2. 添加适当的数据库索引
3. 考虑使用缓存
4. 优化复杂业务逻辑

#### 内存使用过高
1. 检查是否有未释放的大对象
2. 监控内存泄漏
3. 调整Node.js内存限制

#### 高CPU使用
1. 优化计算密集型操作
2. 使用Worker线程处理重任务
3. 检查是否有无限循环

## 最佳实践

### 1. 生产环境部署
- 设置合适的采样率（推荐0.1）
- 定期清理历史数据
- 配置告警通知渠道
- 监控监控系统本身的资源消耗

### 2. 开发环境使用
- 使用100%采样率获取完整数据
- 查看响应头了解单个请求性能
- 利用性能报告优化代码

### 3. 故障排查流程
1. 查看告警列表确定问题类型
2. 使用性能报告定位问题路由
3. 分析慢查询找出性能瓶颈
4. 查看趋势数据了解问题演变

## 高级功能

### 1. 自定义监控指标

```javascript
import { performanceMonitor } from './middleware/performance-monitor-enhanced';

// 添加自定义业务指标
performanceMonitor.incrementCounter('business_orders_created', {
  order_type: 'online',
  user_level: 'VIP'
});

// 记录自定义耗时
performanceMonitor.recordHistogram('order_processing_time', duration, {
  processing_step: 'payment'
});
```

### 2. 告警事件监听

```javascript
performanceMonitor.on('alert:triggered', (alert) => {
  // 自定义告警处理逻辑
  if (alert.type === 'response_time' && alert.severity === 'critical') {
    // 发送紧急通知
    sendAlert(alert);
  }
});
```

### 3. 性能数据导出

```javascript
// 获取原始性能数据
const metrics = performanceMonitor.getMetrics();
// 导出到外部监控系统
exportMetrics(metrics);
```

## 注意事项

1. **性能开销**：监控系统本身会消耗少量资源，生产环境建议使用10%采样率
2. **数据保留**：默认保留24小时数据，定期清理避免内存溢出
3. **敏感信息**：性能数据不包含请求体内容，避免敏感信息泄露
4. **并发限制**：高并发时可能跳过部分监控以确保业务性能

## 故障排除

### 问题：监控数据不准确
- 检查采样率设置
- 确认中间件加载顺序
- 查看是否有其他中间件干扰

### 问题：内存持续增长
- 检查数据清理是否正常工作
- 确认没有内存泄漏
- 考虑增加清理频率

### 问题：告警过于频繁
- 调整告警阈值
- 设置合理的冷却时间
- 优化触发条件

## 总结

本性能监控系统为中道商城系统提供了全面的性能可观测性能力。通过合理配置和使用，可以：

- 及时发现性能问题
- 优化系统性能
- 提升用户体验
- 支持系统容量规划

如有问题或建议，请联系开发团队。