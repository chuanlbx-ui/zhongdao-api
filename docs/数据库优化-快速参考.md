# 数据库优化 - 快速参考

## ⚡ 4项核心优化

### 1. 连接池配置
```bash
# .env.development
DB_CONNECTION_LIMIT=50  # 开发: 50, 生产: 100-200
```

### 2. 数据库索引
```sql
-- Orders
CREATE INDEX orders_status_idx ON orders(status);
CREATE INDEX orders_buyer_status_idx ON orders(buyer_id, status);

-- CommissionCalculations
CREATE INDEX commission_calculations_user_period_idx 
  ON commission_calculations(user_id, period);

-- InventoryLogs
CREATE INDEX inventory_logs_user_warehouse_idx 
  ON inventory_logs(user_id, warehouse_type);
```

### 3. 查询优化工具
```typescript
import { QueryOptimizer } from '@/shared/database/query-optimizer';

// 批量查询
await QueryOptimizer.batchQuery(queryFn, total, 100);

// 并发查询
await QueryOptimizer.concurrentQueries([query1, query2]);

// 分页
const { skip, take } = QueryOptimizer.getPaginationParams(page, perPage);

// 性能测量
await QueryOptimizer.measureQuery('name', queryFn, 1000);
```

### 4. 查询缓存
```typescript
import { queryCache, DEFAULT_CACHE_CONFIGS } from '@/shared/cache/query-cache';

// 缓存查询
await queryCache.withCache('key', queryFn, DEFAULT_CACHE_CONFIGS.short);

// 装饰器
@Cacheable(DEFAULT_CACHE_CONFIGS.medium)
async getData() { ... }

// 清除缓存
await queryCache.deleteByPattern('orders:.*');
```

---

## 📊 性能指标目标

| 指标 | 优化前 | 优化后 | 提升 |
|------|-------|-------|------|
| 连接池占用 | 高峰80% | 高峰40% | ⬇️ 50% |
| 平均查询时间 | 600ms | 240ms | ⬇️ 60% |
| 缓存命中率 | N/A | 70-80% | ⬆️ 新增 |
| 并发能力 | 20 | 50+ | ⬆️ 2.5x |

---

## 🚀 快速开始

### 步骤1: 更新环境配置
```bash
# .env.development
DB_CONNECTION_LIMIT=50
```

### 步骤2: 应用数据库迁移
```bash
npx prisma migrate dev --name "add_performance_indexes"
```

### 步骤3: 在服务中使用优化
```typescript
// 使用缓存
const data = await queryCache.withCache(
  'user:orders',
  () => getUserOrders(userId),
  DEFAULT_CACHE_CONFIGS.short
);

// 使用查询优化
const stats = await QueryOptimizer.measureQuery(
  'getStats',
  () => prisma.order.aggregate({ ... })
);
```

---

## ✅ 优化效果验证

### 观察指标
1. **数据库连接**: `show processlist` → 连接数下降
2. **查询时间**: 日志中 "慢查询警告" 减少
3. **缓存命中**: `queryCache.getStats()` → 命中率提升
4. **API响应**: 平均响应时间 600ms → 240ms

### 测试命令
```bash
# 运行测试
npm run test:frontend

# 监控性能
curl http://localhost:3000/health
```

---

## 🔧 常见场景优化

### 场景1: 大列表查询
```typescript
const orders = await queryCache.withCache(
  `orders:${userId}:${page}`,
  () => QueryOptimizer.batchQuery(
    (skip, take) => prisma.order.findMany({ skip, take }),
    total,
    50
  ),
  DEFAULT_CACHE_CONFIGS.short
);
```

### 场景2: 统计计算
```typescript
@Cacheable(DEFAULT_CACHE_CONFIGS.medium)
async getOrderStatistics(userId: string) {
  return QueryOptimizer.measureQuery(
    'getOrderStatistics',
    () => prisma.order.aggregate({ ... }),
    2000
  );
}
```

### 场景3: 关联数据加载
```typescript
// 先加载基础数据
const orders = await prisma.order.findMany({
  select: { id: true, orderNo: true }
});

// 延迟加载关联
const withItems = await QueryOptimizer.lazyLoadRelations(
  orders,
  (id) => getOrderItems(id)
);
```

---

## 📚 相关文件

| 文件 | 说明 |
|------|------|
| `.env.development` | 环境配置 |
| `prisma/schema.prisma` | 数据库Schema和索引 |
| `src/shared/database/query-optimizer.ts` | 查询优化工具 |
| `src/shared/cache/query-cache.ts` | 缓存管理器 |
| `docs/数据库性能优化指南.md` | 完整指南 |

---

## 🎯 主要改进点

✅ **连接池**: 20→50 (可按需调整)
✅ **索引**: 添加12个关键索引
✅ **查询工具**: 6种优化方法
✅ **缓存系统**: 支持装饰器和手动管理
✅ **监控**: 自动性能测量和指标收集

---

**快速参考完成！** 详见 `数据库性能优化指南.md`
