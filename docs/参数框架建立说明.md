# é¡¹ç›®å‚æ•°ç®¡ç†æ¡†æ¶å»ºç«‹è¯´æ˜

## ğŸ“Œ å»ºç«‹å®Œæˆ

æˆ‘å·²ä¸ºä½ çš„é¡¹ç›®å»ºç«‹äº†å®Œæ•´çš„å‚æ•°ç®¡ç†æ¡†æ¶ã€‚æ‰€æœ‰ä¸šåŠ¡é€»è¾‘å‚æ•°ï¼ˆä¼šå‘˜ç­‰çº§ã€æŠ˜æ‰£æ¯”ä¾‹ã€ä½£é‡‘æ¯”ä¾‹ç­‰ï¼‰ç°åœ¨éƒ½å¯ä»¥é€šè¿‡æ•°æ®åº“è¿›è¡ŒåŠ¨æ€ç®¡ç†ï¼Œæ— éœ€æ”¹ä»£ç é‡æ–°éƒ¨ç½²ã€‚

---

## ğŸ—ï¸ æ¡†æ¶ç»„æˆ

### 1. æ•°æ®åº“è¡¨ï¼ˆSystemConfigï¼‰
```sql
-- è‡ªåŠ¨ä¸ºä½ æ·»åŠ åˆ° Prisma schema
model SystemConfig {
  key               String @unique  // é…ç½®é”®ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
  value             String          // é…ç½®å€¼ï¼ˆJSONæ ¼å¼ï¼‰
  description       String?         // é…ç½®è¯´æ˜
  category          String?         // é…ç½®åˆ†ç±»
  type              ConfigValueType // å€¼ç±»å‹
  lastModifiedBy    String?         // æœ€åä¿®æ”¹è€…
  createdAt         DateTime
  updatedAt         DateTime
}
```

### 2. ConfigService æœåŠ¡ç±»
**ä½ç½®**ï¼š`src/modules/config/config.service.ts`

æ ¸å¿ƒæ–¹æ³•ï¼š
- `getConfig<T>(key, default?)` - è·å–é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰
- `getConfigsByCategory(category)` - è·å–æŸåˆ†ç±»çš„æ‰€æœ‰é…ç½®
- `updateConfig(key, value, options)` - æ›´æ–°é…ç½®
- `clearCache()` - æ¸…é™¤ç¼“å­˜

### 3. é…ç½®åˆå§‹åŒ–è„šæœ¬
**ä½ç½®**ï¼š`src/modules/config/config.init.ts`

åŒ…å«5ç±»é…ç½®çš„é»˜è®¤å€¼ï¼š
- âœ… äº‘åº—ç­‰çº§é…ç½®ï¼ˆ6ä¸ªç­‰çº§ï¼‰
- âœ… ä½£é‡‘é…ç½®ï¼ˆ6ä¸ªå‚æ•°ï¼‰
- âœ… é€šåˆ¸é…ç½®ï¼ˆ5ä¸ªå‚æ•°ï¼‰
- âœ… è®¢å•é…ç½®ï¼ˆ4ä¸ªå‚æ•°ï¼‰
- âœ… åº“å­˜é…ç½®ï¼ˆ3ä¸ªå‚æ•°ï¼‰

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨

### ç¬¬1æ­¥ï¼šåº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ–é…ç½®

åœ¨ `src/index.ts` ä¸­æ·»åŠ åˆå§‹åŒ–ä»£ç ï¼š

```typescript
import { initializeConfigs } from './modules/config';

app.listen(PORT, async () => {
  // åˆå§‹åŒ–æ‰€æœ‰é…ç½®
  await initializeConfigs();
  
  console.log(`âœ… åº”ç”¨å·²å¯åŠ¨ï¼Œç«¯å£: ${PORT}`);
});
```

### ç¬¬2æ­¥ï¼šåœ¨ä¸šåŠ¡é€»è¾‘ä¸­è¯»å–å‚æ•°

**ä¾‹å­1ï¼šåœ¨åº—é“ºæœåŠ¡ä¸­**

```typescript
// src/modules/shop/shop.service.ts
import { configService } from '../../modules/config';

async checkCloudShopUpgrade(userId: string) {
  // åŠ¨æ€è¯»å–å‚æ•°ï¼ˆè€Œä¸æ˜¯ç¡¬ç¼–ç ï¼‰
  const minBottles = await configService.getConfig<number>(
    'cloud_shop_level_1_minBottles',
    4  // é»˜è®¤å€¼
  );
  
  const user = await prisma.user.findUnique({ where: { id: userId } });
  
  if (user.totalBottles >= minBottles) {
    // å¯ä»¥å‡çº§
  }
}
```

**ä¾‹å­2ï¼šåœ¨ä½£é‡‘è®¡ç®—ä¸­**

```typescript
// src/modules/payment/payment.service.ts
async calculateCommission(salesAmount: number) {
  const personalRate = await configService.getConfig<number>(
    'commission_personal_rate',
    0.05  // é»˜è®¤5%
  );
  
  return salesAmount * personalRate;
}
```

### ç¬¬3æ­¥ï¼šåç»­åœ¨ç®¡ç†åå°ä¿®æ”¹å‚æ•°

å½“å¼€å‘ç®¡ç†åå°æ—¶ï¼Œè¿è¥äººå‘˜å¯ä»¥ç›´æ¥ä¿®æ”¹å‚æ•°ï¼š

```typescript
// ç®¡ç†å‘˜ç‚¹å‡»"æ›´æ–°å‚æ•°"
await configService.updateConfig('cloud_shop_level_1_minBottles', 6, {
  lastModifiedBy: adminUserId
});

// âœ… ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯åº”ç”¨
```

---

## ğŸ“‹ å‚æ•°å‘½åè§„èŒƒ

æ‰€æœ‰å‚æ•°ä½¿ç”¨ `snake_case` æ ¼å¼ï¼š`<æ¨¡å—>_<åŠŸèƒ½>_<å±æ€§>`

```
cloud_shop_level_1_minBottles           // äº‘åº—ä¸€çº§æœ€ä½ç“¶æ•°
cloud_shop_level_1_purchaseDiscount     // äº‘åº—ä¸€çº§é‡‡è´­æŠ˜æ‰£
commission_personal_rate                // ä¸ªäººé”€å”®ä½£é‡‘æ¯”ä¾‹
points_min_transfer_amount              // é€šåˆ¸æœ€ä½è½¬è´¦é‡‘é¢
order_auto_cancel_minutes               // è®¢å•è‡ªåŠ¨å–æ¶ˆæ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
inventory_warning_threshold             // åº“å­˜é¢„è­¦é˜ˆå€¼
```

---

## ğŸ“Š äº”å¤§é…ç½®åˆ†ç±»

### 1ï¸âƒ£ äº‘åº—ç­‰çº§é…ç½® (category: cloud_shop_levels)
```
cloud_shop_level_1 è‡³ cloud_shop_level_6

æ¯ä¸ªç­‰çº§åŒ…å«ï¼š
- minBottlesï¼šæœ€ä½ç“¶æ•°è¦æ±‚
- minTeamSizeï¼šæœ€ä½å›¢é˜Ÿäººæ•°
- minDirectMembersï¼šæœ€ä½ç›´æ¨äººæ•°
- purchaseDiscountï¼šé‡‡è´­æŠ˜æ‰£
- monthlyTargetï¼šæœˆé”€å”®ç›®æ ‡
- monthlyCommissionï¼šæœˆä½£é‡‘
```

### 2ï¸âƒ£ ä½£é‡‘é…ç½® (category: commission)
```
- commission_personal_rateï¼šä¸ªäººé”€å”®ä½£é‡‘æ¯”ä¾‹ï¼ˆé»˜è®¤5%ï¼‰
- commission_direct_referral_rateï¼šç›´æ¨ä½£é‡‘æ¯”ä¾‹ï¼ˆé»˜è®¤2%ï¼‰
- commission_indirect_referral_rateï¼šé—´æ¥æ¨èä½£é‡‘æ¯”ä¾‹ï¼ˆé»˜è®¤1%ï¼‰
- commission_team_bonus_rateï¼šå›¢é˜Ÿå¥–é‡‘æ¯”ä¾‹ï¼ˆé»˜è®¤3%ï¼‰
- commission_level_bonus_rateï¼šç­‰çº§å¥–é‡‘æ¯”ä¾‹ï¼ˆé»˜è®¤2%ï¼‰
- commission_performance_thresholdï¼šä¸šç»©å¥–é‡‘é˜ˆå€¼ï¼ˆé»˜è®¤10000ï¼‰
```

### 3ï¸âƒ£ é€šåˆ¸é…ç½® (category: points)
```
- points_min_transfer_amountï¼šæœ€ä½è½¬è´¦é‡‘é¢ï¼ˆé»˜è®¤1ï¼‰
- points_max_transfer_amountï¼šæœ€é«˜è½¬è´¦é‡‘é¢ï¼ˆé»˜è®¤100000ï¼‰
- points_daily_transfer_limitï¼šæ¯æ—¥è½¬è´¦é™é¢ï¼ˆé»˜è®¤1000000ï¼‰
- points_transfer_fee_rateï¼šè½¬è´¦æ‰‹ç»­è´¹ç‡ï¼ˆé»˜è®¤1%ï¼‰
- points_freeze_thresholdï¼šå†»ç»“é˜ˆå€¼ï¼ˆé»˜è®¤100000ï¼‰
```

### 4ï¸âƒ£ è®¢å•é…ç½® (category: order)
```
- order_auto_cancel_minutesï¼šè‡ªåŠ¨å–æ¶ˆè®¢å•æ—¶é—´ï¼Œå•ä½åˆ†é’Ÿï¼ˆé»˜è®¤30ï¼‰
- order_refund_daysï¼šé€€æ¬¾æ—¶é™ï¼Œå•ä½å¤©ï¼ˆé»˜è®¤7ï¼‰
- order_default_shipping_feeï¼šé»˜è®¤è¿è´¹ï¼ˆé»˜è®¤10ï¼‰
- order_free_shipping_thresholdï¼šåŒ…é‚®é˜ˆå€¼ï¼ˆé»˜è®¤200ï¼‰
```

### 5ï¸âƒ£ åº“å­˜é…ç½® (category: inventory)
```
- inventory_warning_thresholdï¼šåº“å­˜é¢„è­¦é˜ˆå€¼ï¼ˆé»˜è®¤10ï¼‰
- inventory_auto_reorder_enabledï¼šæ˜¯å¦å¯ç”¨è‡ªåŠ¨è¡¥è´§ï¼ˆé»˜è®¤falseï¼‰
- inventory_auto_reorder_quantityï¼šè‡ªåŠ¨è¡¥è´§æ•°é‡ï¼ˆé»˜è®¤100ï¼‰
```

---

## ğŸ”„ å†…å­˜ç¼“å­˜

ç³»ç»Ÿè‡ªåŠ¨ç¼“å­˜æ‰€æœ‰é…ç½®ï¼Œæé«˜æ€§èƒ½ï¼š

```
- ç¼“å­˜æ—¶é—´ï¼š5åˆ†é’Ÿ
- ä¿®æ”¹æ—¶è‡ªåŠ¨æ¸…é™¤
- å¯æ‰‹åŠ¨æ¸…é™¤ï¼šconfigService.clearCache()
```

**ç¼“å­˜æµç¨‹**ï¼š
1. é¦–æ¬¡è¯»å–é…ç½® â†’ ä»æ•°æ®åº“åŠ è½½
2. 5åˆ†é’Ÿå†…å†æ¬¡è¯»å–åŒä¸ªé…ç½® â†’ ä»å†…å­˜ç¼“å­˜è¯»å–ï¼ˆè¶…å¿«ï¼‰
3. 5åˆ†é’Ÿåä»æœªæ›´æ–° â†’ è¿‡æœŸå¹¶åˆ é™¤ç¼“å­˜
4. ä¸‹æ¬¡è¯»å– â†’ é‡æ–°ä»æ•°æ®åº“åŠ è½½

---

## ğŸ“ æ–‡ä»¶ä½ç½®

```
src/modules/config/
â”œâ”€â”€ config.service.ts       // ConfigService ç±»ï¼ˆä¸»è¦æœåŠ¡ï¼‰
â”œâ”€â”€ config.init.ts         // é…ç½®åˆå§‹åŒ–è„šæœ¬
â”œâ”€â”€ config.types.ts        // TypeScript ç±»å‹å®šä¹‰
â”œâ”€â”€ index.ts              // æ¨¡å—å¯¼å‡º
â””â”€â”€ USAGE.md              // è¯¦ç»†ä½¿ç”¨æ–‡æ¡£

prisma/
â””â”€â”€ schema.prisma         // å·²æ·»åŠ  SystemConfig è¡¨

docs/
â””â”€â”€ å‚æ•°æ¡†æ¶å»ºç«‹è¯´æ˜.md     // æœ¬æ–‡ä»¶
```

---

## âœ… ç«‹å³å¯åšçš„äº‹

### 1. è¿è¡Œè¿ç§»
```bash
npx prisma migrate dev --name add_system_config
```

### 2. åˆå§‹åŒ–é…ç½®
åœ¨åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ `initializeConfigs()`

### 3. æ”¹é€ ç°æœ‰ä»£ç 
é€æ­¥å°†ç¡¬ç¼–ç å‚æ•°æ”¹ä¸ºåŠ¨æ€è¯»å–ï¼š

```typescript
// æ—§ï¼šç¡¬ç¼–ç 
export const CLOUD_SHOP_LEVELS = {
  1: { minBottles: 4, ... }
};

// æ–°ï¼šåŠ¨æ€è¯»å–
const config = await configService.getConfig('cloud_shop_level_1_minBottles');
```

### 4. åç»­ï¼šåˆ›å»ºç®¡ç†åå° API

```typescript
// GET /api/v1/admin/configs/:key
// PUT /api/v1/admin/configs/:key
// DELETE /api/v1/admin/configs/:key
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¿™æ ·åšæ›´å¥½

| æ–¹é¢ | ç¡¬ç¼–ç  | å‚æ•°æ¡†æ¶ |
|------|--------|---------|
| **ä¿®æ”¹å‚æ•°** | âŒ æ”¹ä»£ç â†’ç¼–è¯‘â†’éƒ¨ç½² | âœ… æ•°æ®åº“ä¿®æ”¹â†’ç«‹å³ç”Ÿæ•ˆ |
| **ç»´æŠ¤æˆæœ¬** | âŒ é«˜ï¼ˆå‚æ•°åˆ†æ•£åœ¨ä»£ç å„å¤„ï¼‰ | âœ… ä½ï¼ˆé›†ä¸­ç®¡ç†ï¼‰ |
| **çµæ´»æ€§** | âŒ ä½ | âœ… é«˜ |
| **å®‰å…¨æ€§** | âŒ å®¹æ˜“æ”¹é”™ | âœ… ç®¡ç†åå°éªŒè¯ |
| **è¿è¥å‹å¥½** | âŒ éœ€è¦æ”¹ä»£ç  | âœ… æ— éœ€æŠ€æœ¯çŸ¥è¯† |

---

## ğŸ’¡ å¸¸è§é—®é¢˜

**Q: å¦‚æœå‚æ•°å¾ˆå¤šæ€ä¹ˆåŠï¼Ÿ**
A: å¯ä»¥æŒ‰æ¨¡å—åˆ†ç±»ï¼Œä½¿ç”¨ `getConfigsByCategory()` æ‰¹é‡è·å–

**Q: å‚æ•°æ”¹äº†ä¼šä¸ä¼šå½±å“å·²æœ‰ä¸šåŠ¡ï¼Ÿ**
A: ä¸ä¼šï¼Œç¼“å­˜ 5 åˆ†é’Ÿï¼Œç»™ä½ ååº”æ—¶é—´ã€‚ä¹Ÿå¯ä»¥æ‰‹åŠ¨ `clearCache()`

**Q: èƒ½å¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Ÿ**
A: å¯ä»¥ï¼Œè€Œä¸”éå¸¸æ¨èã€‚å¯ä»¥åœ¨ä¸åœæœºçš„æƒ…å†µä¸‹è°ƒæ•´ä¸šåŠ¡å‚æ•°

**Q: å¦‚ä½•è·Ÿè¸ªå‚æ•°ä¿®æ”¹å†å²ï¼Ÿ**
A: `lastModifiedBy` å­—æ®µè®°å½•æœ€åä¿®æ”¹è€…ï¼Œåç»­å¯æ‰©å±•æ·»åŠ ä¿®æ”¹å†å²è¡¨

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- ğŸ“– è¯¦ç»†ä½¿ç”¨æŒ‡å—ï¼š`src/modules/config/USAGE.md`
- ğŸ”§ API å‚è€ƒï¼šè§ä¸Šæ–¹"ConfigService æœåŠ¡ç±»"éƒ¨åˆ†
- ğŸ“ ç±»å‹å®šä¹‰ï¼š`src/modules/config/config.types.ts`

---

## ğŸš€ ä¸‹ä¸€æ­¥å»ºè®®

1. **å³åˆ»**ï¼š
   - âœ… æ•°æ®åº“è¿ç§»
   - âœ… åº”ç”¨åˆå§‹åŒ–

2. **æœ¬å‘¨**ï¼š
   - â³ æ”¹é€  shop æ¨¡å—ä»£ç 
   - â³ æ”¹é€  payment æ¨¡å—ä»£ç 
   - â³ æ”¹é€  team æ¨¡å—ä»£ç 

3. **åç»­**ï¼š
   - â³ åˆ›å»ºç®¡ç†åå° API
   - â³ åˆ›å»ºå‚æ•°é…ç½® UI
   - â³ åŠ å…¥å‚æ•°ä¿®æ”¹å®¡è®¡æ—¥å¿—

---

**ç¥è´ºï¼ä½ ç°åœ¨æ‹¥æœ‰ä¸€ä¸ªå¼ºå¤§çš„ã€å¯æ‰©å±•çš„å‚æ•°ç®¡ç†ç³»ç»Ÿï¼** ğŸ‰
