# 支付安全部署指南

## 概述

本文档描述了中道商城支付系统的安全部署要求，确保支付回调处理的安全性和可靠性。

## 安全架构

### 1. 多层安全防护

```
┌─────────────────────────────────────┐
│          CDN/WAF层                  │
│    • DDoS防护                       │
│    • IP黑白名单                     │
│    • 基础入侵检测                   │
└─────────────────────────────────────┘
              │
┌─────────────────────────────────────┐
│         应用层安全                   │
│    • 速率限制                       │
│    • 签名验证                       │
│    • 幂等性控制                     │
│    • 审计日志                       │
└─────────────────────────────────────┘
              │
┌─────────────────────────────────────┐
│        业务逻辑安全                   │
│    • 事务一致性                     │
│    • 异常处理                       │
│    • 补偿机制                       │
│    • 重试策略                       │
└─────────────────────────────────────┘
```

### 2. 核心安全组件

- **安全回调处理器** (`SecurePaymentCallbackHandler`)
- **签名验证器** (`SignatureVerifier`)
- **配置管理器** (`PaymentSecurityConfigManager`)
- **重试处理器** (`PaymentRetryHandler`)

## 环境要求

### 1. 服务器要求

- **操作系统**: Linux (推荐 Ubuntu 20.04+)
- **内存**: 最小 4GB，推荐 8GB+
- **CPU**: 最小 2核，推荐 4核+
- **存储**: SSD，最少 50GB

### 2. 网络要求

- **HTTPS**: 必须启用 TLS 1.2+
- **防火墙**: 仅开放必要端口 (80, 443)
- **IP白名单**: 配置支付渠道官方IP

### 3. 依赖服务

- **MySQL**: 8.0+
- **Redis**: 6.0+ (用于幂次性和缓存)
- **Nginx**: 1.18+ (反向代理)

## 配置要求

### 1. 环境变量配置

```bash
# 支付安全密钥（必须配置强密码）
PAYMENT_SECURITY_SECRET=your_very_secure_secret_key_here

# 微信支付安全配置
WECHAT_API_V3_KEY=your_32_char_api_key_here
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_SERIAL_NO=your_serial_no_here
WECHAT_PLATFORM_PUBLIC_KEY=your_platform_public_key

# 支付宝安全配置
ALIPAY_APP_ID=your_alipay_app_id
ALIPAY_PRIVATE_KEY=your_private_key_here
ALIPAY_PUBLIC_KEY=your_alipay_public_key
ALIPAY_SIGN_TYPE=RSA2

# 回调URL（必须使用HTTPS）
WECHAT_NOTIFY_URL=https://your-domain.com/api/v1/payments/wechat/notify
ALIPAY_NOTIFY_URL=https://your-domain.com/api/v1/payments/alipay/notify

# 安全阈值
WECHAT_MAX_CALLBACK_DELAY=300
ALIPAY_MAX_CALLBACK_DELAY=300
WECHAT_AMOUNT_THRESHOLD=1000
ALIPAY_AMOUNT_THRESHOLD=1000
```

### 2. Nginx 配置示例

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    # SSL 配置
    ssl_certificate /path/to/your/cert.pem;
    ssl_certificate_key /path/to/your/key.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512;
    ssl_prefer_server_ciphers off;

    # 安全头部
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";

    # 速率限制
    limit_req_zone $binary_remote_addr zone=payment_limit:10m rate=10r/s;
    limit_req zone=payment_limit burst=20 nodelay;

    # 支付回调路径
    location /api/v1/payments/*/notify {
        # 限制请求大小
        client_max_body_size 1m;

        # 仅允许POST
        limit_except POST {
            deny all;
        }

        # IP白名单（可选）
        # allow 101.226.103.0/24;
        # allow 110.75.142.0/24;
        # deny all;

        # 代理到应用
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 5s;
        proxy_send_timeout 10s;
        proxy_read_timeout 10s;
    }
}
```

### 3. 数据库配置

```sql
-- 创建必要的索引
CREATE INDEX idx_payment_callback_logs_provider_created ON payment_callback_logs(provider, createdAt);
CREATE INDEX idx_payment_callback_logs_order_id ON payment_callback_logs(orderId);
CREATE INDEX idx_payment_retry_tasks_next_retry ON payment_retry_tasks(type, nextRetryAt);
CREATE INDEX idx_payment_compensations_status ON payment_compensations(type, status);

-- 设置审计日志保留期（根据需求调整）
CREATE EVENT IF NOT EXISTS cleanup_payment_audit_logs
ON SCHEDULE EVERY 1 DAY
DO
  DELETE FROM paymentCallbackLogs
  WHERE createdAt < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

## 部署步骤

### 1. 准备工作

```bash
# 1. 更新系统
sudo apt update && sudo apt upgrade -y

# 2. 安装必要软件
sudo apt install -y nginx mysql-server redis-server

# 3. 配置防火墙
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable
```

### 2. 部署应用

```bash
# 1. 克隆代码
git clone https://github.com/your-org/zhongdao-mall.git
cd zhongdao-mall

# 2. 安装依赖
npm ci --production

# 3. 配置环境变量
cp .env.production.example .env.production
# 编辑 .env.production 文件，配置必要的环境变量

# 4. 生成 Prisma 客户端
npx prisma generate

# 5. 运行数据库迁移
npx prisma migrate deploy

# 6. 构建应用
npm run build

# 7. 使用 PM2 启动应用
npm install -g pm2
pm2 start ecosystem.config.js --env production
```

### 3. 配置 PM2

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'zhongdao-mall',
    script: './dist/index.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production'
    },
    env_production: {
      NODE_ENV: 'production'
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max_old_space_size=1024'
  }]
};
```

## 安全检查清单

### 1. 基础安全

- [ ] HTTPS 已启用且证书有效
- [ ] 所有敏感配置使用环境变量
- [ ] 防火墙规则正确配置
- [ ] 系统定期更新补丁

### 2. 支付安全

- [ ] 微信支付密钥已配置（32位）
- [ ] 支付宝密钥已配置（RSA格式）
- [ ] 回调URL使用HTTPS
- [ ] IP白名单已配置（生产环境）
- [ ] 签名验证已启用
- [ ] 幂次性控制已启用

### 3. 监控和日志

- [ ] 审计日志已启用
- [ ] 错误监控已配置
- [ ] 性能监控已启用
- [ ] 告警通知已设置
- [ ] 日志定期清理策略已制定

### 4. 数据安全

- [ ] 数据库访问已限制
- [ ] 敏感数据已加密
- [ ] 定期备份已配置
- [ ] 数据库用户权限最小化

## 监控和维护

### 1. 关键监控指标

- 支付成功率
- 回调处理延迟
- 签名验证失败次数
- IP白名单拒绝次数
- 重复回调检测次数

### 2. 告警规则

- 支付成功率低于95%
- 回调处理延迟超过5分钟
- 签名验证失败率超过1%
- 服务器资源使用率超过80%

### 3. 定期维护任务

- 每日：检查错误日志
- 每周：更新IP白名单
- 每月：清理旧日志数据
- 每季度：安全评估和渗透测试

## 应急响应

### 1. 支付异常处理

```bash
# 查看最近的支付错误
grep "支付" /var/log/zhongdao-mall/error.log | tail -100

# 检查数据库一致性
npx prisma db validate

# 查看未处理的补偿记录
mysql -u root -p -e "
  SELECT * FROM paymentCompensations
  WHERE status = 'PENDING'
  ORDER BY createdAt DESC LIMIT 10;
"
```

### 2. 签名问题排查

```bash
# 检查微信支付证书
openssl x509 -in /path/to/wechat_cert.pem -text -noout

# 验证支付宝公钥
openssl rsa -in /path/to/alipay_public_key.pem -pubin -text -noout
```

### 3. 回调重放攻击处理

如果怀疑遭受重放攻击：

1. 立即检查 `paymentCallbackLogs` 表
2. 识别重复的 callbackId
3. 临时增加 IP 白名单限制
4. 分析攻击来源并封禁

## 最佳实践

1. **最小权限原则**：数据库用户仅授予必要权限
2. **深度防御**：多层安全控制，不依赖单一机制
3. **定期轮换**：定期更换密钥和令牌
4. **完整审计**：记录所有支付相关操作
5. **自动化测试**：定期进行安全测试和扫描

## 联系方式

如发现安全问题或需要支持，请联系：

- 安全团队邮箱：security@zhongdao.com
- 技术支持邮箱：tech@zhongdao.com
- 紧急联系电话：+86-xxx-xxxx-xxxx

## 参考资源

- [微信支付安全指南](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter1_1_3.shtml)
- [支付宝开放平台安全指南](https://docs.open.alipay.com/200/106120)
- [OWASP 支付安全指南](https://owasp.org/www-project-cheat-sheets/cheatsheets/Payment_Processing_Cheat_Sheet.html)