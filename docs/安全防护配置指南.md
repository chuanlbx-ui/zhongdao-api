# 中道商城系统安全防护配置指南

## 📋 概述

本指南详细介绍了中道商城系统的安全防护体系，包括已实施的安全措施、配置方法以及安全最佳实践。

## 🛡️ 已实施的安全防护措施

### 1. 认证和授权安全

#### JWT安全增强
- ✅ **强制密钥配置**: 必须设置`JWT_SECRET`环境变量
- ✅ **Token黑名单机制**: 支持登出时立即失效Token
- ✅ **Token刷新系统**: 安全的Token刷新机制
- ✅ **密钥强度检查**: 自动验证JWT密钥复杂度

#### 微信认证安全
- ✅ **完整微信登录**: 真实的微信小程序登录流程
- ✅ **用户信息验证**: 微信用户信息真实性验证
- ✅ **会话管理**: 安全的用户会话管理
- ✅ **登录限流**: 防止暴力破解攻击

### 2. CSRF防护

#### CSRF令牌机制
- ✅ **动态令牌生成**: 基于用户和会话的CSRF令牌
- ✅ **多级验证**: Cookie、Header、请求体三重验证
- ✅ **自动过期**: 24小时自动过期机制
- ✅ **令牌清理**: 定期清理过期令牌

### 3. 文件上传安全

#### 文件验证机制
- ✅ **类型检查**: 严格的文件类型和扩展名验证
- ✅ **大小限制**: 默认10MB文件大小限制
- ✅ **内容验证**: 文件头部字节验证
- ✅ **安全命名**: 自动生成安全的文件名
- ✅ **病毒扫描**: 可配置的恶意文件检测

### 4. 输入验证和数据安全

#### 增强输入验证
- ✅ **模式检测**: SQL注入、XSS、路径遍历等攻击模式检测
- ✅ **敏感信息检测**: 自动检测和屏蔽敏感数据泄露
- ✅ **请求大小限制**: 防止大文件攻击
- ✅ **参数长度验证**: 严格的参数长度限制

#### XSS防护
- ✅ **DOMPurify过滤**: 专业的XSS过滤库
- ✅ **上下文感知**: 基于上下文的XSS防护
- ✅ **脚本阻断**: 自动阻断恶意脚本

### 5. 安全头配置

#### HTTP安全头
- ✅ **CSP策略**: 内容安全策略配置
- ✅ **XSS保护**: 浏览器XSS保护
- ✅ **点击劫持防护**: Frame-Options头
- ✅ **MIME类型嗅探防护**: X-Content-Type-Options
- ✅ **HTTPS强制**: HSTS头（生产环境）

### 6. 限流和监控

#### 多层级限流
- ✅ **登录限流**: 15分钟内最多5次登录尝试
- ✅ **API限流**: 15分钟内最多100次API请求
- ✅ **敏感操作限流**: 15分钟内最多10次敏感操作
- ✅ **IP黑名单**: 自动管理恶意IP黑名单

#### 安全监控
- ✅ **实时监控**: 安全事件实时监控和告警
- ✅ **IP信誉检查**: 基于行为的IP风险评估
- ✅ **安全审计**: 完整的安全事件记录
- ✅ **自动化响应**: 自动安全威胁响应机制

## ⚙️ 安全配置

### 环境变量配置

#### 必需的环境变量
```bash
# 基础配置
NODE_ENV=production  # 生产环境必须设置
JWT_SECRET=your-very-strong-jwt-secret-key-here-at-least-64-characters

# 数据库配置（必须启用SSL）
DATABASE_URL=mysql://user:password@host:3306/database?sslmode=verify-full

# CORS配置（生产环境必须指定具体域名）
CORS_ORIGIN=https://yourdomain.com,https://admin.yourdomain.com

# 文件上传配置
MAX_PAYLOAD_SIZE=10485760  # 10MB
UPLOAD_PATH=./uploads
ALLOWED_FILE_TYPES=jpg,jpeg,png,gif,pdf,doc,docx

# 安全配置
ENABLE_SECURITY_MONITORING=true
ENABLE_CSRF_PROTECTION=true
ENABLE_FILE_SECURITY=true
```

#### 微信支付配置
```bash
# 微信小程序配置
WECHAT_APP_ID=wx1234567890abcdef
WECHAT_MCH_ID=1234567890
WECHAT_API_V3_KEY=your_32_character_api_v3_key_here

# API证书（生产环境必需）
WECHAT_API_CLIENT_CERT="-----BEGIN CERTIFICATE-----\n...\n-----END CERTIFICATE-----"
WECHAT_API_CLIENT_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----"
WECHAT_API_SERIAL_NO=your_cert_serial_no

# 回调配置
WECHAT_NOTIFY_URL=https://yourdomain.com/api/v1/payments/wechat/notify
WECHAT_SANDBOX=false  # 生产环境必须为false
```

### 安全级别配置

#### 高安全级别（推荐用于生产环境）
```bash
NODE_ENV=production
DEBUG=false
ENABLE_SECURITY_HEADERS=true
ENABLE_ENHANCED_INPUT_VALIDATION=true
ENABLE_CSRF_PROTECTION=true
ENABLE_RATE_LIMITING=true
ENABLE_SECURITY_MONITORING=true
ENABLE_FILE_UPLOAD_SECURITY=true
LOG_LEVEL=warn
```

#### 中等安全级别（适用于预发布环境）
```bash
NODE_ENV=staging
DEBUG=true
ENABLE_SECURITY_HEADERS=true
ENABLE_ENHANCED_INPUT_VALIDATION=true
ENABLE_CSRF_PROTECTION=true
ENABLE_RATE_LIMITING=true
ENABLE_SECURITY_MONITORING=true
ENABLE_FILE_UPLOAD_SECURITY=true
LOG_LEVEL=info
```

#### 开发环境配置
```bash
NODE_ENV=development
DEBUG=true
ENABLE_SECURITY_HEADERS=false
ENABLE_ENHANCED_INPUT_VALIDATION=true
ENABLE_CSRF_PROTECTION=false
ENABLE_RATE_LIMITING=true
ENABLE_SECURITY_MONITORING=false
ENABLE_FILE_UPLOAD_SECURITY=true
LOG_LEVEL=debug
```

## 🔒 安全最佳实践

### 1. 密钥管理

#### JWT密钥安全
- 使用密码学安全的随机生成器
- 密钥长度至少64字符
- 包含大小写字母、数字和特殊字符
- 定期轮换密钥（建议每季度）

#### 数据库安全
- 生产环境必须启用SSL/TLS
- 使用强密码策略
- 定期备份数据
- 限制数据库访问权限

### 2. 网络安全

#### HTTPS配置
- 生产环境强制使用HTTPS
- 配置有效的SSL证书
- 启用HSTS预加载
- 禁用不安全的协议

#### 防火墙配置
- 只开放必要的端口
- 实施IP白名单（如果可能）
- 配置DDoS防护
- 定期更新防火墙规则

### 3. 应用安全

#### 输入验证
- 永不信任用户输入
- 使用白名单验证
- 实施长度限制
- 验证数据格式

#### 错误处理
- 不暴露系统内部信息
- 记录详细的错误日志
- 实施优雅的错误响应
- 避免信息泄露

### 4. 监控和审计

#### 安全监控
- 实时监控安全事件
- 设置安全告警
- 定期安全扫描
- 实施渗透测试

#### 日志审计
- 记录所有安全相关操作
- 定期审计日志文件
- 实施日志轮转
- 保护敏感日志信息

## 📊 安全检查清单

### 启动前检查清单

- [ ] 所有必需的环境变量已设置
- [ ] JWT密钥强度足够（≥64字符）
- [ ] 数据库连接启用SSL
- [ ] CORS配置正确
- [ ] 文件上传目录权限正确
- [ ] SSL证书有效（生产环境）

### 部署后检查清单

- [ ] 安全头配置正确
- [ ] CSRF防护正常工作
- [ ] 限流机制生效
- [ ] 安全监控无错误
- [ ] 日志记录正常
- [ ] 所有安全端点可访问

### 定期维护清单（每月）

- [ ] 检查安全配置报告
- [ ] 审查安全事件日志
- [ ] 更新安全补丁
- [ ] 轮换敏感密钥（如需要）
- [ ] 测试备份恢复
- [ ] 进行安全扫描

### 应急响应清单

- [ ] 安全事件响应流程已建立
- [ ] 联系人信息更新
- [ ] 备份系统正常运行
- [ ] 监控告警正常工作
- [ ] 事件处理文档完整

## 🚨 安全事件响应

### 常见安全事件类型

#### 1. 暴力破解攻击
**症状**: 大量登录失败尝试
**响应**:
- 自动增加IP到黑名单
- 临时启用验证码
- 增加认证失败限制
- 通知安全管理员

#### 2. SQL注入攻击
**症状**: 检测到SQL注入模式
**响应**:
- 立即阻止请求
- 记录详细攻击信息
- 分析攻击向量
- 修复注入点

#### 3. XSS攻击
**症状**: 检测到恶意脚本
**响应**:
- 自动过滤恶意内容
- 清理受影响的数据
- 加强输入验证
- 用户安全教育

#### 4. 文件上传攻击
**症状**: 恶意文件上传尝试
**响应**:
- 立即删除恶意文件
- 更新文件类型黑名单
- 加强文件验证
- 扫描已上传文件

### 应急响应流程

#### 1. 检测阶段
1. 监控系统检测到异常
2. 自动生成安全事件
3. 通知相关人员

#### 2. 分析阶段
1. 分析事件严重程度
2. 确定影响范围
3. 收集证据

#### 3. 响应阶段
1. 立即采取防护措施
2. 隔离受影响系统
3. 清理恶意内容

#### 4. 恢复阶段
1. 修复安全漏洞
2. 恢复正常服务
3. 加强防护措施

#### 5. 总结阶段
1. 编写事件报告
2. 更新安全策略
3. 培训相关人员

## 📈 安全监控和报告

### 安全指标

#### 核心指标
- 安全事件数量
- 攻击尝试次数
- IP黑名单数量
- 漏洞发现数量

#### 监控仪表板
访问 `/health/security` 端点查看实时安全状态：

```bash
curl https://yourdomain.com/health/security
```

响应示例：
```json
{
  "success": true,
  "data": {
    "securityLevel": "EXCELLENT",
    "overallScore": 95,
    "timestamp": "2025-11-19T12:00:00.000Z",
    "issues": {
      "errors": 0,
      "warnings": 2
    },
    "monitoring": {
      "totalEvents": 145,
      "blacklistedIPs": 12,
      "suspiciousIPs": 8
    },
    "recommendations": [
      "当前安全配置良好，建议定期进行安全审计",
      "生产环境建议定期更新依赖包",
      "考虑实施定期安全扫描和渗透测试",
      "建议启用安全监控和告警系统"
    ]
  }
}
```

### 定期安全报告

#### 月度安全报告
- 安全事件统计
- 漏洞发现和修复
- 安全配置变化
- 威胁趋势分析

#### 季度安全报告
- 全面安全评估
- 安全合规检查
- 风险评估报告
- 改进建议

## 🔧 故障排除

### 常见安全问题

#### 1. JWT密钥错误
**问题**: JWT_SECRET未设置或太短
**解决方案**:
```bash
# 生成安全的JWT密钥
openssl rand -hex 64
# 设置环境变量
export JWT_SECRET="生成的密钥"
```

#### 2. CSRF验证失败
**问题**: 前端未正确发送CSRF令牌
**解决方案**:
```javascript
// 确保前端包含CSRF令牌
fetch('/api/v1/data', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRF-Token': getCSRFToken() // 从Cookie获取
  },
  body: JSON.stringify(data)
});
```

#### 3. 文件上传失败
**问题**: 文件类型或大小不符合要求
**解决方案**:
- 检查ALLOWED_FILE_TYPES配置
- 检查MAX_FILE_SIZE设置
- 验证文件格式

#### 4. 安全检查失败
**问题**: 系统检测到潜在威胁
**解决方案**:
- 检查请求内容是否包含敏感信息
- 验证输入格式
- 查看安全日志

## 📞 技术支持

### 安全问题报告
如果您发现安全漏洞或安全问题，请通过以下方式报告：

1. **内部安全团队**
   - 安全负责人：security@zhongdao-mall.com
   - 紧急联系电话：+86-xxx-xxxx-xxxx

2. **漏洞报告流程**
   - 详细描述漏洞信息
   - 提供复现步骤
   - 包含影响评估
   - 提交修复建议

### 安全咨询
- 安全配置咨询
- 安全最佳实践指导
- 安全培训安排
- 第三方安全审计协调

---

**更新时间**: 2025-11-19
**版本**: v1.0.0
**维护**: 安全团队

⚠️ **重要提醒**: 本文档包含敏感安全信息，请妥善保管，不要泄露给未授权人员。