# 自动化测试使用指南

本文档介绍了中道商城系统的自动化测试工具，帮助开发者快速验证系统功能、监控性能表现。

## 📋 目录

1. [快速开始](#快速开始)
2. [积分API测试](#积分api测试)
3. [性能测试](#性能测试)
4. [快速测试](#快速测试)
5. [测试配置](#测试配置)
6. [常见问题](#常见问题)

## 🚀 快速开始

### 1. 启动开发服务器

```bash
# 确保数据库已启动
npm run db:generate

# 启动开发服务器
npm run dev
```

### 2. 运行快速测试（推荐日常使用）

```bash
# 快速验证核心功能
npm run test:quick
```

### 3. 运行完整的测试套件

```bash
# 测试积分相关API
npm run test:points

# 运行性能测试
npm run test:performance

# 运行所有API测试
npm run test:api:all
```

## 💰 积分API测试

积分API测试脚本 (`scripts/test-points-api.js`) 用于全面测试积分系统功能，包括：

- 余额查询
- 积分转账
- 积分充值
- 流水记录
- 统计信息
- 冻结/解冻
- 批量充值

### 运行测试

```bash
# 基础测试
npm run test:points

# 或直接运行脚本
node scripts/test-points-api.js
```

### 测试配置

1. 复制环境变量配置文件：
```bash
cp scripts/test-env.example scripts/.test-env
```

2. 编辑配置文件，填入真实的测试数据：
```bash
# 测试用户Token（从登录API获取）
ADMIN_TOKEN=your_admin_token_here
DIRECTOR_TOKEN=your_director_token_here
VIP_TOKEN=your_vip_token_here
NORMAL_TOKEN=your_normal_token_token_here

# 对应的用户ID
ADMIN_USER_ID=admin_user_id_25_characters
...
```

3. 加载配置并运行测试：
```bash
source scripts/.test-env && npm run test:points
```

### 测试报告

测试完成后会生成两个报告文件：

- **JSON报告**: `test-points-api-report.json` - 机器可读的详细测试数据
- **HTML报告**: `test-points-api-report.html` - 可视化测试报告，便于查看

## ⚡ 性能测试

性能测试脚本 (`scripts/test-performance.js`) 用于监控系统性能表现，包括：

- API响应时间分析
- 并发请求测试
- 内存使用监控
- CPU使用率追踪

### 运行测试

```bash
# 运行性能测试
npm run test:performance

# 或直接运行脚本
node scripts/test-performance.js
```

### 测试内容

1. **响应时间测试**: 测试各个API的平均响应时间、P95、P99等指标
2. **并发测试**: 模拟多用户同时访问，测试系统并发能力
3. **资源监控**: 实时监控内存和CPU使用情况
4. **性能评级**: 自动评估性能等级（优秀/良好/可接受/缓慢/严重）

### 性能报告

- **JSON报告**: `performance-test-report.json` - 详细性能数据
- **HTML报告**: `performance-test-report.html` - 包含图表的可视化报告
- **内存配置**: `memory-profile.json` - 内存使用历史数据

### 性能阈值

```javascript
thresholds: {
  responseTime: {
    excellent: 200,   // 优秀: < 200ms
    good: 500,        // 良好: 200-500ms
    acceptable: 1000, // 可接受: 500-1000ms
    slow: 2000        // 缓慢: > 1000ms
  },
  memory: {
    warning: 500,     // MB
    critical: 1000    // MB
  },
  cpu: {
    warning: 70,      // %
    critical: 90      // %
  }
}
```

## ⚡ 快速测试

快速测试脚本 (`scripts/run-quick-tests.js`) 用于开发过程中的快速验证，检查核心功能是否正常。

### 运行测试

```bash
# 运行快速测试
npm run test:quick
```

### 测试项目

- 服务器健康检查
- 管理员认证
- 积分余额查询
- 商品列表获取

## ⚙️ 测试配置

### 环境变量

所有测试脚本支持以下环境变量：

```bash
# API基础地址
API_BASE_URL=http://localhost:3000

# 测试用户认证
ADMIN_TOKEN=...
NORMAL_TOKEN=...
VIP_TOKEN=...
DIRECTOR_TOKEN=...
```

### 测试用户角色

系统支持以下用户角色的测试：

- **ADMIN**: 管理员，拥有所有权限
- **DIRECTOR**: 董事，拥有充值和冻结权限
- **VIP**: VIP用户，普通功能增强
- **NORMAL**: 普通用户，基础功能权限

### 自定义测试

可以通过修改测试脚本来自定义测试用例：

1. **添加新的API测试** (在 `test-points-api.js`):
```javascript
{
  name: '新测试用例',
  method: 'GET',
  path: '/api/v1/new-endpoint',
  userRole: 'normal',
  expectedStatus: 200,
  expectedFields: ['field1', 'field2']
}
```

2. **添加新的性能测试** (在 `test-performance.js`):
```javascript
{
  name: '新性能测试',
  method: 'GET',
  path: '/api/v1/new-endpoint',
  concurrent: 10,
  iterations: 100,
  expectedTime: 300
}
```

## ❓ 常见问题

### Q: 测试失败，提示"服务器未运行"

**A**: 确保开发服务器已启动：
```bash
npm run dev
```

### Q: 积分测试提示"token未配置"

**A**: 按以下步骤配置测试token：

1. 先登录获取token：
```bash
curl -X POST http://localhost:3000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"password"}'
```

2. 复制返回的token到配置文件

### Q: 性能测试显示内存使用过高

**A**: 可能的原因：
- 存在内存泄漏
- 测试并发数过高
- 需要增加内存限制

查看详细报告中的内存使用趋势，定位问题。

### Q: 如何在CI/CD中集成测试？

**A**: 示例GitHub Actions配置：

```yaml
- name: Run API Tests
  run: |
    npm run test:quick
    npm run test:points

- name: Run Performance Tests
  run: |
    npm run test:performance
```

### Q: 测试报告在哪里？

**A**: 测试报告保存在项目根目录：
- `test-points-api-report.html` - 积分API测试报告
- `performance-test-report.html` - 性能测试报告
- `quick-test-report.json` - 快速测试数据报告

### Q: 如何调试测试失败？

**A**: 调试步骤：

1. 查看测试报告中的错误信息
2. 检查服务器日志：`npm run dev` 查看控制台输出
3. 使用API工具（如Postman）手动测试失败的API
4. 检查数据库数据是否正确

## 📚 相关文档

- [API文档](http://localhost:3000/api-docs) - 详细的API接口文档
- [开发指南](./开发指南.md) - 开发流程和规范
- [性能优化指南](./性能优化指南.md) - 系统性能优化建议

## 🤝 贡献

欢迎提交测试用例改进建议或新的测试脚本！请通过以下方式：

1. 创建Issue描述测试需求
2. 提交Pull Request包含测试代码
3. 更新相关文档

---

**测试工具开发团队**
最后更新: 2025-12-08