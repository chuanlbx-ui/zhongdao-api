# 🚀 快速部署指南 - 环境变量修复版

## ✨ 核心改进

这次更新解决了之前的关键问题：**环境变量在编译时被硬编码到dist目录**。

现在编译后的代码可以在任何环境（开发/测试/生产）正确运行，每个环境使用自己的环境变量。

## 📋 部署选项

### 方式1️⃣：Windows用户（推荐）

一条命令完成全部部署：

```powershell
npm run deploy:config-fix
```

**包含的步骤：**
1. ✅ 本地编译
2. ✅ 验证编译结果
3. ✅ 备份远程旧版本
4. ✅ 上传新版本到远程
5. ✅ 重启远程应用
6. ✅ 验证应用启动成功

### 方式2️⃣：Linux/Mac用户

```bash
npm run deploy:config-fix:bash

# 或指定自定义参数
bash scripts/deploy-and-verify.sh production <remote-host> <remote-user> <remote-path>
```

### 方式3️⃣：手动部署（高级用户）

```bash
# 第1步：本地编译
npm run build

# 第2步：验证编译结果
npm run deploy:config-check

# 第3步：上传到远程
scp -r dist package.json root@162.14.114.224:/www/wwwroot/zd-api.wenbita.cn/

# 第4步：远程重启应用
ssh root@162.14.114.224 "cd /www/wwwroot/zd-api.wenbita.cn && pm2 restart ecosystem.config.js --update-env"

# 第5步：验证
curl https://zd-api.wenbita.cn/health
```

## 🔐 前置条件

### 1. 本地环境

✅ Node.js >= 18.0.0
✅ npm >= 9.0.0
✅ PowerShell（Windows）或 Bash（Linux/Mac）

### 2. 远程服务器

✅ SSH访问权限（IP: 162.14.114.224, 用户: root）
✅ PM2 已安装（或使用systemd/supervisor）
✅ Node.js 已安装

### 3. 环境变量设置

在远程服务器上创建环境变量文件：

```bash
# 登录远程服务器
ssh root@162.14.114.224

# 创建环境变量文件
cat > /etc/profile.d/node-env.sh << 'EOF'
#!/bin/bash

# JWT配置
export JWT_SECRET="your-production-secret-key-12345"
export JWT_EXPIRES_IN="7d"
export JWT_REFRESH_EXPIRES_IN="30d"

# 数据库配置
export DATABASE_URL="mysql://zhongdao_mall:password@cd-cynosdbmysql-grp-5q7r23ge.sql.tencentcdb.com:22947/zhongdao-mall"
export DB_HOST="cd-cynosdbmysql-grp-5q7r23ge.sql.tencentcdb.com"
export DB_PORT="22947"
export DB_USER="zhongdao_mall"
export DB_PASSWORD="your-db-password"
export DB_NAME="zhongdao-mall"

# 应用配置
export NODE_ENV="production"
export PORT="3000"

# CORS配置
export CORS_ORIGIN="https://zd-h5.wenbita.cn,https://zd-admin.wenbita.cn"
EOF

# 加载环境变量
source /etc/profile.d/node-env.sh

# 验证环境变量是否设置
echo "JWT_SECRET: $JWT_SECRET"
echo "DATABASE_URL: $DATABASE_URL"
```

## ⚡ 快速部署流程

### 步骤1：检查本地代码

```bash
# 确保代码已提交到git
git status

# 如果有未提交的修改
git add .
git commit -m "环境变量修复版本"
```

### 步骤2：执行部署

#### Windows用户：
```powershell
npm run deploy:config-fix
```

#### Linux/Mac用户：
```bash
npm run deploy:config-fix:bash
```

部署脚本会自动输出详细的步骤日志。

### 步骤3：验证部署结果

部署脚本会自动验证，但你也可以手动检查：

```bash
# 检查应用是否启动
ssh root@162.14.114.224 "pm2 list"

# 查看应用日志
ssh root@162.14.114.224 "pm2 logs api | tail -20"

# 测试API端点
curl https://zd-api.wenbita.cn/health
curl https://zd-api.wenbita.cn/health/database
```

## 🔄 常见任务

### 查看部署日志

```bash
# 实时日志
ssh root@162.14.114.224 "pm2 logs api"

# 或查看文件日志
ssh root@162.14.114.224 "tail -f /www/wwwroot/zd-api.wenbita.cn/logs/api.log"
```

### 重启应用

```bash
# 使用PM2
ssh root@162.14.114.224 "pm2 restart api"

# 或使用systemd（如果已配置）
ssh root@162.14.114.224 "systemctl restart node-zd-api"
```

### 查看应用配置

```bash
# 查看实际加载的配置（脱敏显示）
ssh root@162.14.114.224 "pm2 logs api" | grep "应用配置信息"
```

### 恢复到上一个版本

```bash
# 查看可用备份
ssh root@162.14.114.224 "ls -lah /www/wwwroot/zd-api.wenbita.cn/dist_backup_*"

# 恢复备份（选择最新的时间戳）
ssh root@162.14.114.224 << 'EOF'
cd /www/wwwroot/zd-api.wenbita.cn
rm -rf dist
cp -r dist_backup_20240115_143000 dist
pm2 restart api
EOF
```

### 更新环境变量（无需重新部署）

```bash
# 远程修改环境变量
ssh root@162.14.114.224 "vim /etc/profile.d/node-env.sh"

# 加载新的环境变量
ssh root@162.14.114.224 "source /etc/profile.d/node-env.sh"

# 重启应用以加载新环境变量
ssh root@162.14.114.224 "pm2 restart api --update-env"
```

## ✅ 验证清单

部署完成后，检查以下项目：

- [ ] 本地编译成功 (`npm run build`)
- [ ] 编译结果验证通过 (`npm run deploy:config-check`)
- [ ] SSH能够连接到远程服务器
- [ ] 远程服务器环境变量已设置 (`ssh root@... "echo $JWT_SECRET"`)
- [ ] dist目录已上传到远程 (`ssh root@... "ls -la dist"`)
- [ ] 应用已重启 (`ssh root@... "pm2 list"`)
- [ ] 健康检查通过 (`curl https://zd-api.wenbita.cn/health`)
- [ ] 数据库连接正常 (`curl https://zd-api.wenbita.cn/health/database`)

## 🆘 故障排查

### 问题1：编译失败

**错误：** `npm ERR! code ELIFECYCLE`

**解决：**
```bash
# 清理缓存
rm -rf node_modules dist
npm install
npm run build
```

### 问题2：SSH连接失败

**错误：** `ssh: Could not resolve hostname`

**解决：**
```bash
# 检查网络连接
ping 162.14.114.224

# 检查SSH配置
ssh -v root@162.14.114.224

# 配置SSH密钥（可选，避免输入密码）
ssh-copy-id -i ~/.ssh/id_rsa.pub root@162.14.114.224
```

### 问题3：部署后应用未启动

**错误：** `curl: (7) Failed to connect to port 3000`

**解决：**
```bash
# 查看应用错误日志
ssh root@162.14.114.224 "pm2 logs api --err | tail -50"

# 检查环境变量是否设置
ssh root@162.14.114.224 "env | grep JWT_SECRET"

# 手动启动应用查看错误
ssh root@162.14.114.224 "cd /www/wwwroot/zd-api.wenbita.cn && node dist/index.js"
```

### 问题4：环境变量未被读取

**症状：** 应用日志中显示 `JWT_SECRET未设置`

**原因：** 环境变量文件未被加载

**解决：**
```bash
# 检查环境变量文件是否存在
ssh root@162.14.114.224 "cat /etc/profile.d/node-env.sh"

# 确保权限正确
ssh root@162.14.114.224 "chmod 644 /etc/profile.d/node-env.sh"

# 重新加载环境
ssh root@162.14.114.224 "source /etc/profile.d/node-env.sh && env | grep JWT"

# 使用--update-env重启PM2
ssh root@162.14.114.224 "pm2 restart api --update-env"
```

## 📚 相关文档

- 详细说明：`docs/环境变量运行时读取修复说明.md`
- 配置模块：`src/config/index.ts`
- 部署脚本：
  - `scripts/deploy-config-fix.ps1` (PowerShell)
  - `scripts/deploy-and-verify.sh` (Bash)

## 🎯 核心概念回顾

**编译时读取环境变量 ❌**
```typescript
const JWT_SECRET = process.env.JWT_SECRET;  // 硬编码到dist
```

**运行时读取环境变量 ✅**
```typescript
import { config } from './config';  // 应用启动时读取
const JWT_SECRET = config.jwt.secret;  // 运行时获取
```

这样编译后的 `dist` 可以在任何环境正确运行！

## 💡 Tips

1. **提前验证编译结果**
   ```bash
   npm run deploy:config-check
   ```

2. **保留备份**
   - 脚本自动创建备份，保留最近3个版本
   - 可以随时回滚

3. **逐步部署**
   - 先在测试环境验证
   - 确认无误后再部署到生产环境

4. **监控日志**
   - 部署后立即查看日志
   - 确保应用正常启动

---

**部署需要帮助？检查 `docs/环境变量运行时读取修复说明.md` 获取完整文档。**
