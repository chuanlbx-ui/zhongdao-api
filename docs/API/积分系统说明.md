# 积分（通券）系统说明

## 概述

中道商城的积分系统（称为"通券"）是平台内部流通的虚拟货币，用户可以通过多种方式获得通券，并用于商品购买、转账等操作。通券系统是平台商业模式的核心，连接了用户、店铺和平台的整个生态。

## 通券获取方式

### 1. 下级采购返佣

**说明**: 当下级用户使用通券购买商品时，上级用户可以获得通券返佣。

**规则**:
- 直推用户购物：上级获得交易金额的12%-20%作为通券返佣
- 间推用户购物：上上级获得交易金额的2%-8%作为通券返佣
- 返佣比例根据上级用户的等级决定

**示例**:
```
用户A（三星店长，12%返佣）
  └─ 用户B（VIP，5%返佣）
      └─ 用户C（普通会员）购买1000元商品
      └─ 用户B获得：1000 × 5% = 50通券
      └─ 用户A获得：1000 × 12% = 120通券
```

### 2. 平台充值（特权用户）

**说明**: 五星店长和董事级别用户可以向平台充值通券。

**规则**:
- 仅限STAR_5和DIRECTOR级别用户
- 充值比例：1元人民币 = 1通券
- 单次最低充值：1000通券
- 单日充值上限：50000通券

### 3. 用户间转账

**说明**: 用户之间可以进行通券转账。

**规则**:
- 转账双方都必须是店长级别（VIP及以上）
- 单笔转账范围：1-10000通券
- 每日转账次数限制：50次
- 平台内转账免费，跨平台转账收取1%手续费

### 4. 活动奖励

**说明**: 平台定期举办活动，奖励通券。

**活动类型**:
- 新用户注册奖励
- 首单奖励
- 团队达标奖励
- 销售竞赛奖励
- 节日活动奖励

## API接口详解

### 1. 获取通券余额

**接口地址**: `GET /api/v1/points/balance`

**请求头**:
```
Authorization: Bearer <token>
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "balance": 12580.50,
    "frozenBalance": 500.00,
    "availableBalance": 12080.50,
    "totalIncome": 50000.00,
    "totalExpense": 37419.50,
    "statistics": {
      "todayIncome": 150.00,
      "todayExpense": 0.00,
      "monthIncome": 2800.00,
      "monthExpense": 1200.00,
      "yearIncome": 35000.00,
      "yearExpense": 25000.00
    },
    "limits": {
      "dailyTransferLimit": 100000.00,
      "dailyTransferred": 0.00,
      "maxTransferPerTransaction": 10000.00,
      "minTransferPerTransaction": 1.00
    },
    "lastUpdated": "2025-11-24T03:06:00.000Z"
  },
  "message": "获取成功"
}
```

### 2. 通券转账

**接口地址**: `POST /api/v1/points/transfer`

**请求参数**:
```json
{
  "toUserId": "cmi4n337o0001edbcfwcx3rydn",
  "amount": 100.50,
  "note": "进货结算",
  "password": "123456"  // 交易密码
}
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "transactionId": "TXN202511240001",
    "fromUserId": "cmi1234567890abcdef",
    "toUserId": "cmi4n337o0001edbcfwcx3rydn",
    "toUserInfo": {
      "nickname": "李四",
      "avatarUrl": "https://wx.qlogo.cn/...",
      "level": "VIP"
    },
    "amount": 100.50,
    "fee": 0.00,
    "actualAmount": 100.50,
    "balance": 11980.00,
    "status": "SUCCESS",
    "note": "进货结算",
    "timestamp": "2025-11-24T10:30:00.000Z"
  },
  "message": "转账成功"
}
```

### 3. 获取交易明细

**接口地址**: `GET /api/v1/points/transactions`

**查询参数**:
- `type`: 交易类型（INCOME/EXPENSE/TRANSFER/FREEZE/UNFREEZE）
- `startDate`: 开始日期
- `endDate`: 结束日期
- `page`: 页码
- `limit`: 每页数量

**响应数据**:
```json
{
  "success": true,
  "data": {
    "transactions": [
      {
        "id": "txn_1234567890",
        "type": "INCOME",
        "subType": "COMMISSION",
        "amount": 120.00,
        "balance": 12580.50,
        "description": "下级用户购物返佣",
        "relatedUser": {
          "id": "cmi1234567890abcddd",
          "nickname": "王五",
          "avatarUrl": "https://wx.qlogo.cn/..."
        },
        "relatedOrder": {
          "id": "cmo1234567890",
          "orderNo": "ZD20251124001"
        },
        "status": "COMPLETED",
        "createdAt": "2025-11-24T10:30:00.000Z"
      },
      {
        "id": "txn_1234567891",
        "type": "EXPENSE",
        "subType": "PURCHASE",
        "amount": -299.50,
        "balance": 12460.50,
        "description": "购买中道口服液",
        "relatedProduct": {
          "id": "cmp1234567890",
          "name": "中道口服液",
          "spec": "10支/盒",
          "quantity": 1
        },
        "status": "COMPLETED",
        "createdAt": "2025-11-24T09:15:00.000Z"
      },
      {
        "id": "txn_1234567892",
        "type": "TRANSFER",
        "subType": "OUTGOING",
        "amount": -500.00,
        "balance": 11960.50,
        "description": "转账给张三",
        "relatedUser": {
          "id": "cmi9876543210",
          "nickname": "张三",
          "avatarUrl": "https://wx.qlogo.cn/..."
        },
        "fee": 5.00,
        "status": "COMPLETED",
        "createdAt": "2025-11-23T15:20:00.000Z"
      }
    ],
    "summary": {
      "totalTransactions": 156,
      "totalIncome": 35680.00,
      "totalExpense": -23099.50,
      "netIncome": 12580.50,
      "commissionIncome": 25000.00,
      "transferIncome": 5680.00,
      "purchaseExpense": -18000.00,
      "transferExpense": -5099.50
    },
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 156,
      "totalPages": 8
    }
  },
  "message": "获取成功"
}
```

### 4. 通券充值（特权用户）

**接口地址**: `POST /api/v1/points/recharge`

**请求参数**:
```json
{
  "amount": 5000,
  "paymentMethod": "WECHAT",
  "promotionCode": "FIRST_RECHARGE_2025"
}
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "rechargeId": "rch_1234567890",
    "amount": 5000.00,
    "actualAmount": 5000.00,
    "bonusAmount": 500.00,  // 首充赠送10%
    "totalPoints": 5500.00,
    "paymentInfo": {
      "paymentUrl": "https://pay.zhongdao-mall.com/recharge/123456",
      "qrCode": "data:image/png;base64,",
      "expiresAt": "2025-11-24T11:30:00.000Z"
    },
    "status": "PENDING_PAYMENT",
    "promotionApplied": {
      "code": "FIRST_RECHARGE_2025",
      "name": "首次充值优惠",
      "bonusRate": 0.10
    }
  },
  "message": "充值订单创建成功，请在30分钟内完成支付"
}
```

### 5. 查询充值状态

**接口地址**: `GET /api/v1/points/recharge/{rechargeId}/status`

**响应数据**:
```json
{
  "success": true,
  "data": {
    "rechargeId": "rch_1234567890",
    "amount": 5000.00,
    "status": "COMPLETED",
    "paidAt": "2025-11-24T11:25:00.000Z",
    "pointsAdded": 5500.00,
    "balanceBefore": 7080.50,
    "balanceAfter": 12580.50,
    "transactionId": "txn_1234567893"
  },
  "message": "获取成功"
}
```

### 6. 通券提现

**接口地址**: `POST /api/v1/points/withdraw`

**请求参数**:
```json
{
  "amount": 2000,
  "withdrawMethod": "BANK",
  "bankInfo": {
    "accountName": "张三",
    "accountNumber": "6222021234567890",
    "bankName": "工商银行",
    "branchName": "深圳南山支行"
  },
  "password": "123456"
}
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "withdrawId": "wth_1234567890",
    "amount": 2000.00,
    "fee": 20.00,  // 1%手续费
    "actualAmount": 1980.00,
    "status": "PENDING_REVIEW",
    "estimatedArrival": "3-5个工作日",
    "reviewNotes": "提现申请已提交，等待财务审核"
  },
  "message": "提现申请提交成功"
}
```

### 7. 获取通券统计报表

**接口地址**: `GET /api/v1/points/statistics`

**查询参数**:
- `period`: 统计周期（day/week/month/year）
- `startDate`: 开始日期
- `endDate`: 结束日期
- `groupBy`: 分组方式（type/user/product）

**响应数据**:
```json
{
  "success": true,
  "data": {
    "overview": {
      "totalIncome": 35000.00,
      "totalExpense": -20000.00,
      "netIncome": 15000.00,
      "averageDaily": 500.00,
      "growthRate": 15.5
    },
    "incomeBreakdown": [
      {
        "type": "COMMISSION",
        "amount": 25000.00,
        "percentage": 71.4,
        "transactions": 156,
        "growth": 20.3
      },
      {
        "type": "TRANSFER_IN",
        "amount": 8000.00,
        "percentage": 22.9,
        "transactions": 23,
        "growth": 5.2
      },
      {
        "type": "RECHARGE",
        "amount": 2000.00,
        "percentage": 5.7,
        "transactions": 2,
        "growth": 0
      }
    ],
    "expenseBreakdown": [
      {
        "type": "PURCHASE",
        "amount": -15000.00,
        "percentage": 75,
        "transactions": 89,
        "growth": 10.5
      },
      {
        "type": "TRANSFER_OUT",
        "amount": -3000.00,
        "percentage": 15,
        "transactions": 15,
        "growth": -5.2
      },
      {
        "type": "WITHDRAW",
        "amount": -2000.00,
        "percentage": 10,
        "transactions": 4,
        "growth": 50
      }
    ],
    "trends": {
      "daily": [
        {
          "date": "2025-11-01",
          "income": 500.00,
          "expense": -300.00,
          "net": 200.00
        }
      ],
      "monthly": [
        {
          "month": "2025-10",
          "income": 12000.00,
          "expense": -8000.00,
          "net": 4000.00
        }
      ]
    },
    "topIncomeSources": [
      {
        "userId": "cmi1234567890abcddd",
        "nickname": "李四",
        "avatarUrl": "https://wx.qlogo.cn/...",
        "amount": 5000.00,
        "transactions": 25
      }
    ]
  },
  "message": "获取成功"
}
```

## 通券使用场景

### 1. 商品购买

通券是平台的主要支付方式之一：

- 用户可以使用通券购买任何商品
- 享受基于用户等级的折扣价格
- 通券支付无额外手续费

### 2. 团队内部结算

- 上级给下级发放奖励
- 团队内部利润分配
- 活动奖金发放

### 3. 平台服务费

- 特殊服务申请费用
- 认证费用
- 培训课程费用

## 交易类型说明

| 类型编码 | 类型名称 | 说明 | 余额变化 |
|---------|---------|------|----------|
| INCOME | 收入 | 通券增加 | + |
| EXPENSE | 支出 | 通券减少 | - |
| TRANSFER | 转账 | 用户间转账 | ± |
| FREEZE | 冻结 | 通券冻结 | = |
| UNFREEZE | 解冻 | 通券解冻 | = |
| REFUND | 退款 | 退款返回 | + |

### 子类型详解

| 子类型编码 | 子类型名称 | 触发条件 |
|-----------|-----------|----------|
| COMMISSION | 佣金返佣 | 下级用户购物 |
| PURCHASE | 商品购买 | 使用通券购物 |
| TRANSFER_IN | 转账收入 | 收到他人转账 |
| TRANSFER_OUT | 转账支出 | 给他人转账 |
| RECHARGE | 充值 | 平台充值 |
| WITHDRAW | 提现 | 通券提现 |
| GIFT | 礼物 | 活动奖励 |
| PENALTY | 扣罚 | 违规处罚 |

## 安全机制

### 1. 交易密码

- 重要操作需要交易密码验证
- 交易密码与登录密码独立
- 支持密码找回和重置

### 2. 额度限制

- 单日转账上限：100000通券
- 单笔转账上限：10000通券
- 每日提现上限：50000通券

### 3. 风控系统

- 异常交易监控
- 大额交易审核
- 频繁交易限制
- 黑名单机制

### 4. 冻结机制

以下情况可能导致通券被冻结：
- 账户安全风险
- 违规操作
- 交易纠纷
- 法律要求

## 数据库模型

### PointsTransaction表

```sql
CREATE TABLE PointsTransaction (
  id VARCHAR(36) PRIMARY KEY,
  userId VARCHAR(36) NOT NULL,
  type ENUM('INCOME', 'EXPENSE', 'TRANSFER', 'FREEZE', 'UNFREEZE', 'REFUND') NOT NULL,
  subType VARCHAR(50) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  balance DECIMAL(10,2) NOT NULL,
  description TEXT,
  relatedUserId VARCHAR(36),  // 交易相关用户
  relatedOrderId VARCHAR(36), // 相关订单
  relatedProductId VARCHAR(36), // 相关商品
  status ENUM('PENDING', 'COMPLETED', 'FAILED', 'CANCELLED') DEFAULT 'COMPLETED',
  metadata JSON,  // 额外数据
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_userId (userId),
  INDEX idx_type (type),
  INDEX idx_status (status),
  INDEX idx_createdAt (createdAt),
  INDEX idx_userId_createdAt (userId, createdAt)
);
```

### UserPoints表

```sql
CREATE TABLE UserPoints (
  id VARCHAR(36) PRIMARY KEY,
  userId VARCHAR(36) UNIQUE NOT NULL,
  balance DECIMAL(10,2) DEFAULT 0.00,
  frozenBalance DECIMAL(10,2) DEFAULT 0.00,
  totalIncome DECIMAL(10,2) DEFAULT 0.00,
  totalExpense DECIMAL(10,2) DEFAULT 0.00,
  lastTransactionAt TIMESTAMP,
  passwordHash VARCHAR(255),  // 交易密码
  passwordFailedCount INT DEFAULT 0,
  passwordLockedUntil TIMESTAMP,
  dailyTransferLimit DECIMAL(10,2) DEFAULT 100000.00,
  dailyTransferred DECIMAL(10,2) DEFAULT 0.00,
  lastTransferDate DATE,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_userId (userId),
  FOREIGN KEY (userId) REFERENCES User(id)
);
```

## 前端集成示例

### React组件

```tsx
// PointsBalance.tsx
import React from 'react';
import { Card, Row, Col, Statistic, Progress, Button } from 'antd';
import { useQuery } from '@tanstack/react-query';

export const PointsBalance: React.FC = () => {
  const { data: balanceData } = useQuery({
    queryKey: ['pointsBalance'],
    queryFn: () => api.get('/points/balance').then(res => res.data.data)
  });

  if (!balanceData) return null;

  const usagePercentage = (balanceData.totalExpense / Math.abs(balanceData.totalIncome)) * 100;

  return (
    <Card title="通券余额" extra={
      <Button type="primary" icon={<TransactionOutlined />}>
        转账
      </Button>
    }>
      <Row gutter={16}>
        <Col span={8}>
          <Statistic
            title="可用余额"
            value={balanceData.availableBalance}
            precision={2}
            suffix="通券"
            valueStyle={{ color: '#3f8600' }}
          />
        </Col>
        <Col span={8}>
          <Statistic
            title="冻结余额"
            value={balanceData.frozenBalance}
            precision={2}
            suffix="通券"
            valueStyle={{ color: '#cf1322' }}
          />
        </Col>
        <Col span={8}>
          <Statistic
            title="累计收入"
            value={balanceData.totalIncome}
            precision={2}
            suffix="通券"
          />
        </Col>
      </Row>

      <div className="mt-4">
        <p className="text-gray-500 mb-2">收支比例</p>
        <Progress
          percent={usagePercentage}
          status="active"
          format={() => `${usagePercentage.toFixed(1)}%`}
        />
        <p className="text-sm text-gray-500 mt-1">
          收入: {balanceData.totalIncome.toFixed(2)} |
          支出: {Math.abs(balanceData.totalExpense).toFixed(2)}
        </p>
      </div>

      <Row gutter={16} className="mt-4">
        <Col span={12}>
          <Statistic
            title="今日收入"
            value={balanceData.statistics.todayIncome}
            precision={2}
            suffix="通券"
            valueStyle={{ color: '#3f8600' }}
          />
        </Col>
        <Col span={12}>
          <Statistic
            title="今日支出"
            value={Math.abs(balanceData.statistics.todayExpense)}
            precision={2}
            suffix="通券"
            valueStyle={{ color: '#cf1322' }}
          />
        </Col>
      </Row>
    </Card>
  );
};

// TransactionHistory.tsx
import React, { useState } from 'react';
import { Table, Tag, DatePicker, Space, Button, Input, Select } from 'antd';
import { useQuery } from '@tanstack/react-query';
import { SearchOutlined, ReloadOutlined } from '@ant-design/icons';

export const TransactionHistory: React.FC = () => {
  const [filters, setFilters] = useState({
    type: '',
    dateRange: [],
    page: 1
  });

  const { data: transactionData, isLoading, refetch } = useQuery({
    queryKey: ['pointsTransactions', filters],
    queryFn: () => api.get('/points/transactions', {
      params: filters
    }).then(res => res.data.data)
  });

  const columns = [
    {
      title: '时间',
      dataIndex: 'createdAt',
      key: 'createdAt',
      render: (time: string) => dayjs(time).format('YYYY-MM-DD HH:mm:ss')
    },
    {
      title: '类型',
      dataIndex: 'type',
      key: 'type',
      render: (type: string) => {
        const typeMap = {
          INCOME: { color: 'green', text: '收入' },
          EXPENSE: { color: 'red', text: '支出' },
          TRANSFER: { color: 'blue', text: '转账' },
          FREEZE: { color: 'orange', text: '冻结' },
          UNFREEZE: { color: 'purple', text: '解冻' }
        };
        const config = typeMap[type] || { color: 'default', text: type };
        return <Tag color={config.color}>{config.text}</Tag>;
      }
    },
    {
      title: '描述',
      dataIndex: 'description',
      key: 'description'
    },
    {
      title: '金额',
      dataIndex: 'amount',
      key: 'amount',
      render: (amount: number) => (
        <span style={{ color: amount >= 0 ? '#3f8600' : '#cf1322' }}>
          {amount >= 0 ? '+' : ''}{amount.toFixed(2)} 通券
        </span>
      )
    },
    {
      title: '余额',
      dataIndex: 'balance',
      key: 'balance',
      render: (balance: number) => `${balance.toFixed(2)} 通券`
    },
    {
      title: '相关用户',
      key: 'relatedUser',
      render: (_, record: any) => record.relatedUser ? (
        <Space>
          <Avatar size="small" src={record.relatedUser.avatarUrl} />
          <span>{record.relatedUser.nickname}</span>
        </Space>
      ) : '-'
    }
  ];

  return (
    <Card
      title="交易明细"
      extra={
        <Space>
          <Select
            placeholder="交易类型"
            style={{ width: 120 }}
            value={filters.type}
            onChange={(value) => setFilters({ ...filters, type: value })}
          >
            <Select.Option value="">全部</Select.Option>
            <Select.Option value="INCOME">收入</Select.Option>
            <Select.Option value="EXPENSE">支出</Select.Option>
            <Select.Option value="TRANSFER">转账</Select.Option>
          </Select>
          <DatePicker.RangePicker
            value={filters.dateRange}
            onChange={(dates) => setFilters({ ...filters, dateRange: dates })}
          />
          <Button
            icon={<SearchOutlined />}
            onClick={() => refetch()}
          >
            搜索
          </Button>
          <Button
            icon={<ReloadOutlined />}
            onClick={() => refetch()}
          >
            刷新
          </Button>
        </Space>
      }
    >
      <Table
        columns={columns}
        dataSource={transactionData?.transactions}
        loading={isLoading}
        pagination={{
          current: filters.page,
          total: transactionData?.pagination.total,
          onChange: (page) => setFilters({ ...filters, page })
        }}
        rowKey="id"
      />

      {/* 汇总信息 */}
      <div className="mt-4 p-4 bg-gray-50 rounded">
        <Row gutter={16}>
          <Col span={6}>
            <Statistic
              title="总收入"
              value={transactionData?.summary.totalIncome}
              precision={2}
              suffix="通券"
              valueStyle={{ color: '#3f8600' }}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="总支出"
              value={Math.abs(transactionData?.summary.totalExpense)}
              precision={2}
              suffix="通券"
              valueStyle={{ color: '#cf1322' }}
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="净收入"
              value={transactionData?.summary.netIncome}
              precision={2}
              suffix="通券"
            />
          </Col>
          <Col span={6}>
            <Statistic
              title="交易笔数"
              value={transactionData?.summary.totalTransactions}
              suffix="笔"
            />
          </Col>
        </Row>
      </div>
    </Card>
  );
};
```

## 最佳实践

1. **余额管理**
   - 定期查看余额变动
   - 设置余额预警提醒
   - 合理规划通券使用

2. **转账安全**
   - 核实收款方信息
   - 设置交易密码
   - 保留转账记录

3. **交易查询**
   - 定期导出交易记录
   - 核对重要交易
   - 及时反馈异常

4. **风险防范**
   - 保护账户安全
   - 不相信高收益承诺
   - 及时举报可疑行为