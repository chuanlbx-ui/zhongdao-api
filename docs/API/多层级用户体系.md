# 多层级用户体系

## 概述

中道商城系统采用多层级用户体系设计，从普通会员逐步升级到董事级别，每个等级享有不同的权益和佣金比例。该体系旨在激励用户发展团队，实现共赢。

## 用户等级体系

### 等级结构

```
董事 (DIRECTOR)
    ↑
五星店长 (STAR_5)
    ↑
四星店长 (STAR_4)
    ↑
三星店长 (STAR_3)
    ↑
二星店长 (STAR_2)
    ↑
一星店长 (STAR_1)
    ↑
VIP会员 (VIP)
    ↑
普通会员 (NORMAL)
```

### 等级说明

| 等级 | 升级条件 | 进货折扣 | 直推佣金 | 间推佣金 | 特殊权益 |
|------|----------|----------|----------|----------|----------|
| NORMAL | 注册即可 | 无折扣 | 0% | 0% | 基础购物 |
| VIP | 首单≥599元 | 5折 | 5% | 0% | 享受进货折扣 |
| STAR_1 | 直推5个VIP | 4折 | 8% | 2% | 团队管理 |
| STAR_2 | 直推10个VIP，团队50人 | 3.5折 | 10% | 3% | 更高佣金 |
| STAR_3 | 直推15个VIP，团队150人 | 3折 | 12% | 4% | 中级管理 |
| STAR_4 | 直推25个VIP，团队500人 | 2.6折 | 15% | 5% | 高级管理 |
| STAR_5 | 直推40个VIP，团队1000人 | 2.4折 | 18% | 6% | 顶级管理 |
| DIRECTOR | 直推60个VIP，团队3000人 | 2.2折 | 20% | 8% | 平台充值权益 |

## API接口详解

### 1. 获取用户等级信息

**接口地址**: `GET /api/v1/users/level-info`

**请求头**:
```
Authorization: Bearer <token>
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "currentLevel": "STAR_3",
    "levelName": "三星店长",
    "progress": {
      "directVipCount": 15,
      "requiredDirectVip": 15,
      "teamSize": 150,
      "requiredTeamSize": 150,
      "totalSales": 100000.00,
      "requiredSales": 80000.00,
      "percentage": 100,
      "canUpgrade": true
    },
    "nextLevel": {
      "level": "STAR_4",
      "levelName": "四星店长",
      "benefits": {
        "discount": 0.74,
        "directCommission": 0.15,
        "indirectCommission": 0.05
      },
      "requirements": {
        "directVip": 25,
        "teamSize": 500,
        "totalSales": 200000
      }
    },
    "privileges": [
      "VIEW_TEAM_STATS",
      "MANAGE_SUBORDINATES",
      "COMMISSION_WITHDRAW",
      "LEVEL_MANAGEMENT"
    ]
  },
  "message": "获取成功"
}
```

### 2. 获取团队结构

**接口地址**: `GET /api/v1/teams/structure`

**请求参数**:
```
GET /api/v1/teams/structure?level=2&limit=50
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "root": {
      "id": "cmi1234567890abcdef",
      "nickname": "张三",
      "level": "STAR_3",
      "avatarUrl": "https://wx.qlogo.cn/...",
      "directCount": 15,
      "teamCount": 150
    },
    "children": [
      {
        "id": "cmi1234567890abcddd",
        "nickname": "李四",
        "level": "STAR_2",
        "parentId": "cmi1234567890abcdef",
        "directCount": 8,
        "teamCount": 45,
        "children": [...]
      }
    ],
    "pagination": {
      "page": 1,
      "limit": 50,
      "total": 150,
      "hasMore": true
    }
  },
  "message": "获取成功"
}
```

### 3. 获取团队统计

**接口地址**: `GET /api/v1/teams/stats`

**查询参数**:
- `period`: 统计周期（day/week/month/year）
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**:
```json
{
  "success": true,
  "data": {
    "overview": {
      "totalMembers": 150,
      "activeMembers": 120,
      "newMembers": 15,
      "totalSales": 500000.00,
      "myCommission": 25000.00,
      "teamRank": 5
    },
    "levelDistribution": [
      { "level": "NORMAL", "count": 50, "percentage": 33.3 },
      { "level": "VIP", "count": 60, "percentage": 40 },
      { "level": "STAR_1", "count": 25, "percentage": 16.7 },
      { "level": "STAR_2", "count": 10, "percentage": 6.7 },
      { "level": "STAR_3", "count": 5, "percentage": 3.3 }
    ],
    "performance": {
      "daily": [
        { "date": "2025-11-01", "sales": 5000.00, "members": 2 },
        { "date": "2025-11-02", "sales": 6500.00, "members": 3 }
      ],
      "monthly": [
        { "month": "2025-10", "sales": 150000.00, "members": 45 },
        { "month": "2025-11", "sales": 180000.00, "members": 52 }
      ]
    },
    "ranking": {
      "personal": {
        "rank": 15,
        "totalUsers": 500,
        "topUser": {
          "nickname": "王总",
          "teamSize": 5000,
          "level": "DIRECTOR"
        }
      },
      "team": {
        "rank": 8,
        "totalTeams": 100,
        "performance": 85.5
      }
    }
  },
  "message": "获取成功"
}
```

### 4. 获取直推列表

**接口地址**: `GET /api/v1/teams/direct-referrals`

**查询参数**:
- `page`: 页码（默认1）
- `limit`: 每页数量（默认20）
- `level`: 筛选等级
- `status`: 状态筛选（active/inactive/all）

**响应数据**:
```json
{
  "success": true,
  "data": {
    "referrals": [
      {
        "id": "cmi1234567890abcddd",
        "nickname": "李四",
        "avatarUrl": "https://wx.qlogo.cn/...",
        "phone": "138****1234",
        "level": "STAR_2",
        "joinDate": "2025-10-15",
        "lastActive": "2025-11-23",
        "totalOrders": 25,
        "totalSales": 30000.00,
        "status": "active",
        "commissionEarned": 1500.00
      }
    ],
    "summary": {
      "totalReferrals": 15,
      "activeReferrals": 12,
      "totalCommission": 8500.00,
      "monthlyCommission": 1200.00
    },
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 15,
      "totalPages": 1
    }
  },
  "message": "获取成功"
}
```

### 5. 申请等级升级

**接口地址**: `POST /api/v1/users/apply-upgrade`

**请求参数**:
```json
{
  "targetLevel": "STAR_4",
  "reason": "已满足升级条件，团队人数和业绩达标"
}
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "applicationId": "app_1234567890",
    "status": "pending",
    "estimatedReviewTime": "3个工作日",
    "currentProgress": {
      "directVipCount": {
        "current": 25,
        "required": 25,
        "passed": true
      },
      "teamSize": {
        "current": 500,
        "required": 500,
        "passed": true
      },
      "totalSales": {
        "current": 210000.00,
        "required": 200000.00,
        "passed": true
      }
    }
  },
  "message": "升级申请已提交，请等待审核"
}
```

## 团队路径机制

### 1. 团队路径结构

用户加入时会生成团队路径，便于快速查询上下级关系：

```
用户ID: cmi1234567890abcdef
团队路径: root/parent1/parent2/currentUser
路径深度: 3
```

### 2. 推荐关系

- **直推**: 直接推荐的用户
- **间推**: 通过下级推荐的用户
- **团队**: 所有下级用户（包括多级）

### 3. 佣金分配规则

```
示例：用户A（三星店长）的佣金分配
- 直推用户B购物1000元
  - A获得佣金：1000 × 12% = 120元
  - A的上上级获得：1000 × 4% = 40元
  - A的上上上级获得：1000 × 2% = 20元
```

## 等级权益详情

### 1. 进货折扣权益

不同等级享受不同的进货折扣，等级越高折扣越大：

```typescript
const getDiscountRate = (level: UserLevel): number => {
  const discounts = {
    'NORMAL': 1,      // 无折扣
    'VIP': 0.5,       // 5折
    'STAR_1': 0.4,    // 4折
    'STAR_2': 0.35,   // 3.5折
    'STAR_3': 0.3,    // 3折
    'STAR_4': 0.26,   // 2.6折
    'STAR_5': 0.24,   // 2.4折
    'DIRECTOR': 0.22  // 2.2折
  };
  return discounts[level] || 1;
};
```

### 2. 佣金权益

- **直推佣金**: 直接推荐用户购物时获得的佣金
- **间推佣金**: 间接推荐用户购物时获得的佣金
- **平级奖励**: 同等级用户购物时的特殊奖励
- **团队奖励**: 团队整体业绩达标时的额外奖励

### 3. 特殊权益

#### VIP及以上等级
- 享受进货折扣
- 可以发展下级团队
- 获得购物佣金

#### STAR_1及以上等级
- 团队管理权限
- 查看团队数据
- 导出团队报表

#### STAR_3及以上等级
- 佣金快速结算
- 专属客服支持
- 参与平台决策

#### STAR_5及以上等级
- 平台充值权益
- 区域代理优先权
- 年度分红资格

## 升级规则详解

### 1. 自动升级

系统每天凌晨会自动检测用户是否满足升级条件：

```typescript
// 自动升级检测逻辑
const checkUpgrade = async (userId: string) => {
  const user = await getUser(userId);
  const stats = await getUserStats(userId);
  const nextLevel = getNextLevel(user.level);

  if (stats.directVipCount >= nextLevel.requiredDirectVip &&
      stats.teamSize >= nextLevel.requiredTeamSize &&
      stats.totalSales >= nextLevel.requiredSales) {
    await upgradeUser(userId, nextLevel.level);
    await notifyUpgrade(user, nextLevel);
  }
};
```

### 2. 手动申请

对于特殊情况下，用户可以手动申请升级：
- 系统误判
- 特殊贡献
- 平台活动奖励

### 3. 降级规则

- **长期不活跃**: 连续6个月无任何交易
- **违规操作**: 严重违反平台规则
- **主动申请**: 用户自愿降级

## 数据库模型

### User表关键字段

```sql
CREATE TABLE User (
  id VARCHAR(36) PRIMARY KEY,
  openid VARCHAR(64) UNIQUE NOT NULL,
  nickname VARCHAR(100),
  avatarUrl VARCHAR(500),
  phone VARCHAR(20),
  level ENUM('NORMAL', 'VIP', 'STAR_1', 'STAR_2', 'STAR_3', 'STAR_4', 'STAR_5', 'DIRECTOR') DEFAULT 'NORMAL',
  parentId VARCHAR(36),
  teamPath TEXT, -- 存储团队路径，如 "root/user1/user2"
  isActive BOOLEAN DEFAULT TRUE,
  performance JSON, -- 存储业绩数据
  privileges JSON, -- 存储权限列表
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_parentId (parentId),
  INDEX idx_teamPath (teamPath(255)),
  INDEX idx_level (level),
  FOREIGN KEY (parentId) REFERENCES User(id)
);
```

### LevelRequirement表（等级要求配置）

```sql
CREATE TABLE LevelRequirement (
  id INT AUTO_INCREMENT PRIMARY KEY,
  level VARCHAR(20) UNIQUE NOT NULL,
  levelName VARCHAR(50) NOT NULL,
  requiredDirectVip INT NOT NULL,
  requiredTeamSize INT NOT NULL,
  requiredSales DECIMAL(10,2) NOT NULL,
  discountRate DECIMAL(3,2) NOT NULL,
  directCommissionRate DECIMAL(3,2) NOT NULL,
  indirectCommissionRate DECIMAL(3,2) NOT NULL,
  privileges JSON,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 前端集成示例

### 小程序端

```javascript
// 获取用户等级信息
const getUserLevelInfo = async () => {
  try {
    const res = await wx.request({
      url: 'https://api.zhongdao-mall.com/api/v1/users/level-info',
      method: 'GET',
      header: {
        'Authorization': `Bearer ${wx.getStorageSync('token')}`
      }
    });

    const data = res.data.data;

    // 显示等级进度
    updateLevelProgress(data.progress);

    // 显示下一等级要求
    if (data.nextLevel) {
      showNextLevelInfo(data.nextLevel);
    }

    // 更新权限
    updateUserPermissions(data.privileges);

  } catch (error) {
    console.error('获取等级信息失败', error);
  }
};

// 显示团队树形结构
const showTeamTree = async () => {
  const res = await wx.request({
    url: 'https://api.zhongdao-mall.com/api/v1/teams/structure',
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`
    }
  });

  renderTeamTree(res.data.data);
};
```

### React组件示例

```tsx
// UserLevelCard.tsx
import React from 'react';
import { useQuery } from '@tanstack/react-query';
import { Progress, Card, Badge, Button } from 'antd';

export const UserLevelCard: React.FC = () => {
  const { data: levelInfo } = useQuery({
    queryKey: ['userLevelInfo'],
    queryFn: () => api.get('/users/level-info').then(res => res.data.data)
  });

  if (!levelInfo) return null;

  return (
    <Card title="我的等级" extra={<Badge count={levelInfo.levelName} />}>
      <div className="mb-4">
        <div className="flex justify-between mb-2">
          <span>升级进度</span>
          <span>{levelInfo.progress.percentage}%</span>
        </div>
        <Progress
          percent={levelInfo.progress.percentage}
          status={levelInfo.progress.canUpgrade ? 'success' : 'active'}
        />
      </div>

      <div className="grid grid-cols-2 gap-4 mb-4">
        <div>
          <p className="text-gray-500">直推VIP</p>
          <p className="text-xl font-bold">
            {levelInfo.progress.directVipCount}/{levelInfo.progress.requiredDirectVip}
          </p>
        </div>
        <div>
          <p className="text-gray-500">团队人数</p>
          <p className="text-xl font-bold">
            {levelInfo.progress.teamSize}/{levelInfo.progress.requiredTeamSize}
          </p>
        </div>
      </div>

      {levelInfo.nextLevel && (
        <div className="border-t pt-4">
          <h4 className="mb-2">下一等级：{levelInfo.nextLevel.levelName}</h4>
          <p className="text-sm text-gray-500 mb-3">
            进货折扣：{levelInfo.nextLevel.benefits.discount * 10}折 |
            直推佣金：{levelInfo.nextLevel.benefits.directCommission * 100}%
          </p>
          {levelInfo.progress.canUpgrade && (
            <Button type="primary" block onClick={handleApplyUpgrade}>
              申请升级
            </Button>
          )}
        </div>
      )}
    </Card>
  );
};

// TeamStatsChart.tsx
import React from 'react';
import { Line } from '@ant-design/charts';
import { useQuery } from '@tanstack/react-query';

export const TeamStatsChart: React.FC = () => {
  const { data: teamStats } = useQuery({
    queryKey: ['teamStats'],
    queryFn: () => api.get('/teams/stats?period=month').then(res => res.data.data)
  });

  const config = {
    data: teamStats?.performance.monthly || [],
    xField: 'month',
    yField: 'sales',
    seriesField: 'type',
    smooth: true,
    tooltip: {
      formatter: (datum: any) => ({
        name: '销售额',
        value: `¥${datum.sales.toLocaleString()}`
      })
    }
  };

  return (
    <Card title="团队业绩趋势">
      <Line {...config} />
    </Card>
  );
};
```

## 最佳实践

1. **等级展示**
   - 使用明显的视觉标识展示用户等级
   - 实时显示升级进度
   - 清晰展示下一等级权益

2. **团队管理**
   - 树形结构展示团队关系
   - 支持多维度筛选和搜索
   - 提供团队活跃度分析

3. **数据统计**
   - 实时更新团队数据
   - 使用图表可视化展示
   - 支持数据导出功能

4. **权限控制**
   - 根据等级控制功能访问
   - 动态显示/隐藏菜单项
   - 友好的权限提示

5. **性能优化**
   - 大量数据分页加载
   - 使用缓存减少请求
   - 异步加载团队数据