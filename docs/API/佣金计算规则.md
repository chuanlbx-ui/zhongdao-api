# 佣金计算规则

## 概述

中道商城的佣金系统是一个复杂的多级分配机制，旨在激励用户发展团队、提升业绩。佣金系统包括直推佣金、间推佣金、平级奖励、团队奖励等多种形式，形成一个完整的激励体系。

## 佣金类型详解

### 1. 直推佣金（Direct Commission）

**定义**: 当直接推荐的用户（下级）购买商品时，推荐人获得的佣金。

**计算规则**:
```
直推佣金 = 商品成交金额 × 直推佣金比例
```

**佣金比例表**:
| 推荐人等级 | 佣金比例 | 最低佣金 | 说明 |
|-----------|---------|---------|------|
| NORMAL | 0% | 0 | 普通会员无直推佣金 |
| VIP | 5% | 0 | VIP会员享受5%直推佣金 |
| STAR_1 | 8% | 0 | 一星店长享受8%直推佣金 |
| STAR_2 | 10% | 0 | 二星店长享受10%直推佣金 |
| STAR_3 | 12% | 0 | 三星店长享受12%直推佣金 |
| STAR_4 | 16% | 0 | 四星店长享受16%直推佣金 |
| STAR_5 | 18% | 0 | 五星店长享受18%直推佣金 |
| DIRECTOR | 20% | 0 | 董事享受20%直推佣金 |

**示例**:
```
用户A（三星店长，12%）
  └─ 直推用户B购买商品1000元
  └─ 用户A获得直推佣金：1000 × 12% = 120元
```

### 2. 间推佣金（Indirect Commission）

**定义**: 当间接推荐的用户（下级的下级）购买商品时，上上级获得的佣金。

**计算规则**:
```
间推佣金 = 商品成交金额 × 间推佣金比例
```

**佣金比例表**:
| 上上级等级 | 间推佣金比例 | 间推层级限制 |
|-----------|-------------|-------------|
| STAR_1 | 2% | 1级间推 |
| STAR_2 | 3% | 1-2级间推 |
| STAR_3 | 4% | 1-2级间推 |
| STAR_4 | 5% | 1-3级间推 |
| STAR_5 | 6% | 1-3级间推 |
| DIRECTOR | 8% | 1-5级间推 |

**示例**:
```
用户A（四星店长，16%直推，5%间推）
  └─ 用户B（VIP，5%直推）
      └─ 用户C（普通会员）购买1000元
      └─ 用户B获得直推佣金：1000 × 5% = 50元
      └─ 用户A获得间推佣金：1000 × 5% = 50元
```

### 3. 平级奖励（Peer Bonus）

**定义**: 当同等级的下级用户购买商品时，上级用户获得的额外奖励。

**触发条件**:
- 下级用户等级必须 ≥ 上级用户等级
- 只有STAR_2及以上等级享受平级奖励

**奖励比例**:
| 上级等级 | 平级奖励比例 | 说明 |
|---------|-------------|------|
| STAR_2 | 1% | 对二星及以下下级 |
| STAR_3 | 2% | 对三星及以下下级 |
| STAR_4 | 3% | 对四星及以下下级 |
| STAR_5 | 4% | 对五星及以下下级 |
| DIRECTOR | 5% | 对所有等级下级 |

**示例**:
```
用户A（三星店长，12%直推，4%间推，2%平级）
  └─ 用户B（三星店长）购买1000元
  └─ 用户A获得平级奖励：1000 × 2% = 20元
```

### 4. 团队业绩奖励（Team Performance Bonus）

**定义**: 当团队整体业绩达到一定目标时，团队负责人获得的额外奖励。

**奖励规则**:
| 团队月销售额 | 奖励比例 | 奖励对象 |
|-------------|---------|---------|
| 10万元 | 1% | 团队负责人 |
| 50万元 | 1.5% | 团队负责人 |
| 100万元 | 2% | 团队负责人及核心成员 |
| 500万元 | 2.5% | 团队负责人及核心成员 |
| 1000万元 | 3% | 整个团队 |

### 5. 特殊奖励（Special Rewards）

**新用户首单奖励**
- 首单金额≥599元：奖励推荐人50通券
- 首单金额≥2999元：奖励推荐人200通券

**团队规模奖励**
- 直推达到20人：奖励1000通券
- 直推达到50人：奖励3000通券
- 直推达到100人：奖励8000通券

## API接口详解

### 1. 获取佣金统计

**接口地址**: `GET /api/v1/commission/statistics`

**查询参数**:
- `period`: 统计周期（day/week/month/year）
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**:
```json
{
  "success": true,
  "data": {
    "overview": {
      "totalCommission": 25000.00,
      "pendingCommission": 3500.00,
      "settledCommission": 21500.00,
      "averageMonthly": 8333.33,
      "growthRate": 15.5
    },
    "commissionBreakdown": {
      "directCommission": {
        "amount": 15000.00,
        "percentage": 60,
        "transactions": 156,
        "count": 45
      },
      "indirectCommission": {
        "amount": 7500.00,
        "percentage": 30,
        "transactions": 89,
        "count": 23
      },
      "peerBonus": {
        "amount": 2000.00,
        "percentage": 8,
        "transactions": 12,
        "count": 5
      },
      "teamBonus": {
        "amount": 500.00,
        "percentage": 2,
        "transactions": 2,
        "count": 1
      }
    },
    "monthlyTrend": [
      {
        "month": "2025-10",
        "total": 8500.00,
        "direct": 5100.00,
        "indirect": 2550.00,
        "peer": 680.00,
        "team": 170.00
      },
      {
        "month": "2025-11",
        "total": 12000.00,
        "direct": 7200.00,
        "indirect": 3600.00,
        "peer": 960.00,
        "team": 240.00
      }
    ],
    "topEarners": [
      {
        "userId": "cmi1234567890abcddd",
        "nickname": "李四",
        "avatarUrl": "https://wx.qlogo.cn/...",
        "level": "STAR_4",
        "totalCommission": 8500.00,
        "directCount": 23,
        "teamSize": 156
      }
    ],
    "commissionRate": {
      "currentLevel": "STAR_3",
      "directRate": 0.12,
      "indirectRate": 0.04,
      "peerRate": 0.02
    }
  },
  "message": "获取成功"
}
```

### 2. 获取佣金明细

**接口地址**: `GET /api/v1/commission/details`

**查询参数**:
- `type`: 佣金类型（direct/indirect/peer/team）
- `status`: 状态（pending/settled/failed）
- `page`: 页码
- `limit`: 每页数量

**响应数据**:
```json
{
  "success": true,
  "data": {
    "commissions": [
      {
        "id": "cmm_1234567890",
        "type": "DIRECT",
        "amount": 120.00,
        "rate": 0.12,
        "orderAmount": 1000.00,
        "status": "SETTLED",
        "settledAt": "2025-11-24T10:30:00.000Z",
        "relatedOrder": {
          "id": "cmo1234567890",
          "orderNo": "ZD20251124001",
          "buyerNickname": "王五"
        },
        "relatedUser": {
          "id": "cmi1234567890abcddd",
          "nickname": "王五",
          "level": "VIP",
          "relationship": "DIRECT_REFERRAL"
        },
        "commissionLevel": 1,
        "createdAt": "2025-11-24T10:25:00.000Z"
      },
      {
        "id": "cmm_1234567891",
        "type": "INDIRECT",
        "amount": 50.00,
        "rate": 0.05,
        "orderAmount": 1000.00,
        "status": "PENDING",
        "estimatedSettleDate": "2025-12-01",
        "relatedOrder": {
          "id": "cmo1234567891",
          "orderNo": "ZD20251124002",
          "buyerNickname": "赵六"
        },
        "relatedUser": {
          "id": "cmi9876543210",
          "nickname": "赵六",
          "level": "NORMAL",
          "relationship": "INDIRECT_REFERRAL",
          "middleMan": {
            "id": "cmi1234567890abcddd",
            "nickname": "王五",
            "level": "VIP"
          }
        },
        "commissionLevel": 2,
        "createdAt": "2025-11-24T09:15:00.000Z"
      }
    ],
    "summary": {
      "totalAmount": 850.00,
      "pendingAmount": 250.00,
      "settledAmount": 600.00,
      "totalRecords": 25
    },
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 25,
      "totalPages": 2
    }
  },
  "message": "获取成功"
}
```

### 3. 申请佣金提现

**接口地址**: `POST /api/v1/commission/withdraw`

**请求参数**:
```json
{
  "amount": 5000.00,
  "withdrawMethod": "WECHAT",
  "withdrawInfo": {
    "wechatId": "wx_zhangsan_123",
    "realName": "张三",
    "idCard": "440101199001011234"
  },
  "password": "123456"
}
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "withdrawId": "wdw_1234567890",
    "amount": 5000.00,
    "fee": 50.00,
    "actualAmount": 4950.00,
    "status": "PENDING_REVIEW",
    "estimatedArrival": "2-3个工作日",
    "reviewProcess": [
      "系统初审（自动）",
      "财务审核（1个工作日）",
      "打款处理（1-2个工作日）"
    ]
  },
  "message": "提现申请已提交"
}
```

### 4. 获取提现记录

**接口地址**: `GET /api/v1/commission/withdrawals`

**查询参数**:
- `status`: 状态（pending/approved/rejected/completed）
- `startDate`: 开始日期
- `endDate`: 结束日期

**响应数据**:
```json
{
  "success": true,
  "data": {
    "withdrawals": [
      {
        "id": "wdw_1234567890",
        "amount": 5000.00,
        "fee": 50.00,
        "actualAmount": 4950.00,
        "status": "COMPLETED",
        "withdrawMethod": "WECHAT",
        "appliedAt": "2025-11-20T10:30:00.000Z",
        "reviewedAt": "2025-11-21T14:20:00.000Z",
        "completedAt": "2025-11-22T09:15:00.000Z",
        "reviewer": {
          "id": "admin_001",
          "name": "财务部-李会计"
        },
        "reviewNote": "审核通过，已安排打款",
        "transactionId": "TXN20251122001"
      }
    ],
    "summary": {
      "totalWithdrawn": 25000.00,
      "totalFees": 250.00,
      "actualReceived": 24750.00,
      "pendingAmount": 5000.00,
      "withdrawalCount": 8
    }
  },
  "message": "获取成功"
}
```

### 5. 佣金计算器

**接口地址**: `POST /api/v1/commission/calculate`

**请求参数**:
```json
{
  "orderAmount": 1000.00,
  "buyerLevel": "VIP",
  "sellerId": "cmi1234567890abcddd",
  "commissionChain": [
    {
      "userId": "cmi1234567890abcddd",
      "level": "STAR_3",
      "relationship": "DIRECT"
    },
    {
      "userId": "cmi9876543210fedcba",
      "level": "STAR_4",
      "relationship": "INDIRECT"
    }
  ]
}
```

**响应数据**:
```json
{
  "success": true,
  "data": {
    "orderAmount": 1000.00,
    "totalCommission": 170.00,
    "commissionBreakdown": [
      {
        "userId": "cmi1234567890abcddd",
        "nickname": "张三",
        "level": "STAR_3",
        "relationship": "DIRECT",
        "commissionType": "DIRECT",
        "rate": 0.12,
        "amount": 120.00
      },
      {
        "userId": "cmi9876543210fedcba",
        "nickname": "李四",
        "level": "STAR_4",
        "relationship": "INDIRECT",
        "commissionType": "INDIRECT",
        "rate": 0.05,
        "amount": 50.00
      }
    ],
    "calculationRules": {
      "directCommission": {
        "rule": "orderAmount × directRate",
        "rate": 0.12,
        "amount": 120.00
      },
      "indirectCommission": {
        "rule": "orderAmount × indirectRate",
        "rate": 0.05,
        "amount": 50.00,
        "maxLevel": 3
      },
      "peerBonus": {
        "eligible": false,
        "reason": "Buyer level is lower than seller"
      }
    }
  },
  "message": "计算完成"
}
```

## 佣金结算规则

### 1. 结算周期

- **T+1结算**: 次日结算（订单完成确认后24小时）
- **T+7结算**: 7天结算（包含售后期）
- **月度结算**: 每月25日结算月度奖金

### 2. 结算条件

- 订单必须已完成（DELIVERED状态）
- 超过7天售后期
- 无退款纠纷
- 佣金金额≥1元

### 3. 提现规则

- 最低提现金额：100元
- 提现手续费：1%（最低2元，最高50元）
- 每日提现上限：50000元
- 每月提现次数不限

### 4. 税务处理

- 月收入≤800元：免税
- 800元<月收入≤4000元：扣除800元后按20%税率
- 月收入>4000元：扣除20%后按20%税率

## 特殊场景处理

### 1. 退款场景

```
订单金额1000元，已结算佣金120元
└─ 用户申请退款成功
└─ 系统自动扣回已结算佣金120元
└─ 若佣金已提现，从余额中扣除
└─ 若余额不足，标记为负数，下次结算抵扣
```

### 2. 等级变动

```
用户A原为STAR_2（10%直推）
└─ 升级为STAR_3（12%直推）
└─ 升级后的订单按新比例计算
└─ 升级前的订单保持原比例
```

### 3. 团队重组

```
用户A转移团队到新的上级
└─ 原上级不再获得A的间推佣金
└─ 新上级开始获得A的直推佣金
└─ A原有的下级关系保持不变
```

## 数据库模型

### CommissionRecord表

```sql
CREATE TABLE CommissionRecord (
  id VARCHAR(36) PRIMARY KEY,
  userId VARCHAR(36) NOT NULL,  // 佣金获得者
  orderId VARCHAR(36) NOT NULL, // 相关订单
  buyerId VARCHAR(36) NOT NULL, // 购买者
  sellerId VARCHAR(36) NOT NULL, // 销售者（如果是店长）
  type ENUM('DIRECT', 'INDIRECT', 'PEER', 'TEAM', 'SPECIAL') NOT NULL,
  commissionLevel INT NOT NULL, // 佣金层级（1=直推，2=间推...）
  orderAmount DECIMAL(10,2) NOT NULL,
  commissionRate DECIMAL(5,4) NOT NULL,
  commissionAmount DECIMAL(10,2) NOT NULL,
  status ENUM('PENDING', 'SETTLED', 'CANCELLED', 'WITHDRAWN') DEFAULT 'PENDING',
  settledAt TIMESTAMP,
  withdrawId VARCHAR(36),
  metadata JSON,
  createdAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updatedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  INDEX idx_userId (userId),
  INDEX idx_orderId (orderId),
  INDEX idx_status (status),
  INDEX idx_createdAt (createdAt),
  FOREIGN KEY (userId) REFERENCES User(id),
  FOREIGN KEY (orderId) REFERENCES Order(id)
);
```

### WithdrawRecord表

```sql
CREATE TABLE WithdrawRecord (
  id VARCHAR(36) PRIMARY KEY,
  userId VARCHAR(36) NOT NULL,
  amount DECIMAL(10,2) NOT NULL,
  fee DECIMAL(10,2) NOT NULL,
  actualAmount DECIMAL(10,2) NOT NULL,
  withdrawMethod ENUM('WECHAT', 'ALIPAY', 'BANK') NOT NULL,
  withdrawInfo JSON NOT NULL,
  status ENUM('PENDING', 'APPROVED', 'REJECTED', 'COMPLETED', 'FAILED') DEFAULT 'PENDING',
  appliedAt TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  reviewedAt TIMESTAMP,
  reviewerId VARCHAR(36),
  reviewNote TEXT,
  completedAt TIMESTAMP,
  transactionId VARCHAR(36),
  failureReason TEXT,

  INDEX idx_userId (userId),
  INDEX idx_status (status),
  INDEX idx_appliedAt (appliedAt),
  FOREIGN KEY (userId) REFERENCES User(id)
);
```

## 前端集成示例

```tsx
// CommissionDashboard.tsx
import React from 'react';
import { Card, Row, Col, Statistic, Progress, Button, Table, Tag } from 'antd';
import { useQuery } from '@tanstack/react-query';
import { DollarOutlined, TrophyOutlined, TeamOutlined, RiseOutlined } from '@ant-design/icons';

export const CommissionDashboard: React.FC = () => {
  const { data: commissionStats } = useQuery({
    queryKey: ['commissionStatistics'],
    queryFn: () => api.get('/commission/statistics').then(res => res.data.data)
  });

  if (!commissionStats) return null;

  return (
    <div className="commission-dashboard">
      {/* 佣金概览 */}
      <Row gutter={16} className="mb-4">
        <Col span={6}>
          <Card>
            <Statistic
              title="总佣金"
              value={commissionStats.overview.totalCommission}
              precision={2}
              prefix="¥"
              valueStyle={{ color: '#3f8600' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="待结算"
              value={commissionStats.overview.pendingCommission}
              precision={2}
              prefix="¥"
              valueStyle={{ color: '#fa8c16' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="已结算"
              value={commissionStats.overview.settledCommission}
              precision={2}
              prefix="¥"
              valueStyle={{ color: '#1890ff' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic
              title="月均收入"
              value={commissionStats.overview.averageMonthly}
              precision={2}
              prefix="¥"
            />
          </Card>
        </Col>
      </Row>

      {/* 佣金构成 */}
      <Card title="佣金构成分析" className="mb-4">
        <Row gutter={16}>
          {Object.entries(commissionStats.commissionBreakdown).map(([key, value]: [string, any]) => (
            <Col span={6} key={key}>
              <div className="text-center">
                <Progress
                  type="circle"
                  percent={value.percentage}
                  format={() => `${value.amount.toFixed(0)}`}
                />
                <h4 className="mt-2">
                  {key === 'directCommission' && '直推佣金'}
                  {key === 'indirectCommission' && '间推佣金'}
                  {key === 'peerBonus' && '平级奖励'}
                  {key === 'teamBonus' && '团队奖励'}
                </h4>
                <p className="text-gray-500">
                  {value.count}笔交易
                </p>
              </div>
            </Col>
          ))}
        </Row>
      </Card>

      {/* 快捷操作 */}
      <Row gutter={16}>
        <Col span={8}>
          <Button type="primary" size="large" block icon={<DollarOutlined />}>
            申请提现
          </Button>
        </Col>
        <Col span={8}>
          <Button size="large" block icon={<TrophyOutlined />}>
            佣金明细
          </Button>
        </Col>
        <Col span={8}>
          <Button size="large" block icon={<RiseOutlined />}>
            佣金计算器
          </Button>
        </Col>
      </Row>
    </div>
  );
};

// CommissionCalculator.tsx
import React, { useState } from 'react';
import { Card, InputNumber, Select, Button, Table, Divider } from 'antd';

export const CommissionCalculator: React.FC = () => {
  const [orderAmount, setOrderAmount] = useState(1000);
  const [buyerLevel, setBuyerLevel] = useState('VIP');
  const [calculation, setCalculation] = useState(null);

  const handleCalculate = async () => {
    try {
      const res = await api.post('/commission/calculate', {
        orderAmount,
        buyerLevel
      });
      setCalculation(res.data.data);
    } catch (error) {
      console.error('计算失败', error);
    }
  };

  const columns = [
    {
      title: '获得者',
      dataIndex: ['nickname'],
      key: 'nickname'
    },
    {
      title: '等级',
      dataIndex: ['level'],
      key: 'level',
      render: (level: string) => {
        const levelMap = {
          'NORMAL': '普通',
          'VIP': 'VIP',
          'STAR_1': '一星',
          'STAR_2': '二星',
          'STAR_3': '三星',
          'STAR_4': '四星',
          'STAR_5': '五星',
          'DIRECTOR': '董事'
        };
        return levelMap[level] || level;
      }
    },
    {
      title: '关系',
      dataIndex: ['relationship'],
      key: 'relationship',
      render: (rel: string) => {
        const relMap = {
          'DIRECT': '直推',
          'INDIRECT': '间推'
        };
        return relMap[rel] || rel;
      }
    },
    {
      title: '佣金类型',
      dataIndex: ['commissionType'],
      key: 'commissionType'
    },
    {
      title: '比例',
      dataIndex: ['rate'],
      key: 'rate',
      render: (rate: number) => `${(rate * 100).toFixed(1)}%`
    },
    {
      title: '金额',
      dataIndex: ['amount'],
      key: 'amount',
      render: (amount: number) => `¥${amount.toFixed(2)}`
    }
  ];

  return (
    <Card title="佣金计算器">
      <div className="mb-4">
        <div className="grid grid-cols-2 gap-4 mb-4">
          <div>
            <label className="block mb-2">订单金额</label>
            <InputNumber
              style={{ width: '100%' }}
              value={orderAmount}
              onChange={setOrderAmount}
              min={1}
              formatter={value => `¥ ${value}`}
              parser={value => value!.replace(/¥\s?|(,*)/g, '')}
            />
          </div>
          <div>
            <label className="block mb-2">购买者等级</label>
            <Select
              style={{ width: '100%' }}
              value={buyerLevel}
              onChange={setBuyerLevel}
            >
              <Select.Option value="NORMAL">普通会员</Select.Option>
              <Select.Option value="VIP">VIP会员</Select.Option>
              <Select.Option value="STAR_1">一星店长</Select.Option>
              <Select.Option value="STAR_2">二星店长</Select.Option>
              <Select.Option value="STAR_3">三星店长</Select.Option>
              <Select.Option value="STAR_4">四星店长</Select.Option>
              <Select.Option value="STAR_5">五星店长</Select.Option>
              <Select.Option value="DIRECTOR">董事</Select.Option>
            </Select>
          </div>
        </div>
        <Button type="primary" size="large" onClick={handleCalculate}>
          计算佣金
        </Button>
      </div>

      {calculation && (
        <>
          <Divider />
          <div className="mb-4">
            <h3>订单金额：¥{calculation.orderAmount.toFixed(2)}</h3>
            <h2 className="text-2xl font-bold text-green-600">
              总佣金：¥{calculation.totalCommission.toFixed(2)}
            </h2>
          </div>
          <Table
            columns={columns}
            dataSource={calculation.commissionBreakdown}
            pagination={false}
            rowKey="userId"
          />
        </>
      )}
    </Card>
  );
};
```

## 最佳实践

1. **佣金优化**
   - 培养高等级下级
   - 提升团队整体业绩
   - 保持团队活跃度

2. **提现管理**
   - 合理安排提现时间
   - 注意税务影响
   - 保留足够余额应对退款

3. **数据追踪**
   - 定期查看佣金报表
   - 分析佣金来源构成
   - 优化团队结构

4. **合规经营**
   - 遵守平台规则
   - 不进行虚假交易
   - 合理避税