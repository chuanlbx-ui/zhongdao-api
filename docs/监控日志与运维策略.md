# ä¸­é“å•†åŸç³»ç»Ÿ - ç›‘æ§æ—¥å¿—ä¸è¿ç»´ç­–ç•¥

**æ–‡æ¡£ç›®çš„**ï¼šå®šä¹‰å®Œæ•´çš„ç³»ç»Ÿç›‘æ§ã€æ—¥å¿—ç®¡ç†å’Œè¿ç»´ç­–ç•¥
**é€‚ç”¨èŒƒå›´**ï¼šç³»ç»Ÿè¿ç»´ã€æ•…éšœæ’æŸ¥ã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨ç›‘æ§
**æœ€åæ›´æ–°**ï¼š2025å¹´11æœˆ18æ—¥
**ç‰ˆæœ¬**ï¼š1.0

---

## ğŸ¯ ç›‘æ§ä½“ç³»æ¶æ„

### ğŸ“Š ç›‘æ§å±‚æ¬¡ç»“æ„

```mermaid
graph TD
    A[ä¸šåŠ¡ç›‘æ§] --> A1[è®¢å•é‡ç›‘æ§]
    A --> A2[ç”¨æˆ·æ´»è·ƒåº¦]
    A --> A3[äº¤æ˜“æˆåŠŸç‡]
    A --> A4[ç­‰çº§å‡çº§ç»Ÿè®¡]

    B[åº”ç”¨ç›‘æ§] --> B1[APIå“åº”æ—¶é—´]
    B --> B2[é”™è¯¯ç‡]
    B --> B3[å¹¶å‘ç”¨æˆ·æ•°]
    B --> B4[å†…å­˜/CPUä½¿ç”¨ç‡]

    C[ç³»ç»Ÿç›‘æ§] --> C1[æœåŠ¡å™¨è´Ÿè½½]
    C --> C2[æ•°æ®åº“æ€§èƒ½]
    C --> C3[ç½‘ç»œå»¶è¿Ÿ]
    C --> C4[ç£ç›˜ä½¿ç”¨ç‡]

    D[å®‰å…¨ç›‘æ§] --> D1[ç™»å½•å¼‚å¸¸]
    D --> D2[æƒé™è¶Šç•Œ]
    D --> D3[æ”»å‡»æ£€æµ‹]
    D --> D4[æ•°æ®æ³„éœ²]

    E[æ—¥å¿—ç›‘æ§] --> E1[é”™è¯¯æ—¥å¿—]
    E --> E2[ä¸šåŠ¡æ—¥å¿—]
    E --> E3[å®¡è®¡æ—¥å¿—]
    E --> E4[ç³»ç»Ÿæ—¥å¿—]
```

### ğŸ”§ ç›‘æ§å·¥å…·æ ˆ

#### æ ¸å¿ƒç›‘æ§ç»„ä»¶

```typescript
// ç›‘æ§ç³»ç»Ÿé…ç½®
interface MonitoringStack {
  // æŒ‡æ ‡æ”¶é›†
  metrics: {
    collection: 'Prometheus';      // æŒ‡æ ‡æ”¶é›†
    storage: 'Prometheus';         // æ—¶åºæ•°æ®åº“
    visualization: 'Grafana';      // å¯è§†åŒ–é¢æ¿
  };

  // æ—¥å¿—ç®¡ç†
  logging: {
    collection: 'Filebeat';        // æ—¥å¿—æ”¶é›†
    processing: 'Logstash';        // æ—¥å¿—å¤„ç†
    storage: 'Elasticsearch';      // æ—¥å¿—å­˜å‚¨
    visualization: 'Kibana';       // æ—¥å¿—å¯è§†åŒ–
  };

  // åˆ†å¸ƒå¼è¿½è¸ª
  tracing: {
    instrumentation: 'OpenTelemetry'; // è¿½è¸ªåŸ‹ç‚¹
    collection: 'Jaeger';           // è¿½è¸ªæ”¶é›†
    visualization: 'Jaeger UI';     // è¿½è¸ªå¯è§†åŒ–
  };

  // å‘Šè­¦é€šçŸ¥
  alerting: {
    engine: 'AlertManager';        // å‘Šè­¦å¼•æ“
    channels: ['Email', 'Wechat', 'SMS']; // é€šçŸ¥æ¸ é“
    escalation: 'PagerDuty';       // å‘Šè­¦å‡çº§
  };
}
```

---

## ğŸ“ˆ ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡

### ğŸª æ ¸å¿ƒä¸šåŠ¡æŒ‡æ ‡

#### ç”¨æˆ·ç›¸å…³æŒ‡æ ‡

```typescript
// ç”¨æˆ·ç›‘æ§æŒ‡æ ‡å®šä¹‰
interface UserMetrics {
  // ç”¨æˆ·å¢é•¿
  userGrowth: {
    newUsersPerDay: number;        // æ¯æ—¥æ–°å¢ç”¨æˆ·
    userRetentionRate: number;     // ç”¨æˆ·ç•™å­˜ç‡
    userChurnRate: number;         // ç”¨æˆ·æµå¤±ç‡
    activeUserCount: number;       // æ´»è·ƒç”¨æˆ·æ•°
  };

  // ç”¨æˆ·ç­‰çº§åˆ†å¸ƒ
  userLevelDistribution: {
    normal: number;                // æ™®é€šä¼šå‘˜æ•°é‡
    vip: number;                   // VIPä¼šå‘˜æ•°é‡
    star_1: number;                // ä¸€æ˜Ÿåº—é•¿æ•°é‡
    star_2: number;                // äºŒæ˜Ÿåº—é•¿æ•°é‡
    star_3: number;                // ä¸‰æ˜Ÿåº—é•¿æ•°é‡
    star_4: number;                // å››æ˜Ÿåº—é•¿æ•°é‡
    star_5: number;                // äº”æ˜Ÿåº—é•¿æ•°é‡
    director: number;              // è‘£äº‹æ•°é‡
  };

  // ç”¨æˆ·è¡Œä¸º
  userBehavior: {
    loginFrequency: number;        // ç™»å½•é¢‘æ¬¡
    averageSessionDuration: number; // å¹³å‡ä¼šè¯æ—¶é•¿
    featureUsageRate: Record<string, number>; // åŠŸèƒ½ä½¿ç”¨ç‡
  };
}

// ç”¨æˆ·ç­‰çº§å‡çº§ç›‘æ§
class UserLevelMonitoring {
  async trackUserUpgrades(): Promise<void> {
    const upgrades = await this.getUserUpgradesLast24h();

    // è®°å½•å‡çº§ç»Ÿè®¡
    for (const upgrade of upgrades) {
      this.metricsCollector.record('user_upgrade', {
        user_id: upgrade.userId,
        from_level: upgrade.fromLevel,
        to_level: upgrade.toLevel,
        upgrade_time: upgrade.createdAt,
        upgrade_duration: upgrade.processingDuration
      });
    }

    // è®¡ç®—å‡çº§æˆåŠŸç‡
    const successRate = this.calculateUpgradeSuccessRate(upgrades);
    this.metricsCollector.gauge('user_upgrade_success_rate', successRate);

    // å¦‚æœæˆåŠŸç‡ä½äº95%ï¼Œè§¦å‘å‘Šè­¦
    if (successRate < 0.95) {
      this.alertManager.sendAlert({
        level: 'warning',
        message: `ç”¨æˆ·å‡çº§æˆåŠŸç‡è¿‡ä½: ${(successRate * 100).toFixed(2)}%`,
        metrics: { successRate, totalUpgrades: upgrades.length }
      });
    }
  }
}
```

#### äº¤æ˜“ç›¸å…³æŒ‡æ ‡

```typescript
// äº¤æ˜“ç›‘æ§æŒ‡æ ‡
interface TransactionMetrics {
  // äº¤æ˜“é‡
  transactionVolume: {
    dailyGMV: number;              // æ¯æ—¥æˆäº¤æ€»é¢
    dailyOrderCount: number;       // æ¯æ—¥è®¢å•æ•°
    averageOrderValue: number;     // å¹³å‡è®¢å•é‡‘é¢
    conversionRate: number;        // è½¬åŒ–ç‡
  };

  // é‡‡è´­ä¸šåŠ¡
  purchaseMetrics: {
    purchaseRequestCount: number;  // é‡‡è´­è¯·æ±‚æ•°
    purchaseSuccessRate: number;   // é‡‡è´­æˆåŠŸç‡
    averagePurchaseAmount: number; // å¹³å‡é‡‡è´­é‡‘é¢
    purchaseProcessingTime: number; // é‡‡è´­å¤„ç†æ—¶é—´
  };

  // é€šåˆ¸æµè½¬
  pointsFlowMetrics: {
    dailyTransferVolume: number;   // æ¯æ—¥è½¬è´¦é‡
    transferSuccessRate: number;   // è½¬è´¦æˆåŠŸç‡
    rechargeVolume: number;        // å……å€¼é‡
    withdrawVolume: number;        // æç°é‡
  };
}

// äº¤æ˜“ç›‘æ§å®ç°
class TransactionMonitoring {
  async monitorTransactionHealth(): Promise<void> {
    const now = new Date();
    const last24h = new Date(now.getTime() - 24 * 60 * 60 * 1000);

    // è·å–24å°æ—¶å†…çš„äº¤æ˜“æ•°æ®
    const transactions = await this.getTransactions(last24h, now);

    // è®¡ç®—å…³é”®æŒ‡æ ‡
    const metrics = {
      totalAmount: transactions.reduce((sum, t) => sum + t.amount, 0),
      totalCount: transactions.length,
      successCount: transactions.filter(t => t.status === 'success').length,
      averageProcessingTime: this.calculateAverageProcessingTime(transactions)
    };

    // è®°å½•æŒ‡æ ‡
    this.metricsCollector.counter('transaction_total_count').inc(metrics.totalCount);
    this.metricsCollector.counter('transaction_total_amount').inc(metrics.totalAmount);
    this.metricsCollector.gauge('transaction_success_rate', metrics.successCount / metrics.totalCount);
    this.metricsCollector.gauge('transaction_processing_time', metrics.averageProcessingTime);

    // å¼‚å¸¸æ£€æµ‹
    if (metrics.successCount / metrics.totalCount < 0.98) {
      this.alertManager.sendAlert({
        level: 'critical',
        message: `äº¤æ˜“æˆåŠŸç‡è¿‡ä½: ${((metrics.successCount / metrics.totalCount) * 100).toFixed(2)}%`,
        details: {
          successCount: metrics.successCount,
          totalCount: metrics.totalCount,
          period: 'last_24h'
        }
      });
    }
  }
}
```

### ğŸ¯ ä¸šåŠ¡å¥åº·åº¦è¯„åˆ†

```typescript
// ä¸šåŠ¡å¥åº·åº¦è¯„åˆ†ç³»ç»Ÿ
class BusinessHealthScorer {
  private readonly weights = {
    userGrowth: 0.2,              // ç”¨æˆ·å¢é•¿æƒé‡
    transactionHealth: 0.3,       // äº¤æ˜“å¥åº·æƒé‡
    systemPerformance: 0.3,       // ç³»ç»Ÿæ€§èƒ½æƒé‡
    userSatisfaction: 0.2         // ç”¨æˆ·æ»¡æ„åº¦æƒé‡
  };

  async calculateHealthScore(): Promise<HealthScore> {
    const scores = await Promise.all([
      this.calculateUserGrowthScore(),
      this.calculateTransactionHealthScore(),
      this.calculateSystemPerformanceScore(),
      this.calculateUserSatisfactionScore()
    ]);

    const overallScore = Object.entries(this.weights).reduce((total, [key, weight]) => {
      return total + (scores[key] * weight);
    }, 0);

    return {
      overall: overallScore,
      breakdown: scores,
      level: this.getHealthLevel(overallScore),
      recommendations: this.getRecommendations(scores)
    };
  }

  private getHealthLevel(score: number): 'excellent' | 'good' | 'warning' | 'critical' {
    if (score >= 0.9) return 'excellent';
    if (score >= 0.75) return 'good';
    if (score >= 0.6) return 'warning';
    return 'critical';
  }
}

interface HealthScore {
  overall: number;
  breakdown: Record<string, number>;
  level: 'excellent' | 'good' | 'warning' | 'critical';
  recommendations: string[];
}
```

---

## ğŸ–¥ï¸ åº”ç”¨æ€§èƒ½ç›‘æ§

### âš¡ APIæ€§èƒ½ç›‘æ§

#### å“åº”æ—¶é—´ç›‘æ§

```typescript
// APIæ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
class ApiPerformanceMonitoring {
  // æ€§èƒ½æŒ‡æ ‡æ”¶é›†
  middleware() {
    return (req: Request, res: Response, next: NextFunction) => {
      const startTime = Date.now();
      const requestId = req.headers['x-request-id'] as string || this.generateRequestId();

      // è®°å½•è¯·æ±‚å¼€å§‹
      this.logger.info('API request started', {
        requestId,
        method: req.method,
        url: req.url,
        userAgent: req.headers['user-agent'],
        userId: req.user?.id
      });

      // ç›‘å¬å“åº”ç»“æŸ
      res.on('finish', () => {
        const duration = Date.now() - startTime;
        const statusCode = res.statusCode;

        // è®°å½•æ€§èƒ½æŒ‡æ ‡
        this.recordApiMetrics({
          requestId,
          method: req.method,
          url: req.url,
          statusCode,
          duration,
          userId: req.user?.id
        });

        // è®°å½•è¯·æ±‚å®Œæˆæ—¥å¿—
        this.logger.info('API request completed', {
          requestId,
          method: req.method,
          url: req.url,
          statusCode,
          duration,
          userId: req.user?.id
        });

        // æ€§èƒ½å‘Šè­¦
        if (duration > 5000) { // è¶…è¿‡5ç§’
          this.alertManager.sendAlert({
            level: 'warning',
            message: `APIå“åº”æ—¶é—´è¿‡é•¿: ${duration}ms`,
            details: {
              method: req.method,
              url: req.url,
              duration,
              requestId
            }
          });
        }
      });

      next();
    };
  }

  private recordApiMetrics(metrics: ApiMetrics): void {
    // è®°å½•PrometheusæŒ‡æ ‡
    this.metricsCollector
      .counter('api_requests_total')
      .inc({
        method: metrics.method,
        url: metrics.url,
        status_code: metrics.statusCode.toString()
      });

    this.metricsCollector
      .histogram('api_request_duration')
      .observe(metrics.duration, {
        method: metrics.method,
        url: metrics.url
      });

    // è®°å½•æ…¢æŸ¥è¯¢
    if (metrics.duration > 2000) {
      this.slowQueryLogger.warn('Slow API request', metrics);
    }
  }
}

interface ApiMetrics {
  requestId: string;
  method: string;
  url: string;
  statusCode: number;
  duration: number;
  userId?: string;
}
```

#### æ•°æ®åº“æ€§èƒ½ç›‘æ§

```typescript
// æ•°æ®åº“æ€§èƒ½ç›‘æ§
class DatabaseMonitoring {
  async monitorDatabasePerformance(): Promise<void> {
    // è·å–æ•°æ®åº“è¿æ¥çŠ¶æ€
    const connectionStats = await this.getConnectionStats();

    // è®°å½•è¿æ¥æ± æŒ‡æ ‡
    this.metricsCollector.gauge('db_connections_active', connectionStats.active);
    this.metricsCollector.gauge('db_connections_idle', connectionStats.idle);
    this.metricsCollector.gauge('db_connections_total', connectionStats.total);

    // ç›‘æ§æ…¢æŸ¥è¯¢
    const slowQueries = await this.getSlowQueries();
    for (const query of slowQueries) {
      this.slowQueryLogger.error('Slow query detected', {
        query: query.query,
        duration: query.duration,
        timestamp: query.timestamp,
        parameters: query.parameters
      });

      this.metricsCollector.counter('db_slow_queries_total').inc({
        table: this.extractTableFromQuery(query.query)
      });
    }

    // ç›‘æ§æ•°æ®åº“é”ç­‰å¾…
    const lockWaits = await this.getLockWaits();
    if (lockWaits.length > 0) {
      this.alertManager.sendAlert({
        level: 'warning',
        message: `æ£€æµ‹åˆ°æ•°æ®åº“é”ç­‰å¾…: ${lockWaits.length}ä¸ª`,
        details: lockWaits
      });
    }
  }

  async monitorTablePerformance(): Promise<void> {
    const tables = ['users', 'shops', 'purchase_orders', 'points_transactions'];

    for (const table of tables) {
      const stats = await this.getTableStats(table);

      // è®°å½•è¡¨å¤§å°å’Œè¡Œæ•°
      this.metricsCollector.gauge(`db_table_size_bytes`, stats.sizeBytes, { table });
      this.metricsCollector.gauge(`db_table_rows`, stats.rowCount, { table });

      // ç›‘æ§è¡¨ç´¢å¼•æ•ˆç‡
      if (stats.indexEfficiency < 0.9) {
        this.alertManager.sendAlert({
          level: 'warning',
          message: `è¡¨ ${table} ç´¢å¼•æ•ˆç‡ä½: ${(stats.indexEfficiency * 100).toFixed(2)}%`,
          details: {
            table,
            indexEfficiency: stats.indexEfficiency,
            recommendation: 'è€ƒè™‘é‡å»ºæˆ–ä¼˜åŒ–ç´¢å¼•'
          }
        });
      }
    }
  }
}
```

### ğŸ’¾ å†…å­˜å’ŒCPUç›‘æ§

```typescript
// ç³»ç»Ÿèµ„æºç›‘æ§
class SystemResourceMonitoring {
  private readonly monitoringInterval = 60000; // 1åˆ†é’Ÿ

  startMonitoring(): void {
    setInterval(() => {
      this.collectSystemMetrics();
    }, this.monitoringInterval);
  }

  private async collectSystemMetrics(): Promise<void> {
    const memUsage = process.memoryUsage();
    const cpuUsage = process.cpuUsage();

    // è®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ
    this.metricsCollector.gauge('nodejs_memory_rss', memUsage.rss);
    this.metricsCollector.gauge('nodejs_memory_heap_used', memUsage.heapUsed);
    this.metricsCollector.gauge('nodejs_memory_heap_total', memUsage.heapTotal);
    this.metricsCollector.gauge('nodejs_memory_external', memUsage.external);

    // è®¡ç®—å†…å­˜ä½¿ç”¨ç‡
    const heapUsageRatio = memUsage.heapUsed / memUsage.heapTotal;
    this.metricsCollector.gauge('nodejs_memory_usage_ratio', heapUsageRatio);

    // å†…å­˜å‘Šè­¦
    if (heapUsageRatio > 0.9) {
      this.alertManager.sendAlert({
        level: 'critical',
        message: `å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${(heapUsageRatio * 100).toFixed(2)}%`,
        details: {
          heapUsed: memUsage.heapUsed,
          heapTotal: memUsage.heapTotal,
          rss: memUsage.rss
        }
      });
    }

    // æ£€æŸ¥å†…å­˜æ³„æ¼
    if (heapUsageRatio > 0.8) {
      await this.checkMemoryLeak();
    }
  }

  private async checkMemoryLeak(): Promise<void> {
    // å¼ºåˆ¶åƒåœ¾å›æ”¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
    if (global.gc) {
      global.gc();

      // ç­‰å¾…ä¸€æ®µæ—¶é—´åå†æ¬¡æ£€æŸ¥
      setTimeout(async () => {
        const memUsage = process.memoryUsage();
        const heapUsageRatio = memUsage.heapUsed / memUsage.heapTotal;

        // å¦‚æœGCåå†…å­˜ä½¿ç”¨ç‡ä»ç„¶å¾ˆé«˜ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼
        if (heapUsageRatio > 0.8) {
          this.alertManager.sendAlert({
            level: 'critical',
            message: 'å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼',
            details: {
              heapUsageRatio,
              heapUsed: memUsage.heapUsed,
              heapTotal: memUsage.heapTotal,
              recommendation: 'å»ºè®®æ£€æŸ¥ä»£ç å¹¶åŠæ—¶é‡å¯æœåŠ¡'
            }
          });
        }
      }, 5000);
    }
  }
}
```

---

## ğŸ“ æ—¥å¿—ç®¡ç†ç­–ç•¥

### ğŸ—‚ï¸ æ—¥å¿—åˆ†ç±»å’Œæ ¼å¼

#### æ—¥å¿—çº§åˆ«å®šä¹‰

```typescript
// æ—¥å¿—çº§åˆ«å’Œæ ¼å¼å®šä¹‰
enum LogLevel {
  ERROR = 'error',      // é”™è¯¯ï¼šç³»ç»Ÿé”™è¯¯ã€å¼‚å¸¸
  WARN = 'warn',        // è­¦å‘Šï¼šæ½œåœ¨é—®é¢˜
  INFO = 'info',        // ä¿¡æ¯ï¼šé‡è¦ä¸šåŠ¡æ“ä½œ
  DEBUG = 'debug',      // è°ƒè¯•ï¼šè¯¦ç»†è°ƒè¯•ä¿¡æ¯
  TRACE = 'trace'       // è¿½è¸ªï¼šæœ€è¯¦ç»†ä¿¡æ¯
}

// æ ‡å‡†æ—¥å¿—æ ¼å¼
interface LogEntry {
  timestamp: string;              // ISO 8601 æ—¶é—´æˆ³
  level: LogLevel;                // æ—¥å¿—çº§åˆ«
  service: string;                // æœåŠ¡åç§°
  requestId?: string;             // è¯·æ±‚ID
  userId?: string;                // ç”¨æˆ·ID
  message: string;                // æ—¥å¿—æ¶ˆæ¯
  data?: Record<string, any>;     // ç»“æ„åŒ–æ•°æ®
  error?: {                       // é”™è¯¯ä¿¡æ¯
    name: string;
    message: string;
    stack?: string;
  };
  tags?: string[];                // æ ‡ç­¾
  duration?: number;              // æ“ä½œè€—æ—¶(ms)
}
```

#### ä¸šåŠ¡æ—¥å¿—è§„èŒƒ

```typescript
// ç”¨æˆ·æ“ä½œæ—¥å¿—
class UserActivityLogger {
  logUserLogin(userId: string, deviceInfo: DeviceInfo, success: boolean): void {
    this.logger.info('User login attempt', {
      userId,
      success,
      deviceInfo,
      timestamp: new Date().toISOString(),
      category: 'user_activity',
      action: 'login'
    });
  }

  logUserUpgrade(userId: string, fromLevel: string, toLevel: string, duration: number): void {
    this.logger.info('User level upgrade', {
      userId,
      fromLevel,
      toLevel,
      duration,
      timestamp: new Date().toISOString(),
      category: 'user_activity',
      action: 'level_upgrade'
    });
  }

  logPurchaseOrder(buyerId: string, sellerId: string, amount: number, status: string): void {
    this.logger.info('Purchase order created', {
      buyerId,
      sellerId,
      amount,
      status,
      timestamp: new Date().toISOString(),
      category: 'business_transaction',
      action: 'purchase_order'
    });
  }
}

// å®‰å…¨å®¡è®¡æ—¥å¿—
class SecurityAuditLogger {
  logPermissionCheck(userId: string, resource: string, action: string, granted: boolean): void {
    this.logger.info('Permission check', {
      userId,
      resource,
      action,
      granted,
      timestamp: new Date().toISOString(),
      category: 'security_audit',
      action: 'permission_check'
    });

    // è®°å½•æƒé™æ‹’ç»
    if (!granted) {
      this.alertManager.sendAlert({
        level: 'warning',
        message: `æƒé™æ‹’ç»: ç”¨æˆ· ${userId} å°è¯•è®¿é—® ${resource}/${action}`,
        details: { userId, resource, action }
      });
    }
  }

  logSuspiciousActivity(userId: string, activity: string, details: Record<string, any>): void {
    this.logger.warn('Suspicious activity detected', {
      userId,
      activity,
      details,
      timestamp: new Date().toISOString(),
      category: 'security_audit',
      action: 'suspicious_activity'
    });

    this.alertManager.sendAlert({
      level: 'high',
      message: `æ£€æµ‹åˆ°å¯ç–‘æ´»åŠ¨: ${activity}`,
      details: { userId, activity, details }
    });
  }
}
```

### ğŸ” æ—¥å¿—æŸ¥è¯¢å’Œåˆ†æ

#### æ—¥å¿—æŸ¥è¯¢æ¥å£

```typescript
// æ—¥å¿—æŸ¥è¯¢æœåŠ¡
class LogQueryService {
  // æ ¹æ®ç”¨æˆ·IDæŸ¥è¯¢æ“ä½œæ—¥å¿—
  async getUserActivityLogs(
    userId: string,
    options: {
      startDate?: Date;
      endDate?: Date;
      actions?: string[];
      limit?: number;
      offset?: number;
    }
  ): Promise<LogEntry[]> {
    const query = {
      bool: {
        must: [
          { term: { userId } },
          { term: { category: 'user_activity' } }
        ]
      }
    };

    if (options.startDate || options.endDate) {
      query.bool.must.push({
        range: {
          timestamp: {
            gte: options.startDate?.toISOString(),
            lte: options.endDate?.toISOString()
          }
        }
      });
    }

    if (options.actions?.length) {
      query.bool.must.push({
        terms: { action: options.actions }
      });
    }

    const result = await this.elasticsearch.search({
      index: 'zhongdao-mall-logs-*',
      body: {
        query,
        sort: [{ timestamp: { order: 'desc' } }],
        size: options.limit || 100,
        from: options.offset || 0
      }
    });

    return result.body.hits.hits.map(hit => hit._source);
  }

  // æŸ¥è¯¢é”™è¯¯æ—¥å¿—
  async getErrorLogs(options: {
    startDate?: Date;
    endDate?: Date;
    service?: string;
    level?: LogLevel;
    search?: string;
  }): Promise<LogEntry[]> {
    const query = {
      bool: {
        must: [
          { term: { level: options.level || 'error' } }
        ]
      }
    };

    if (options.service) {
      query.bool.must.push({ term: { service: options.service } });
    }

    if (options.search) {
      query.bool.must.push({
        multi_match: {
          query: options.search,
          fields: ['message', 'error.message']
        }
      });
    }

    if (options.startDate || options.endDate) {
      query.bool.must.push({
        range: {
          timestamp: {
            gte: options.startDate?.toISOString(),
            lte: options.endDate?.toISOString()
          }
        }
      });
    }

    const result = await this.elasticsearch.search({
      index: 'zhongdao-mall-logs-*',
      body: {
        query,
        sort: [{ timestamp: { order: 'desc' } }],
        size: 100
      }
    });

    return result.body.hits.hits.map(hit => hit._source);
  }

  // è·å–æ—¥å¿—ç»Ÿè®¡ä¿¡æ¯
  async getLogStatistics(options: {
    startDate: Date;
    endDate: Date;
    interval?: 'hour' | 'day' | 'week';
  }): Promise<LogStatistics> {
    const interval = options.interval || 'day';

    const aggregationQuery = {
      aggs: {
        logs_over_time: {
          date_histogram: {
            field: 'timestamp',
            calendar_interval: interval
          }
        },
        logs_by_level: {
          terms: {
            field: 'level'
          }
        },
        logs_by_service: {
          terms: {
            field: 'service'
          }
        }
      }
    };

    const result = await this.elasticsearch.search({
      index: 'zhongdao-mall-logs-*',
      body: {
        query: {
          range: {
            timestamp: {
              gte: options.startDate.toISOString(),
              lte: options.endDate.toISOString()
            }
          }
        },
        aggs: aggregationQuery.aggs,
        size: 0
      }
    });

    return this.parseAggregationResult(result.body.aggregations);
  }
}

interface LogStatistics {
  totalLogs: number;
  timeSeries: Array<{
    timestamp: string;
    count: number;
  }>;
  byLevel: Record<string, number>;
  byService: Record<string, number>;
}
```

---

## ğŸš¨ å‘Šè­¦ç­–ç•¥

### ğŸ“Š å‘Šè­¦çº§åˆ«å®šä¹‰

```typescript
// å‘Šè­¦çº§åˆ«é…ç½®
enum AlertLevel {
  CRITICAL = 'critical',    // ä¸¥é‡ï¼šç³»ç»Ÿä¸å¯ç”¨ã€æ•°æ®ä¸¢å¤±é£é™©
  HIGH = 'high',           // é«˜ï¼šåŠŸèƒ½å¼‚å¸¸ã€æ€§èƒ½ä¸¥é‡ä¸‹é™
  WARNING = 'warning',     // è­¦å‘Šï¼šæ½œåœ¨é—®é¢˜ã€éœ€è¦å…³æ³¨
  INFO = 'info'           // ä¿¡æ¯ï¼šä¸€èˆ¬é€šçŸ¥ã€çŠ¶æ€æ›´æ–°
}

// å‘Šè­¦è§„åˆ™å®šä¹‰
interface AlertRule {
  name: string;                    // è§„åˆ™åç§°
  description: string;             // è§„åˆ™æè¿°
  level: AlertLevel;               // å‘Šè­¦çº§åˆ«
  condition: string;               // è§¦å‘æ¡ä»¶
  threshold: number;               // é˜ˆå€¼
  duration: number;                // æŒç»­æ—¶é—´(ç§’)
  labels: Record<string, string>;  // æ ‡ç­¾
  annotations: Record<string, string>; // æ³¨é‡Š
}
```

### ğŸ¯ å‘Šè­¦è§„åˆ™é…ç½®

#### ä¸šåŠ¡å‘Šè­¦è§„åˆ™

```yaml
# prometheus-rules.yml
groups:
  - name: business-alerts
    rules:
      # ç”¨æˆ·å‡çº§å¤±è´¥ç‡è¿‡é«˜
      - alert: UserUpgradeFailureRate
        expr: rate(user_upgrade_failures_total[5m]) / rate(user_upgrade_attempts_total[5m]) > 0.1
        for: 2m
        labels:
          severity: high
          team: business
        annotations:
          summary: "ç”¨æˆ·å‡çº§å¤±è´¥ç‡è¿‡é«˜"
          description: "è¿‡å»5åˆ†é’Ÿç”¨æˆ·å‡çº§å¤±è´¥ç‡: {{ $value | humanizePercentage }}"

      # äº¤æ˜“æˆåŠŸç‡è¿‡ä½
      - alert: TransactionSuccessRateLow
        expr: rate(transaction_success_total[5m]) / rate(transaction_attempts_total[5m]) < 0.95
        for: 1m
        labels:
          severity: critical
          team: business
        annotations:
          summary: "äº¤æ˜“æˆåŠŸç‡è¿‡ä½"
          description: "è¿‡å»5åˆ†é’Ÿäº¤æ˜“æˆåŠŸç‡: {{ $value | humanizePercentage }}"

      # é€šåˆ¸è½¬è´¦å¤±è´¥
      - alert: PointsTransferFailures
        expr: rate(points_transfer_failures_total[5m]) > 0.1
        for: 2m
        labels:
          severity: high
          team: finance
        annotations:
          summary: "é€šåˆ¸è½¬è´¦å¤±è´¥ç‡è¿‡é«˜"
          description: "è¿‡å»5åˆ†é’Ÿé€šåˆ¸è½¬è´¦å¤±è´¥æ¬¡æ•°: {{ $value }}"

  - name: system-alerts
    rules:
      # APIå“åº”æ—¶é—´è¿‡é•¿
      - alert: HighApiResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 3m
        labels:
          severity: warning
          team: backend
        annotations:
          summary: "APIå“åº”æ—¶é—´è¿‡é•¿"
          description: "95åˆ†ä½å“åº”æ—¶é—´: {{ $value }}s"

      # é”™è¯¯ç‡è¿‡é«˜
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) > 0.05
        for: 2m
        labels:
          severity: high
          team: backend
        annotations:
          summary: "APIé”™è¯¯ç‡è¿‡é«˜"
          description: "è¿‡å»5åˆ†é’Ÿé”™è¯¯ç‡: {{ $value | humanizePercentage }}"

      # å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜
      - alert: HighMemoryUsage
        expr: nodejs_memory_usage_ratio > 0.9
        for: 5m
        labels:
          severity: critical
          team: ops
        annotations:
          summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å†…å­˜ä½¿ç”¨ç‡: {{ $value | humanizePercentage }}"

      # æ•°æ®åº“è¿æ¥æ± è€—å°½
      - alert: DatabaseConnectionPoolExhausted
        expr: db_connections_active / db_connections_total > 0.9
        for: 1m
        labels:
          severity: critical
          team: ops
        annotations:
          summary: "æ•°æ®åº“è¿æ¥æ± å³å°†è€—å°½"
          description: "æ´»è·ƒè¿æ¥æ•°: {{ $value }}"
```

### ğŸ“¢ å‘Šè­¦é€šçŸ¥é…ç½®

#### å‘Šè­¦é€šçŸ¥æœåŠ¡

```typescript
// å‘Šè­¦é€šçŸ¥æœåŠ¡
class AlertNotificationService {
  private readonly notificationChannels = {
    email: new EmailNotifier(),
    wechat: new WechatNotifier(),
    sms: new SmsNotifier(),
    slack: new SlackNotifier()
  };

  async sendAlert(alert: Alert): Promise<void> {
    // æ ¹æ®å‘Šè­¦çº§åˆ«é€‰æ‹©é€šçŸ¥æ¸ é“
    const channels = this.getNotificationChannels(alert.level);

    // æ„å»ºé€šçŸ¥æ¶ˆæ¯
    const message = this.buildAlertMessage(alert);

    // å¹¶å‘å‘é€é€šçŸ¥
    await Promise.allSettled(
      channels.map(channel => this.sendNotification(channel, alert, message))
    );

    // è®°å½•å‘Šè­¦æ—¥å¿—
    this.logger.warn('Alert sent', {
      alertId: alert.id,
      level: alert.level,
      name: alert.name,
      channels: channels.map(c => c.constructor.name)
    });
  }

  private getNotificationChannels(level: AlertLevel): Notifier[] {
    switch (level) {
      case AlertLevel.CRITICAL:
        return [
          this.notificationChannels.email,
          this.notificationChannels.wechat,
          this.notificationChannels.sms,
          this.notificationChannels.slack
        ];
      case AlertLevel.HIGH:
        return [
          this.notificationChannels.email,
          this.notificationChannels.wechat,
          this.notificationChannels.slack
        ];
      case AlertLevel.WARNING:
        return [this.notificationChannels.email, this.notificationChannels.slack];
      case AlertLevel.INFO:
        return [this.notificationChannels.slack];
      default:
        return [];
    }
  }

  private buildAlertMessage(alert: Alert): string {
    return `
ğŸš¨ **${alert.level.toUpperCase()}** å‘Šè­¦

**å‘Šè­¦åç§°**: ${alert.name}
**å‘Šè­¦æè¿°**: ${alert.description}
**è§¦å‘æ—¶é—´**: ${alert.timestamp}
**æŒç»­æ—¶é—´**: ${alert.duration}ç§’

**è¯¦ç»†ä¿¡æ¯**:
${alert.details ? JSON.stringify(alert.details, null, 2) : 'æ— '}

**å»ºè®®æ“ä½œ**:
${alert.recommendations?.join('\n') || 'è¯·è”ç³»ç›¸å…³å›¢é˜Ÿå¤„ç†'}

---
*æ­¤å‘Šè­¦ç”±ä¸­é“å•†åŸç›‘æ§ç³»ç»Ÿè‡ªåŠ¨å‘å‡º*
    `.trim();
  }
}

interface Alert {
  id: string;
  level: AlertLevel;
  name: string;
  description: string;
  timestamp: string;
  duration: number;
  details?: Record<string, any>;
  recommendations?: string[];
}
```

---

## ğŸ› ï¸ è¿ç»´è‡ªåŠ¨åŒ–

### ğŸ”„ è‡ªåŠ¨åŒ–éƒ¨ç½²

#### CI/CDæµæ°´çº¿

```yaml
# .github/workflows/deploy.yml
name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Run integration tests
        run: npm run test:integration

      - name: Upload coverage
        uses: codecov/codecov-action@v3

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run security audit
        run: npm audit --audit-level moderate

      - name: Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  build:
    needs: [test, security-scan]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker image
        run: |
          docker build -t zhongdao-mall:${{ github.sha }} .
          docker tag zhongdao-mall:${{ github.sha }} zhongdao-mall:latest

      - name: Push to registry
        if: github.ref == 'refs/heads/main'
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker push zhongdao-mall:${{ github.sha }}
          docker push zhongdao-mall:latest

  deploy-staging:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to staging
        run: |
          # éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
          ssh deploy@staging.zhongdao-mall.com "
            docker pull zhongdao-mall:latest
            docker-compose -f docker-compose.staging.yml up -d
          "

      - name: Run smoke tests
        run: |
          # è¿è¡Œå†’çƒŸæµ‹è¯•
          npm run test:smoke -- --baseUrl=https://staging.zhongdao-mall.com

  deploy-production:
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to production
        run: |
          # è“ç»¿éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
          ssh deploy@prod.zhongdao-mall.com "
            ./scripts/blue-green-deploy.sh zhongdao-mall:latest
          "

      - name: Post-deployment health check
        run: |
          # éƒ¨ç½²åå¥åº·æ£€æŸ¥
          ./scripts/health-check.sh https://api.zhongdao-mall.com
```

### ğŸ”§ è‡ªåŠ¨åŒ–è¿ç»´è„šæœ¬

#### å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# scripts/health-check.sh

set -e

API_BASE_URL=${1:-"http://localhost:3000"}
TIMEOUT=30
MAX_RETRIES=3

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æŸ¥APIå¥åº·çŠ¶æ€
check_api_health() {
    log_info "æ£€æŸ¥APIå¥åº·çŠ¶æ€..."

    for i in $(seq 1 $MAX_RETRIES); do
        if curl -f -s --max-time $TIMEOUT "$API_BASE_URL/health" > /dev/null; then
            log_info "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
            return 0
        else
            log_warn "âŒ ç¬¬${i}æ¬¡å¥åº·æ£€æŸ¥å¤±è´¥"
            if [ $i -lt $MAX_RETRIES ]; then
                sleep 5
            fi
        fi
    done

    log_error "ğŸš¨ APIå¥åº·æ£€æŸ¥å¤±è´¥ï¼ŒæœåŠ¡å¯èƒ½ä¸å¯ç”¨"
    return 1
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database_connection() {
    log_info "æ£€æŸ¥æ•°æ®åº“è¿æ¥..."

    if curl -f -s --max-time $TIMEOUT "$API_BASE_URL/health/database" > /dev/null; then
        log_info "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
        return 0
    else
        log_error "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi
}

# æ£€æŸ¥Redisè¿æ¥
check_redis_connection() {
    log_info "æ£€æŸ¥Redisè¿æ¥..."

    if curl -f -s --max-time $TIMEOUT "$API_BASE_URL/health/redis" > /dev/null; then
        log_info "âœ… Redisè¿æ¥æ­£å¸¸"
        return 0
    else
        log_error "âŒ Redisè¿æ¥å¤±è´¥"
        return 1
    fi
}

# æ£€æŸ¥å…³é”®ä¸šåŠ¡æ¥å£
check_business_endpoints() {
    log_info "æ£€æŸ¥å…³é”®ä¸šåŠ¡æ¥å£..."

    endpoints=(
        "/api/v1/users/health"
        "/api/v1/shops/health"
        "/api/v1/purchases/health"
        "/api/v1/points/health"
    )

    for endpoint in "${endpoints[@]}"; do
        if curl -f -s --max-time $TIMEOUT "$API_BASE_URL$endpoint" > /dev/null; then
            log_info "âœ… $endpoint æ­£å¸¸"
        else
            log_error "âŒ $endpoint å¼‚å¸¸"
            return 1
        fi
    done
}

# ä¸»æ£€æŸ¥æµç¨‹
main() {
    log_info "å¼€å§‹ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
    log_info "ç›®æ ‡åœ°å€: $API_BASE_URL"

    failed_checks=0

    check_api_health || ((failed_checks++))
    check_database_connection || ((failed_checks++))
    check_redis_connection || ((failed_checks++))
    check_business_endpoints || ((failed_checks++))

    if [ $failed_checks -eq 0 ]; then
        log_info "ğŸ‰ æ‰€æœ‰å¥åº·æ£€æŸ¥é€šè¿‡ï¼"
        exit 0
    else
        log_error "ğŸ’¥ æœ‰ $failed_checks é¡¹æ£€æŸ¥å¤±è´¥"
        exit 1
    fi
}

main "$@"
```

#### è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# scripts/backup.sh

set -e

# é…ç½®
BACKUP_DIR="/backup/zhongdao-mall"
DATE=$(date +%Y%m%d_%H%M%S)
RETENTION_DAYS=7

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# å¤‡ä»½æ•°æ®åº“
backup_database() {
    log_info "å¼€å§‹å¤‡ä»½æ•°æ®åº“..."

    local backup_file="$BACKUP_DIR/database/zhongdao_mall_$DATE.sql"

    mkdir -p "$(dirname "$backup_file")"

    # ä½¿ç”¨mysqldumpå¤‡ä»½æ•°æ®åº“
    mysqldump \
        --single-transaction \
        --routines \
        --triggers \
        --all-databases \
        --host="$DB_HOST" \
        --user="$DB_USER" \
        --password="$DB_PASSWORD" \
        --result-file="$backup_file"

    # å‹ç¼©å¤‡ä»½æ–‡ä»¶
    gzip "$backup_file"

    log_info "âœ… æ•°æ®åº“å¤‡ä»½å®Œæˆ: ${backup_file}.gz"
}

# å¤‡ä»½æ–‡ä»¶å­˜å‚¨
backup_files() {
    log_info "å¼€å§‹å¤‡ä»½æ–‡ä»¶å­˜å‚¨..."

    local backup_dir="$BACKUP_DIR/files_$DATE"

    # å¤‡ä»½ä¸Šä¼ çš„æ–‡ä»¶
    if [ -d "/app/uploads" ]; then
        mkdir -p "$backup_dir/uploads"
        rsync -av --delete /app/uploads/ "$backup_dir/uploads/"
        log_info "âœ… æ–‡ä»¶å¤‡ä»½å®Œæˆ: $backup_dir"
    fi

    # å¤‡ä»½é…ç½®æ–‡ä»¶
    mkdir -p "$backup_dir/config"
    cp /app/.env "$backup_dir/config/" 2>/dev/null || log_warn "æœªæ‰¾åˆ°.envæ–‡ä»¶"
    cp -r /app/config "$backup_dir/config/" 2>/dev/null || log_warn "æœªæ‰¾åˆ°configç›®å½•"
}

# å¤‡ä»½æ—¥å¿—æ–‡ä»¶
backup_logs() {
    log_info "å¼€å§‹å¤‡ä»½æ—¥å¿—æ–‡ä»¶..."

    local backup_dir="$BACKUP_DIR/logs_$DATE"

    if [ -d "/app/logs" ]; then
        mkdir -p "$backup_dir"
        rsync -av --delete /app/logs/ "$backup_dir/"
        log_info "âœ… æ—¥å¿—å¤‡ä»½å®Œæˆ: $backup_dir"
    else
        log_warn "æœªæ‰¾åˆ°æ—¥å¿—ç›®å½•"
    fi
}

# æ¸…ç†è¿‡æœŸå¤‡ä»½
cleanup_old_backups() {
    log_info "æ¸…ç† $RETENTION_DAYS å¤©å‰çš„å¤‡ä»½..."

    # æ¸…ç†æ•°æ®åº“å¤‡ä»½
    find "$BACKUP_DIR/database" -name "*.sql.gz" -mtime +$RETENTION_DAYS -delete

    # æ¸…ç†æ–‡ä»¶å¤‡ä»½
    find "$BACKUP_DIR" -name "files_*" -mtime +$RETENTION_DAYS -exec rm -rf {} +

    # æ¸…ç†æ—¥å¿—å¤‡ä»½
    find "$BACKUP_DIR" -name "logs_*" -mtime +$RETENTION_DAYS -exec rm -rf {} +

    log_info "âœ… è¿‡æœŸå¤‡ä»½æ¸…ç†å®Œæˆ"
}

# éªŒè¯å¤‡ä»½å®Œæ•´æ€§
verify_backup() {
    log_info "éªŒè¯å¤‡ä»½å®Œæ•´æ€§..."

    # éªŒè¯æ•°æ®åº“å¤‡ä»½
    local db_backup=$(find "$BACKUP_DIR/database" -name "*$DATE*.sql.gz" | head -1)
    if [ -n "$db_backup" ]; then
        if gzip -t "$db_backup" 2>/dev/null; then
            log_info "âœ… æ•°æ®åº“å¤‡ä»½æ–‡ä»¶å®Œæ•´"
        else
            log_error "âŒ æ•°æ®åº“å¤‡ä»½æ–‡ä»¶æŸå"
            return 1
        fi
    fi

    log_info "âœ… å¤‡ä»½éªŒè¯å®Œæˆ"
}

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨
upload_to_cloud() {
    if [ -n "$CLOUD_STORAGE_BUCKET" ]; then
        log_info "ä¸Šä¼ å¤‡ä»½åˆ°äº‘å­˜å‚¨..."

        # ä½¿ç”¨AWS S3ä½œä¸ºç¤ºä¾‹
        for backup in "$BACKUP_DIR"/*"$DATE"*; do
            if [ -d "$backup" ]; then
                tar -czf "${backup}.tar.gz" -C "$(dirname "$backup")" "$(basename "$backup")"
                aws s3 cp "${backup}.tar.gz" "s3://$CLOUD_STORAGE_BUCKET/"
            elif [ -f "$backup" ]; then
                aws s3 cp "$backup" "s3://$CLOUD_STORAGE_BUCKET/"
            fi
        done

        log_info "âœ… äº‘å­˜å‚¨ä¸Šä¼ å®Œæˆ"
    fi
}

# ä¸»å¤‡ä»½æµç¨‹
main() {
    log_info "å¼€å§‹ç³»ç»Ÿå¤‡ä»½..."
    log_info "å¤‡ä»½æ—¶é—´: $DATE"

    # åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p "$BACKUP_DIR"/{database,files,logs}

    # æ‰§è¡Œå¤‡ä»½
    backup_database
    backup_files
    backup_logs

    # éªŒè¯å¤‡ä»½
    verify_backup

    # ä¸Šä¼ åˆ°äº‘å­˜å‚¨
    upload_to_cloud

    # æ¸…ç†è¿‡æœŸå¤‡ä»½
    cleanup_old_backups

    log_info "ğŸ‰ ç³»ç»Ÿå¤‡ä»½å®Œæˆï¼"
}

main "$@"
```

---

## ğŸ“Š ç›‘æ§é¢æ¿é…ç½®

### ğŸ“ˆ Grafanaä»ªè¡¨æ¿

#### ä¸šåŠ¡ç›‘æ§é¢æ¿

```json
{
  "dashboard": {
    "title": "ä¸­é“å•†åŸ - ä¸šåŠ¡ç›‘æ§",
    "tags": ["business", "zhongdao-mall"],
    "timezone": "browser",
    "panels": [
      {
        "title": "ç”¨æˆ·å¢é•¿è¶‹åŠ¿",
        "type": "graph",
        "targets": [
          {
            "expr": "increase(user_registration_total[1h])",
            "legendFormat": "æ–°å¢ç”¨æˆ·"
          },
          {
            "expr": "user_active_total",
            "legendFormat": "æ´»è·ƒç”¨æˆ·"
          }
        ]
      },
      {
        "title": "ç”¨æˆ·ç­‰çº§åˆ†å¸ƒ",
        "type": "piechart",
        "targets": [
          {
            "expr": "user_level_total",
            "legendFormat": "{{level}}"
          }
        ]
      },
      {
        "title": "äº¤æ˜“ç»Ÿè®¡",
        "type": "stat",
        "targets": [
          {
            "expr": "increase(transaction_amount_total[1h])",
            "legendFormat": "å°æ—¶äº¤æ˜“é¢"
          },
          {
            "expr": "increase(transaction_count_total[1h])",
            "legendFormat": "å°æ—¶è®¢å•æ•°"
          }
        ]
      },
      {
        "title": "ç”¨æˆ·å‡çº§æˆåŠŸç‡",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(user_upgrade_success_total[5m]) / rate(user_upgrade_attempt_total[5m])",
            "legendFormat": "å‡çº§æˆåŠŸç‡"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "unit": "percentunit",
            "thresholds": {
              "steps": [
                {"color": "red", "value": 0},
                {"color": "yellow", "value": 0.8},
                {"color": "green", "value": 0.95}
              ]
            }
          }
        }
      }
    ]
  }
}
```

#### ç³»ç»Ÿæ€§èƒ½é¢æ¿

```json
{
  "dashboard": {
    "title": "ä¸­é“å•†åŸ - ç³»ç»Ÿæ€§èƒ½",
    "tags": ["system", "performance"],
    "panels": [
      {
        "title": "APIå“åº”æ—¶é—´",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "50åˆ†ä½"
          },
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95åˆ†ä½"
          },
          {
            "expr": "histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "99åˆ†ä½"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total{status=~\"5..\"}[5m]) / rate(http_requests_total[5m])",
            "legendFormat": "5xxé”™è¯¯ç‡"
          },
          {
            "expr": "rate(http_requests_total{status=~\"4..\"}[5m]) / rate(http_requests_total[5m])",
            "legendFormat": "4xxé”™è¯¯ç‡"
          }
        ]
      },
      {
        "title": "å†…å­˜ä½¿ç”¨æƒ…å†µ",
        "type": "graph",
        "targets": [
          {
            "expr": "nodejs_memory_usage_ratio",
            "legendFormat": "å†…å­˜ä½¿ç”¨ç‡"
          },
          {
            "expr": "nodejs_memory_heap_used / 1024 / 1024",
            "legendFormat": "å †å†…å­˜ä½¿ç”¨(MB)"
          }
        ]
      },
      {
        "title": "æ•°æ®åº“æ€§èƒ½",
        "type": "graph",
        "targets": [
          {
            "expr": "db_connections_active",
            "legendFormat": "æ´»è·ƒè¿æ¥æ•°"
          },
          {
            "expr": "rate(db_slow_queries_total[5m])",
            "legendFormat": "æ…¢æŸ¥è¯¢ç‡"
          }
        ]
      }
    ]
  }
}
```

---

## ğŸ“‹ è¿ç»´æ£€æŸ¥æ¸…å•

### ğŸŒ… æ—¥å¸¸è¿ç»´æ£€æŸ¥

#### æ¯æ—¥æ£€æŸ¥é¡¹ç›®
- [ ] ç³»ç»Ÿå¥åº·çŠ¶æ€æ£€æŸ¥
- [ ] ä¸šåŠ¡æŒ‡æ ‡æ­£å¸¸æ€§æ£€æŸ¥
- [ ] é”™è¯¯æ—¥å¿—å®¡æŸ¥
- [ ] å‘Šè­¦ä¿¡æ¯å¤„ç†
- [ ] å¤‡ä»½ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
- [ ] æ€§èƒ½æŒ‡æ ‡è¶‹åŠ¿åˆ†æ

#### æ¯å‘¨æ£€æŸ¥é¡¹ç›®
- [ ] ç³»ç»Ÿæ€§èƒ½æŠ¥å‘Šåˆ†æ
- [ ] å®‰å…¨æ¼æ´æ‰«æ
- [ ] æ—¥å¿—æ¸…ç†å½’æ¡£
- [ ] ç›‘æ§è§„åˆ™ä¼˜åŒ–
- [ ] å®¹é‡è§„åˆ’è¯„ä¼°
- [ ] æ–‡æ¡£æ›´æ–°ç»´æŠ¤

#### æ¯æœˆæ£€æŸ¥é¡¹ç›®
- [ ] ç¾å¤‡æ¼”ç»ƒæµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] å®‰å…¨å®¡è®¡
- [ ] ç›‘æ§ç³»ç»Ÿç»´æŠ¤
- [ ] è¿ç»´æµç¨‹ä¼˜åŒ–
- [ ] å›¢é˜ŸåŸ¹è®­è®¡åˆ’

### ğŸš¨ åº”æ€¥å“åº”æµç¨‹

#### æ•…éšœå“åº”ç­‰çº§

**P0 - ä¸¥é‡æ•…éšœ**
- ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨
- æ•°æ®ä¸¢å¤±é£é™©
- å“åº”æ—¶é—´ï¼š< 15åˆ†é’Ÿ
- è§£å†³æ—¶é—´ï¼š< 2å°æ—¶

**P1 - é‡è¦æ•…éšœ**
- æ ¸å¿ƒåŠŸèƒ½å¼‚å¸¸
- æ€§èƒ½ä¸¥é‡ä¸‹é™
- å“åº”æ—¶é—´ï¼š< 30åˆ†é’Ÿ
- è§£å†³æ—¶é—´ï¼š< 4å°æ—¶

**P2 - ä¸€èˆ¬æ•…éšœ**
- éƒ¨åˆ†åŠŸèƒ½å¼‚å¸¸
- æ€§èƒ½è½»å¾®ä¸‹é™
- å“åº”æ—¶é—´ï¼š< 1å°æ—¶
- è§£å†³æ—¶é—´ï¼š< 8å°æ—¶

**P3 - ä½ä¼˜å…ˆçº§**
- ç”¨æˆ·ä½“éªŒå½±å“
- éæ ¸å¿ƒåŠŸèƒ½é—®é¢˜
- å“åº”æ—¶é—´ï¼š< 4å°æ—¶
- è§£å†³æ—¶é—´ï¼š< 24å°æ—¶

---

**é‡è¦æé†’**ï¼š
1. ç›‘æ§æ˜¯ç³»ç»Ÿçš„çœ¼ç›ï¼Œå¿…é¡»è¦†ç›–æ‰€æœ‰å…³é”®æŒ‡æ ‡
2. æ—¥å¿—æ˜¯æ’æŸ¥çš„ä¾æ®ï¼Œå¿…é¡»å®Œæ•´ã€å‡†ç¡®ã€å¯æŸ¥è¯¢
3. å‘Šè­¦æ˜¯å“åº”çš„ä¿¡å·ï¼Œå¿…é¡»åŠæ—¶ã€å‡†ç¡®ã€æœ‰æ•ˆ
4. è‡ªåŠ¨åŒ–æ˜¯è¿ç»´çš„ä¿éšœï¼Œå¿…é¡»æŒç»­ä¼˜åŒ–å’Œæ”¹è¿›
5. æ–‡æ¡£æ˜¯çŸ¥è¯†çš„è½½ä½“ï¼Œå¿…é¡»åŠæ—¶æ›´æ–°å’Œåˆ†äº«

**é€šè¿‡å®Œå–„çš„ç›‘æ§æ—¥å¿—ä½“ç³»ï¼Œæˆ‘ä»¬å°†ç¡®ä¿ä¸­é“å•†åŸç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œå¿«é€Ÿæ•…éšœæ¢å¤ï¼** ğŸ›¡ï¸