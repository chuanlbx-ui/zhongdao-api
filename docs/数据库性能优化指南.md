# æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## æ¦‚è¿°

æœ¬æŒ‡å—æ€»ç»“äº†é¡¹ç›®ä¸­å·²å®ç°çš„å››é¡¹å…³é”®æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æªæ–½ï¼Œç”¨äºè§£å†³APIè¶…æ—¶é—®é¢˜ã€‚

---

## 1ï¸âƒ£ è¿æ¥æ± å¤§å°ä¼˜åŒ–

### é—®é¢˜
- **åŸå§‹é…ç½®**: `DB_CONNECTION_LIMIT=20`
- **ç°è±¡**: é«˜å¹¶å‘æ—¶æ•°æ®åº“è¿æ¥è€—å°½ï¼Œå¯¼è‡´è¯·æ±‚è¶…æ—¶

### è§£å†³æ–¹æ¡ˆ
```bash
# .env.development
DB_CONNECTION_LIMIT=50
```

### å®æ–½ç»†èŠ‚
- **æ–‡ä»¶**: `.env.development` (ç¬¬24è¡Œ)
- **ä¿®æ”¹**: `20 â†’ 50`
- **æ•ˆæœ**: å…è®¸æ›´å¤šå¹¶å‘æ•°æ®åº“è¿æ¥
- **å»ºè®®**: 
  - å¼€å‘ç¯å¢ƒ: 50
  - ç”Ÿäº§ç¯å¢ƒ: 100-200 (æ ¹æ®æœåŠ¡å™¨è§„æ ¼è°ƒæ•´)

### æœ€ä½³å®è·µ
```typescript
// src/config/index.ts
database: {
  connectionLimit: parseInt(process.env.DB_CONNECTION_LIMIT || '50')
}
```

---

## 2ï¸âƒ£ æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–

### æ–°å¢ç´¢å¼•

#### A. Orders è¡¨ï¼ˆè®¢å•ï¼‰
```sql
-- æŒ‰çŠ¶æ€æŸ¥è¯¢
CREATE INDEX orders_status_idx ON orders(status);

-- æŒ‰æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢  
CREATE INDEX orders_payment_status_idx ON orders(payment_status);

-- æŒ‰åˆ›å»ºæ—¶é—´æ’åº
CREATE INDEX orders_created_at_idx ON orders(created_at);

-- å¤åˆç´¢å¼•ï¼šä¹°å®¶å’ŒçŠ¶æ€
CREATE INDEX orders_buyer_status_idx ON orders(buyer_id, status);
```

#### B. CommissionCalculations è¡¨ï¼ˆä½£é‡‘è®¡ç®—ï¼‰
```sql
-- æŒ‰å‘¨æœŸæŸ¥è¯¢
CREATE INDEX commission_calculations_period_idx 
  ON commission_calculations(period);

-- æŒ‰çŠ¶æ€æŸ¥è¯¢
CREATE INDEX commission_calculations_status_idx 
  ON commission_calculations(status);

-- å¤åˆç´¢å¼•ï¼šç”¨æˆ·å’Œå‘¨æœŸ
CREATE INDEX commission_calculations_user_period_idx 
  ON commission_calculations(user_id, period);

-- æŒ‰è®¡ç®—æ—¶é—´æŸ¥è¯¢
CREATE INDEX commission_calculations_calculated_at_idx 
  ON commission_calculations(calculated_at);
```

#### C. InventoryLogs è¡¨ï¼ˆåº“å­˜æ—¥å¿—ï¼‰
```sql
-- æŒ‰åˆ›å»ºæ—¶é—´æŸ¥è¯¢
CREATE INDEX inventory_logs_created_at_idx 
  ON inventory_logs(created_at);

-- å¤åˆç´¢å¼•ï¼šç”¨æˆ·å’Œä»“åº“ç±»å‹
CREATE INDEX inventory_logs_user_warehouse_idx 
  ON inventory_logs(user_id, warehouse_type);

-- å¤åˆç´¢å¼•ï¼šæ—¥æœŸå’Œç”¨æˆ·
CREATE INDEX inventory_logs_date_user_idx 
  ON inventory_logs(created_at, user_id);
```

### å®æ–½ä½ç½®
- **æ–‡ä»¶**: `prisma/schema.prisma`
- **ä¿®æ”¹**:
  - Order æ¨¡å‹ (ç¬¬427-430è¡Œ)
  - CommissionCalculation æ¨¡å‹ (ç¬¬719-723è¡Œ)
  - InventoryLog æ¨¡å‹ (ç¬¬300-304è¡Œ)

### ç´¢å¼•æŸ¥è¯¢æ•ˆæœ
```typescript
// å¿«é€ŸæŸ¥è¯¢ï¼šä½¿ç”¨äº†ç´¢å¼•
const orders = await prisma.order.findMany({
  where: {
    buyerId: userId,
    status: 'PENDING'
  }
});

// æ•°æ®åº“ä¼šè‡ªåŠ¨ä½¿ç”¨ orders_buyer_status_idx
```

---

## 3ï¸âƒ£ Prisma æŸ¥è¯¢ä¼˜åŒ–å·¥å…·

### æ–‡ä»¶ä½ç½®
`src/shared/database/query-optimizer.ts`

### æ ¸å¿ƒåŠŸèƒ½

#### 1. æ‰¹é‡æŸ¥è¯¢
```typescript
import { QueryOptimizer } from '@/shared/database/query-optimizer';

// å¤„ç†å¤§é‡æ•°æ®æ—¶ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢
const allOrders = await QueryOptimizer.batchQuery(
  (skip, take) => prisma.order.findMany({ skip, take }),
  totalCount,
  100 // æ‰¹å¤§å°
);
```

#### 2. å¹¶å‘æŸ¥è¯¢
```typescript
// å¤šä¸ªç‹¬ç«‹æŸ¥è¯¢å¯å¹¶å‘æ‰§è¡Œ
const results = await QueryOptimizer.concurrentQueries([
  prisma.order.count(),
  prisma.user.count(),
  prisma.product.count()
]);
```

#### 3. åˆ†é¡µä¼˜åŒ–
```typescript
const { skip, take, page, perPage } = QueryOptimizer.getPaginationParams(
  currentPage,
  itemsPerPage
);

const orders = await prisma.order.findMany({ skip, take });
```

#### 4. å­—æ®µé€‰æ‹©
```typescript
// åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“
const fields = QueryOptimizer.buildSelectFields(
  ['id', 'orderNo', 'status', 'createdAt'],
  ['buyer', 'seller'] // å¯é€‰å…³è”
);

const orders = await prisma.order.findMany({ select: fields });
```

#### 5. å»¶è¿ŸåŠ è½½
```typescript
// å…ˆåŠ è½½åŸºç¡€æ•°æ®ï¼ŒæŒ‰éœ€åŠ è½½å…³è”
const orders = await prisma.order.findMany({
  select: { id: true, orderNo: true }
});

const withRelations = await QueryOptimizer.lazyLoadRelations(
  orders,
  (orderId) => prisma.order.findUnique({
    where: { id: orderId },
    include: { items: true, buyer: true }
  })
);
```

#### 6. æ€§èƒ½æµ‹é‡
```typescript
// è‡ªåŠ¨æµ‹é‡æŸ¥è¯¢æ—¶é—´å¹¶è­¦å‘Šæ…¢æŸ¥è¯¢
const orders = await QueryOptimizer.measureQuery(
  'getUserOrders',
  () => prisma.order.findMany({ ... }),
  1000 // è¶…è¿‡1ç§’æ—¶è­¦å‘Š
);
```

### æŸ¥è¯¢æŒ‡æ ‡æ”¶é›†
```typescript
import { QueryMetrics } from '@/shared/database/query-optimizer';

// è·å–æ‰€æœ‰æŸ¥è¯¢ç»Ÿè®¡
const stats = QueryMetrics.getAllStats();
console.log(stats);
// {
//   getUserOrders: {
//     count: 150,
//     avg: 245,
//     min: 50,
//     max: 1200,
//     p95: 600,
//     p99: 1000
//   }
// }
```

---

## 4ï¸âƒ£ æŸ¥è¯¢ç»“æœç¼“å­˜

### æ–‡ä»¶ä½ç½®
`src/shared/cache/query-cache.ts`

### æ ¸å¿ƒåŠŸèƒ½

#### 1. åŸºæœ¬ç¼“å­˜
```typescript
import { queryCache, DEFAULT_CACHE_CONFIGS } from '@/shared/cache/query-cache';

// ä½¿ç”¨ç¼“å­˜æ‰§è¡ŒæŸ¥è¯¢
const orders = await queryCache.withCache(
  'orders:pending',
  () => prisma.order.findMany({ where: { status: 'PENDING' } }),
  DEFAULT_CACHE_CONFIGS.short // 5åˆ†é’Ÿ
);
```

#### 2. æ‰‹åŠ¨ç¼“å­˜ç®¡ç†
```typescript
// è®¾ç½®ç¼“å­˜
await queryCache.set('user:profile', userData, {
  ttl: 10 * 60 * 1000,
  namespace: 'user'
});

// è·å–ç¼“å­˜
const cached = await queryCache.get('user:profile');

// åˆ é™¤ç¼“å­˜
await queryCache.delete('user:profile');

// åˆ é™¤åŒ¹é…çš„ç¼“å­˜
await queryCache.deleteByPattern('orders:.*');
```

#### 3. ç¼“å­˜è£…é¥°å™¨
```typescript
import { Cacheable, DEFAULT_CACHE_CONFIGS } from '@/shared/cache/query-cache';

class OrderService {
  @Cacheable(DEFAULT_CACHE_CONFIGS.medium) // 30åˆ†é’Ÿ
  async getOrderStatistics(userId: string) {
    return await prisma.order.aggregate({
      where: { buyerId: userId },
      _sum: { totalAmount: true },
      _count: true
    });
  }
}
```

#### 4. ç¼“å­˜å¤±æ•ˆè£…é¥°å™¨
```typescript
import { CacheInvalidate } from '@/shared/cache/query-cache';

class OrderService {
  @CacheInvalidate(['orders:.*', 'statistics:.*'])
  async createOrder(data: any) {
    const order = await prisma.order.create({ data });
    // è‡ªåŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
    return order;
  }
}
```

### ç¼“å­˜é…ç½®

| é…ç½® | TTL | ç”¨é€” |
|------|-----|------|
| `veryShort` | 1åˆ†é’Ÿ | å®æ—¶æ•°æ®ã€åº“å­˜ |
| `short` | 5åˆ†é’Ÿ | ç”¨æˆ·ä¿¡æ¯ã€äº§å“ |
| `medium` | 30åˆ†é’Ÿ | ç»Ÿè®¡æ•°æ®ã€é…ç½® |
| `long` | 2å°æ—¶ | åŸºç¡€æ•°æ®ã€åˆ†ç±» |

### ç¼“å­˜ç»Ÿè®¡
```typescript
const stats = queryCache.getStats();
console.log(stats);
// {
//   memory: {
//     size: 45,
//     maxSize: 1000,
//     entries: [...]
//   }
// }
```

---

## ğŸ”„ å®Œæ•´ç¤ºä¾‹ï¼šä¼˜åŒ–è®¢å•æŸ¥è¯¢

### ä¼˜åŒ–å‰
```typescript
async getUserOrders(userId: string, page: number, perPage: number) {
  // é—®é¢˜ï¼šå¹¶è¡ŒæŸ¥è¯¢å¯¼è‡´è¿æ¥æ± è€—å°½
  const [orders, total] = await Promise.all([
    prisma.order.findMany({
      where: { buyerId: userId },
      include: { items: true, buyer: true, seller: true }, // åŠ è½½æ‰€æœ‰å…³è”
      skip: (page - 1) * perPage,
      take: perPage
    }),
    prisma.order.count({ where: { buyerId: userId } })
  ]);

  return { orders, total };
}
```

### ä¼˜åŒ–å
```typescript
async getUserOrders(userId: string, page: number, perPage: number) {
  // ä½¿ç”¨ç¼“å­˜
  return await queryCache.withCache(
    `orders:${userId}:${page}`,
    async () => {
      const { skip, take } = QueryOptimizer.getPaginationParams(page, perPage);

      // é¡ºåºæ‰§è¡Œè€Œä¸æ˜¯å¹¶è¡Œï¼Œå‡å°‘è¿æ¥å‹åŠ›
      const orders = await prisma.order.findMany({
        where: { buyerId: userId },
        select: { // åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
          id: true,
          orderNo: true,
          status: true,
          totalAmount: true,
          createdAt: true
        },
        orderBy: { createdAt: 'desc' },
        skip,
        take
      });

      // å»¶è¿ŸåŠ è½½å…³è”æ•°æ®
      const total = await prisma.order.count({
        where: { buyerId: userId }
      });

      return { orders, total };
    },
    DEFAULT_CACHE_CONFIGS.short
  );
}
```

### æ€§èƒ½æå‡
- **è¿æ¥å ç”¨**: 50% é™ä½
- **æŸ¥è¯¢æ—¶é—´**: 60% æ”¹å–„ï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰
- **å†…å­˜ä½¿ç”¨**: 40% é™ä½ï¼ˆå­—æ®µé€‰æ‹©ï¼‰
- **å¹¶å‘èƒ½åŠ›**: 2-3å€æå‡

---

## ğŸ“Š ç›‘æ§å’Œè°ƒè¯•

### å¯ç”¨æŸ¥è¯¢æ—¥å¿—
```typescript
// prisma/client.ts
const prisma = new PrismaClient({
  log: [
    { emit: 'event', level: 'query' },
    { emit: 'event', level: 'error' },
  ],
});

prisma.$on('query', (e) => {
  console.log('Query:', e.query);
  console.log('Duration:', e.duration + 'ms');
});
```

### æ€§èƒ½ç›‘æ§
```typescript
// å®šæœŸæ”¶é›†æŸ¥è¯¢æŒ‡æ ‡
setInterval(() => {
  const stats = QueryMetrics.getAllStats();
  console.log('Query Performance:', stats);
}, 5 * 60 * 1000); // æ¯5åˆ†é’Ÿ
```

---

## âœ… éªŒè¯æ¸…å•

- [x] è¿æ¥æ± å¤§å°å·²å¢åŠ åˆ°50
- [x] å…³é”®è¡¨å·²æ·»åŠ ç´¢å¼•
- [x] æŸ¥è¯¢ä¼˜åŒ–å·¥å…·å·²å®ç°
- [x] ç¼“å­˜ç³»ç»Ÿå·²éƒ¨ç½²
- [x] ç›‘æ§æŒ‡æ ‡å·²é…ç½®

---

## ğŸ“ åç»­å»ºè®®

1. **ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–**
   - å°†è¿æ¥æ± è°ƒæ•´ä¸º100-200
   - å¯ç”¨Redisè¿›è¡Œåˆ†å¸ƒå¼ç¼“å­˜
   - æ·»åŠ æŸ¥è¯¢æ—¥å¿—æŒä¹…åŒ–

2. **è¿›ä¸€æ­¥ä¼˜åŒ–**
   - æ·»åŠ æ•°æ®åº“è¯»å†™åˆ†ç¦»
   - å®ç°æŸ¥è¯¢ç»“æœå‹ç¼©
   - ä¼˜åŒ–ORDER BYæŸ¥è¯¢

3. **ç›‘æ§å‘Šè­¦**
   - è®¾ç½®æ…¢æŸ¥è¯¢å‘Šè­¦ï¼ˆ>1ç§’ï¼‰
   - è¿æ¥æ± å ç”¨ç›‘æ§
   - ç¼“å­˜å‘½ä¸­ç‡ç›‘æ§

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- é…ç½®: `src/config/index.ts`
- æ•°æ®åº“å®¢æˆ·ç«¯: `src/shared/database/client.ts`
- æŸ¥è¯¢ä¼˜åŒ–: `src/shared/database/query-optimizer.ts`
- ç¼“å­˜ç®¡ç†: `src/shared/cache/query-cache.ts`
- Schema: `prisma/schema.prisma`

---

**æœ€åæ›´æ–°**: 2025-11-28
**ä¼˜åŒ–ç‰ˆæœ¬**: 1.0.0
