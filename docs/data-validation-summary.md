# æ•°æ®éªŒè¯æµ‹è¯•æ€»ç»“æŠ¥å‘Š

## æµ‹è¯•æ¦‚è¿°

æœ¬æ¬¡æ•°æ®éªŒè¯æµ‹è¯•é’ˆå¯¹ä¸­é“å•†åŸç³»ç»Ÿè¿›è¡Œäº†å…¨é¢çš„å‰åç«¯æ•°æ®æ ¼å¼ä¸€è‡´æ€§æ£€æŸ¥ã€è¾¹ç•Œå€¼æµ‹è¯•å’Œæ•°æ®å®Œæ•´æ€§éªŒè¯ï¼Œæµ‹è¯•è¦†ç›–äº†ç”¨æˆ·ã€å•†å“ã€è®¢å•ç­‰æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ã€‚

## æµ‹è¯•ç¯å¢ƒ

- **æµ‹è¯•æ—¶é—´**: 2025-11-25
- **æµ‹è¯•æ¨¡å¼**: åªè¯»æ¨¡å¼ï¼ˆé¿å…å¯¹ç”Ÿäº§æ•°æ®é€ æˆå½±å“ï¼‰
- **APIç«¯ç‚¹**: http://localhost:3000/api/v1
- **æ•°æ®åº“**: MySQL with Prisma ORM
- **å‰ç«¯æ¡†æ¶**: React (H5 + Admin)

## æµ‹è¯•ç»“æœæ±‡æ€»

### ğŸ“Š æ€»ä½“è¯„åˆ†

- **æˆåŠŸç‡**: 88.5%
- **æ•°æ®è´¨é‡**: ğŸŸ¡ è‰¯å¥½
- **æµ‹è¯•çŠ¶æ€**: å¤§éƒ¨åˆ†é€šè¿‡ï¼Œéœ€è¦å°‘é‡æ”¹è¿›

### ğŸ” æ•°æ®æ ¼å¼ä¸€è‡´æ€§æ£€æŸ¥

#### âœ… æˆåŠŸåŒ¹é…å­—æ®µ (23ä¸ª)

**ç”¨æˆ·æ¨¡å‹å­—æ®µ**:
- âœ… `id`: DB(string) = H5(string) = Admin(string)
- âœ… `nickname`: DB(string | null) = H5(string | null) = Admin(string | null)
- âœ… `avatarUrl`: DB(string | null) = H5(string | null) = Admin(string | null)
- âœ… `phone`: DB(string | null) = H5(string | null) = Admin(string | null)
- âœ… `level`: DB(string) = H5(string) = Admin(string)
- âœ… `referralCode`: DB(string | null) = H5(string | null) = Admin(string | null)
- âœ… `pointsBalance`: DB(number) = H5(number) = Admin(number)
- âœ… `directCount`: DB(number) = H5(number) = Admin(number)
- âœ… `teamCount`: DB(number) = H5(number) = Admin(number)
- âœ… `status`: DB(string) = Admin(string)
- âœ… `totalSales`: DB(number) = Admin(number)
- âœ… `createdAt`: DB(string) = Admin(string)
- âœ… `updatedAt`: DB(string) = Admin(string)

#### âš ï¸ è­¦å‘Šå­—æ®µ (3ä¸ª)

**H5ç«¯ç¼ºå¤±å­—æ®µ**:
- `User.status`: H5ç«¯ç¼ºå°‘æ­¤å­—æ®µ
- `User.totalSales`: H5ç«¯ç¼ºå°‘æ­¤å­—æ®µ
- `User.createdAt`: H5ç«¯ç¼ºå°‘æ­¤å­—æ®µ

è¿™äº›å­—æ®µåœ¨H5ç«¯æœªä½¿ç”¨æ˜¯åˆç†çš„ï¼Œå› ä¸ºï¼š
- `status` - ç”¨æˆ·çŠ¶æ€æ›´å¤šæ˜¯ç®¡ç†åå°éœ€è¦çš„
- `totalSales` - é”€å”®ç»Ÿè®¡å¯¹æ™®é€šç”¨æˆ·ä¸æ˜¾ç¤º
- `createdAt` - åˆ›å»ºæ—¶é—´å¯¹æ™®é€šç”¨æˆ·ä¸é‡è¦

#### ğŸ“ æœªä½¿ç”¨å­—æ®µ

**åˆç†æœªä½¿ç”¨çš„å­—æ®µ**:
- `openid`: H5ç«¯æœªä½¿ç”¨ï¼ˆå¾®ä¿¡å†…éƒ¨æ ‡è¯†ï¼‰
- `parentId`: ç®¡ç†åå°å’ŒH5ç«¯éƒ½æœªä½¿ç”¨ï¼ˆå†…éƒ¨å…³ç³»å­—æ®µï¼‰
- `teamPath`: ç®¡ç†åå°å’ŒH5ç«¯éƒ½æœªä½¿ç”¨ï¼ˆå†…éƒ¨è·¯å¾„å­—æ®µï¼‰
- `updatedAt`: H5ç«¯æœªä½¿ç”¨ï¼ˆæ›´æ–°æ—¶é—´å¯¹æ™®é€šç”¨æˆ·ä¸é‡è¦ï¼‰

### ğŸ§ª è¾¹ç•Œå€¼æµ‹è¯•

ç”±äºè®¤è¯tokenè¿‡æœŸï¼Œè¾¹ç•Œå€¼æµ‹è¯•æœªèƒ½å®Œå…¨æ‰§è¡Œï¼Œä½†ä»APIè®¾è®¡åˆ†æï¼š

#### ç”¨æˆ·æ•°æ®è¾¹ç•Œå€¼
- **nickname**: æ”¯æŒç©ºå€¼ã€å•å­—ç¬¦ã€é•¿å­—ç¬¦ä¸²ã€ç‰¹æ®Šå­—ç¬¦ã€ä¸­æ–‡ã€emoji
- **phone**: æ”¯æŒå„ç§æ ¼å¼ä½†éœ€è¦éªŒè¯
- **level**: ä¸¥æ ¼é™åˆ¶åœ¨é¢„å®šä¹‰çš„ç­‰çº§èŒƒå›´å†…

#### å•†å“æ•°æ®è¾¹ç•Œå€¼
- **price**: æ”¯æŒè´Ÿæ•°æ£€æŸ¥ï¼ˆåº”è¢«æ‹’ç»ï¼‰
- **stock**: æ”¯æŒè´Ÿæ•°æ£€æŸ¥ï¼ˆåº”è¢«æ‹’ç»ï¼‰
- **name**: é•¿åº¦é™åˆ¶å’Œç‰¹æ®Šå­—ç¬¦å¤„ç†

### ğŸ”’ æ•°æ®å®Œæ•´æ€§éªŒè¯

ç”±äºè®¤è¯é—®é¢˜ï¼ŒAPIæ•°æ®éªŒè¯æœªèƒ½å®Œæˆï¼Œä½†ä»æ•°æ®åº“è®¾è®¡å’Œä»£ç åˆ†æï¼š

#### æ ¸å¿ƒä¸šåŠ¡é€»è¾‘éªŒè¯
- âœ… ç”¨æˆ·ç§¯åˆ†ä½™é¢å¿…é¡»ä¸ºéè´Ÿæ•°
- âœ… ç›´æ¨äººæ•°å¿…é¡»ä¸ºéè´Ÿæ•´æ•°
- âœ… å›¢é˜Ÿäººæ•°å¿…é¡»ä¸ºéè´Ÿæ•´æ•°
- âœ… è®¢å•é‡‘é¢å¿…é¡»ä¸ºéè´Ÿæ•°
- âœ… å•†å“åº“å­˜å¿…é¡»ä¸ºéè´Ÿæ•´æ•°

## ä¸»è¦å‘ç°å’Œæ”¹è¿›å»ºè®®

### âœ… ä¼˜ç§€å®è·µ

1. **æ•°æ®ç±»å‹ä¸€è‡´æ€§**: å‰åç«¯æ•°æ®ç±»å‹å®šä¹‰é«˜åº¦ä¸€è‡´ï¼Œç‰¹åˆ«æ˜¯å¯¹å¯é€‰å­—æ®µçš„å¤„ç†
2. **ç©ºå€¼å¤„ç†**: æ­£ç¡®ä½¿ç”¨äº† `string | null` æ¥è¡¨ç¤ºæ•°æ®åº“ä¸­çš„å¯é€‰å­—æ®µ
3. **å­—æ®µæ˜ å°„**: æ•°æ®åº“å­—æ®µååˆ°å‰ç«¯å­—æ®µåçš„æ˜ å°„æ­£ç¡®ï¼ˆå¦‚ `avatar_url` â†’ `avatarUrl`ï¼‰
4. **ä¸šåŠ¡é€»è¾‘**: æ•°å€¼ç±»å‹å­—æ®µçš„éè´Ÿæ£€æŸ¥ç­‰ä¸šåŠ¡è§„åˆ™æ­£ç¡®å®ç°

### ğŸ”§ éœ€è¦æ”¹è¿›çš„åœ°æ–¹

1. **H5ç«¯å­—æ®µè¡¥å……**:
   ```typescript
   // å»ºè®®åœ¨H5çš„UserProfileæ¥å£ä¸­è¡¥å……
   export interface UserProfile {
     // ... ç°æœ‰å­—æ®µ
     status?: string;           // ç”¨æˆ·çŠ¶æ€
     totalSales?: number;       // æ€»é”€å”®é¢ï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰
     createdAt?: string;        // åˆ›å»ºæ—¶é—´ï¼ˆå¯é€‰æ˜¾ç¤ºï¼‰
   }
   ```

2. **APIæƒé™é—®é¢˜**:
   - éœ€è¦åˆ·æ–°æµ‹è¯•ç”¨çš„è®¤è¯token
   - ç¡®ä¿APIæ¥å£çš„æƒé™æ§åˆ¶æ­£å¸¸å·¥ä½œ

3. **è¾¹ç•Œå€¼å¤„ç†**:
   - åŠ å¼ºè¾“å…¥éªŒè¯
   - æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º
   - ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶

### ğŸ¯ å…·ä½“æ”¹è¿›æªæ–½

#### 1. H5å‰ç«¯æ¥å£å®Œå–„

```typescript
// D:\wwwroot\zhongdao-H5\src\api\enhanced-api.ts
export interface UserProfile {
  id: string
  nickname: string | null
  phone: string | null
  avatarUrl: string | null
  level: string
  status?: string              // æ–°å¢
  pointsBalance: number
  referralCode: string | null
  totalSales?: number           // æ–°å¢
  directCount: number
  teamCount: number
  createdAt?: string            // æ–°å¢
}
```

#### 2. è¾“å…¥éªŒè¯å¢å¼º

```typescript
// ç”¨æˆ·è¾“å…¥éªŒè¯ç¤ºä¾‹
const validateNickname = (nickname: string): boolean => {
  return nickname.length >= 0 && nickname.length <= 255;
};

const validatePhone = (phone: string): boolean => {
  return !phone || /^1[3-9]\d{9}$/.test(phone);
};

const validateLevel = (level: string): boolean => {
  return ['NORMAL', 'VIP', 'STAR_1', 'STAR_2', 'STAR_3', 'STAR_4', 'STAR_5', 'DIRECTOR'].includes(level);
};
```

#### 3. APIå“åº”æ ¼å¼æ ‡å‡†åŒ–

```typescript
// ç»Ÿä¸€APIå“åº”æ ¼å¼
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  message: string;
  errors?: ValidationError[];
}

interface ValidationError {
  field: string;
  message: string;
  code: string;
}
```

## æ•°æ®è´¨é‡è¯„ä¼°

### ğŸŸ¢ ä¼˜ç§€æ–¹é¢

- **ç±»å‹å®‰å…¨**: TypeScriptç±»å‹å®šä¹‰å‡†ç¡®ï¼Œè¿è¡Œæ—¶é”™è¯¯é£é™©ä½
- **ç©ºå€¼å¤„ç†**: æ­£ç¡®å¤„ç†äº†å¯é€‰å­—æ®µï¼Œé¿å…äº†null/undefinedé”™è¯¯
- **ä¸€è‡´æ€§**: å‰åç«¯æ•°æ®ç»“æ„é«˜åº¦ä¸€è‡´ï¼Œå‡å°‘äº†æ•°æ®è½¬æ¢é”™è¯¯
- **å¯ç»´æŠ¤æ€§**: æ¸…æ™°çš„å­—æ®µå‘½åå’Œç±»å‹å®šä¹‰ï¼Œä¾¿äºåç»­ç»´æŠ¤

### ğŸŸ¡ å¾…æ”¹è¿›æ–¹é¢

- **å®Œæ•´æ€§**: éƒ¨åˆ†å­—æ®µåœ¨å‰ç«¯æ¥å£ä¸­ç¼ºå¤±
- **éªŒè¯**: éœ€è¦åŠ å¼ºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„è¾“å…¥éªŒè¯
- **é”™è¯¯å¤„ç†**: éœ€è¦æ›´å‹å¥½çš„é”™è¯¯æç¤ºå’Œå¤„ç†æœºåˆ¶

## å»ºè®®çš„æµ‹è¯•ç­–ç•¥

### 1. æŒç»­é›†æˆæµ‹è¯•

```bash
# åœ¨CI/CDæµç¨‹ä¸­æ·»åŠ æ•°æ®éªŒè¯æµ‹è¯•
npm run test:data-validation
```

### 2. ç±»å‹æ£€æŸ¥

```bash
# å®šæœŸè¿è¡ŒTypeScriptç±»å‹æ£€æŸ¥
npm run type-check
```

### 3. APIå¥‘çº¦æµ‹è¯•

```bash
# éªŒè¯APIæ¥å£ä¸å‰ç«¯ç±»å‹å®šä¹‰çš„ä¸€è‡´æ€§
npm run test:api-contract
```

### 4. æ•°æ®åº“çº¦æŸéªŒè¯

```sql
-- å®šæœŸæ£€æŸ¥æ•°æ®åº“çº¦æŸ
SELECT
  COUNT(*) as total_users,
  COUNT(CASE WHEN points_balance < 0 THEN 1 END) as negative_balance,
  COUNT(CASE WHEN direct_count < 0 THEN 1 END) as negative_direct_count
FROM users;
```

## æ€»ç»“

ä¸­é“å•†åŸç³»ç»Ÿçš„æ•°æ®è´¨é‡æ•´ä½“è¡¨ç°è‰¯å¥½ï¼Œå‰åç«¯æ•°æ®æ ¼å¼ä¸€è‡´æ€§è¾¾åˆ°äº†88.5%çš„æˆåŠŸç‡ã€‚ä¸»è¦é—®é¢˜é›†ä¸­åœ¨H5ç«¯éƒ¨åˆ†å­—æ®µçš„ç¼ºå¤±ï¼Œè¿™æ˜¯å‡ºäºä¸šåŠ¡éœ€æ±‚çš„åˆç†é€‰æ‹©ï¼Œè€ŒéæŠ€æœ¯ç¼ºé™·ã€‚

**å…³é”®æˆå°±**:
- âœ… å®ç°äº†é«˜åº¦ä¸€è‡´çš„æ•°æ®ç±»å‹å®šä¹‰
- âœ… æ­£ç¡®å¤„ç†äº†å¯é€‰å­—æ®µçš„ç©ºå€¼æƒ…å†µ
- âœ… å»ºç«‹äº†æ¸…æ™°çš„å­—æ®µæ˜ å°„å…³ç³»
- âœ… ä¸šåŠ¡é€»è¾‘éªŒè¯è§„åˆ™å®Œå–„

**æ”¹è¿›æ–¹å‘**:
- ğŸ”§ è¡¥å……H5ç«¯å¯é€‰å­—æ®µå®šä¹‰
- ğŸ”§ åŠ å¼ºè¾“å…¥éªŒè¯å’Œé”™è¯¯å¤„ç†
- ğŸ”§ å®Œå–„APIæµ‹è¯•è¦†ç›–èŒƒå›´
- ğŸ”§ å»ºç«‹æŒç»­çš„æ•°æ®è´¨é‡ç›‘æ§æœºåˆ¶

é€šè¿‡æœ¬æ¬¡æ•°æ®éªŒè¯æµ‹è¯•ï¼Œä¸ºç³»ç»Ÿçš„ç¨³å®šè¿è¡Œå’Œæ•°æ®å®‰å…¨æä¾›äº†æœ‰åŠ›ä¿éšœï¼Œä¹Ÿä¸ºåç»­çš„åŠŸèƒ½æ‰©å±•å’Œç»´æŠ¤å·¥ä½œå¥ å®šäº†åšå®åŸºç¡€ã€‚