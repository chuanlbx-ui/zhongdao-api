<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中道商城 - 监控面板</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        .status-ok { color: #10b981; }
        .status-warning { color: #f59e0b; }
        .status-danger { color: #ef4444; }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .loading {
            animation: pulse 2s infinite;
        }

        .progress-bar {
            transition: width 0.5s ease;
        }

        /* 顶部信息栏 */
        .top-bar {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        /* API连接状态 */
        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
        }

        .api-status.online {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .api-status.offline {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* 错误提示 */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
            padding: 12px 16px;
            margin-bottom: 20px;
            border-radius: 4px;
            color: #991b1b;
        }
    </style>
</head>
<body>
    <!-- 顶部信息栏 -->
    <div class="top-bar">
        <div class="glass rounded-lg px-4 py-2 flex items-center space-x-4">
            <span id="lastUpdate" class="text-sm text-gray-600">未更新</span>
            <button onclick="refreshData()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                <i class="fas fa-sync-alt mr-2"></i>手动刷新
            </button>
            <div id="apiStatus" class="api-status offline">
                <span class="status-dot"></span>
                <span>离线</span>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-7xl">
        <!-- 错误提示区域 -->
        <div id="errorContainer" style="display: none;">
            <div class="glass rounded-xl p-4 error-message">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="errorMessage"></span>
            </div>
        </div>

        <!-- 头部 -->
        <div class="glass rounded-2xl p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-chart-line mr-3 text-purple-600"></i>
                        中道商城监控中心
                    </h1>
                    <p class="text-gray-600 mt-2">系统实时监控与性能分析</p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-500">数据源</p>
                    <p class="text-lg font-semibold text-blue-600">API Server</p>
                </div>
            </div>
        </div>

        <!-- 系统状态概览 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- 活跃用户 -->
            <div class="metric-card glass rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">活跃用户</p>
                        <p id="activeUsers" class="text-2xl font-bold text-gray-800 loading">--</p>
                    </div>
                    <i class="fas fa-users text-4xl text-blue-500"></i>
                </div>
            </div>

            <!-- 今日订单 -->
            <div class="metric-card glass rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">今日订单</p>
                        <p id="orders" class="text-2xl font-bold text-gray-800 loading">--</p>
                    </div>
                    <i class="fas fa-shopping-cart text-4xl text-orange-500"></i>
                </div>
            </div>

            <!-- 今日收入 -->
            <div class="metric-card glass rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">今日收入</p>
                        <p id="revenue" class="text-2xl font-bold text-gray-800 loading">--</p>
                    </div>
                    <i class="fas fa-yen-sign text-4xl text-green-500"></i>
                </div>
            </div>

            <!-- 响应时间 -->
            <div class="metric-card glass rounded-xl p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-600 text-sm">响应时间</p>
                        <p id="responseTime" class="text-2xl font-bold text-gray-800 loading">--</p>
                    </div>
                    <i class="fas fa-tachometer-alt text-4xl text-purple-500"></i>
                </div>
            </div>
        </div>

        <!-- 系统资源监控 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- CPU 使用率 -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-microchip mr-2 text-blue-600"></i>CPU 使用率
                </h3>
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div>
                            <span id="cpuValue" class="text-2xl font-bold text-gray-800 loading">--</span>
                            <span class="text-gray-600 ml-2">%</span>
                        </div>
                        <div id="cpuStatus" class="text-sm">--</div>
                    </div>
                    <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-gray-200">
                        <div id="cpuBar" class="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-blue-500 to-purple-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 内存使用率 -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-memory mr-2 text-green-600"></i>内存使用率
                </h3>
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div>
                            <span id="memoryValue" class="text-2xl font-bold text-gray-800 loading">--</span>
                            <span class="text-gray-600 ml-2">%</span>
                        </div>
                        <div id="memoryStatus" class="text-sm">--</div>
                    </div>
                    <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-gray-200">
                        <div id="memoryBar" class="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-green-500 to-teal-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- 磁盘使用率 -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-hdd mr-2 text-orange-600"></i>磁盘使用率
                </h3>
                <div class="relative pt-1">
                    <div class="flex mb-2 items-center justify-between">
                        <div>
                            <span id="diskValue" class="text-2xl font-bold text-gray-800 loading">--</span>
                            <span class="text-gray-600 ml-2">%</span>
                        </div>
                        <div id="diskStatus" class="text-sm">--</div>
                    </div>
                    <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-gray-200">
                        <div id="diskBar" class="progress-bar shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-gradient-to-r from-orange-500 to-red-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 性能图表 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- 请求量趋势 -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-chart-line mr-2 text-purple-600"></i>请求量趋势
                </h3>
                <canvas id="requestsChart" width="400" height="200"></canvas>
            </div>

            <!-- 响应时间趋势 -->
            <div class="glass rounded-xl p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-clock mr-2 text-indigo-600"></i>响应时间趋势
                </h3>
                <canvas id="responseTimeChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- 告警信息 -->
        <div class="glass rounded-xl p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">
                <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i>系统告警
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center p-4 bg-red-50 rounded-lg">
                    <p class="text-3xl font-bold text-red-600" id="criticalAlerts">--</p>
                    <p class="text-sm text-gray-600 mt-1">严重</p>
                </div>
                <div class="text-center p-4 bg-orange-50 rounded-lg">
                    <p class="text-3xl font-bold text-orange-600" id="highAlerts">--</p>
                    <p class="text-sm text-gray-600 mt-1">高级</p>
                </div>
                <div class="text-center p-4 bg-yellow-50 rounded-lg">
                    <p class="text-3xl font-bold text-yellow-600" id="mediumAlerts">--</p>
                    <p class="text-sm text-gray-600 mt-1">中级</p>
                </div>
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <p class="text-3xl font-bold text-blue-600" id="lowAlerts">--</p>
                    <p class="text-sm text-gray-600 mt-1">低级</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API基础URL - 使用相对路径避免CORS问题
        const API_BASE_URL = '/api/v1/monitoring/dashboard';

        // 初始化图表
        const requestsCtx = document.getElementById('requestsChart').getContext('2d');
        const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');

        const requestsChart = new Chart(requestsCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '请求数',
                    data: [],
                    borderColor: 'rgb(147, 51, 234)',
                    backgroundColor: 'rgba(147, 51, 234, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        const responseTimeChart = new Chart(responseTimeCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: '响应时间 (ms)',
                    data: [],
                    borderColor: 'rgb(99, 102, 241)',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        // 历史数据存储
        const historyData = {
            requests: [],
            responseTime: [],
            labels: []
        };

        // 错误提示
        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorContainer.style.display = 'block';

            // 5秒后自动隐藏错误提示
            setTimeout(() => {
                errorContainer.style.display = 'none';
            }, 5000);
        }

        // 更新数据函数
        async function refreshData() {
            try {
                // 隐藏错误提示
                document.getElementById('errorContainer').style.display = 'none';

                const response = await fetch(API_BASE_URL);

                // 更新API状态
                const apiStatusEl = document.getElementById('apiStatus');
                if (response.ok) {
                    apiStatusEl.className = 'api-status online';
                    apiStatusEl.innerHTML = '<span class="status-dot"></span><span>在线</span>';

                    const data = await response.json();
                    if (data.success) {
                        updateMetrics(data.data);
                        updateLastUpdateTime();
                    } else {
                        showError('获取监控数据失败: ' + (data.error?.message || '未知错误'));
                    }
                } else {
                    apiStatusEl.className = 'api-status offline';
                    apiStatusEl.innerHTML = '<span class="status-dot"></span><span>离线</span>';
                    showError('API服务不可用 (' + response.status + ')');
                }
            } catch (error) {
                const apiStatusEl = document.getElementById('apiStatus');
                apiStatusEl.className = 'api-status offline';
                apiStatusEl.innerHTML = '<span class="status-dot"></span><span>离线</span>';

                showError('连接API失败: ' + error.message);
            } finally {
                // 移除加载状态
                document.querySelectorAll('.loading').forEach(el => {
                    if (el.textContent === '--') {
                        el.classList.remove('loading');
                    }
                });
            }
        }

        function updateMetrics(data) {
            // 更新业务指标
            if (data.business) {
                document.getElementById('activeUsers').textContent = data.business.activeUsers ? data.business.activeUsers.toLocaleString() : '0';
                document.getElementById('orders').textContent = data.business.orders ? data.business.orders.toLocaleString() : '0';
                document.getElementById('revenue').textContent = data.business.revenue ? '¥' + (data.business.revenue / 100).toLocaleString() : '¥0';
            }

            // 更新性能指标
            if (data.performance) {
                document.getElementById('responseTime').textContent = data.performance.avgResponseTime ? data.performance.avgResponseTime + ' ms' : '0 ms';
            }

            // 更新系统资源
            if (data.system) {
                updateResourceBar('cpu', data.system.cpu || 0);
                updateResourceBar('memory', data.system.memory || 0);
                updateResourceBar('disk', data.system.disk || 0);
            }

            // 更新告警
            if (data.alerts) {
                document.getElementById('criticalAlerts').textContent = data.alerts.critical || 0;
                document.getElementById('highAlerts').textContent = data.alerts.high || 0;
                document.getElementById('mediumAlerts').textContent = data.alerts.medium || 0;
                document.getElementById('lowAlerts').textContent = data.alerts.low || 0;
            }

            // 更新图表数据
            const now = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            // 保持最近20个数据点
            historyData.labels.push(now);
            historyData.requests.push(data.performance?.requests || 0);
            historyData.responseTime.push(data.performance?.avgResponseTime || 0);

            if (historyData.labels.length > 20) {
                historyData.labels.shift();
                historyData.requests.shift();
                historyData.responseTime.shift();
            }

            // 更新请求量图表
            requestsChart.data.labels = historyData.labels;
            requestsChart.data.datasets[0].data = historyData.requests;
            requestsChart.update();

            // 更新响应时间图表
            responseTimeChart.data.labels = historyData.labels;
            responseTimeChart.data.datasets[0].data = historyData.responseTime;
            responseTimeChart.update();
        }

        function updateResourceBar(resource, value) {
            const valueEl = document.getElementById(resource + 'Value');
            const barEl = document.getElementById(resource + 'Bar');
            const statusEl = document.getElementById(resource + 'Status');

            valueEl.textContent = value.toFixed(1);
            barEl.style.width = value + '%';

            // 更新状态文字和颜色
            if (value < 60) {
                statusEl.textContent = '正常';
                statusEl.className = 'text-sm text-green-600';
            } else if (value < 80) {
                statusEl.textContent = '警告';
                statusEl.className = 'text-sm text-yellow-600';
            } else {
                statusEl.textContent = '危险';
                statusEl.className = 'text-sm text-red-600';
            }
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = '最后更新: ' +
                now.toLocaleTimeString('zh-CN');
        }

        // 页面加载时获取一次数据
        refreshData();
    </script>
</body>
</html>