# 测试覆盖率提升指南

## 📊 当前状态

- **覆盖率目标**：已从60%提升到80%
- **测试配置**：vitest.config.ts已更新
- **环境配置**：.env.test已创建
- **新增测试**：已创建3个单元测试文件

## 🎯 已完成的改进

### 1. 更新vitest配置 ✅
```typescript
// vitest.config.ts
coverage: {
  thresholds: {
    global: {
      branches: 80,    // 从60提升到80
      functions: 80,   // 从60提升到80
      lines: 80,       // 从60提升到80
      statements: 80   // 从60提升到80
    }
  }
}
```

### 2. 创建测试环境配置 ✅
创建了`.env.test`文件，包含：
- 数据库配置
- JWT配置
- Redis配置
- 禁用的安全功能（便于测试）

### 3. 补充关键单元测试 ✅

#### 3.1 工具函数测试 (`tests/unit/utils.test.ts`)
- 金额格式化
- 手机号验证
- 订单号生成
- 折扣计算
- 字符串处理
- 日期处理
- 数组操作

#### 3.2 响应处理测试 (`tests/unit/response.test.ts`)
- 成功响应创建
- 错误响应创建
- 分页响应格式化
- 批量操作响应
- 响应格式验证

#### 3.3 认证中间件测试 (`tests/unit/auth-middleware.test.ts`)
- JWT Token生成和验证
- Token黑名单机制
- 认证中间件测试
- 可选认证测试

#### 3.4 输入验证测试 (`tests/unit/validation.test.ts`)
- 邮箱验证
- 密码强度检查
- 用户名验证
- 金额验证
- 手机号验证
- 业务规则验证

## 📝 如何运行测试

### 运行所有测试
```bash
npm run test
```

### 运行测试并生成覆盖率报告
```bash
npm run test:coverage
```

### 运行特定测试文件
```bash
# 运行工具函数测试
npm run test tests/unit/utils.test.ts

# 运行响应处理测试
npm run test tests/unit/response.test.ts

# 运行认证中间件测试
npm run test tests/unit/auth-middleware.test.ts
```

### 监听模式（开发时使用）
```bash
npm run test:watch
```

## 🔍 查看覆盖率报告

1. 运行覆盖率测试后，报告会生成在 `coverage/` 目录
2. 打开 `coverage/index.html` 查看详细报告
3. 未覆盖的代码会用红色标记

## 📈 进一步提升建议

### 1. 优先覆盖核心业务模块
- **用户管理** (`src/shared/services/user.service.ts`)
- **商品管理** (`src/modules/products/`)
- **订单处理** (`src/modules/orders/`)
- **支付处理** (`src/modules/payments/`)
- **佣金计算** (`src/modules/commission/`)

### 2. 补充集成测试
```typescript
// 测试示例：创建订单流程
describe('订单创建流程', () => {
  it('应该能够创建完整订单', async () => {
    // 1. 用户登录
    // 2. 选择商品
    // 3. 加入购物车
    // 4. 创建订单
    // 5. 支付订单
  });
});
```

### 3. 边界条件测试
- 空值输入处理
- 极值测试（最大/最小值）
- 并发请求测试
- 错误恢复测试

### 4. 性能测试
```typescript
describe('性能测试', () => {
  it('API响应时间应小于500ms', async () => {
    const start = Date.now();
    await apiRequest();
    const duration = Date.now() - start;
    expect(duration).toBeLessThan(500);
  });
});
```

## 🛠️ 测试工具和技巧

### 1. 使用Mock隔离依赖
```typescript
// Mock数据库
vi.mock('@prisma/client', () => ({
  PrismaClient: vi.fn().mockImplementation(() => ({
    user: {
      findUnique: vi.fn(),
      create: vi.fn(),
    }
  }))
}));
```

### 2. 测试数据工厂
```typescript
// 创建测试数据
const createTestUser = (overrides = {}) => ({
  id: 'test-user-id',
  nickname: 'Test User',
  level: 'NORMAL',
  ...overrides
});
```

### 3. 快照测试
```typescript
it('用户响应格式应该正确', () => {
  const response = userService.formatUser(testUser);
  expect(response).toMatchSnapshot();
});
```

## ⚠️ 常见问题解决

### 1. 测试环境变量
确保所有敏感信息都在测试环境中配置：
```bash
# .env.test
NODE_ENV=test
DATABASE_URL=mysql://test:test@localhost:3306/zhongdao_test
JWT_SECRET=test-secret
```

### 2. 异步测试
使用async/await处理异步操作：
```typescript
it('应该处理异步操作', async () => {
  const result = await someAsyncFunction();
  expect(result).toBeDefined();
});
```

### 3. 清理测试数据
使用beforeEach和afterEach清理测试数据：
```typescript
beforeEach(async () => {
  await setupTestData();
});

afterEach(async () => {
  await cleanupTestData();
});
```

## 📊 覆盖率目标达成检查

运行以下命令检查实际覆盖率：
```bash
npm run test:coverage
```

期望输出：
```
----------|---------|----------|---------|---------|-------------------
File        | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s
----------|---------|----------|---------|---------|-------------------
All files  |    80   |    80    |    80   |    80   |
----------|---------|----------|---------|---------|-------------------
```

## 🎯 下一步行动计划

1. **立即执行**
   - [x] 更新vitest配置（完成）
   - [x] 创建测试环境配置（完成）
   - [x] 编写基础单元测试（完成）

2. **本周内完成**
   - [ ] 运行完整覆盖率测试
   - [ ] 识别覆盖率低于80%的文件
   - [ ] 为核心业务模块补充测试

3. **两周内完成**
   - [ ] 达到80%的全局覆盖率目标
   - [ ] 建立CI/CD中的自动化测试
   - [ ] 编写测试文档和最佳实践

## 💡 最佳实践

1. **测试命名规范**
   - 使用描述性的测试名称
   - 遵循"应该做什么"的模式

2. **测试组织**
   - 按功能模块组织测试
   - 使用describe和it合理分组

3. **测试隔离**
   - 每个测试应该独立运行
   - 不依赖其他测试的状态

4. **测试维护**
   - 定期更新测试数据
   - 及时修复失败的测试
   - 保持测试代码整洁

## 📚 相关资源

- [Vitest官方文档](https://vitest.dev/)
- [Jest测试最佳实践](https://github.com/goldbergyoni/javascript-testing-best-practices)
- [测试覆盖率指南](https://github.com/istanbuljs/nyc)

---

**记住**：测试覆盖率的目的是提高代码质量，而不是单纯追求数字。确保测试有意义且能真正验证业务逻辑。