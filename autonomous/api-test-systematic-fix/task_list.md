# API测试系统性修复计划

## 任务概述
作为PM-AI，带领多个AI智能体同事完成API测试的系统性修复，解决数据库schema不同步、测试环境基础设施问题以及修复方式零散化等根本问题。

## 智能体团队分工

### 1. Database Expert (数据库专家)
- 负责Prisma schema同步
- 修复表名和模型引用错误
- 确保数据库一致性

### 2. Infrastructure Specialist (基础设施专家)
- 修复测试环境配置
- 处理数据库连接问题
- 优化测试数据管理

### 3. Test Architect (测试架构师)
- 重建测试体系结构
- 设计渐进式测试恢复策略
- 建立测试质量门禁

### 4. Code Quality Engineer (代码质量工程师)
- 统一模型命名规范
- 修复认证系统
- 建立lint规则和文档

## Phase 1: 基础设施修复（最高优先级）

- [ ] 1.1 数据库完全同步
  - [ ] 检查prisma/schema.prisma与数据库的一致性
  - [ ] 运行npx prisma db pull确保schema同步
  - [ ] 重新生成Prisma客户端
  - [ ] 验证所有表是否存在
- [ ] 1.2 测试数据管理器修复
  - [ ] 修复test-data-manager.ts中的表名错误
  - [ ] 确保使用正确的Prisma模型名称
  - [ ] 创建完整的测试数据初始化脚本
- [ ] 1.3 环境配置验证
  - [ ] 确认DATABASE_URL指向正确的测试数据库
  - [ ] 验证数据库连接权限
  - [ ] 检查.env.test配置

## Phase 2: 核心系统修复

- [ ] 2.1 认证系统彻底修复
  - [ ] 检查JWT中间件实现
  - [ ] 修复token生成和验证
  - [ ] 确保测试辅助函数正确工作
- [ ] 2.2 模型名称统一
  - [ ] 全项目搜索并替换所有错误的模型名
  - [ ] 建立命名规范文档
  - [ ] 添加lint规则防止未来错误

## Phase 3: 渐进式测试恢复

- [ ] 3.1 建立测试金字塔
  - [ ] 运行基础连接测试
  - [ ] 运行单个模块测试
  - [ ] 运行集成测试
- [ ] 3.2 创建测试验证脚本
  - [ ] 自动检测常见问题
  - [ ] 生成测试前检查清单
  - [ ] 提供修复建议

## 立即执行任务（今天）

- [ ] 4.1 停止所有后台测试进程
- [ ] 4.2 备份当前测试结果
- [ ] 4.3 运行数据库同步命令
- [ ] 4.4 修复test-data-manager.ts
- [ ] 4.5 验证基础数据库操作

## 短期目标（1-2天）

- [ ] 5.1 修复认证系统
- [ ] 5.2 确保支付和库存模块继续通过
- [ ] 5.3 修复用户和商品模块
- [ ] 5.4 建立持续集成检查

## 中期目标（1周）

- [ ] 6.1 所有模块测试通过率 >80%
- [ ] 6.2 建立自动化测试流水线
- [ ] 6.3 创建测试质量门禁
- [ ] 6.4 编写测试最佳实践文档

## 质量保证措施

- [ ] 7.1 修复后验证
  - [ ] 每个修复必须通过测试验证
  - [ ] 不能引入新的失败测试
  - [ ] 保持已有通过的测试继续通过
- [ ] 7.2 文档同步更新
  - [ ] 记录所有修复内容
  - [ ] 更新开发指南
  - [ ] 培训团队成员避免重复错误

## 风险控制

- [ ] 8.1 数据安全
  - [ ] 修复前备份数据库
  - [ ] 使用独立的测试环境
  - [ ] 不影响生产数据
- [ ] 8.2 进度跟踪
  - [ ] 每日更新修复进度
  - [ ] 及时报告阻塞问题
  - [ ] 调整优先级确保核心功能可用